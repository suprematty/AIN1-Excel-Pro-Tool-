<!DOCTYPE html>
<!--
AIN1 EXCEL PRO
Author: Matthew Naliponguit Sugang
License: CC BY-NC-ND 4.0
Copyright © 2026

Unauthorized modification, resale, or redistribution is prohibited.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIN1 Excel Pro - VBA & Formula Workshop</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-main: #1a1d2e;
            --bg-dark: #0f1118;
            --bg-light: #252842;
            --bg-lighter: #2d3250;
            --bg-accent: #1e2239;
            --line-num-bg: #13151f;
            --line-num-text: #4a5070;
            --text-main: #a8b1d1;
            --text-bright: #ffffff;
            
            /* VIBRANT VBA Syntax Colors - Enhanced for visibility */
            --vba-keyword: #ff1493;           /* Deep Pink - Sub, Function, If, For, etc. */
            --vba-keyword-control: #00ffff;   /* Cyan - Then, End, Next, Loop */
            --vba-string: #ffff00;            /* Bright Yellow - Strings */
            --vba-function: #00d4ff;          /* Bright Cyan - MsgBox, InputBox */
            --vba-number: #ff66ff;            /* Bright Purple - Numbers */
            --vba-comment: #7fff00;           /* Chartreuse Green - Comments */
            --vba-operator: #ffffff;          /* White - Operators */
            --vba-object: #00ff00;            /* Bright Green - Worksheet, Range */
            --vba-constant: #ffa500;          /* Orange - vbCrLf, xlUp */
            --vba-type: #87ceeb;              /* Sky Blue - Integer, String */
            --vba-boolean: #ff1493;           /* Deep Pink - True, False */
            --vba-builtin: #ffff66;           /* Light Yellow - Value, Name */
            --vba-declaration: #ff6347;       /* Tomato Red - Dim, As, Set */
            
            --accent-cyan: #00d4ff;
            --accent-pink: #ff6b9d;
            --accent-green: #50fa7b;
            --accent-orange: #ffb86c;
            --accent-purple: #bd93f9;
            --success: #50fa7b;
            --warning: #ffb86c;
            --error: #ff5555;
            --info: #00d4ff;
            --border: #2d3250;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-main);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Enhanced Header */
        .header {
            background: linear-gradient(135deg, #1a1d2e 0%, #252842 50%, #1e2239 100%);
            padding: 20px 30px;
            border-bottom: 3px solid;
            border-image: linear-gradient(90deg, var(--accent-cyan), var(--accent-pink), var(--accent-purple)) 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 30px rgba(0, 212, 255, 0.15);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 200%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .logo {
            font-size: 26px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-pink), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
            position: relative;
            z-index: 1;
        }

        .header-right {
            display: flex;
            gap: 30px;
            align-items: center;
            font-size: 13px;
            position: relative;
            z-index: 1;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: rgba(80, 250, 123, 0.15);
            border: 2px solid var(--success);
            border-radius: 25px;
            box-shadow: 0 0 20px rgba(80, 250, 123, 0.3);
        }

        .pulse-dot {
            width: 10px;
            height: 10px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px var(--success);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); box-shadow: 0 0 10px var(--success); }
            50% { opacity: 0.6; transform: scale(0.95); box-shadow: 0 0 5px var(--success); }
        }

        /* Main Container */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Enhanced Sidebar */
        .sidebar {
            width: 300px;
            background: linear-gradient(180deg, var(--bg-dark) 0%, var(--bg-light) 100%);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-shadow: 5px 0 20px rgba(0, 0, 0, 0.3);
            position: relative;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.collapsed {
            transform: translateX(-300px);
            width: 0;
        }

        /* Navigation Toggle Button - SEPARATED from sidebar, always visible */
        .nav-toggle-btn {
            position: fixed;
            left: 310px;  /* 300px sidebar + 10px gap = separated from panel */
            bottom: 20px;
            width: 35px;  /* Smaller width */
            height: 60px;  /* Smaller height */
            background: linear-gradient(135deg, var(--bg-accent), var(--bg-dark));
            border: 2px solid var(--accent-cyan);
            border-radius: 8px;
            color: var(--accent-cyan);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001;
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.4);
        }

        .nav-toggle-btn:hover {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            box-shadow: 0 4px 25px rgba(0, 255, 255, 0.8);
            transform: scale(1.1);
        }

        .nav-toggle-btn:active {
            transform: scale(0.95);
        }

        /* When sidebar is collapsed, move button to left edge */
        body.nav-collapsed .nav-toggle-btn {
            left: 10px;  /* 10px from screen edge when collapsed */
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.7);
            animation: pulse 2s infinite;
        }

        /* Pulse animation when collapsed */
        @keyframes pulse {
            0%, 100% { 
                box-shadow: 0 4px 20px rgba(0, 255, 255, 0.7);
            }
            50% { 
                box-shadow: 0 4px 30px rgba(0, 255, 255, 1);
                transform: scale(1.15);
            }
        }

        #navArrow {
            transition: transform 0.3s ease;
            display: inline-block;
            font-weight: bold;
        }

        body.nav-collapsed #navArrow {
            transform: rotate(180deg);
        }

        .sidebar-header {
            padding: 25px 20px;
            background: var(--bg-accent);
            border-bottom: 2px solid var(--accent-cyan);
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent-cyan);
            text-align: center;
        }

        .nav-section {
            padding: 20px 15px;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--accent-purple);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 15px;
            padding-left: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 14px;
            background: linear-gradient(180deg, var(--accent-cyan), var(--accent-purple));
            border-radius: 2px;
        }

        .nav-item {
            padding: 14px 16px;
            margin-bottom: 6px;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 14px;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, var(--accent-cyan), transparent);
            transition: width 0.3s ease;
        }

        .nav-item:hover {
            background: var(--bg-lighter);
            color: var(--accent-cyan);
            transform: translateX(5px);
        }

        .nav-item:hover::before {
            width: 100%;
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(255, 107, 157, 0.2));
            color: var(--accent-cyan);
            border-left: 4px solid var(--accent-cyan);
            font-weight: 700;
            box-shadow: 0 2px 10px rgba(0, 212, 255, 0.3);
        }

        .nav-icon {
            font-size: 18px;
            width: 20px;
            text-align: center;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;      /* ADDED: Allow vertical scrolling */
            overflow-x: hidden;    /* ADDED: Prevent horizontal scrolling */
        }

        .view {
            display: none;
            flex-direction: column;
            min-height: 100%;      /* MODIFIED: Allow growth beyond viewport */
        }

        .view.active {
            display: flex;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Enhanced Editor Header */
        .editor-header {
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-accent) 100%);
            padding: 20px 30px;
            border-bottom: 2px solid var(--border);
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.2);
        }

        .editor-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-bright);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .editor-title::before {
            content: '';
            width: 6px;
            height: 24px;
            background: linear-gradient(180deg, var(--accent-cyan), var(--accent-pink));
            border-radius: 3px;
        }

        .editor-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: 2px solid var(--accent-cyan);
            background: transparent;
            color: var(--accent-cyan);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Inter', sans-serif;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--accent-cyan);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn span {
            position: relative;
            z-index: 1;
        }

        .btn:hover {
            color: var(--bg-main);
            box-shadow: 0 0 25px rgba(0, 212, 255, 0.5);
            transform: translateY(-3px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-pink));
            border: none;
            color: white;
        }

        .btn-primary:hover {
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.7);
        }

        .btn-success {
            border-color: var(--success);
            color: var(--success);
        }

        .btn-success::before {
            background: var(--success);
        }

        /* Code Container */
        .code-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
            background: var(--bg-main);
        }

        .line-numbers {
            background: var(--line-num-bg);
            color: var(--line-num-text);
            padding: 20px 16px;
            text-align: right;
            font-size: 14px;
            line-height: 1.6;
            font-family: 'Fira Code', monospace;
            user-select: none;
            min-width: 70px;
            overflow: hidden;
            border-right: 2px solid var(--border);
            white-space: pre;
            display: block;
            overflow-x: hidden;
            word-wrap: normal;
        }

        .code-input-wrapper {
            flex: 1;
            position: relative;
            overflow: auto;
        }

        .code-input {
            width: 100%;
            height: 100%;
            padding: 20px;
            background: transparent;
            color: transparent;  /* CRITICAL: Makes typed text invisible - only highlighting shows */
            caret-color: var(--accent-cyan);  /* Keep caret visible */
            font-size: 15px;
            line-height: 1.6;
            font-family: 'Fira Code', monospace;
            border: none;
            outline: none;
            resize: none;
            white-space: pre;
            overflow-wrap: normal;
            overflow: auto;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;  /* On top so you can type */
            tab-size: 4;
        }

        /* Execution Tool Input - VISIBLE TEXT (no syntax highlighting overlay) */
        #execInput {
            color: var(--text-main);  /* Make text visible! */
            background: var(--bg-dark);
            position: relative;  /* Not absolute */
            z-index: 1;
        }

        .code-highlight {
            width: 100%;
            height: 100%;
            padding: 20px;
            font-size: 15px;
            line-height: 1.6;
            font-family: 'Fira Code', monospace;
            white-space: pre;
            overflow-wrap: normal;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;  /* Behind the textarea */
            pointer-events: none;
            overflow: hidden;
            /* NO color property here - colors come from span classes */
        }

        /* Extended Syntax Highlighting - More Vibrant & Distinct */
        .keyword { 
            color: var(--vba-keyword); 
            font-weight: 700; 
            text-shadow: 0 0 2px rgba(255, 20, 147, 0.5);
        }
        .keyword-control { 
            color: var(--vba-keyword-control); 
            font-weight: 700; 
            text-shadow: 0 0 2px rgba(0, 255, 255, 0.5);
        }
        .keyword-sub { 
            color: #ff1493; 
            font-weight: 900; 
            text-shadow: 0 0 3px rgba(255, 20, 147, 0.7);
        }
        .keyword-condition {
            color: #ff69b4;
            font-weight: 700;
            text-shadow: 0 0 2px rgba(255, 105, 180, 0.5);
        }
        .keyword-loop {
            color: #da70d6;
            font-weight: 700;
            text-shadow: 0 0 2px rgba(218, 112, 214, 0.5);
        }
        .declaration { 
            color: var(--vba-declaration); 
            font-weight: 700; 
            text-shadow: 0 0 2px rgba(255, 99, 71, 0.5);
        }
        .string { 
            color: var(--vba-string); 
            text-shadow: 0 0 2px rgba(255, 255, 0, 0.3);
        }
        .comment { 
            color: var(--vba-comment); 
            font-style: italic; 
            text-shadow: 0 0 2px rgba(127, 255, 0, 0.3);
        }
        .number { 
            color: var(--vba-number); 
            font-weight: 600; 
            text-shadow: 0 0 2px rgba(255, 102, 255, 0.5);
        }
        .function { 
            color: var(--vba-function); 
            font-weight: 700; 
            text-shadow: 0 0 2px rgba(0, 212, 255, 0.5);
        }
        .object { 
            color: var(--vba-object); 
            font-weight: 600; 
            text-shadow: 0 0 2px rgba(0, 255, 0, 0.4);
        }
        .operator { 
            color: var(--vba-operator); 
        }
        .constant { 
            color: var(--vba-constant); 
            font-weight: 700; 
            text-shadow: 0 0 2px rgba(255, 165, 0, 0.5);
        }
        .type { 
            color: var(--vba-type); 
            font-weight: 600; 
        }
        .boolean { 
            color: var(--vba-boolean); 
            font-weight: 700; 
            text-shadow: 0 0 2px rgba(255, 20, 147, 0.5);
        }
        .builtin { 
            color: var(--vba-builtin); 
            font-weight: 600; 
        }

        /* VBA Lint Engine - Squiggly Underlines */
        .vba-squiggle-critical {
            text-decoration: underline wavy #ff4444;
            text-decoration-thickness: 2px;
            text-underline-offset: 2px;
        }
        
        .vba-squiggle-major {
            text-decoration: underline wavy #ffaa00;
            text-decoration-thickness: 2px;
            text-underline-offset: 2px;
        }
        
        .vba-squiggle-minor {
            text-decoration: underline wavy #ffff00;
            text-decoration-thickness: 1px;
            text-underline-offset: 2px;
        }
        
        .vba-squiggle-info {
            text-decoration: underline wavy #00aaff;
            text-decoration-thickness: 1px;
            text-underline-offset: 2px;
        }

        /* Live Monitor Badge */
        .live-monitor-badge {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(80, 250, 123, 0.15);
            border: 2px solid var(--success);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10;
            box-shadow: 0 0 20px rgba(80, 250, 123, 0.4);
        }

        .monitor-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 10px var(--success);
        }

        /* Separate Notification Sidebars */
        .notification-sidebar {
            width: 380px;
            background: var(--bg-dark);
            border-left: 2px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            z-index: 100;
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.5);
        }

        .notification-sidebar.closed {
            transform: translateX(100%);
            visibility: hidden;
            pointer-events: none;
        }

        .notif-header {
            padding: 25px;
            background: linear-gradient(135deg, var(--bg-accent), var(--bg-light));
            border-bottom: 2px solid var(--accent-cyan);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notif-title {
            font-weight: 700;
            font-size: 15px;
            color: var(--accent-cyan);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notif-count {
            background: var(--accent-pink);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .close-notif {
            background: transparent;
            border: 2px solid var(--error);
            color: var(--error);
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .close-notif:hover {
            background: var(--error);
            color: white;
            transform: scale(1.05);
        }

        .notif-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .notif-item {
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-cyan);
            font-size: 13px;
            line-height: 1.6;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .notif-number {
            position: absolute;
            top: 8px;
            right: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
        }

        .notif-success {
            background: rgba(80, 250, 123, 0.1);
            border-left-color: var(--success);
        }

        .notif-error {
            background: rgba(255, 85, 85, 0.1);
            border-left-color: var(--error);
        }

        .notif-warning {
            background: rgba(255, 184, 108, 0.1);
            border-left-color: var(--warning);
        }

        .notif-info {
            background: rgba(0, 212, 255, 0.1);
            border-left-color: var(--info);
        }

        .notif-toggle {
            position: fixed;
            right: 20px;
            top: 120px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-pink));
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 10px 0 0 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            box-shadow: -5px 5px 20px rgba(0, 212, 255, 0.4);
            z-index: 50;
            transition: all 0.3s;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }

        .notif-toggle:hover {
            transform: translateX(-8px);
            box-shadow: -8px 8px 25px rgba(0, 212, 255, 0.6);
        }

        .notif-toggle.hidden {
            display: none;
        }

        /* Formula Input */
        .formula-input-container {
            padding: 25px;
        }

        .formula-label {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent-cyan);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .formula-input-wrapper {
            position: relative;
        }

        .formula-input {
            width: 100%;
            padding: 18px;
            background: var(--bg-light);
            border: 3px solid var(--border);
            color: var(--text-bright);
            font-family: 'Fira Code', monospace;
            font-size: 17px;
            border-radius: 10px;
            outline: none;
            transition: all 0.3s;
            font-weight: 500;
        }

        .formula-input:focus {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 25px rgba(0, 212, 255, 0.3);
            background: var(--bg-accent);
        }

        .formula-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-dark);
            border: 2px solid var(--accent-cyan);
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }

        .formula-suggestions.show {
            display: block;
        }

        .suggestion-item {
            padding: 14px 18px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid var(--border);
        }

        .suggestion-item:hover {
            background: var(--bg-light);
            color: var(--accent-cyan);
        }

        .suggestion-item.selected {
            background: linear-gradient(90deg, rgba(0, 212, 255, 0.2), transparent);
            border-left: 4px solid var(--accent-cyan);
        }

        .suggestion-name {
            font-weight: 700;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            color: var(--accent-cyan);
        }

        .suggestion-desc {
            font-size: 11px;
            color: var(--text-main);
            margin-top: 4px;
        }

        .formula-syntax {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 212, 255, 0.08);
            border: 2px solid var(--accent-cyan);
            border-radius: 8px;
            font-size: 13px;
            font-family: 'Fira Code', monospace;
        }

        .syntax-label {
            color: var(--accent-cyan);
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 12px;
        }

        /* Template Grid */
        .template-scroll-container {
            overflow-y: auto;
            height: calc(100vh - 200px);
            padding: 25px;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .template-card {
            background: linear-gradient(135deg, var(--bg-light), var(--bg-lighter));
            border: 2px solid var(--border);
            border-left: 5px solid var(--accent-pink);
            padding: 22px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .template-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent, rgba(0, 212, 255, 0.1));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .template-card:hover::before {
            opacity: 1;
        }

        .template-card:hover {
            border-left-color: var(--accent-cyan);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
        }

        .template-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-cyan);
            margin-bottom: 10px;
        }

        .template-desc {
            font-size: 13px;
            color: var(--text-main);
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .template-category {
            display: inline-block;
            padding: 5px 12px;
            background: linear-gradient(135deg, rgba(255, 107, 157, 0.3), rgba(189, 147, 249, 0.3));
            color: var(--accent-pink);
            font-size: 11px;
            border-radius: 15px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Function Library */
        .function-scroll-container {
            overflow-y: auto;
            height: calc(100vh - 200px);
            padding: 25px;
        }

        .function-item {
            background: var(--bg-light);
            border: 2px solid var(--border);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .function-item:hover {
            border-color: var(--accent-cyan);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.2);
            transform: translateX(5px);
        }

        /* Clickable Formula Enhancement */
        .clickable-formula {
            transition: all 0.3s ease, background-color 0.2s;
        }

        .clickable-formula:hover {
            background: linear-gradient(135deg, var(--bg-light), var(--bg-accent));
            border-color: var(--accent-purple);
            box-shadow: 0 5px 25px rgba(156, 39, 176, 0.3);
        }

        .clickable-formula:active {
            transform: translateX(3px) scale(0.98);
        }

        .click-hint {
            opacity: 0;
            transition: opacity 0.3s;
        }

        .clickable-formula:hover .click-hint {
            opacity: 1;
        }

        .function-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .function-name {
            font-family: 'Fira Code', monospace;
            font-weight: 700;
            color: var(--vba-function);
            font-size: 16px;
        }

        .function-category-badge {
            padding: 4px 12px;
            background: rgba(102, 217, 239, 0.2);
            color: var(--vba-function);
            font-size: 11px;
            border-radius: 12px;
            font-weight: 700;
        }

        .function-desc {
            font-size: 13px;
            color: var(--text-main);
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .function-syntax {
            font-family: 'Fira Code', monospace;
            font-size: 12px;
            color: var(--vba-string);
            background: var(--bg-dark);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .function-example {
            font-family: 'Fira Code', monospace;
            font-size: 11px;
            color: var(--accent-purple);
            background: var(--bg-dark);
            padding: 8px;
            border-radius: 6px;
            border-left: 3px solid var(--accent-purple);
        }

        /* Resource Section Headers */
        .resource-section-header {
            background: linear-gradient(135deg, var(--bg-accent), var(--bg-dark));
            border-left: 4px solid var(--accent-cyan);
            padding: 15px 20px;
            margin: 30px 0 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 212, 255, 0.1);
        }

        .resource-section-header:first-child {
            margin-top: 0;
        }

        .resource-section-header h3 {
            margin: 0;
            color: var(--accent-cyan);
            font-size: 15px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        /* Progress Bar */
        .progress-container {
            background: var(--bg-light);
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            border: 2px solid var(--accent-cyan);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-cyan);
        }

        .progress-percent {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent-purple);
            font-family: 'Fira Code', monospace;
        }

        .progress-bar-bg {
            width: 100%;
            height: 24px;
            background: var(--bg-dark);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border);
        }

        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        /* Info Box */
        .info-box {
            margin: 20px;
            padding: 20px;
            background: rgba(0, 212, 255, 0.08);
            border: 2px solid var(--accent-cyan);
            border-radius: 10px;
        }

        .info-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-cyan);
            margin-bottom: 10px;
        }

        .info-text {
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-main);
        }

        /* Execution Output */
        .execution-output {
            margin: 20px;
            padding: 25px;
            background: var(--bg-light);
            border-radius: 10px;
            border: 2px solid var(--border);
            max-height: 600px;
            overflow-y: auto;
        }

        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        /* EXECUTION TOOL: PROFESSIONAL PANEL LAYOUT */
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        .exec-panel-container {
            display: flex;
            gap: 20px;
            margin: 20px;
            height: 500px;
        }
        
        .exec-panel {
            flex: 1;
            background: var(--bg-light);
            border-radius: 10px;
            border: 2px solid var(--border);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .exec-panel-header {
            background: linear-gradient(135deg, var(--bg-accent), var(--bg-light));
            padding: 15px 20px;
            border-bottom: 2px solid var(--accent-cyan);
            font-weight: 700;
            font-size: 13px;
            color: var(--accent-cyan);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .exec-panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .exec-panel-icon {
            font-size: 16px;
        }
        
        .exec-panel-actions {
            display: flex;
            gap: 8px;
        }
        
        .exec-panel-btn {
            background: rgba(139, 233, 253, 0.1);
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .exec-panel-btn:hover {
            background: rgba(139, 233, 253, 0.2);
            transform: translateY(-1px);
        }
        
        .exec-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            font-family: 'Fira Code', 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        /* Code View Panel (Left) */
        .exec-code-view {
            background: var(--bg-dark);
            color: var(--text);
            padding: 20px;
            white-space: pre-wrap;
            word-wrap: break-word;
            user-select: text;
        }
        
        .exec-code-view.empty {
            color: var(--text-dim);
            font-style: italic;
            text-align: center;
            padding-top: 40px;
        }
        
        /* Immediate Window Panel (Right) */
        .exec-immediate-window {
            background: #1a1d23;
            color: #e6e6e6;
            padding: 15px;
        }
        
        .exec-log-entry {
            margin-bottom: 8px;
            padding: 6px 10px;
            border-left: 3px solid transparent;
            border-radius: 3px;
            transition: background 0.2s;
        }
        
        .exec-log-entry:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        .exec-log-timestamp {
            color: #6272a4;
            font-size: 11px;
            margin-right: 10px;
        }
        
        .exec-log-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            margin-right: 8px;
            text-transform: uppercase;
        }
        
        .exec-log-message {
            color: #f8f8f2;
            font-size: 12px;
        }
        
        /* Log Types */
        .exec-log-info {
            border-left-color: var(--accent-cyan);
        }
        
        .exec-log-info .exec-log-type {
            background: rgba(139, 233, 253, 0.2);
            color: var(--accent-cyan);
        }
        
        .exec-log-success {
            border-left-color: var(--success);
        }
        
        .exec-log-success .exec-log-type {
            background: rgba(80, 250, 123, 0.2);
            color: var(--success);
        }
        
        .exec-log-warning {
            border-left-color: var(--warning);
        }
        
        .exec-log-warning .exec-log-type {
            background: rgba(255, 184, 108, 0.2);
            color: var(--warning);
        }
        
        .exec-log-error {
            border-left-color: var(--error);
        }
        
        .exec-log-error .exec-log-type {
            background: rgba(255, 85, 85, 0.2);
            color: var(--error);
        }
        
        .exec-log-phase {
            border-left-color: var(--accent-purple);
        }
        
        .exec-log-phase .exec-log-type {
            background: rgba(189, 147, 249, 0.2);
            color: var(--accent-purple);
        }
        
        .exec-immediate-empty {
            color: #6272a4;
            font-style: italic;
            text-align: center;
            padding: 40px 20px;
        }
        
        /* Scrollbar for panels */
        .exec-panel-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .exec-panel-content::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        
        .exec-panel-content::-webkit-scrollbar-thumb {
            background: var(--accent-cyan);
            border-radius: 4px;
        }
        
        .exec-panel-content::-webkit-scrollbar-thumb:hover {
            background: var(--accent-purple);
        }
        
        /* Responsive: Stack panels on small screens */
        @media (max-width: 1200px) {
            .exec-panel-container {
                flex-direction: column;
                height: auto;
            }
            
            .exec-panel {
                min-height: 300px;
            }
        }

        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        /* TEST RESULTS POPUP PANEL */
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        .test-results-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 600px;
            max-width: 90vw;
            height: 100vh;
            background: var(--bg-dark);
            border-left: 3px solid var(--accent-cyan);
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .test-results-panel.open {
            transform: translateX(0);
        }
        
        .test-results-header {
            background: linear-gradient(135deg, var(--bg-accent), var(--bg-light));
            padding: 20px 25px;
            border-bottom: 2px solid var(--accent-cyan);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .test-results-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-cyan);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-results-close {
            background: rgba(255, 85, 85, 0.2);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 20px;
            font-weight: 700;
            transition: all 0.2s;
        }
        
        .test-results-close:hover {
            background: rgba(255, 85, 85, 0.3);
            transform: scale(1.1);
        }
        
        .test-results-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        
        .test-results-content .execution-output {
            margin: 0;
            padding: 25px;
            background: transparent;
            border: none;
            border-radius: 0;
            max-height: none;
        }
        
        .test-results-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .test-results-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }
        
        .view-results-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(139, 233, 253, 0.4);
            transition: all 0.3s ease;
            z-index: 9998;
            display: none;
        }
        
        .view-results-btn.visible {
            display: block;
            animation: pulse 2s infinite;
        }
        
        .view-results-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(139, 233, 253, 0.6);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .test-results-panel {
                width: 100vw;
                max-width: 100vw;
            }
            
            .view-results-btn {
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
                font-size: 13px;
            }
        }

        .verdict-section {
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 5px solid;
        }

        .verdict-pass { 
            background: rgba(80, 250, 123, 0.1); 
            border-left-color: var(--success); 
        }

        .verdict-warn { 
            background: rgba(255, 184, 108, 0.1); 
            border-left-color: var(--warning); 
        }

        .verdict-fail { 
            background: rgba(255, 85, 85, 0.1); 
            border-left-color: var(--error); 
        }

        .verdict-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .verdict-summary {
            font-size: 14px;
            line-height: 1.6;
        }

        .issue-item {
            background: var(--bg-dark);
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 6px;
            border-left: 4px solid var(--error);
        }

        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .issue-severity {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .severity-critical {
            background: rgba(255, 85, 85, 0.2);
            color: var(--error);
        }

        .severity-major {
            background: rgba(255, 184, 108, 0.2);
            color: var(--warning);
        }

        .severity-minor {
            background: rgba(0, 212, 255, 0.2);
            color: var(--accent-cyan);
        }

        .issue-location {
            font-family: 'Fira Code', monospace;
            font-size: 12px;
            color: var(--accent-purple);
        }

        .issue-description {
            font-size: 13px;
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .issue-fix {
            background: var(--bg-main);
            padding: 10px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            font-size: 12px;
            color: var(--success);
            margin-top: 8px;
        }

        .test-cases-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }

        .test-cases-table th,
        .test-cases-table td {
            padding: 10px;
            border: 1px solid var(--border);
            text-align: left;
        }

        .test-cases-table th {
            background: var(--bg-dark);
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .test-result-pass { color: var(--success); font-weight: 600; }
        .test-result-fail { color: var(--error); font-weight: 600; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: var(--bg-main);
            border: 3px solid var(--accent-cyan);
            width: 90%;
            max-width: 1100px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 60px rgba(0, 212, 255, 0.5);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--bg-dark), var(--bg-accent));
            padding: 25px 30px;
            border-bottom: 2px solid var(--accent-cyan);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .code-preview {
            background: var(--bg-dark);
            padding: 25px;
            border-radius: 10px;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.6;
            overflow-x: auto;
            white-space: pre;
            color: var(--text-main);
            border: 2px solid var(--border);
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 2px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--accent-cyan), var(--accent-purple));
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--accent-pink), var(--accent-cyan));
        }

        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        /* COMPREHENSIVE RESPONSIVE & MOBILE SUPPORT */
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        /* ========== TABLET & SMALLER DESKTOP (< 1024px) ========== */
        @media (max-width: 1024px) {
            .sidebar { 
                width: 250px; 
            }
            
            .notification-sidebar { 
                width: 320px; 
            }
            
            .template-grid { 
                grid-template-columns: 1fr; 
            }
            
            /* Stack execution tool panels at this breakpoint */
            .exec-panel-container {
                flex-direction: column;
                height: auto;
            }
            
            .exec-panel {
                min-height: 300px;
                max-height: 400px;
            }
        }
        
        /* ========== MOBILE & PHONE (< 768px) ========== */
        @media (max-width: 768px) {
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            /* GENERAL LAYOUT */
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            
            body {
                font-size: 14px;
                overflow-x: hidden;
            }
            
            .container {
                min-width: 100%;
            }
            
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            /* HEADER */
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            
            .header {
                padding: 12px 15px;
                flex-wrap: wrap;
            }
            
            .logo {
                font-size: 16px;
                width: 100%;
                margin-bottom: 8px;
                text-align: center;
            }
            
            .header-right {
                width: 100%;
                justify-content: center;
                gap: 10px;
            }
            
            .status-badge {
                padding: 6px 12px;
                font-size: 11px;
            }
            
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            /* NAVIGATION SIDEBAR */
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            
            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100vh;
                width: 80vw;
                max-width: 300px;
                z-index: 10001;
                transition: left 0.3s ease;
                box-shadow: 5px 0 20px rgba(0, 0, 0, 0.3);
            }
            
            .sidebar.mobile-open {
                left: 0;
            }
            
            .nav-toggle-btn {
                position: fixed;
                top: 10px;
                left: 10px;
                z-index: 10002;
                background: var(--accent-cyan);
                color: var(--bg-dark);
                border: none;
                width: 40px;
                height: 40px;
                border-radius: 8px;
                font-size: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 12px rgba(139, 233, 253, 0.4);
            }
            
            /* Mobile overlay for sidebar */
            .sidebar::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.5);
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
                z-index: -1;
            }
            
            .sidebar.mobile-open::before {
                opacity: 1;
                pointer-events: all;
            }
            
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            /* MAIN CONTENT AREA */
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            /* EDITOR COMPONENTS */
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            
            .editor-header {
                flex-direction: column;
                padding: 15px;
                gap: 10px;
            }
            
            .editor-title {
                font-size: 16px;
                text-align: center;
                width: 100%;
            }
            
            .editor-actions {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            /* BUTTONS - LARGER TOUCH TARGETS */
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            
            .btn {
                padding: 12px 20px;
                font-size: 14px;
                min-width: 120px;
                min-height: 44px;
            }
            
            .btn-primary {
                padding: 14px 24px;
            }
            
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            /* CODE EDITOR */
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            
            .code-container {
                margin: 10px;
            }
            
            .code-input,
            .code-highlight {
                font-size: 13px;
                line-height: 1.6;
            }
            
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            /* EXECUTION TOOL PANELS - STACK VERTICALLY */
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            
            .exec-panel-container {
                flex-direction: column;
                height: auto;
                margin: 10px;
                gap: 15px;
            }
            
            .exec-panel {
                min-height: 250px;
                max-height: 400px;
                width: 100%;
            }
            
            .exec-panel-header {
                padding: 12px 15px;
                font-size: 12px;
            }
            
            .exec-panel-btn {
                padding: 6px 12px;
                font-size: 10px;
            }
            
            .exec-code-view,
            .exec-immediate-window {
                font-size: 12px;
            }
            
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            /* NOTIFICATION SIDEBARS */
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            
            .notification-sidebar {
                width: 100vw;
                max-width: 100vw;
                right: -100vw;
            }
            
            .notification-sidebar:not(.closed) {
                right: 0;
            }
            
            .notif-toggle {
                display: none;
            }
            
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            /* TEST RESULTS PANEL - FULL SCREEN ON MOBILE */
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            
            .test-results-panel {
                width: 100vw;
                max-width: 100vw;
            }
            
            .test-results-header {
                padding: 15px;
            }
            
            .test-results-title {
                font-size: 16px;
            }
            
            .test-results-close {
                padding: 10px 15px;
                font-size: 18px;
            }
            
            .view-results-btn {
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
                font-size: 13px;
                border-radius: 20px;
            }
            
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            /* INFO BOXES & CONTENT */
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            
            .info-box {
                margin: 10px;
                padding: 15px;
            }
            
            .info-title {
                font-size: 14px;
            }
            
            .info-text {
                font-size: 12px;
            }
            
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            /* PROGRESS BAR */
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            
            .progress-container {
                margin: 10px;
                padding: 15px;
            }
            
            .progress-label,
            .progress-percent {
                font-size: 12px;
            }
            
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            /* EXECUTION OUTPUT */
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            
            .execution-output {
                margin: 10px;
                padding: 15px;
            }
            
            .verdict-title {
                font-size: 16px;
            }
            
            .verdict-summary {
                font-size: 13px;
            }
            
            .issue-item {
                padding: 12px;
                margin-bottom: 10px;
            }
            
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            /* TEMPLATES & FUNCTION LISTS */
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            
            .template-grid {
                grid-template-columns: 1fr;
                padding: 10px;
            }
            
            .template-card {
                padding: 15px;
            }
            
            .function-card {
                padding: 12px;
            }
            
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            /* FORMULA CHECKER */
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            
            .formula-input-container {
                padding: 15px;
            }
            
            .formula-input {
                font-size: 14px;
                padding: 12px;
            }
            
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            /* MODALS */
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 0;
            }
            
            .modal-header {
                padding: 15px;
            }
            
            .modal-title {
                font-size: 16px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            /* TABLES */
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            
            .test-cases-table {
                font-size: 12px;
            }
            
            .test-cases-table th,
            .test-cases-table td {
                padding: 8px;
            }
            
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            /* SCROLLBARS - THINNER ON MOBILE */
            /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
            
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
        }
        
        /* ========== SMALL MOBILE (< 480px) ========== */
        @media (max-width: 480px) {
            .logo {
                font-size: 14px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 13px;
                min-width: 100px;
            }
            
            .exec-panel {
                min-height: 200px;
                max-height: 300px;
            }
            
            .editor-title {
                font-size: 14px;
            }
            
            .view-results-btn {
                padding: 10px 16px;
                font-size: 12px;
            }
        }
        
        /* ========== TOUCH DEVICES (ANY SIZE) ========== */
        @media (pointer: coarse) {
            /* Increase all interactive elements for touch */
            .btn,
            .nav-item,
            .template-card,
            .function-card {
                min-height: 44px;
            }
            
            /* Larger tap targets */
            button,
            .close-notif,
            .exec-panel-btn {
                min-width: 44px;
                min-height: 44px;
            }
        }
        
        /* ========== LANDSCAPE MOBILE ========== */
        @media (max-width: 768px) and (orientation: landscape) {
            .exec-panel {
                max-height: 250px;
            }
            
            .header {
                padding: 8px 15px;
            }
            
            .logo {
                margin-bottom: 0;
                width: auto;
            }
            
            .header-right {
                width: auto;
            }
        }
        
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        /* FOOTER & LICENSE */
        /* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */
        
        footer {
            background: var(--bg-dark);
            border-top: 2px solid var(--accent-cyan);
            padding: 20px;
            text-align: center;
            font-size: 13px;
            color: var(--text-dim);
            margin-top: auto;
        }
        
        footer p {
            margin: 0;
            line-height: 1.6;
        }
        
        footer a {
            color: var(--accent-cyan);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        footer a:hover {
            color: var(--accent-purple);
            text-decoration: underline;
        }
        
        .license-section {
            background: var(--bg-light);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 4px solid var(--accent-cyan);
        }
        
        .license-section h3 {
            color: var(--accent-cyan);
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .license-section p {
            line-height: 1.8;
            margin-bottom: 10px;
            color: var(--text);
        }
        
        .license-section a {
            color: var(--accent-purple);
            text-decoration: none;
            font-weight: 600;
        }
        
        .license-section a:hover {
            text-decoration: underline;
        }
        
        /* Mobile footer adjustments */
        @media (max-width: 768px) {
            footer {
                padding: 15px 10px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div style="font-size: 20px; font-weight: 800; letter-spacing: 2px;">AIN1 EXCEL PRO</div>
                <div style="font-size: 11px; opacity: 0.7; margin-top: 3px;">v4.05</div>
                <div style="font-size: 10px; font-weight: 600; opacity: 0.8; margin-top: 2px;">Created by: Matthew Naliponguit Sugang</div>
            </div>
            <div class="header-right">
                <div class="status-badge">
                    <span class="pulse-dot"></span>
                    <span>Live Monitoring Active</span>
                </div>
                <span id="currentTime" style="font-weight: 600;"></span>
            </div>
        </div>

        <!-- Main Container -->
        <div class="main-container">
            <!-- Navigation Toggle Button - OUTSIDE sidebar so it never disappears -->
            <button class="nav-toggle-btn" id="navToggleBtn" onclick="toggleNavigation()" title="Toggle Navigation Panel">
                <span id="navArrow">◄</span>
            </button>
            
            <!-- Sidebar -->
            <div class="sidebar" id="mainSidebar">
                <div class="sidebar-header">Navigation Panel</div>
                
                <div class="nav-section">
                    <div class="section-title">Development Tools</div>
                    <div class="nav-item active" onclick="switchView('code-editor', this)">
                        <span class="nav-icon">◆</span>
                        <span>Code Editor</span>
                    </div>
                    <div class="nav-item" onclick="switchView('formula-checker', this)">
                        <span class="nav-icon">◈</span>
                        <span>Formula Checker</span>
                    </div>
                    <div class="nav-item" onclick="switchView('execution-tool', this)">
                        <span class="nav-icon">⚡</span>
                        <span>Execution Tool</span>
                    </div>
                    <div class="nav-item" onclick="switchView('templates', this)">
                        <span class="nav-icon">▣</span>
                        <span>Code Templates</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="section-title">Excel Resources</div>
                    <div class="nav-item" onclick="switchView('functions', this)">
                        <span class="nav-icon">◉</span>
                        <span>Functions & Formulas</span>
                    </div>
                    <div class="nav-item" onclick="switchView('operators', this)">
                        <span class="nav-icon">⊕</span>
                        <span>Arithmetic Operators</span>
                    </div>
                    <div class="nav-item" onclick="switchView('constants', this)">
                        <span class="nav-icon">⬡</span>
                        <span>Constants & Declarations</span>
                    </div>
                    <div class="nav-item" onclick="switchView('criteria', this)">
                        <span class="nav-icon">🎯</span>
                        <span>Criteria Expressions</span>
                    </div>
                    <div class="nav-item" onclick="switchView('shortcuts', this)">
                        <span class="nav-icon">⌨️</span>
                        <span>Keyboard Shortcuts</span>
                    </div>
                    <div class="nav-item" onclick="switchView('license', this)">
                        <span class="nav-icon">📜</span>
                        <span>License & About</span>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <div class="main-content">
                    <!-- Code Editor View -->
                    <div id="view-code-editor" class="view active">
                        <div class="editor-header">
                            <div class="editor-title">VBA Code Editor with Live Monitoring</div>
                            <div class="editor-actions">
                                <button class="btn btn-primary" onclick="formatCode()">
                                    <span>✨ Format Code</span>
                                </button>
                                <button class="btn btn-success" onclick="clearEditor()">
                                    <span>🗑️ Clear</span>
                                </button>
                                <button class="btn" onclick="copyCode()">
                                    <span>📋 Copy</span>
                                </button>
                                <button class="btn" onclick="loadTemplateDialog()">
                                    <span>📂 Load Template</span>
                                </button>
                            </div>
                        </div>
                        <div class="code-container">
                            <div class="line-numbers" id="lineNumbers">1</div>
                            <div class="code-input-wrapper">
                                <div class="code-highlight" id="codeHighlight"></div>
                                <textarea class="code-input" id="codeInput" spellcheck="false" 
                                          placeholder="' Start typing your VBA code here...
' Live monitoring will automatically check your code
' Press Tab for indentation"></textarea>
                            </div>
                            <div class="live-monitor-badge">
                                <span class="monitor-dot"></span>
                                <span>Live Monitor Active</span>
                            </div>
                        </div>
                    </div>

                    <!-- Formula Checker View -->
                    <div id="view-formula-checker" class="view">
                        <div class="editor-header">
                            <div class="editor-title">Excel Formula Checker with Autocomplete</div>
                            <div class="editor-actions">
                                <button class="btn btn-primary" onclick="checkFormula()">
                                    <span>🔍 Check Formula</span>
                                </button>
                                <button class="btn btn-success" onclick="clearFormula()">
                                    <span>🗑️ Clear</span>
                                </button>
                            </div>
                        </div>
                        <div class="formula-input-container">
                            <div class="formula-label">📊 Enter Excel Formula</div>
                            <!-- Syntax Guide - NOW ABOVE TEXTBOX -->
                            <div class="formula-syntax" id="formulaSyntax" style="display: none;">
                                <div class="syntax-label">Syntax Guide:</div>
                                <div id="syntaxHelp"></div>
                            </div>
                            <!-- Formula Input - NOW BELOW SYNTAX GUIDE -->
                            <div class="formula-input-wrapper">
                                <input type="text" class="formula-input" id="formulaInput" 
                                       placeholder='Type = to see all available formulas (e.g., =SUM, =VLOOKUP, =IF)'>
                                <div class="formula-suggestions" id="formulaSuggestions"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Execution Tool View -->
                    <div id="view-execution-tool" class="view">
                        <div class="editor-header">
                            <div class="editor-title">⚡ Execution Tool - Advanced Analysis</div>
                            <div class="editor-actions">
                                <button class="btn btn-primary" onclick="window.ExecTool.runAnalysis()">
                                    <span>▶ Execute Analysis</span>
                                </button>
                                <button class="btn btn-success" onclick="window.ExecTool.clearExecution()">
                                    <span>🗑️ Clear</span>
                                </button>
                                <button class="btn" onclick="window.ExecTool.copyExecutionCode()">
                                    <span>📋 Copy</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="progress-container" id="execProgressContainer" style="display: none;">
                            <div class="progress-header">
                                <span class="progress-label" id="execProgressLabel" aria-live="polite">Starting...</span>
                                <span class="progress-percent" id="execProgressPercent">0%</span>
                            </div>
                            <div class="progress-bar-bg" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" id="execProgressBar">
                                <div class="progress-bar-fill" id="execProgressFill"></div>
                            </div>
                        </div>

                        <div class="info-box">
                            <div class="info-title">🔬 Zero-False-Pass Analysis</div>
                            <div class="info-text">
                                Paste your VBA code and/or Excel formulas below. The tool performs comprehensive analysis with 7-stage validation.
                                No rubber-stamping - every approval requires proof.
                            </div>
                        </div>
                        
                        <div class="code-container" style="max-height: 300px;">
                            <div class="line-numbers" id="execLineNumbers">1</div>
                            <div class="code-input-wrapper">
                                <textarea class="code-input" id="execInput" spellcheck="false" 
                                          placeholder="' Paste your VBA code or Excel formulas here
' The tool will analyze:
'   - VBA: Syntax, compile errors, runtime risks, logic issues
'   - Formulas: Structure, functions, references, calc errors
' 
' Example VBA:
Sub Test()
    Dim x As Integer
    MsgBox &quot;Hello&quot;
End Sub

' Example Formula:
=IFERROR(VLOOKUP(A1, Data!A:B, 2, FALSE), &quot;Not Found&quot;)"></textarea>
                            </div>
                        </div>

                        <!-- Professional Panel Layout (IDE-style) -->
                        <div class="exec-panel-container" id="execPanelContainer" style="display: none;">
                            <!-- Left Panel: Code Being Executed -->
                            <div class="exec-panel">
                                <div class="exec-panel-header">
                                    <div class="exec-panel-title">
                                        <span class="exec-panel-icon">📝</span>
                                        <span>Code Under Analysis</span>
                                    </div>
                                    <div class="exec-panel-actions">
                                        <button class="exec-panel-btn" onclick="window.ExecUI.copyCodeView()" title="Copy code">
                                            📋 Copy
                                        </button>
                                    </div>
                                </div>
                                <div class="exec-panel-content">
                                    <div class="exec-code-view empty" id="execCodeView">
                                        No code loaded yet. Click "Execute Analysis" to begin.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Panel: Immediate Window (Logs & Output) -->
                            <div class="exec-panel">
                                <div class="exec-panel-header">
                                    <div class="exec-panel-title">
                                        <span class="exec-panel-icon">⚡</span>
                                        <span>Immediate Window</span>
                                    </div>
                                    <div class="exec-panel-actions">
                                        <button class="exec-panel-btn" onclick="window.ExecUI.clearImmediateWindow()" title="Clear logs">
                                            🗑️ Clear
                                        </button>
                                        <button class="exec-panel-btn" onclick="window.ExecUI.copyImmediateLogs()" title="Copy all logs">
                                            📋 Copy
                                        </button>
                                    </div>
                                </div>
                                <div class="exec-panel-content" id="execImmediateContent">
                                    <div class="exec-immediate-empty">
                                        Waiting for execution... Logs will appear here.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="execution-output" id="execOutput" style="display: none;">
                            <!-- Analysis results will appear here -->
                        </div>
                    </div>

                    <!-- Templates View -->
                    <div id="view-templates" class="view">
                        <div class="editor-header">
                            <div class="editor-title">VBA Code Templates Library</div>
                        </div>
                        <div class="template-scroll-container">
                            <div class="template-grid" id="templateGrid"></div>
                        </div>
                    </div>

                    <!-- Functions Library View -->
                    <div id="view-functions" class="view">
                        <div class="editor-header">
                            <div class="editor-title">Excel Functions & Formula Templates</div>
                        </div>
                        <div class="function-scroll-container">
                            <div id="functionList"></div>
                        </div>
                    </div>

                    <!-- Arithmetic Operators View -->
                    <div id="view-operators" class="view">
                        <div class="editor-header">
                            <div class="editor-title">Arithmetic Operators - Complete Reference</div>
                        </div>
                        <div class="function-scroll-container">
                            <div id="operatorList"></div>
                        </div>
                    </div>

                    <!-- Constants & Declarations View -->
                    <div id="view-constants" class="view">
                        <div class="editor-header">
                            <div class="editor-title">VBA Constants & Declarations - Complete Reference</div>
                        </div>
                        <div class="function-scroll-container">
                            <div id="constantList"></div>
                        </div>
                    </div>

                    <!-- Criteria Expressions View -->
                    <div id="view-criteria" class="view">
                        <div class="editor-header">
                            <div class="editor-title">📊 Excel Criteria Expressions - Complete Guide</div>
                        </div>
                        <div class="info-box" style="margin: 20px;">
                            <div class="info-title">🎯 What Are Criteria Expressions?</div>
                            <div class="info-text">
                                Criteria expressions are special text strings used in Excel functions like COUNTIF, SUMIF, AVERAGEIF to filter and analyze data. 
                                They combine operators (=, >, <, <>, etc.) with values to create conditional logic within formulas.
                            </div>
                        </div>
                        <div class="function-scroll-container">
                            <div id="criteriaList"></div>
                        </div>
                    </div>

                    <!-- Keyboard Shortcuts View -->
                    <div id="view-shortcuts" class="view">
                        <div class="editor-header">
                            <div class="editor-title">⌨️ Excel Keyboard Shortcuts – All-in-One Complete Guide</div>
                        </div>
                        <div class="function-scroll-container" style="padding: 20px;">
                            
                            <div class="info-box">
                                <div class="info-title">🎯 Master Excel with Keyboard Shortcuts</div>
                                <div class="info-text">
                                    This comprehensive guide covers all essential Excel keyboard shortcuts organized by category. 
                                    Compatible with Excel 2010, 2013, 2016, 2019, and Excel 365.
                                </div>
                            </div>

                            <!-- 1. GENERAL / FILE -->
                            <div class="function-card" style="margin-bottom: 30px;">
                                <div class="function-name" style="font-size: 18px; color: var(--accent-cyan);">1️⃣ GENERAL / FILE OPERATIONS</div>
                                <div style="overflow-x: auto; margin-top: 15px;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr style="background: var(--bg-accent);"><th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Shortcut</th><th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Action</th></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + N</td><td style="padding: 8px; border: 1px solid var(--border);">Create new workbook</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + O</td><td style="padding: 8px; border: 1px solid var(--border);">Open workbook</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + S</td><td style="padding: 8px; border: 1px solid var(--border);">Save workbook</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + P</td><td style="padding: 8px; border: 1px solid var(--border);">Print</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + W</td><td style="padding: 8px; border: 1px solid var(--border);">Close workbook</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + F4</td><td style="padding: 8px; border: 1px solid var(--border);">Close workbook (alternative)</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + Tab</td><td style="padding: 8px; border: 1px solid var(--border);">Switch between open workbooks</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Alt + F4</td><td style="padding: 8px; border: 1px solid var(--border);">Close Excel</td></tr>
                                    </table>
                                </div>
                            </div>

                            <!-- 2. EDITING & FORMULAS -->
                            <div class="function-card" style="margin-bottom: 30px;">
                                <div class="function-name" style="font-size: 18px; color: var(--accent-cyan);">2️⃣ EDITING & FORMULAS</div>
                                <div style="overflow-x: auto; margin-top: 15px;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr style="background: var(--bg-accent);"><th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Shortcut</th><th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Action</th></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">F2</td><td style="padding: 8px; border: 1px solid var(--border);">Edit active cell</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + Enter</td><td style="padding: 8px; border: 1px solid var(--border);">Fill selected cells with current entry</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + D</td><td style="padding: 8px; border: 1px solid var(--border);">Fill Down</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + R</td><td style="padding: 8px; border: 1px solid var(--border);">Fill Right</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + `</td><td style="padding: 8px; border: 1px solid var(--border);">Show/hide formulas</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Alt + Enter</td><td style="padding: 8px; border: 1px solid var(--border);">Insert line break in cell</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + ;</td><td style="padding: 8px; border: 1px solid var(--border);">Insert current date</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + Shift + :</td><td style="padding: 8px; border: 1px solid var(--border);">Insert current time</td></tr>
                                    </table>
                                </div>
                            </div>

                            <!-- 3. NAVIGATION -->
                            <div class="function-card" style="margin-bottom: 30px;">
                                <div class="function-name" style="font-size: 18px; color: var(--accent-cyan);">3️⃣ NAVIGATION</div>
                                <div style="overflow-x: auto; margin-top: 15px;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr style="background: var(--bg-accent);"><th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Shortcut</th><th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Action</th></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + ↑/↓/←/→</td><td style="padding: 8px; border: 1px solid var(--border);">Jump to edge of data region</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + Home</td><td style="padding: 8px; border: 1px solid var(--border);">Go to cell A1</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + End</td><td style="padding: 8px; border: 1px solid var(--border);">Go to last used cell</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + Page Up/Down</td><td style="padding: 8px; border: 1px solid var(--border);">Switch between worksheets</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + G</td><td style="padding: 8px; border: 1px solid var(--border);">Go To dialog</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + F</td><td style="padding: 8px; border: 1px solid var(--border);">Find</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + H</td><td style="padding: 8px; border: 1px solid var(--border);">Find and Replace</td></tr>
                                    </table>
                                </div>
                            </div>

                            <!-- 4. SELECTION -->
                            <div class="function-card" style="margin-bottom: 30px;">
                                <div class="function-name" style="font-size: 18px; color: var(--accent-cyan);">4️⃣ SELECTION</div>
                                <div style="overflow-x: auto; margin-top: 15px;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr style="background: var(--bg-accent);"><th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Shortcut</th><th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Action</th></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Shift + ↑/↓/←/→</td><td style="padding: 8px; border: 1px solid var(--border);">Extend selection by one cell</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + Shift + ↑/↓/←/→</td><td style="padding: 8px; border: 1px solid var(--border);">Extend selection to edge of data</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + A</td><td style="padding: 8px; border: 1px solid var(--border);">Select all / current region</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + Space</td><td style="padding: 8px; border: 1px solid var(--border);">Select entire column</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Shift + Space</td><td style="padding: 8px; border: 1px solid var(--border);">Select entire row</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + Shift + End</td><td style="padding: 8px; border: 1px solid var(--border);">Extend selection to last used cell</td></tr>
                                    </table>
                                </div>
                            </div>

                            <!-- 5. FORMATTING -->
                            <div class="function-card" style="margin-bottom: 30px;">
                                <div class="function-name" style="font-size: 18px; color: var(--accent-cyan);">5️⃣ FORMATTING</div>
                                <div style="overflow-x: auto; margin-top: 15px;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr style="background: var(--bg-accent);"><th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Shortcut</th><th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Action</th></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + 1</td><td style="padding: 8px; border: 1px solid var(--border);">Format Cells dialog</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + B</td><td style="padding: 8px; border: 1px solid var(--border);">Bold</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + I</td><td style="padding: 8px; border: 1px solid var(--border);">Italic</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + U</td><td style="padding: 8px; border: 1px solid var(--border);">Underline</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + 5</td><td style="padding: 8px; border: 1px solid var(--border);">Strikethrough</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Alt + H, O, I</td><td style="padding: 8px; border: 1px solid var(--border);">AutoFit column width</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + Shift + $</td><td style="padding: 8px; border: 1px solid var(--border);">Apply currency format</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + Shift + %</td><td style="padding: 8px; border: 1px solid var(--border);">Apply percentage format</td></tr>
                                    </table>
                                </div>
                            </div>

                            <!-- 6. ROWS / COLUMNS -->
                            <div class="function-card" style="margin-bottom: 30px;">
                                <div class="function-name" style="font-size: 18px; color: var(--accent-cyan);">6️⃣ ROWS / COLUMNS</div>
                                <div style="overflow-x: auto; margin-top: 15px;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr style="background: var(--bg-accent);"><th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Shortcut</th><th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Action</th></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + +</td><td style="padding: 8px; border: 1px solid var(--border);">Insert cells/rows/columns</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + -</td><td style="padding: 8px; border: 1px solid var(--border);">Delete cells/rows/columns</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + Shift + +</td><td style="padding: 8px; border: 1px solid var(--border);">Insert cells dialog</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Alt + H, D, R</td><td style="padding: 8px; border: 1px solid var(--border);">Delete row</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Alt + H, D, C</td><td style="padding: 8px; border: 1px solid var(--border);">Delete column</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + 9</td><td style="padding: 8px; border: 1px solid var(--border);">Hide selected rows</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + 0</td><td style="padding: 8px; border: 1px solid var(--border);">Hide selected columns</td></tr>
                                    </table>
                                </div>
                            </div>

                            <!-- 7. DATA & TABLES -->
                            <div class="function-card" style="margin-bottom: 30px;">
                                <div class="function-name" style="font-size: 18px; color: var(--accent-cyan);">7️⃣ DATA & TABLES</div>
                                <div style="overflow-x: auto; margin-top: 15px;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr style="background: var(--bg-accent);"><th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Shortcut</th><th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Action</th></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + T</td><td style="padding: 8px; border: 1px solid var(--border);">Create Table</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + Shift + L</td><td style="padding: 8px; border: 1px solid var(--border);">Toggle AutoFilter</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Alt + ↓</td><td style="padding: 8px; border: 1px solid var(--border);">Open filter dropdown (in header)</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Alt + A, M, M</td><td style="padding: 8px; border: 1px solid var(--border);">Remove duplicates</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Alt + A, S, S</td><td style="padding: 8px; border: 1px solid var(--border);">Sort dialog</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Alt + D, P</td><td style="padding: 8px; border: 1px solid var(--border);">PivotTable (legacy)</td></tr>
                                    </table>
                                </div>
                            </div>

                            <!-- 8. FORMULAS & FUNCTIONS -->
                            <div class="function-card" style="margin-bottom: 30px;">
                                <div class="function-name" style="font-size: 18px; color: var(--accent-cyan);">8️⃣ FORMULAS & FUNCTIONS</div>
                                <div style="overflow-x: auto; margin-top: 15px;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr style="background: var(--bg-accent);"><th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Shortcut</th><th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Action</th></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">= then Tab</td><td style="padding: 8px; border: 1px solid var(--border);">Auto-complete function name</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Shift + F3</td><td style="padding: 8px; border: 1px solid var(--border);">Insert Function dialog</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + Shift + Enter</td><td style="padding: 8px; border: 1px solid var(--border);">Array formula (legacy)</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">F4</td><td style="padding: 8px; border: 1px solid var(--border);">Toggle absolute/relative references ($A$1, A$1, $A1, A1)</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">F9</td><td style="padding: 8px; border: 1px solid var(--border);">Calculate all sheets in all workbooks</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Shift + F9</td><td style="padding: 8px; border: 1px solid var(--border);">Calculate active sheet</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + Alt + F9</td><td style="padding: 8px; border: 1px solid var(--border);">Force calculate all (even unchanged)</td></tr>
                                    </table>
                                </div>
                            </div>

                            <!-- 9. VBA / DEVELOPER -->
                            <div class="function-card" style="margin-bottom: 30px;">
                                <div class="function-name" style="font-size: 18px; color: var(--accent-cyan);">9️⃣ VBA / DEVELOPER</div>
                                <div style="overflow-x: auto; margin-top: 15px;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr style="background: var(--bg-accent);"><th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Shortcut</th><th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Action</th></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Alt + F11</td><td style="padding: 8px; border: 1px solid var(--border);">Open VBA Editor (VBE)</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">F5</td><td style="padding: 8px; border: 1px solid var(--border);">Run macro / Continue execution</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">F8</td><td style="padding: 8px; border: 1px solid var(--border);">Step Into (debug line by line)</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Shift + F8</td><td style="padding: 8px; border: 1px solid var(--border);">Step Over (skip function)</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + Shift + F8</td><td style="padding: 8px; border: 1px solid var(--border);">Step Out (exit function)</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + Break</td><td style="padding: 8px; border: 1px solid var(--border);">Stop macro execution</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">F9</td><td style="padding: 8px; border: 1px solid var(--border);">Toggle breakpoint (in VBE)</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid var(--border); font-family: 'Fira Code', monospace; color: var(--accent-purple);">Ctrl + G</td><td style="padding: 8px; border: 1px solid var(--border);">Show Immediate Window (in VBE)</td></tr>
                                    </table>
                                </div>
                            </div>

                            <!-- 10. VERSION NOTES -->
                            <div class="function-card">
                                <div class="function-name" style="font-size: 18px; color: var(--accent-cyan);">🔟 EXCEL VERSION COMPATIBILITY</div>
                                <div style="margin-top: 15px; line-height: 1.8;">
                                    <p><strong>✅ All shortcuts above work in:</strong></p>
                                    <ul style="margin-left: 20px; margin-top: 10px;">
                                        <li>Excel 2010</li>
                                        <li>Excel 2013</li>
                                        <li>Excel 2016</li>
                                        <li>Excel 2019</li>
                                        <li>Excel 365 (Microsoft 365)</li>
                                    </ul>
                                    <p style="margin-top: 15px;"><strong>📝 Notes:</strong></p>
                                    <ul style="margin-left: 20px; margin-top: 10px;">
                                        <li><strong>Ctrl + Shift + Enter</strong> for array formulas is legacy - Excel 365 uses dynamic arrays automatically</li>
                                        <li><strong>Ctrl + 0</strong> (hide columns) may be disabled in some Excel 2010 versions</li>
                                        <li>Alt key shortcuts (e.g., Alt + H, O, I) are Ribbon-based and work in Excel 2007+</li>
                                        <li>Mac users: Replace <strong>Ctrl</strong> with <strong>⌘ (Command)</strong> and <strong>Alt</strong> with <strong>⌥ (Option)</strong></li>
                                    </ul>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- License & About View -->
                    <div id="view-license" class="view">
                        <div class="editor-header">
                            <div class="editor-title">📜 License & About</div>
                        </div>
                        <div class="function-scroll-container" style="padding: 20px;">
                            
                            <!-- License Section -->
                            <div class="license-section">
                                <h3>📄 License</h3>
                                <p>
                                    <strong>AIN1 Excel Pro</strong> is licensed under the 
                                    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" rel="noopener noreferrer">
                                        Creative Commons Attribution–NonCommercial–NoDerivatives 4.0 International License (CC BY-NC-ND 4.0)
                                    </a>.
                                </p>
                                <p>
                                    <strong>What this means:</strong>
                                </p>
                                <ul style="margin-left: 20px; line-height: 1.8;">
                                    <li>✅ <strong>You MAY:</strong> Use this tool for free for personal, educational, or non-commercial purposes</li>
                                    <li>✅ <strong>You MAY:</strong> Share the link to this tool with others</li>
                                    <li>❌ <strong>You MAY NOT:</strong> Modify, adapt, or create derivative works</li>
                                    <li>❌ <strong>You MAY NOT:</strong> Resell, redistribute, or use commercially without permission</li>
                                    <li>❌ <strong>You MAY NOT:</strong> Remove attribution or claim as your own work</li>
                                </ul>
                            </div>

                            <!-- About Section -->
                            <div class="license-section" style="margin-top: 30px;">
                                <h3>👨‍💻 About the Author</h3>
                                <p>
                                    <strong>Created by: Matthew Naliponguit Sugang</strong>
                                </p>
                                <p>
                                    AIN1 Excel Pro (formerly VBA Code Editor Ultimate Pro) is a comprehensive tool for VBA development, 
                                    Excel formula analysis, and code execution testing. It features advanced syntax highlighting, 
                                    live error detection, intelligent autocomplete, and comprehensive Excel resources.
                                </p>
                            </div>

                            <!-- Version Section -->
                            <div class="license-section" style="margin-top: 30px;">
                                <h3>🔖 Version Information</h3>
                                <p>
                                    <strong>Version:</strong> 4.05<br>
                                    <strong>Released:</strong> 2026<br>
                                    <strong>Copyright:</strong> © 2026 Matthew Naliponguit Sugang
                                </p>
                            </div>

                            <!-- Contact Section -->
                            <div class="license-section" style="margin-top: 30px;">
                                <h3>📧 Contact & Permissions</h3>
                                <p>
                                    For commercial licensing, custom modifications, or other permissions, 
                                    please contact the author.
                                </p>
                                <p>
                                    <strong>Important:</strong> Unauthorized modification, resale, or redistribution is prohibited 
                                    and may result in legal action.
                                </p>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Code Editor Notification Sidebar -->
                <div class="notification-sidebar closed" id="codeNotifSidebar">
                    <div class="notif-header">
                        <div class="notif-title">
                            <span>📊 Code Analysis</span>
                            <span class="notif-count" id="codeNotifCount">0</span>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="close-notif" onclick="clearCodeNotifications()" title="Clear all notifications">🗑️</button>
                            <button class="close-notif" onclick="toggleCodeNotifications()">✕</button>
                        </div>
                    </div>
                    <div class="notif-content" id="codeNotifContent">
                        <div class="notif-item notif-success">
                            <span class="notif-number">#1</span>
                            ✓ System initialized and ready for code analysis
                        </div>
                    </div>
                </div>

                <!-- Formula Checker Notification Sidebar -->
                <div class="notification-sidebar closed" id="formulaNotifSidebar">
                    <div class="notif-header">
                        <div class="notif-title">
                            <span>🔬 Formula Analysis</span>
                            <span class="notif-count" id="formulaNotifCount">0</span>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="close-notif" onclick="clearFormulaNotifications()" title="Clear all notifications">🗑️</button>
                            <button class="close-notif" onclick="toggleFormulaNotifications()">✕</button>
                        </div>
                    </div>
                    <div class="notif-content" id="formulaNotifContent">
                        <div class="notif-item notif-success">
                            <span class="notif-number">#1</span>
                            ✓ Formula checker ready - type = to start
                        </div>
                    </div>
                </div>

                <!-- Execution Tool Notification Sidebar -->
                <div class="notification-sidebar closed" id="execNotifSidebar">
                    <div class="notif-header">
                        <div class="notif-title">
                            <span>⚡ Execution Analysis</span>
                            <span class="notif-count" id="execNotifCount">0</span>
                        </div>
                        <button class="close-notif" onclick="toggleExecNotifications()">✕</button>
                    </div>
                    <div class="notif-content" id="execNotifContent">
                        <div class="notif-item notif-success">
                            <span class="notif-number">#1</span>
                            ✓ Execution Tool ready - paste code to analyze
                        </div>
                    </div>
                </div>

                <!-- Toggle Buttons -->
                <button class="notif-toggle" id="codeNotifToggle" onclick="toggleCodeNotifications()">
                    CODE ANALYSIS
                </button>
                <button class="notif-toggle hidden" id="formulaNotifToggle" onclick="toggleFormulaNotifications()" style="top: 240px;" disabled tabindex="-1">
                    FORMULA ANALYSIS
                </button>
                <button class="notif-toggle hidden" id="execNotifToggle" onclick="toggleExecNotifications()" style="top: 360px;" disabled tabindex="-1">
                    EXECUTION LOGS
                </button>
            </div>
        </div>
    </div>

    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    <!-- TEST RESULTS POPUP PANEL -->
    <!-- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ -->
    
    <!-- Overlay (dimmed background) -->
    <div class="test-results-overlay" id="testResultsOverlay" onclick="window.TestResultsPanel.close()"></div>
    
    <!-- Floating button to open results -->
    <button class="view-results-btn" id="viewResultsBtn" onclick="window.TestResultsPanel.open()">
        📊 View Test Results
    </button>
    
    <!-- Slide-in panel (contains moved execOutput) -->
    <div class="test-results-panel" id="testResultsPanel">
        <div class="test-results-header">
            <div class="test-results-title">
                <span>📊</span>
                <span>Test Results & Analysis Report</span>
            </div>
            <button class="test-results-close" onclick="window.TestResultsPanel.close()" title="Close panel">
                ✕
            </button>
        </div>
        <div class="test-results-content" id="testResultsContent">
            <!-- execOutput will be MOVED here (not copied) -->
        </div>
    </div>

    <!-- Template Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Template Preview</div>
                <button class="btn" onclick="closeModal()" style="padding: 8px 16px;">✕ Close</button>
            </div>
            <div class="modal-body">
                <pre class="code-preview" id="modalCode"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="loadSelectedTemplate()">
                    <span>✓ Load to Editor</span>
                </button>
                <button class="btn" onclick="closeModal()">
                    <span>Cancel</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // VBA CODE EDITOR - VERSION 2.0.1 - CACHE BUSTER: 2025-02-08-FIXED
        // If you're seeing errors, press Ctrl+F5 (or Cmd+Shift+R on Mac) to force refresh
        
        // ========================================
        // EMERGENCY ERROR HANDLER (Ensures buttons work even if errors occur)
        // ========================================
        window.addEventListener('error', function(e) {
            console.error('⚠️ Error caught:', e.message, 'at', e.filename, 'line', e.lineno);
            return true; // Prevent error from breaking execution
        });
        
        console.log('%c🚀 VBA Code Editor v2.0.1 Loading...', 'color: #00d4ff; font-size: 16px; font-weight: bold;');
        
        // Global state
        let currentView = 'code-editor';
        let currentTemplate = null;
        let codeNotifOpen = false;
        let formulaNotifOpen = false;
        let selectedSuggestionIndex = -1;
        let codeNotifCounter = 1;
        let formulaNotifCounter = 1;
        let execNotifCounter = 1;
        let execNotifOpen = false;

        // Execution Tool Namespace (prevent global pollution)
        window.ExecTool = {
            currentAnalysis: null,
            isRunning: false
        };

        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        // EXECUTION TOOL UI NAMESPACE (Professional Panel Management)
        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        window.ExecUI = {
            autoScroll: true,
            logCounter: 0,
            
            // Show professional panel layout
            showPanels() {
                try {
                    const panelContainer = document.getElementById('execPanelContainer');
                    const oldOutput = document.getElementById('execOutput');
                    
                    if (panelContainer) {
                        panelContainer.style.display = 'flex';
                    }
                    
                    // Keep old output hidden for backward compatibility
                    if (oldOutput) {
                        oldOutput.style.display = 'none';
                    }
                } catch (e) {
                    console.error('ExecUI.showPanels error:', e);
                }
            },
            
            // Hide panels
            hidePanels() {
                try {
                    const panelContainer = document.getElementById('execPanelContainer');
                    if (panelContainer) {
                        panelContainer.style.display = 'none';
                    }
                } catch (e) {
                    console.error('ExecUI.hidePanels error:', e);
                }
            },
            
            // Update code view panel (left side)
            updateCodeView(code) {
                try {
                    const codeView = document.getElementById('execCodeView');
                    if (!codeView) return;
                    
                    if (code && code.trim()) {
                        codeView.classList.remove('empty');
                        codeView.textContent = code;
                    } else {
                        codeView.classList.add('empty');
                        codeView.textContent = 'No code loaded yet. Click "Execute Analysis" to begin.';
                    }
                } catch (e) {
                    console.error('ExecUI.updateCodeView error:', e);
                }
            },
            
            // Append log to immediate window
            appendLog(message, type = 'info') {
                try {
                    const content = document.getElementById('execImmediateContent');
                    if (!content) return;
                    
                    // Remove empty state
                    const emptyState = content.querySelector('.exec-immediate-empty');
                    if (emptyState) {
                        content.innerHTML = '';
                    }
                    
                    // Create log entry
                    const logEntry = document.createElement('div');
                    logEntry.className = `exec-log-entry exec-log-${type}`;
                    
                    const timestamp = new Date().toLocaleTimeString('en-US', { 
                        hour12: false, 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        second: '2-digit' 
                    });
                    
                    logEntry.innerHTML = `
                        <span class="exec-log-timestamp">[${timestamp}]</span>
                        <span class="exec-log-type">${type}</span>
                        <span class="exec-log-message">${this.escapeHtml(message)}</span>
                    `;
                    
                    content.appendChild(logEntry);
                    this.logCounter++;
                    
                    // Auto-scroll if enabled and user is at bottom
                    if (this.autoScroll) {
                        this.scrollToBottom();
                    }
                } catch (e) {
                    console.error('ExecUI.appendLog error:', e);
                }
            },
            
            // Escape HTML to prevent injection
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            // Clear immediate window
            clearImmediateWindow() {
                try {
                    const content = document.getElementById('execImmediateContent');
                    if (!content) return;
                    
                    content.innerHTML = '<div class="exec-immediate-empty">Logs cleared. Ready for new execution.</div>';
                    this.logCounter = 0;
                    addExecNotification('info', 'Immediate window cleared');
                } catch (e) {
                    console.error('ExecUI.clearImmediateWindow error:', e);
                }
            },
            
            // Copy immediate window logs
            copyImmediateLogs() {
                try {
                    const content = document.getElementById('execImmediateContent');
                    if (!content) return;
                    
                    const logs = Array.from(content.querySelectorAll('.exec-log-entry'))
                        .map(entry => {
                            const timestamp = entry.querySelector('.exec-log-timestamp')?.textContent || '';
                            const type = entry.querySelector('.exec-log-type')?.textContent || '';
                            const message = entry.querySelector('.exec-log-message')?.textContent || '';
                            return `${timestamp} ${type}: ${message}`;
                        })
                        .join('\n');
                    
                    if (logs) {
                        navigator.clipboard.writeText(logs).then(() => {
                            addExecNotification('success', 'Logs copied to clipboard');
                        });
                    } else {
                        addExecNotification('info', 'No logs to copy');
                    }
                } catch (e) {
                    console.error('ExecUI.copyImmediateLogs error:', e);
                    addExecNotification('error', 'Failed to copy logs');
                }
            },
            
            // Copy code view
            copyCodeView() {
                try {
                    const codeView = document.getElementById('execCodeView');
                    if (!codeView || codeView.classList.contains('empty')) {
                        addExecNotification('info', 'No code to copy');
                        return;
                    }
                    
                    const code = codeView.textContent;
                    navigator.clipboard.writeText(code).then(() => {
                        addExecNotification('success', 'Code copied to clipboard');
                    });
                } catch (e) {
                    console.error('ExecUI.copyCodeView error:', e);
                    addExecNotification('error', 'Failed to copy code');
                }
            },
            
            // Scroll to bottom of immediate window
            scrollToBottom() {
                try {
                    const content = document.getElementById('execImmediateContent');
                    if (content) {
                        content.scrollTop = content.scrollHeight;
                    }
                } catch (e) {
                    console.error('ExecUI.scrollToBottom error:', e);
                }
            },
            
            // Update progress bar with phase
            updateProgress(percent, phase = '') {
                try {
                    const container = document.getElementById('execProgressContainer');
                    const fill = document.getElementById('execProgressFill');
                    const percentEl = document.getElementById('execProgressPercent');
                    const label = document.getElementById('execProgressLabel');
                    const progressBar = document.getElementById('execProgressBar');
                    
                    if (container && percent >= 0) {
                        container.style.display = 'block';
                        
                        if (fill) {
                            fill.style.width = Math.min(100, Math.max(0, percent)) + '%';
                        }
                        
                        if (percentEl) {
                            percentEl.textContent = Math.round(percent) + '%';
                        }
                        
                        if (label && phase) {
                            label.textContent = phase;
                        }
                        
                        if (progressBar) {
                            progressBar.setAttribute('aria-valuenow', Math.round(percent));
                        }
                        
                        // Log phase change to immediate window
                        if (phase) {
                            this.appendLog(phase, 'phase');
                        }
                    }
                } catch (e) {
                    console.error('ExecUI.updateProgress error:', e);
                }
            },
            
            // Hide progress bar
            hideProgress() {
                try {
                    const container = document.getElementById('execProgressContainer');
                    if (container) {
                        container.style.display = 'none';
                    }
                } catch (e) {
                    console.error('ExecUI.hideProgress error:', e);
                }
            },
            
            // Reset UI for new execution
            resetForExecution() {
                try {
                    this.showPanels();
                    this.clearImmediateWindow();
                    this.logCounter = 0;
                    this.autoScroll = true;
                } catch (e) {
                    console.error('ExecUI.resetForExecution error:', e);
                }
            }
        };

        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        // TEST RESULTS PANEL MANAGER (Toggleable Popup for Test Results)
        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        window.TestResultsPanel = {
            isOpen: false,
            execOutputMoved: false,
            
            // Move execOutput into panel (MOVE not copy - single instance)
            moveResultsToPanel() {
                try {
                    // Only move once - don't duplicate!
                    if (this.execOutputMoved) {
                        return;
                    }
                    
                    const execOutput = document.getElementById('execOutput');
                    const panelContent = document.getElementById('testResultsContent');
                    
                    if (!execOutput || !panelContent) {
                        console.warn('TestResultsPanel: Elements not found');
                        return;
                    }
                    
                    // CRITICAL: MOVE the element (appendChild automatically moves it)
                    // This is NOT a copy - the element is relocated
                    panelContent.appendChild(execOutput);
                    this.execOutputMoved = true;
                    
                    console.log('✅ Test results moved to popup panel (not copied)');
                } catch (e) {
                    console.error('TestResultsPanel.moveResultsToPanel error:', e);
                    // FAIL-SAFE: If move fails, results stay in original location
                }
            },
            
            // Show the "View Results" button
            showButton() {
                try {
                    const btn = document.getElementById('viewResultsBtn');
                    if (btn) {
                        btn.classList.add('visible');
                    }
                } catch (e) {
                    console.error('TestResultsPanel.showButton error:', e);
                }
            },
            
            // Hide the "View Results" button
            hideButton() {
                try {
                    const btn = document.getElementById('viewResultsBtn');
                    if (btn) {
                        btn.classList.remove('visible');
                    }
                } catch (e) {
                    console.error('TestResultsPanel.hideButton error:', e);
                }
            },
            
            // Open the panel
            open() {
                try {
                    const panel = document.getElementById('testResultsPanel');
                    const overlay = document.getElementById('testResultsOverlay');
                    
                    if (panel) {
                        panel.classList.add('open');
                        this.isOpen = true;
                    }
                    
                    if (overlay) {
                        overlay.classList.add('visible');
                    }
                    
                    // Hide the button when panel is open
                    this.hideButton();
                } catch (e) {
                    console.error('TestResultsPanel.open error:', e);
                }
            },
            
            // Close the panel
            close() {
                try {
                    const panel = document.getElementById('testResultsPanel');
                    const overlay = document.getElementById('testResultsOverlay');
                    
                    if (panel) {
                        panel.classList.remove('open');
                        this.isOpen = false;
                    }
                    
                    if (overlay) {
                        overlay.classList.remove('visible');
                    }
                    
                    // Show the button when panel is closed
                    this.showButton();
                } catch (e) {
                    console.error('TestResultsPanel.close error:', e);
                }
            },
            
            // Handle analysis completion
            onAnalysisComplete() {
                try {
                    // Move results to panel if not already moved
                    this.moveResultsToPanel();
                    
                    // Show the "View Results" button
                    this.showButton();
                    
                    // Optionally auto-open the panel
                    // Uncomment next line if you want panel to open automatically
                    // this.open();
                } catch (e) {
                    console.error('TestResultsPanel.onAnalysisComplete error:', e);
                }
            },
            
            // Reset for new execution
            reset() {
                try {
                    this.close();
                    this.hideButton();
                    // Note: We don't reset execOutputMoved because the element
                    // stays in the panel - it's just reused for new results
                } catch (e) {
                    console.error('TestResultsPanel.reset error:', e);
                }
            }
        };

        // VBA Keywords (extended)
        // VBA Keywords - Categorized for different colors
        const vbaDeclarations = ['Dim', 'As', 'Set', 'Let', 'Const', 'ReDim', 'Preserve', 'Erase'];
        const vbaSubFunction = ['Sub', 'Function', 'Property', 'Get'];
        const vbaControlFlow = ['End', 'Then', 'Next', 'Loop', 'Wend'];
        const vbaConditions = ['If', 'Else', 'ElseIf', 'Select', 'Case'];
        const vbaLoops = ['For', 'To', 'Each', 'In', 'Do', 'While', 'Until', 'Step'];
        const vbaModifiers = ['Private', 'Public', 'Static', 'Option', 'Explicit', 'Base', 'Compare', 'ByVal', 'ByRef', 'Optional', 'ParamArray'];
        const vbaOperators = ['And', 'Or', 'Not', 'Xor', 'Mod', 'Is', 'Like'];
        const vbaOther = ['Exit', 'With', 'On', 'Error', 'Resume', 'GoTo', 'Call', 'Type', 'Enum', 'Class', 'New', 'Implements', 'Event', 'RaiseEvent', 'WithEvents', 'Declare', 'Lib', 'Alias'];
        
        // Combine for backwards compatibility
        const vbaKeywords = [...vbaDeclarations, ...vbaSubFunction, ...vbaControlFlow, ...vbaConditions, ...vbaLoops, ...vbaModifiers, ...vbaOperators, ...vbaOther];

        // VBA Constants (for syntax highlighting)
        const vbaConstantsList = [
            'vbCrLf', 'vbCr', 'vbLf', 'vbTab', 'vbNullString', 'vbNullChar',
            'vbOKOnly', 'vbOKCancel', 'vbYesNo', 'vbYesNoCancel', 'vbRetryCancel',
            'vbCritical', 'vbQuestion', 'vbExclamation', 'vbInformation',
            'vbDefaultButton1', 'vbDefaultButton2', 'vbApplicationModal',
            'vbOK', 'vbCancel', 'vbYes', 'vbNo', 'vbAbort', 'vbRetry', 'vbIgnore',
            'xlUp', 'xlDown', 'xlToRight', 'xlToLeft', 'xlDiagonalDown', 'xlDiagonalUp',
            'xlEdgeLeft', 'xlEdgeTop', 'xlEdgeBottom', 'xlEdgeRight',
            'xlCalculationManual', 'xlCalculationAutomatic', 'xlCalculationSemiautomatic',
            'xlPasteValues', 'xlPasteFormats', 'xlPasteFormulas', 'xlPasteAll',
            'xlContinuous', 'xlDash', 'xlDashDot', 'xlDashDotDot', 'xlDot',
            'xlThick', 'xlThin', 'xlMedium', 'xlDouble', 'xlHairline'
        ];

        // VBA Objects
        const vbaObjects = [
            'Worksheet', 'Workbook', 'Range', 'Cells', 'Rows', 'Columns', 'Application',
            'ThisWorkbook', 'ActiveWorkbook', 'ActiveSheet', 'Selection', 'Sheets',
            'Worksheets', 'Chart', 'ChartObject', 'PivotTable', 'Comment', 'Shape',
            'CommandButton', 'TextBox', 'ListBox', 'ComboBox', 'CheckBox', 'OptionButton',
            'Label', 'Frame', 'ScrollBar', 'SpinButton', 'Image', 'UserForm'
        ];

        // VBA Functions
        const vbaFunctions = [
            'MsgBox', 'InputBox', 'IsNumeric', 'IsEmpty', 'IsNull', 'IsDate', 'IsError',
            'IsArray', 'IsObject', 'IsMissing', 'UBound', 'LBound', 'Len', 'Left', 'Right',
            'Mid', 'Trim', 'LTrim', 'RTrim', 'Replace', 'Split', 'Join', 'InStr', 'InStrRev',
            'StrComp', 'StrConv', 'UCase', 'LCase', 'Format', 'FormatNumber', 'FormatPercent',
            'CDate', 'CInt', 'CLng', 'CDbl', 'CSng', 'CStr', 'CBool', 'CByte', 'CCur',
            'Year', 'Month', 'Day', 'Hour', 'Minute', 'Second', 'Weekday', 'DateAdd',
            'DateDiff', 'DatePart', 'DateSerial', 'DateValue', 'TimeSerial', 'TimeValue',
            'Now', 'Date', 'Time', 'Timer', 'Val', 'Str', 'Abs', 'Round', 'Int', 'Fix',
            'Sqr', 'Exp', 'Log', 'Sin', 'Cos', 'Tan', 'Atn', 'Rnd', 'Randomize',
            'RGB', 'QBColor', 'CreateObject', 'GetObject', 'Array', 'Filter', 'TypeName',
            'VarType', 'Choose', 'Switch', 'IIf', 'Partition', 'CallByName'
        ];

        // VBA Types
        const vbaTypes = [
            'String', 'Integer', 'Long', 'Single', 'Double', 'Currency', 'Date',
            'Boolean', 'Byte', 'Variant', 'Object', 'Collection', 'Dictionary'
        ];

        // VBA Booleans
        const vbaBooleans = ['True', 'False', 'Nothing', 'Empty', 'Null'];

        // VBA Built-in properties/methods
        const vbaBuiltins = [
            'Value', 'Text', 'Name', 'Count', 'Item', 'Add', 'Remove', 'Clear',
            'Delete', 'Copy', 'Paste', 'Cut', 'Select', 'Activate', 'Open', 'Close',
            'Save', 'SaveAs', 'Print', 'PrintPreview', 'Find', 'FindNext', 'Replace',
            'Sort', 'AutoFilter', 'Calculate', 'Refresh', 'Update', 'Show', 'Hide'
        ];

        // Comprehensive Excel Functions (100+)
        const excelFunctions = [
            // Math & Trig
            { name: 'SUM', syntax: 'SUM(number1, [number2], ...)', desc: 'Adds all numbers in a range', category: 'Math' },
            { name: 'SUMIF', syntax: 'SUMIF(range, criteria, [sum_range])', desc: 'Sums cells that meet criteria', category: 'Math' },
            { name: 'SUMIFS', syntax: 'SUMIFS(sum_range, criteria_range1, criteria1, ...)', desc: 'Sums cells that meet multiple criteria', category: 'Math' },
            { name: 'SUMPRODUCT', syntax: 'SUMPRODUCT(array1, [array2], ...)', desc: 'Multiplies corresponding arrays and returns sum', category: 'Math' },
            { name: 'AVERAGE', syntax: 'AVERAGE(number1, [number2], ...)', desc: 'Returns the average of arguments', category: 'Math' },
            { name: 'AVERAGEIF', syntax: 'AVERAGEIF(range, criteria, [average_range])', desc: 'Averages cells that meet criteria', category: 'Math' },
            { name: 'AVERAGEIFS', syntax: 'AVERAGEIFS(average_range, criteria_range1, criteria1, ...)', desc: 'Averages cells meeting multiple criteria', category: 'Math' },
            { name: 'COUNT', syntax: 'COUNT(value1, [value2], ...)', desc: 'Counts numbers in a range', category: 'Math' },
            { name: 'COUNTA', syntax: 'COUNTA(value1, [value2], ...)', desc: 'Counts non-empty cells', category: 'Math' },
            { name: 'COUNTIF', syntax: 'COUNTIF(range, criteria)', desc: 'Counts cells that meet criteria', category: 'Math' },
            { name: 'COUNTIFS', syntax: 'COUNTIFS(criteria_range1, criteria1, ...)', desc: 'Counts cells meeting multiple criteria', category: 'Math' },
            { name: 'COUNTBLANK', syntax: 'COUNTBLANK(range)', desc: 'Counts blank cells', category: 'Math' },
            { name: 'MAX', syntax: 'MAX(number1, [number2], ...)', desc: 'Returns the largest value', category: 'Math' },
            { name: 'MIN', syntax: 'MIN(number1, [number2], ...)', desc: 'Returns the smallest value', category: 'Math' },
            { name: 'MAXIFS', syntax: 'MAXIFS(max_range, criteria_range1, criteria1, ...)', desc: 'Returns max value meeting criteria', category: 'Math' },
            { name: 'MINIFS', syntax: 'MINIFS(min_range, criteria_range1, criteria1, ...)', desc: 'Returns min value meeting criteria', category: 'Math' },
            { name: 'ROUND', syntax: 'ROUND(number, num_digits)', desc: 'Rounds number to specified digits', category: 'Math' },
            { name: 'ROUNDUP', syntax: 'ROUNDUP(number, num_digits)', desc: 'Rounds number up', category: 'Math' },
            { name: 'ROUNDDOWN', syntax: 'ROUNDDOWN(number, num_digits)', desc: 'Rounds number down', category: 'Math' },
            { name: 'INT', syntax: 'INT(number)', desc: 'Rounds number down to integer', category: 'Math' },
            { name: 'TRUNC', syntax: 'TRUNC(number, [num_digits])', desc: 'Truncates number to integer', category: 'Math' },
            { name: 'ABS', syntax: 'ABS(number)', desc: 'Returns absolute value', category: 'Math' },
            { name: 'POWER', syntax: 'POWER(number, power)', desc: 'Returns number raised to power', category: 'Math' },
            { name: 'SQRT', syntax: 'SQRT(number)', desc: 'Returns square root', category: 'Math' },
            { name: 'MOD', syntax: 'MOD(number, divisor)', desc: 'Returns remainder after division', category: 'Math' },
            { name: 'PRODUCT', syntax: 'PRODUCT(number1, [number2], ...)', desc: 'Multiplies numbers', category: 'Math' },
            { name: 'QUOTIENT', syntax: 'QUOTIENT(numerator, denominator)', desc: 'Returns integer portion of division', category: 'Math' },
            { name: 'RAND', syntax: 'RAND()', desc: 'Returns random number between 0 and 1', category: 'Math' },
            { name: 'RANDBETWEEN', syntax: 'RANDBETWEEN(bottom, top)', desc: 'Returns random integer between numbers', category: 'Math' },
            
            // Lookup & Reference
            { name: 'VLOOKUP', syntax: 'VLOOKUP(lookup_value, table_array, col_index_num, [range_lookup])', desc: 'Looks up value vertically in first column', category: 'Lookup' },
            { name: 'HLOOKUP', syntax: 'HLOOKUP(lookup_value, table_array, row_index_num, [range_lookup])', desc: 'Looks up value horizontally in first row', category: 'Lookup' },
            { name: 'XLOOKUP', syntax: 'XLOOKUP(lookup_value, lookup_array, return_array, [if_not_found])', desc: 'Modern lookup function (Excel 365)', category: 'Lookup' },
            { name: 'INDEX', syntax: 'INDEX(array, row_num, [column_num])', desc: 'Returns value from specific position', category: 'Lookup' },
            { name: 'MATCH', syntax: 'MATCH(lookup_value, lookup_array, [match_type])', desc: 'Returns position of value in range', category: 'Lookup' },
            { name: 'CHOOSE', syntax: 'CHOOSE(index_num, value1, [value2], ...)', desc: 'Returns value from list based on index', category: 'Lookup' },
            { name: 'INDIRECT', syntax: 'INDIRECT(ref_text, [a1])', desc: 'Returns reference specified by text', category: 'Lookup' },
            { name: 'OFFSET', syntax: 'OFFSET(reference, rows, cols, [height], [width])', desc: 'Returns reference offset from starting point', category: 'Lookup' },
            { name: 'COLUMN', syntax: 'COLUMN([reference])', desc: 'Returns column number', category: 'Lookup' },
            { name: 'ROW', syntax: 'ROW([reference])', desc: 'Returns row number', category: 'Lookup' },
            { name: 'COLUMNS', syntax: 'COLUMNS(array)', desc: 'Returns number of columns', category: 'Lookup' },
            { name: 'ROWS', syntax: 'ROWS(array)', desc: 'Returns number of rows', category: 'Lookup' },
            
            // Logical
            { name: 'IF', syntax: 'IF(logical_test, value_if_true, value_if_false)', desc: 'Returns one value if true, another if false', category: 'Logical' },
            { name: 'IFS', syntax: 'IFS(logical_test1, value1, [logical_test2, value2], ...)', desc: 'Tests multiple conditions', category: 'Logical' },
            { name: 'AND', syntax: 'AND(logical1, [logical2], ...)', desc: 'Returns TRUE if all arguments are TRUE', category: 'Logical' },
            { name: 'OR', syntax: 'OR(logical1, [logical2], ...)', desc: 'Returns TRUE if any argument is TRUE', category: 'Logical' },
            { name: 'NOT', syntax: 'NOT(logical)', desc: 'Reverses logic of argument', category: 'Logical' },
            { name: 'XOR', syntax: 'XOR(logical1, [logical2], ...)', desc: 'Returns TRUE if odd number of TRUE values', category: 'Logical' },
            { name: 'IFERROR', syntax: 'IFERROR(value, value_if_error)', desc: 'Returns value if no error, else specified value', category: 'Logical' },
            { name: 'IFNA', syntax: 'IFNA(value, value_if_na)', desc: 'Returns value if not #N/A error', category: 'Logical' },
            { name: 'SWITCH', syntax: 'SWITCH(expression, value1, result1, [value2, result2], ...)', desc: 'Evaluates expression against values', category: 'Logical' },
            
            // Text
            { name: 'CONCATENATE', syntax: 'CONCATENATE(text1, [text2], ...)', desc: 'Joins text strings', category: 'Text' },
            { name: 'CONCAT', syntax: 'CONCAT(text1, [text2], ...)', desc: 'Joins text (modern version)', category: 'Text' },
            { name: 'TEXTJOIN', syntax: 'TEXTJOIN(delimiter, ignore_empty, text1, [text2], ...)', desc: 'Joins text with delimiter', category: 'Text' },
            { name: 'LEFT', syntax: 'LEFT(text, [num_chars])', desc: 'Returns leftmost characters', category: 'Text' },
            { name: 'RIGHT', syntax: 'RIGHT(text, [num_chars])', desc: 'Returns rightmost characters', category: 'Text' },
            { name: 'MID', syntax: 'MID(text, start_num, num_chars)', desc: 'Returns specific characters from text', category: 'Text' },
            { name: 'LEN', syntax: 'LEN(text)', desc: 'Returns length of text', category: 'Text' },
            { name: 'TRIM', syntax: 'TRIM(text)', desc: 'Removes extra spaces', category: 'Text' },
            { name: 'UPPER', syntax: 'UPPER(text)', desc: 'Converts to uppercase', category: 'Text' },
            { name: 'LOWER', syntax: 'LOWER(text)', desc: 'Converts to lowercase', category: 'Text' },
            { name: 'PROPER', syntax: 'PROPER(text)', desc: 'Capitalizes first letter of each word', category: 'Text' },
            { name: 'SUBSTITUTE', syntax: 'SUBSTITUTE(text, old_text, new_text, [instance_num])', desc: 'Replaces text in string', category: 'Text' },
            { name: 'REPLACE', syntax: 'REPLACE(old_text, start_num, num_chars, new_text)', desc: 'Replaces part of text', category: 'Text' },
            { name: 'FIND', syntax: 'FIND(find_text, within_text, [start_num])', desc: 'Finds text (case-sensitive)', category: 'Text' },
            { name: 'SEARCH', syntax: 'SEARCH(find_text, within_text, [start_num])', desc: 'Finds text (not case-sensitive)', category: 'Text' },
            { name: 'TEXT', syntax: 'TEXT(value, format_text)', desc: 'Formats number as text', category: 'Text' },
            { name: 'VALUE', syntax: 'VALUE(text)', desc: 'Converts text to number', category: 'Text' },
            { name: 'TEXTSPLIT', syntax: 'TEXTSPLIT(text, col_delimiter, [row_delimiter])', desc: 'Splits text into rows/columns (365)', category: 'Text' },
            { name: 'TEXTBEFORE', syntax: 'TEXTBEFORE(text, delimiter, [instance_num])', desc: 'Returns text before delimiter (365)', category: 'Text' },
            { name: 'TEXTAFTER', syntax: 'TEXTAFTER(text, delimiter, [instance_num])', desc: 'Returns text after delimiter (365)', category: 'Text' },
            
            // Date & Time
            { name: 'TODAY', syntax: 'TODAY()', desc: 'Returns current date', category: 'Date' },
            { name: 'NOW', syntax: 'NOW()', desc: 'Returns current date and time', category: 'Date' },
            { name: 'DATE', syntax: 'DATE(year, month, day)', desc: 'Returns date value', category: 'Date' },
            { name: 'TIME', syntax: 'TIME(hour, minute, second)', desc: 'Returns time value', category: 'Date' },
            { name: 'YEAR', syntax: 'YEAR(serial_number)', desc: 'Returns year from date', category: 'Date' },
            { name: 'MONTH', syntax: 'MONTH(serial_number)', desc: 'Returns month from date', category: 'Date' },
            { name: 'DAY', syntax: 'DAY(serial_number)', desc: 'Returns day from date', category: 'Date' },
            { name: 'HOUR', syntax: 'HOUR(serial_number)', desc: 'Returns hour from time', category: 'Date' },
            { name: 'MINUTE', syntax: 'MINUTE(serial_number)', desc: 'Returns minute from time', category: 'Date' },
            { name: 'SECOND', syntax: 'SECOND(serial_number)', desc: 'Returns second from time', category: 'Date' },
            { name: 'WEEKDAY', syntax: 'WEEKDAY(serial_number, [return_type])', desc: 'Returns day of week', category: 'Date' },
            { name: 'EOMONTH', syntax: 'EOMONTH(start_date, months)', desc: 'Returns last day of month', category: 'Date' },
            { name: 'EDATE', syntax: 'EDATE(start_date, months)', desc: 'Returns date months before/after', category: 'Date' },
            { name: 'DATEDIF', syntax: 'DATEDIF(start_date, end_date, unit)', desc: 'Calculates difference between dates', category: 'Date' },
            { name: 'NETWORKDAYS', syntax: 'NETWORKDAYS(start_date, end_date, [holidays])', desc: 'Returns working days between dates', category: 'Date' },
            { name: 'WORKDAY', syntax: 'WORKDAY(start_date, days, [holidays])', desc: 'Returns date before/after working days', category: 'Date' },
            
            // Array (Excel 365)
            { name: 'FILTER', syntax: 'FILTER(array, include, [if_empty])', desc: 'Filters data based on criteria (365)', category: 'Array' },
            { name: 'SORT', syntax: 'SORT(array, [sort_index], [sort_order], [by_col])', desc: 'Sorts data (365)', category: 'Array' },
            { name: 'SORTBY', syntax: 'SORTBY(array, by_array1, [sort_order1], ...)', desc: 'Sorts by another array (365)', category: 'Array' },
            { name: 'UNIQUE', syntax: 'UNIQUE(array, [by_col], [exactly_once])', desc: 'Returns unique values (365)', category: 'Array' },
            { name: 'SEQUENCE', syntax: 'SEQUENCE(rows, [columns], [start], [step])', desc: 'Generates sequence of numbers (365)', category: 'Array' },
            { name: 'RANDARRAY', syntax: 'RANDARRAY([rows], [columns], [min], [max], [integer])', desc: 'Returns array of random numbers (365)', category: 'Array' },
            { name: 'TAKE', syntax: 'TAKE(array, rows, [columns])', desc: 'Returns specified rows/columns (365)', category: 'Array' },
            { name: 'DROP', syntax: 'DROP(array, rows, [columns])', desc: 'Drops specified rows/columns (365)', category: 'Array' },
            { name: 'CHOOSECOLS', syntax: 'CHOOSECOLS(array, col_num1, [col_num2], ...)', desc: 'Returns specified columns (365)', category: 'Array' },
            { name: 'CHOOSEROWS', syntax: 'CHOOSEROWS(array, row_num1, [row_num2], ...)', desc: 'Returns specified rows (365)', category: 'Array' },
            
            // Financial Functions
            { name: 'PMT', syntax: 'PMT(rate, nper, pv, [fv], [type])', desc: 'Calculates loan payment', category: 'Financial' },
            { name: 'PV', syntax: 'PV(rate, nper, pmt, [fv], [type])', desc: 'Calculates present value', category: 'Financial' },
            { name: 'FV', syntax: 'FV(rate, nper, pmt, [pv], [type])', desc: 'Calculates future value', category: 'Financial' },
            { name: 'NPV', syntax: 'NPV(rate, value1, [value2], ...)', desc: 'Calculates net present value', category: 'Financial' },
            { name: 'IRR', syntax: 'IRR(values, [guess])', desc: 'Calculates internal rate of return', category: 'Financial' },
            { name: 'RATE', syntax: 'RATE(nper, pmt, pv, [fv], [type], [guess])', desc: 'Calculates interest rate', category: 'Financial' },
            { name: 'NPER', syntax: 'NPER(rate, pmt, pv, [fv], [type])', desc: 'Calculates number of periods', category: 'Financial' },
            { name: 'IPMT', syntax: 'IPMT(rate, per, nper, pv, [fv], [type])', desc: 'Calculates interest payment', category: 'Financial' },
            { name: 'PPMT', syntax: 'PPMT(rate, per, nper, pv, [fv], [type])', desc: 'Calculates principal payment', category: 'Financial' },
            { name: 'SLN', syntax: 'SLN(cost, salvage, life)', desc: 'Calculates straight-line depreciation', category: 'Financial' },
            { name: 'DB', syntax: 'DB(cost, salvage, life, period, [month])', desc: 'Calculates declining balance depreciation', category: 'Financial' },
            { name: 'DDB', syntax: 'DDB(cost, salvage, life, period, [factor])', desc: 'Calculates double-declining balance', category: 'Financial' },
            
            // Statistical Functions
            { name: 'MEDIAN', syntax: 'MEDIAN(number1, [number2], ...)', desc: 'Returns the median value', category: 'Statistical' },
            { name: 'MODE.SNGL', syntax: 'MODE.SNGL(number1, [number2], ...)', desc: 'Returns most frequently occurring value', category: 'Statistical' },
            { name: 'STDEV.S', syntax: 'STDEV.S(number1, [number2], ...)', desc: 'Calculates standard deviation (sample)', category: 'Statistical' },
            { name: 'STDEV.P', syntax: 'STDEV.P(number1, [number2], ...)', desc: 'Calculates standard deviation (population)', category: 'Statistical' },
            { name: 'VAR.S', syntax: 'VAR.S(number1, [number2], ...)', desc: 'Calculates variance (sample)', category: 'Statistical' },
            { name: 'VAR.P', syntax: 'VAR.P(number1, [number2], ...)', desc: 'Calculates variance (population)', category: 'Statistical' },
            { name: 'QUARTILE.INC', syntax: 'QUARTILE.INC(array, quart)', desc: 'Returns quartile of data set', category: 'Statistical' },
            { name: 'PERCENTILE.INC', syntax: 'PERCENTILE.INC(array, k)', desc: 'Returns kth percentile', category: 'Statistical' },
            { name: 'RANK.EQ', syntax: 'RANK.EQ(number, ref, [order])', desc: 'Returns rank of number in list', category: 'Statistical' },
            { name: 'CORREL', syntax: 'CORREL(array1, array2)', desc: 'Calculates correlation coefficient', category: 'Statistical' },
            { name: 'FORECAST.LINEAR', syntax: 'FORECAST.LINEAR(x, known_ys, known_xs)', desc: 'Predicts future value using linear trend', category: 'Statistical' },
            { name: 'SLOPE', syntax: 'SLOPE(known_ys, known_xs)', desc: 'Returns slope of linear regression line', category: 'Statistical' },
            { name: 'INTERCEPT', syntax: 'INTERCEPT(known_ys, known_xs)', desc: 'Returns intercept of linear regression', category: 'Statistical' },
            
            // Database Functions
            { name: 'DSUM', syntax: 'DSUM(database, field, criteria)', desc: 'Sums database values meeting criteria', category: 'Database' },
            { name: 'DAVERAGE', syntax: 'DAVERAGE(database, field, criteria)', desc: 'Averages database values meeting criteria', category: 'Database' },
            { name: 'DCOUNT', syntax: 'DCOUNT(database, field, criteria)', desc: 'Counts database numbers meeting criteria', category: 'Database' },
            { name: 'DCOUNTA', syntax: 'DCOUNTA(database, field, criteria)', desc: 'Counts database non-empty cells', category: 'Database' },
            { name: 'DMAX', syntax: 'DMAX(database, field, criteria)', desc: 'Returns max from database', category: 'Database' },
            { name: 'DMIN', syntax: 'DMIN(database, field, criteria)', desc: 'Returns min from database', category: 'Database' },
            { name: 'DGET', syntax: 'DGET(database, field, criteria)', desc: 'Extracts single value from database', category: 'Database' },
            
            // Information Functions
            { name: 'ISBLANK', syntax: 'ISBLANK(value)', desc: 'Returns TRUE if value is blank', category: 'Info' },
            { name: 'ISERROR', syntax: 'ISERROR(value)', desc: 'Returns TRUE if value is error', category: 'Info' },
            { name: 'ISNA', syntax: 'ISNA(value)', desc: 'Returns TRUE if value is #N/A', category: 'Info' },
            { name: 'ISNUMBER', syntax: 'ISNUMBER(value)', desc: 'Returns TRUE if value is number', category: 'Info' },
            { name: 'ISTEXT', syntax: 'ISTEXT(value)', desc: 'Returns TRUE if value is text', category: 'Info' },
            { name: 'ISLOGICAL', syntax: 'ISLOGICAL(value)', desc: 'Returns TRUE if value is logical', category: 'Info' },
            { name: 'ISEVEN', syntax: 'ISEVEN(number)', desc: 'Returns TRUE if number is even', category: 'Info' },
            { name: 'ISODD', syntax: 'ISODD(number)', desc: 'Returns TRUE if number is odd', category: 'Info' },
            { name: 'TYPE', syntax: 'TYPE(value)', desc: 'Returns type of value', category: 'Info' },
            { name: 'CELL', syntax: 'CELL(info_type, [reference])', desc: 'Returns information about cell', category: 'Info' },
            { name: 'SHEET', syntax: 'SHEET([value])', desc: 'Returns sheet number', category: 'Info' },
            { name: 'SHEETS', syntax: 'SHEETS([reference])', desc: 'Returns number of sheets', category: 'Info' },
            { name: 'N', syntax: 'N(value)', desc: 'Converts value to number', category: 'Info' },
            { name: 'NA', syntax: 'NA()', desc: 'Returns #N/A error', category: 'Info' },
            
            // Engineering Functions
            { name: 'CONVERT', syntax: 'CONVERT(number, from_unit, to_unit)', desc: 'Converts units of measurement', category: 'Engineering' },
            { name: 'DELTA', syntax: 'DELTA(number1, [number2])', desc: 'Tests if two values are equal', category: 'Engineering' },
            { name: 'BIN2DEC', syntax: 'BIN2DEC(number)', desc: 'Converts binary to decimal', category: 'Engineering' },
            { name: 'BIN2HEX', syntax: 'BIN2HEX(number, [places])', desc: 'Converts binary to hexadecimal', category: 'Engineering' },
            { name: 'DEC2BIN', syntax: 'DEC2BIN(number, [places])', desc: 'Converts decimal to binary', category: 'Engineering' },
            { name: 'DEC2HEX', syntax: 'DEC2HEX(number, [places])', desc: 'Converts decimal to hexadecimal', category: 'Engineering' },
            { name: 'HEX2BIN', syntax: 'HEX2BIN(number, [places])', desc: 'Converts hexadecimal to binary', category: 'Engineering' },
            { name: 'HEX2DEC', syntax: 'HEX2DEC(number)', desc: 'Converts hexadecimal to decimal', category: 'Engineering' }
        ];

        // Arithmetic Operators (Complete List - ALL IN ONE PACKAGE)
        const arithmeticOperators = [
            // ARITHMETIC Operators
            { symbol: '+', name: 'Addition / Concatenation', desc: 'Adds numbers or concatenates text', usage: '=A1+B1 or ="Hello "+"World"', example: '=5+3 returns 8', note: '💡 For text, prefer & operator', category: 'Arithmetic' },
            { symbol: '-', name: 'Subtraction / Negation', desc: 'Subtracts numbers or negates', usage: '=A1-B1 or =-A1', example: '=10-3 returns 7', note: '💡 Also used for negative numbers', category: 'Arithmetic' },
            { symbol: '*', name: 'Multiplication', desc: 'Multiplies numbers', usage: '=A1*B1', example: '=5*3 returns 15', note: '💡 Required - cannot write 5A1', category: 'Arithmetic' },
            { symbol: '/', name: 'Division', desc: 'Divides numbers', usage: '=A1/B1', example: '=10/2 returns 5', note: '💡 Returns #DIV/0! if divisor is zero', category: 'Arithmetic' },
            { symbol: '^', name: 'Exponentiation / Power', desc: 'Raises number to power', usage: '=A1^B1', example: '=2^3 returns 8', note: '💡 Use for squares, cubes, roots', category: 'Arithmetic' },
            { symbol: '%', name: 'Percent', desc: 'Converts to percentage', usage: '=A1% or =50%', example: '=50% returns 0.5', note: '💡 Divides by 100 automatically', category: 'Arithmetic' },
            
            // COMPARISON Operators
            { symbol: '=', name: 'Equal To', desc: 'Tests if values are equal', usage: '=IF(A1=B1, "Same", "Different")', example: '=5=5 returns TRUE', note: '💡 Case-insensitive for text', category: 'Comparison' },
            { symbol: '<>', name: 'Not Equal To', desc: 'Tests if values are different', usage: '=IF(A1<>B1, "Different", "Same")', example: '=5<>3 returns TRUE', note: '💡 Opposite of =', category: 'Comparison' },
            { symbol: '>', name: 'Greater Than', desc: 'Tests if left > right', usage: '=IF(A1>B1, "Higher", "Lower")', example: '=10>5 returns TRUE', note: '💡 For text: alphabetical order', category: 'Comparison' },
            { symbol: '<', name: 'Less Than', desc: 'Tests if left < right', usage: '=IF(A1<B1, "Lower", "Higher")', example: '=3<5 returns TRUE', note: '💡 Opposite of >', category: 'Comparison' },
            { symbol: '>=', name: 'Greater Than or Equal To', desc: 'Tests if left >= right', usage: '=IF(A1>=100, "Pass", "Fail")', example: '=5>=5 returns TRUE', note: '💡 Includes equality', category: 'Comparison' },
            { symbol: '<=', name: 'Less Than or Equal To', desc: 'Tests if left <= right', usage: '=IF(A1<=100, "OK", "Over")', example: '=5<=10 returns TRUE', note: '💡 Includes equality', category: 'Comparison' },
            
            // TEXT Operators
            { symbol: '&', name: 'Text Concatenation', desc: 'Joins text strings', usage: '=A1&" "&B1', example: '="Hello"&"World" returns "HelloWorld"', note: '💡 PREFERRED over + for text', category: 'Text' },
            
            // REFERENCE Operators
            { symbol: ':', name: 'Range Operator', desc: 'Defines range from:to', usage: '=SUM(A1:A10)', example: 'A1:B10 = cells from A1 to B10', note: '💡 Creates rectangular range', category: 'Reference' },
            { symbol: ',', name: 'Union Operator', desc: 'Combines multiple ranges', usage: '=SUM(A1:A5,C1:C5)', example: 'A1:A5,C1:C5 = two separate ranges', note: '💡 Also separates function arguments', category: 'Reference' },
            { symbol: ' (space)', name: 'Intersection Operator', desc: 'Returns overlapping cells', usage: '=SUM(A1:C10 B1:B20)', example: 'B1:B10 (overlap of two ranges)', note: '💡 Rarely used, powerful for complex ranges', category: 'Reference' },
            
            // SPECIAL Operators
            { symbol: '$', name: 'Absolute Reference', desc: 'Locks cell reference', usage: '=$A$1 or $A1 or A$1', example: '$A$1 won\'t change when copied', note: '💡 $A$ = column+row, $A1 = column, A$1 = row', category: 'Special' },
            { symbol: '!', name: 'Sheet Reference', desc: 'References another sheet', usage: '=Sheet2!A1', example: '=Sheet2!A1 gets A1 from Sheet2', note: '💡 Use \'Sheet Name\'!A1 for spaces', category: 'Special' },
            { symbol: '\'', name: 'Sheet Name Delimiter', desc: 'Wraps sheet names with spaces', usage: '=\'Sales Data\'!A1', example: '=\'Jan 2024\'!B5', note: '💡 Required for spaces/special chars', category: 'Special' },
            { symbol: '#', name: 'Error Indicator / Spill Range', desc: 'Indicates errors or dynamic arrays', usage: '=A1# (spill range) or #N/A (error)', example: '#N/A, #VALUE!, #DIV/0!', note: '💡 # after ref = entire spill range', category: 'Special' },
            { symbol: '@', name: 'Implicit Intersection', desc: 'Gets single value from array', usage: '=@A1:A10 (returns value in current row)', example: 'Excel 365+ automatic operator', note: '💡 Usually added automatically by Excel', category: 'Special' },
            
            // ARRAY Operators
            { symbol: '{}', name: 'Array Constant', desc: 'Creates literal array', usage: '={1,2,3} or ={1;2;3}', example: '={1,2,3} = horizontal array', note: '💡 , = columns, ; = rows', category: 'Array' },
            { symbol: ';', name: 'Array Row Separator', desc: 'Separates rows in array', usage: '={1,2;3,4}', example: '={1,2;3,4} = 2x2 array', note: '💡 Creates vertical separation', category: 'Array' }
        ];

        // VBA Constants and Declarations (Complete Reference - ALL IN ONE PACKAGE)
        const vbaConstants = [
            // Declaration Keywords
            { keyword: 'Dim', category: 'Declaration', desc: 'Declares a local variable', example: 'Dim myVar As String', type: 'Keyword' },
            { keyword: 'Const', category: 'Declaration', desc: 'Declares a constant value', example: 'Const MAX_VALUE As Long = 1000', type: 'Keyword' },
            { keyword: 'Public', category: 'Declaration', desc: 'Declares a global variable or procedure', example: 'Public userName As String', type: 'Keyword' },
            { keyword: 'Private', category: 'Declaration', desc: 'Declares a module-level variable or procedure', example: 'Private internalData As Variant', type: 'Keyword' },
            { keyword: 'Static', category: 'Declaration', desc: 'Preserves variable value between procedure calls', example: 'Static counter As Integer', type: 'Modifier' },
            { keyword: 'Option Explicit', category: 'Declaration', desc: 'Forces explicit variable declaration', example: 'Option Explicit', type: 'Keyword' },
            { keyword: 'ReDim', category: 'Declaration', desc: 'Redimensions a dynamic array', example: 'ReDim myArray(1 To 100)', type: 'Keyword' },
            { keyword: 'ReDim Preserve', category: 'Declaration', desc: 'Redimensions array while keeping existing data', example: 'ReDim Preserve myArray(1 To 200)', type: 'Keyword' },
            
            // Data Types
            { keyword: 'Byte', category: 'Data Type', desc: '8-bit unsigned integer (0 to 255)', example: 'Dim age As Byte', type: 'Type' },
            { keyword: 'Integer', category: 'Data Type', desc: '16-bit signed integer (-32,768 to 32,767) - AVOID: Use Long instead!', example: 'Dim count As Integer', type: 'Type' },
            { keyword: 'Long', category: 'Data Type', desc: '32-bit signed integer (-2,147,483,648 to 2,147,483,647) - PREFERRED', example: 'Dim rowCount As Long', type: 'Type' },
            { keyword: 'LongLong', category: 'Data Type', desc: '64-bit integer (64-bit VBA only)', example: 'Dim bigNumber As LongLong', type: 'Type' },
            { keyword: 'Single', category: 'Data Type', desc: 'Single-precision floating point (4 bytes)', example: 'Dim temperature As Single', type: 'Type' },
            { keyword: 'Double', category: 'Data Type', desc: 'Double-precision floating point (8 bytes) - PREFERRED for decimals', example: 'Dim price As Double', type: 'Type' },
            { keyword: 'Currency', category: 'Data Type', desc: 'Fixed-point currency type (8 bytes, scaled by 10,000)', example: 'Dim salary As Currency', type: 'Type' },
            { keyword: 'Decimal', category: 'Data Type', desc: 'High-precision numeric (Variant subtype only)', example: 'Dim preciseValue As Decimal', type: 'Type' },
            { keyword: 'String', category: 'Data Type', desc: 'Text data (variable or fixed length)', example: 'Dim fullName As String', type: 'Type' },
            { keyword: 'Boolean', category: 'Data Type', desc: 'True or False', example: 'Dim isActive As Boolean', type: 'Type' },
            { keyword: 'Date', category: 'Data Type', desc: 'Date and time value (stored as Double)', example: 'Dim birthday As Date', type: 'Type' },
            { keyword: 'Variant', category: 'Data Type', desc: 'Flexible data type (16+ bytes - AVOID when possible)', example: 'Dim flexibleVar As Variant', type: 'Type' },
            { keyword: 'Object', category: 'Data Type', desc: 'Reference to an object (4 bytes for pointer)', example: 'Dim ws As Object', type: 'Type' },
            
            // Boolean Constants
            { keyword: 'True', category: 'Boolean Constant', desc: '-1 (all bits set)', example: 'isValid = True', type: 'Constant' },
            { keyword: 'False', category: 'Boolean Constant', desc: '0 (all bits clear)', example: 'isValid = False', type: 'Constant' },
            
            // Null/Empty Constants
            { keyword: 'Nothing', category: 'Null/Empty Constant', desc: 'Object reference is not set (used with Set)', example: 'Set ws = Nothing', type: 'Constant' },
            { keyword: 'Empty', category: 'Null/Empty Constant', desc: 'Uninitialized Variant (no data assigned yet)', example: 'If myVar = Empty Then', type: 'Constant' },
            { keyword: 'Null', category: 'Null/Empty Constant', desc: 'No valid data (Variant only, used in databases)', example: 'If IsNull(myVar) Then', type: 'Constant' },
            
            // Application Constants
            { keyword: 'xlCalculationAutomatic', category: 'Application Constant', desc: 'Automatic calculation (-4105)', example: 'Application.Calculation = xlCalculationAutomatic', type: 'Constant' },
            { keyword: 'xlCalculationManual', category: 'Application Constant', desc: 'Manual calculation (-4135)', example: 'Application.Calculation = xlCalculationManual', type: 'Constant' },
            { keyword: 'xlCalculationSemiautomatic', category: 'Application Constant', desc: 'Semi-automatic calculation (2)', example: 'Application.Calculation = xlCalculationSemiautomatic', type: 'Constant' },
            { keyword: 'ScreenUpdating', category: 'Application Constant', desc: 'Controls screen refresh (True/False)', example: 'Application.ScreenUpdating = False', type: 'Property' },
            { keyword: 'EnableEvents', category: 'Application Constant', desc: 'Controls event firing (True/False)', example: 'Application.EnableEvents = False', type: 'Property' },
            { keyword: 'DisplayAlerts', category: 'Application Constant', desc: 'Controls alert messages (True/False)', example: 'Application.DisplayAlerts = False', type: 'Property' },
            
            // Worksheet Direction
            { keyword: 'xlUp', category: 'Worksheet Direction', desc: 'Move up (-4162)', example: 'Range("A1").End(xlUp)', type: 'Constant' },
            { keyword: 'xlDown', category: 'Worksheet Direction', desc: 'Move down (-4121)', example: 'Range("A1").End(xlDown)', type: 'Constant' },
            { keyword: 'xlToLeft', category: 'Worksheet Direction', desc: 'Move left (-4159)', example: 'Range("A1").End(xlToLeft)', type: 'Constant' },
            { keyword: 'xlToRight', category: 'Worksheet Direction', desc: 'Move right (-4161)', example: 'Range("A1").End(xlToRight)', type: 'Constant' },
            
            // Alignment
            { keyword: 'xlCenter', category: 'Alignment', desc: 'Center alignment (-4108)', example: 'Range("A1").HorizontalAlignment = xlCenter', type: 'Constant' },
            { keyword: 'xlLeft', category: 'Alignment', desc: 'Left alignment (-4131)', example: 'Range("A1").HorizontalAlignment = xlLeft', type: 'Constant' },
            { keyword: 'xlRight', category: 'Alignment', desc: 'Right alignment (-4152)', example: 'Range("A1").HorizontalAlignment = xlRight', type: 'Constant' },
            { keyword: 'xlTop', category: 'Alignment', desc: 'Top alignment (-4160)', example: 'Range("A1").VerticalAlignment = xlTop', type: 'Constant' },
            { keyword: 'xlBottom', category: 'Alignment', desc: 'Bottom alignment (-4107)', example: 'Range("A1").VerticalAlignment = xlBottom', type: 'Constant' },
            { keyword: 'xlJustify', category: 'Alignment', desc: 'Justified alignment (-4130)', example: 'Range("A1").HorizontalAlignment = xlJustify', type: 'Constant' },
            
            // Borders
            { keyword: 'xlEdgeLeft', category: 'Borders', desc: 'Left edge border (7)', example: 'Range("A1").Borders(xlEdgeLeft).LineStyle = xlContinuous', type: 'Constant' },
            { keyword: 'xlEdgeTop', category: 'Borders', desc: 'Top edge border (8)', example: 'Range("A1").Borders(xlEdgeTop).LineStyle = xlContinuous', type: 'Constant' },
            { keyword: 'xlEdgeBottom', category: 'Borders', desc: 'Bottom edge border (9)', example: 'Range("A1").Borders(xlEdgeBottom).LineStyle = xlContinuous', type: 'Constant' },
            { keyword: 'xlEdgeRight', category: 'Borders', desc: 'Right edge border (10)', example: 'Range("A1").Borders(xlEdgeRight).LineStyle = xlContinuous', type: 'Constant' },
            { keyword: 'xlInsideHorizontal', category: 'Borders', desc: 'Inner horizontal borders (12)', example: 'Range("A1:C3").Borders(xlInsideHorizontal).LineStyle = xlContinuous', type: 'Constant' },
            { keyword: 'xlInsideVertical', category: 'Borders', desc: 'Inner vertical borders (11)', example: 'Range("A1:C3").Borders(xlInsideVertical).LineStyle = xlContinuous', type: 'Constant' },
            
            // Sorting
            { keyword: 'xlAscending', category: 'Sorting', desc: 'Sort ascending (1)', example: 'Range("A1:A10").Sort Order1:=xlAscending', type: 'Constant' },
            { keyword: 'xlDescending', category: 'Sorting', desc: 'Sort descending (2)', example: 'Range("A1:A10").Sort Order1:=xlDescending', type: 'Constant' },
            { keyword: 'xlYes', category: 'Sorting', desc: 'Range has header (1)', example: 'Range("A1:C10").Sort Header:=xlYes', type: 'Constant' },
            { keyword: 'xlNo', category: 'Sorting', desc: 'Range has no header (2)', example: 'Range("A1:C10").Sort Header:=xlNo', type: 'Constant' },
            { keyword: 'xlGuess', category: 'Sorting', desc: 'Excel guesses header presence (0)', example: 'Range("A1:C10").Sort Header:=xlGuess', type: 'Constant' },
            
            // Colors
            { keyword: 'xlNone', category: 'Colors', desc: 'No fill or color (-4142)', example: 'Range("A1").Interior.ColorIndex = xlNone', type: 'Constant' },
            { keyword: 'xlAutomatic', category: 'Colors', desc: 'Automatic color (-4105)', example: 'Range("A1").Font.ColorIndex = xlAutomatic', type: 'Constant' },
            { keyword: 'xlColorIndexNone', category: 'Colors', desc: 'Clears color index (-4142)', example: 'Range("A1").Font.ColorIndex = xlColorIndexNone', type: 'Constant' },
            { keyword: 'vbBlack', category: 'Colors', desc: 'Black (0)', example: 'Range("A1").Font.Color = vbBlack', type: 'Constant' },
            { keyword: 'vbRed', category: 'Colors', desc: 'Red (255)', example: 'Range("A1").Font.Color = vbRed', type: 'Constant' },
            { keyword: 'vbGreen', category: 'Colors', desc: 'Green (65280)', example: 'Range("A1").Font.Color = vbGreen', type: 'Constant' },
            { keyword: 'vbBlue', category: 'Colors', desc: 'Blue (16711680)', example: 'Range("A1").Font.Color = vbBlue', type: 'Constant' },
            { keyword: 'vbYellow', category: 'Colors', desc: 'Yellow (65535)', example: 'Range("A1").Font.Color = vbYellow', type: 'Constant' },
            { keyword: 'vbWhite', category: 'Colors', desc: 'White (16777215)', example: 'Range("A1").Font.Color = vbWhite', type: 'Constant' },
            
            // MsgBox Buttons
            { keyword: 'vbOKOnly', category: 'MsgBox Buttons', desc: 'OK button only (0)', example: 'MsgBox "Hello", vbOKOnly', type: 'Constant' },
            { keyword: 'vbOKCancel', category: 'MsgBox Buttons', desc: 'OK and Cancel buttons (1)', example: 'MsgBox "Continue?", vbOKCancel', type: 'Constant' },
            { keyword: 'vbYesNo', category: 'MsgBox Buttons', desc: 'Yes and No buttons (4)', example: 'MsgBox "Proceed?", vbYesNo', type: 'Constant' },
            { keyword: 'vbYesNoCancel', category: 'MsgBox Buttons', desc: 'Yes, No, Cancel buttons (3)', example: 'MsgBox "Save changes?", vbYesNoCancel', type: 'Constant' },
            { keyword: 'vbRetryCancel', category: 'MsgBox Buttons', desc: 'Retry and Cancel buttons (5)', example: 'MsgBox "Try again?", vbRetryCancel', type: 'Constant' },
            { keyword: 'vbAbortRetryIgnore', category: 'MsgBox Buttons', desc: 'Abort, Retry, Ignore (2)', example: 'MsgBox "Error!", vbAbortRetryIgnore', type: 'Constant' },
            
            // MsgBox Icons
            { keyword: 'vbInformation', category: 'MsgBox Icons', desc: 'Information icon (64)', example: 'MsgBox "Done!", vbInformation', type: 'Constant' },
            { keyword: 'vbExclamation', category: 'MsgBox Icons', desc: 'Warning icon (48)', example: 'MsgBox "Warning!", vbExclamation', type: 'Constant' },
            { keyword: 'vbCritical', category: 'MsgBox Icons', desc: 'Critical icon (16)', example: 'MsgBox "Error!", vbCritical', type: 'Constant' },
            { keyword: 'vbQuestion', category: 'MsgBox Icons', desc: 'Question icon (32)', example: 'MsgBox "Continue?", vbQuestion', type: 'Constant' },
            
            // MsgBox Returns
            { keyword: 'vbOK', category: 'MsgBox Returns', desc: 'User clicked OK (1)', example: 'If MsgBox("OK?", vbOKCancel) = vbOK Then', type: 'Constant' },
            { keyword: 'vbCancel', category: 'MsgBox Returns', desc: 'User clicked Cancel (2)', example: 'If result = vbCancel Then', type: 'Constant' },
            { keyword: 'vbYes', category: 'MsgBox Returns', desc: 'User clicked Yes (6)', example: 'If result = vbYes Then', type: 'Constant' },
            { keyword: 'vbNo', category: 'MsgBox Returns', desc: 'User clicked No (7)', example: 'If result = vbNo Then', type: 'Constant' },
            { keyword: 'vbRetry', category: 'MsgBox Returns', desc: 'User clicked Retry (4)', example: 'If result = vbRetry Then', type: 'Constant' },
            { keyword: 'vbIgnore', category: 'MsgBox Returns', desc: 'User clicked Ignore (5)', example: 'If result = vbIgnore Then', type: 'Constant' },
            { keyword: 'vbAbort', category: 'MsgBox Returns', desc: 'User clicked Abort (3)', example: 'If result = vbAbort Then', type: 'Constant' },
            
            // Date Constants
            { keyword: 'vbSunday', category: 'Date Constants', desc: 'Sunday (1)', example: 'If Weekday(Date) = vbSunday Then', type: 'Constant' },
            { keyword: 'vbMonday', category: 'Date Constants', desc: 'Monday (2)', example: 'If Weekday(Date) = vbMonday Then', type: 'Constant' },
            { keyword: 'vbTuesday', category: 'Date Constants', desc: 'Tuesday (3)', example: 'If Weekday(Date) = vbTuesday Then', type: 'Constant' },
            { keyword: 'vbWednesday', category: 'Date Constants', desc: 'Wednesday (4)', example: 'If Weekday(Date) = vbWednesday Then', type: 'Constant' },
            { keyword: 'vbThursday', category: 'Date Constants', desc: 'Thursday (5)', example: 'If Weekday(Date) = vbThursday Then', type: 'Constant' },
            { keyword: 'vbFriday', category: 'Date Constants', desc: 'Friday (6)', example: 'If Weekday(Date) = vbFriday Then', type: 'Constant' },
            { keyword: 'vbSaturday', category: 'Date Constants', desc: 'Saturday (7)', example: 'If Weekday(Date) = vbSaturday Then', type: 'Constant' },
            
            // Error Handling
            { keyword: 'On Error Resume Next', category: 'Error Handling', desc: 'Ignore runtime errors (continue execution)', example: 'On Error Resume Next', type: 'Statement' },
            { keyword: 'On Error GoTo [label]', category: 'Error Handling', desc: 'Jump to error handler on error', example: 'On Error GoTo ErrorHandler', type: 'Statement' },
            { keyword: 'On Error GoTo 0', category: 'Error Handling', desc: 'Disable error handling (default behavior)', example: 'On Error GoTo 0', type: 'Statement' },
            { keyword: 'Err.Number', category: 'Error Handling', desc: 'Returns error number (0 = no error)', example: 'If Err.Number <> 0 Then', type: 'Property' },
            { keyword: 'Err.Description', category: 'Error Handling', desc: 'Returns error description text', example: 'MsgBox Err.Description', type: 'Property' },
            { keyword: 'Err.Source', category: 'Error Handling', desc: 'Returns error source (procedure/object)', example: 'Debug.Print Err.Source', type: 'Property' },
            { keyword: 'Err.Clear', category: 'Error Handling', desc: 'Clears error object', example: 'Err.Clear', type: 'Method' },
            { keyword: 'Error [number]', category: 'Error Handling', desc: 'Raises runtime error', example: 'Error 5', type: 'Statement' },
            
            // File Attributes
            { keyword: 'vbNormal', category: 'File Attributes', desc: 'Normal file (0)', example: 'If GetAttr(path) = vbNormal Then', type: 'Constant' },
            { keyword: 'vbHidden', category: 'File Attributes', desc: 'Hidden file (2)', example: 'SetAttr path, vbHidden', type: 'Constant' },
            { keyword: 'vbReadOnly', category: 'File Attributes', desc: 'Read-only file (1)', example: 'SetAttr path, vbReadOnly', type: 'Constant' },
            { keyword: 'vbSystem', category: 'File Attributes', desc: 'System file (4)', example: 'If GetAttr(path) And vbSystem Then', type: 'Constant' },
            { keyword: 'vbDirectory', category: 'File Attributes', desc: 'Directory/folder (16)', example: 'If GetAttr(path) And vbDirectory Then', type: 'Constant' },
            
            // Best Practice Examples
            { keyword: 'FIRST_DATA_ROW', category: 'Best Practice', desc: 'Const FIRST_DATA_ROW As Long = 2 \'First row with data\'', example: 'Const FIRST_DATA_ROW As Long = 2', type: 'Example' },
            { keyword: 'LAST_COLUMN', category: 'Best Practice', desc: 'Const LAST_COLUMN As String = "Z" \'Last column in range\'', example: 'Const LAST_COLUMN As String = "Z"', type: 'Example' },
            { keyword: 'MAX_RETRIES', category: 'Best Practice', desc: 'Const MAX_RETRIES As Long = 3 \'Maximum retry attempts\'', example: 'Const MAX_RETRIES As Long = 3', type: 'Example' },
            { keyword: 'LATE_CUTOFF_HOUR', category: 'Best Practice', desc: 'Const LATE_CUTOFF_HOUR As Long = 10 \'Hour for late cutoff\'', example: 'Const LATE_CUTOFF_HOUR As Long = 10', type: 'Example' },
            { keyword: 'SUCCESS_COLOR', category: 'Best Practice', desc: 'Const SUCCESS_COLOR As Long = vbGreen \'Color for success\'', example: 'Const SUCCESS_COLOR As Long = vbGreen', type: 'Example' },
            { keyword: 'ERROR_COLOR', category: 'Best Practice', desc: 'Const ERROR_COLOR As Long = vbRed \'Color for errors\'', example: 'Const ERROR_COLOR As Long = vbRed', type: 'Example' },
            
            // String Constants
            { keyword: 'vbNullString', category: 'String Constant', desc: 'Empty string ""', example: 'If myStr = vbNullString Then', type: 'Constant' },
            { keyword: 'vbCrLf', category: 'String Constant', desc: 'Carriage return + line feed (newline)', example: 'msg = "Line1" & vbCrLf & "Line2"', type: 'Constant' },
            { keyword: 'vbCr', category: 'String Constant', desc: 'Carriage return', example: 'Split(text, vbCr)', type: 'Constant' },
            { keyword: 'vbLf', category: 'String Constant', desc: 'Line feed', example: 'Split(text, vbLf)', type: 'Constant' },
            { keyword: 'vbTab', category: 'String Constant', desc: 'Tab character', example: 'data = "Col1" & vbTab & "Col2"', type: 'Constant' },
            { keyword: 'vbNewLine', category: 'String Constant', desc: 'Platform-specific newline', example: 'text & vbNewLine & "Next line"', type: 'Constant' },
            
            // Object Types
            { keyword: 'Worksheet', category: 'Object Type', desc: 'Excel worksheet object', example: 'Dim ws As Worksheet', type: 'Object' },
            { keyword: 'Workbook', category: 'Object Type', desc: 'Excel workbook object', example: 'Dim wb As Workbook', type: 'Object' },
            { keyword: 'Range', category: 'Object Type', desc: 'Excel range object', example: 'Dim rng As Range', type: 'Object' },
            { keyword: 'Chart', category: 'Object Type', desc: 'Excel chart object', example: 'Dim cht As Chart', type: 'Object' },
            { keyword: 'PivotTable', category: 'Object Type', desc: 'Excel pivot table object', example: 'Dim pt As PivotTable', type: 'Object' },
            { keyword: 'Collection', category: 'Object Type', desc: 'VBA collection object', example: 'Dim myCollection As Collection', type: 'Object' },
            { keyword: 'Dictionary', category: 'Object Type', desc: 'Scripting dictionary object', example: 'Dim dict As Dictionary', type: 'Object' },
            
            // Array Declarations
            { keyword: 'Array() Fixed', category: 'Array', desc: 'Creates a fixed-size array', example: 'Dim arr(1 To 10) As Integer', type: 'Declaration' },
            { keyword: 'Array() Dynamic', category: 'Array', desc: 'Creates a dynamic array', example: 'Dim arr() As String', type: 'Declaration' },
            { keyword: 'Array Multi-Dim', category: 'Array', desc: 'Multi-dimensional array', example: 'Dim matrix(1 To 10, 1 To 10) As Double', type: 'Declaration' },
            
            // Scope Modifiers
            { keyword: 'Friend', category: 'Scope', desc: 'Accessible within same project', example: 'Friend Sub Helper()', type: 'Modifier' },
            { keyword: 'Global', category: 'Scope', desc: 'Module-level (same as Public)', example: 'Global userName As String', type: 'Modifier' },
            
            // Procedure Modifiers
            { keyword: 'Optional', category: 'Parameter', desc: 'Parameter is optional', example: 'Sub Test(Optional msg As String = "Hello")', type: 'Modifier' },
            { keyword: 'ByVal', category: 'Parameter', desc: 'Pass parameter by value (copy)', example: 'Sub Test(ByVal x As Integer)', type: 'Modifier' },
            { keyword: 'ByRef', category: 'Parameter', desc: 'Pass parameter by reference (default)', example: 'Sub Test(ByRef x As Integer)', type: 'Modifier' },
            { keyword: 'ParamArray', category: 'Parameter', desc: 'Variable number of arguments', example: 'Sub Test(ParamArray args() As Variant)', type: 'Modifier' }
        ];

        // Excel Criteria Expressions (Complete Reference - ALL IN ONE PACKAGE)
        const criteriaExpressions = [
            // 1️⃣ Comparison / Logical Operators
            { operator: '=', category: 'Comparison', meaning: 'Equal to', example: '"=10"', usage: '=COUNTIF(A:A,"=10")' },
            { operator: '<>', category: 'Comparison', meaning: 'Not equal to', example: '"<>0"', usage: '=COUNTIF(A:A,"<>0")' },
            { operator: '>', category: 'Comparison', meaning: 'Greater than', example: '">50"', usage: '=COUNTIF(A:A,">50")' },
            { operator: '<', category: 'Comparison', meaning: 'Less than', example: '"<100"', usage: '=COUNTIF(A:A,"<100")' },
            { operator: '>=', category: 'Comparison', meaning: 'Greater than or equal', example: '">=75"', usage: '=COUNTIF(A:A,">=75")' },
            { operator: '<=', category: 'Comparison', meaning: 'Less than or equal', example: '"<=60"', usage: '=COUNTIF(A:A,"<=60")' },
            
            // 2️⃣ Empty / Non-Empty Cell Criteria
            { operator: '""', category: 'Empty/Non-Empty', meaning: 'Empty cell', example: '""', usage: '=COUNTIF(A:A,"")' },
            { operator: '<>""', category: 'Empty/Non-Empty', meaning: 'Non-empty cell (preferred)', example: '"<>"""', usage: '=COUNTIF(A:A,"<>""")', note: 'Recommended for clarity' },
            { operator: '"="', category: 'Empty/Non-Empty', meaning: 'Empty cell (alternative)', example: '"="', usage: '=COUNTIF(A:A,"=")' },
            { operator: '"<>"', category: 'Empty/Non-Empty', meaning: 'Non-empty cell (alternative)', example: '"<>"', usage: '=COUNTIF(A:A,"<>")' },
            
            // 3️⃣ Text Criteria
            { operator: '"Text"', category: 'Text', meaning: 'Exact text match', example: '"Apple"', usage: '=COUNTIF(A:A,"Apple")' },
            { operator: '"<>Text"', category: 'Text', meaning: 'Not equal to text', example: '"<>Apple"', usage: '=COUNTIF(A:A,"<>Apple")' },
            { operator: '"=Text"', category: 'Text', meaning: 'Explicit text equality', example: '"=Apple"', usage: '=COUNTIF(A:A,"=Apple")' },
            { operator: '"*Text*"', category: 'Text', meaning: 'Contains text', example: '"*error*"', usage: '=COUNTIF(A:A,"*error*")' },
            { operator: '"Text*"', category: 'Text', meaning: 'Starts with text', example: '"Apple*"', usage: '=COUNTIF(A:A,"Apple*")' },
            { operator: '"*Text"', category: 'Text', meaning: 'Ends with text', example: '"*son"', usage: '=COUNTIF(A:A,"*son")' },
            
            // 4️⃣ Wildcards
            { operator: '*', category: 'Wildcard', meaning: 'Any number of characters', example: '"A*"', usage: '=COUNTIF(A:A,"A*")' },
            { operator: '?', category: 'Wildcard', meaning: 'Exactly one character', example: '"A?C"', usage: '=COUNTIF(A:A,"A?C")' },
            { operator: '~', category: 'Wildcard', meaning: 'Escape wildcard (literal)', example: '"~*"', usage: '=COUNTIF(A:A,"~*")', note: 'Searches for actual * character' },
            
            // 5️⃣ Numeric Criteria
            { operator: '">N"', category: 'Numeric', meaning: 'Greater than number', example: '">10"', usage: '=SUMIF(A:A,">10",B:B)' },
            { operator: '"<=N"', category: 'Numeric', meaning: 'Less than or equal to number', example: '"<=100"', usage: '=SUMIF(A:A,"<=100",B:B)' },
            { operator: '"<>N"', category: 'Numeric', meaning: 'Not equal to number', example: '"<>0"', usage: '=COUNTIF(A:A,"<>0")' },
            
            // 6️⃣ Date Criteria
            { operator: '">"&DATE()', category: 'Date', meaning: 'After specific date', example: '">"&DATE(2024,1,1)', usage: '=COUNTIF(A:A,">"&DATE(2024,1,1))', note: 'Use DATE() function, not hard-typed dates' },
            { operator: '"<="&TODAY()', category: 'Date', meaning: 'Up to today', example: '"<="&TODAY()', usage: '=COUNTIF(A:A,"<="&TODAY())' },
            { operator: '"<>"&TODAY()', category: 'Date', meaning: 'Not today', example: '"<>"&TODAY()', usage: '=COUNTIF(A:A,"<>"&TODAY())' },
            
            // 7️⃣ Boolean Criteria
            { operator: 'TRUE', category: 'Boolean', meaning: 'Logical TRUE', example: 'TRUE', usage: '=COUNTIF(A:A,TRUE)', note: 'Without quotes - logical value' },
            { operator: 'FALSE', category: 'Boolean', meaning: 'Logical FALSE', example: 'FALSE', usage: '=COUNTIF(A:A,FALSE)', note: 'Without quotes - logical value' },
            { operator: '"TRUE"', category: 'Boolean', meaning: 'Text "TRUE"', example: '"TRUE"', usage: '=COUNTIF(A:A,"TRUE")', note: 'With quotes - text string' },
            { operator: '"FALSE"', category: 'Boolean', meaning: 'Text "FALSE"', example: '"FALSE"', usage: '=COUNTIF(A:A,"FALSE")', note: 'With quotes - text string' },
            
            // 8️⃣ Dynamic Criteria (Cell References)
            { operator: '">"&Cell', category: 'Dynamic', meaning: 'Greater than cell value', example: '">"&B1', usage: '=COUNTIF(A:A,">"&B1)', note: 'Criteria built from cell reference' },
            { operator: '"<="&Cell', category: 'Dynamic', meaning: 'Less than or equal to cell', example: '"<="&B1', usage: '=SUMIF(A:A,"<="&B1,C:C)' },
            { operator: '"<>"&Cell', category: 'Dynamic', meaning: 'Not equal to cell', example: '"<>"&B1', usage: '=COUNTIF(A:A,"<>"&B1)' },
            
            // 9️⃣ Functions That Use These Criteria
            { operator: 'COUNTIF', category: 'Functions', meaning: 'Count cells matching criteria', example: 'COUNTIF(range, criteria)', usage: '=COUNTIF(A:A,">50")', note: 'Single criteria' },
            { operator: 'COUNTIFS', category: 'Functions', meaning: 'Count with multiple criteria', example: 'COUNTIFS(range1, criteria1, ...)', usage: '=COUNTIFS(A:A,">50",B:B,"<100")' },
            { operator: 'SUMIF', category: 'Functions', meaning: 'Sum cells matching criteria', example: 'SUMIF(range, criteria, [sum_range])', usage: '=SUMIF(A:A,">0",B:B)' },
            { operator: 'SUMIFS', category: 'Functions', meaning: 'Sum with multiple criteria', example: 'SUMIFS(sum_range, range1, criteria1, ...)', usage: '=SUMIFS(C:C,A:A,">0",B:B,"<100")' },
            { operator: 'AVERAGEIF', category: 'Functions', meaning: 'Average cells matching criteria', example: 'AVERAGEIF(range, criteria, [avg_range])', usage: '=AVERAGEIF(A:A,">50",B:B)' },
            { operator: 'AVERAGEIFS', category: 'Functions', meaning: 'Average with multiple criteria', example: 'AVERAGEIFS(avg_range, range1, criteria1, ...)', usage: '=AVERAGEIFS(C:C,A:A,">0",B:B,"<100")' },
            { operator: 'FILTER', category: 'Functions', meaning: 'Filter array by criteria', example: 'FILTER(array, include, [if_empty])', usage: '=FILTER(A:C,A:A>50)' },
            { operator: 'DSUM', category: 'Functions', meaning: 'Database sum with criteria', example: 'DSUM(database, field, criteria)', usage: '=DSUM(A1:D100,"Sales",F1:F2)' },
            { operator: 'DCOUNT', category: 'Functions', meaning: 'Database count with criteria', example: 'DCOUNT(database, field, criteria)', usage: '=DCOUNT(A1:D100,"ID",F1:F2)' }
        ];

        // MASSIVE VBA Templates Library (25+ templates)
        const vbaTemplates = [
            // Beginner Level
            {
                name: 'Hello World - First Steps',
                category: 'Beginner',
                desc: 'Your first VBA program - displays a simple message box',
                code: `Option Explicit

Sub HelloWorld()
    MsgBox "Hello, World! Welcome to VBA Programming!", vbInformation, "My First Program"
End Sub`
            },
            {
                name: 'Basic Variables & Data Types',
                category: 'Beginner',
                desc: 'Learn how to declare and use different variable types in VBA',
                code: `Option Explicit

Sub LearnVariables()
    ' Declare different data types
    Dim myString As String
    Dim myInteger As Integer
    Dim myLong As Long
    Dim myDouble As Double
    Dim myDate As Date
    Dim myBoolean As Boolean
    Dim myVariant As Variant
    
    ' Assign values
    myString = "Hello VBA"
    myInteger = 100
    myLong = 1000000
    myDouble = 3.14159
    myDate = Now
    myBoolean = True
    myVariant = "Can hold any type"
    
    ' Display results
    MsgBox "String: " & myString & vbCrLf & _
           "Integer: " & myInteger & vbCrLf & _
           "Long: " & myLong & vbCrLf & _
           "Double: " & myDouble & vbCrLf & _
           "Date: " & myDate & vbCrLf & _
           "Boolean: " & myBoolean & vbCrLf & _
           "Variant: " & myVariant, vbInformation, "Variable Types"
End Sub`
            },
            {
                name: 'Simple For Loop',
                category: 'Beginner',
                desc: 'Iterate through cells using a For-Next loop',
                code: `Option Explicit

Sub SimpleForLoop()
    Dim i As Integer
    Dim ws As Worksheet
    
    Set ws = ThisWorkbook.Worksheets("Sheet1")
    
    ' Loop from 1 to 10
    For i = 1 To 10
        ws.Cells(i, 1).Value = "Row " & i
        ws.Cells(i, 2).Value = i * i ' Square of i
        ws.Cells(i, 3).Value = i * 2 ' Double of i
    Next i
    
    MsgBox "Loop completed! Check Sheet1", vbInformation
End Sub`
            },
            {
                name: 'If-Then-Else Decisions',
                category: 'Beginner',
                desc: 'Make decisions in your code based on conditions',
                code: `Option Explicit

Sub GradeCalculator()
    Dim score As Integer
    Dim grade As String
    Dim message As String
    
    ' Get score from user
    score = InputBox("Enter your test score (0-100):", "Grade Calculator")
    
    ' Determine grade
    If score >= 90 Then
        grade = "A"
        message = "Excellent!"
    ElseIf score >= 80 Then
        grade = "B"
        message = "Very Good!"
    ElseIf score >= 70 Then
        grade = "C"
        message = "Good!"
    ElseIf score >= 60 Then
        grade = "D"
        message = "Passing"
    Else
        grade = "F"
        message = "Needs Improvement"
    End If
    
    ' Display result
    MsgBox "Score: " & score & vbCrLf & _
           "Grade: " & grade & vbCrLf & _
           message, vbInformation, "Your Grade"
End Sub`
            },
            {
                name: 'User Input & Output',
                category: 'Beginner',
                desc: 'Get input from user and display customized output',
                code: `Option Explicit

Sub GetUserInfo()
    Dim userName As String
    Dim userAge As Integer
    Dim userCity As String
    Dim message As String
    
    ' Get information from user
    userName = InputBox("What is your name?", "User Information")
    userAge = InputBox("How old are you?", "User Information")
    userCity = InputBox("Which city do you live in?", "User Information")
    
    ' Create personalized message
    message = "Hello " & userName & "!" & vbCrLf & vbCrLf
    message = message & "You are " & userAge & " years old." & vbCrLf
    message = message & "You live in " & userCity & "." & vbCrLf & vbCrLf
    message = message & "Welcome to VBA Programming!"
    
    ' Display message
    MsgBox message, vbInformation, "Welcome"
End Sub`
            },

            // Intermediate Level
            {
                name: 'Excel Data Processing - Safe',
                category: 'Intermediate',
                desc: 'Process Excel data with proper error handling and validation',
                code: `Option Explicit

Sub ProcessExcelData()
    Dim ws As Worksheet
    Dim lastRow As Long
    Dim i As Long
    Dim processedCount As Long
    
    On Error GoTo ErrorHandler
    
    ' Initialize
    Set ws = ThisWorkbook.Worksheets("Sheet1")
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    processedCount = 0
    
    ' Process each row
    For i = 2 To lastRow
        If IsNumeric(ws.Cells(i, 1).Value) Then
            ' Calculate 10% increase
            ws.Cells(i, 2).Value = ws.Cells(i, 1).Value * 1.1
            processedCount = processedCount + 1
        End If
    Next i
    
    MsgBox "Processed " & processedCount & " rows successfully!", vbInformation
    Exit Sub
    
ErrorHandler:
    MsgBox "Error: " & Err.Description, vbCritical, "Processing Error"
End Sub`
            },
            {
                name: 'Safe Range Selection',
                category: 'Intermediate',
                desc: 'Properly select and validate Excel ranges using Set keyword',
                code: `Option Explicit

Sub SafeRangeSelection()
    Dim ws As Worksheet
    Dim targetRange As Range
    Dim cell As Range
    Dim count As Integer
    
    On Error GoTo ErrorHandler
    
    ' Proper object assignment with Set
    Set ws = ThisWorkbook.Worksheets("Data")
    Set targetRange = ws.Range("A1:A10")
    
    ' Validate range exists
    If targetRange Is Nothing Then
        MsgBox "Range not found!", vbExclamation
        Exit Sub
    End If
    
    ' Process each cell
    count = 0
    For Each cell In targetRange
        If Not IsEmpty(cell.Value) Then
            Debug.Print cell.Address & ": " & cell.Value
            count = count + 1
        End If
    Next cell
    
    MsgBox "Processed " & count & " non-empty cells", vbInformation
    Exit Sub
    
ErrorHandler:
    MsgBox "Error in SafeRangeSelection: " & Err.Description, vbCritical
End Sub`
            },
            {
                name: 'High-Performance Loop',
                category: 'Intermediate',
                desc: 'Optimized loop with ScreenUpdating and Calculation management',
                code: `Option Explicit

Sub OptimizedLoop()
    Dim ws As Worksheet
    Dim lastRow As Long
    Dim i As Long
    Dim startTime As Double
    
    On Error GoTo ErrorHandler
    
    ' Record start time
    startTime = Timer
    
    ' Disable Excel features for speed
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    Application.EnableEvents = False
    
    Set ws = ThisWorkbook.Worksheets("Sheet1")
    lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
    
    ' Fast processing loop
    For i = 2 To lastRow
        ws.Cells(i, 3).Value = ws.Cells(i, 1).Value + ws.Cells(i, 2).Value
    Next i
    
RestoreSettings:
    ' Always restore Excel settings
    Application.ScreenUpdating = True
    Application.Calculation = xlCalculationAutomatic
    Application.EnableEvents = True
    
    MsgBox "Completed in " & Format(Timer - startTime, "0.00") & " seconds!", vbInformation
    Exit Sub
    
ErrorHandler:
    MsgBox "Error: " & Err.Description, vbCritical
    Resume RestoreSettings
End Sub`
            },
            {
                name: 'Data Validation & Cleaning',
                category: 'Intermediate',
                desc: 'Clean and validate data before processing',
                code: `Option Explicit

Sub CleanAndValidateData()
    Dim ws As Worksheet
    Dim lastRow As Long
    Dim i As Long
    Dim cleanCount As Long
    
    On Error GoTo ErrorHandler
    
    Set ws = ThisWorkbook.Worksheets("Sheet1")
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    cleanCount = 0
    
    For i = 2 To lastRow
        ' Remove leading/trailing spaces
        ws.Cells(i, 1).Value = Trim(ws.Cells(i, 1).Value)
        
        ' Convert to proper case
        ws.Cells(i, 2).Value = Application.WorksheetFunction.Proper(ws.Cells(i, 2).Value)
        
        ' Remove duplicates
        If i > 2 Then
            If ws.Cells(i, 1).Value = ws.Cells(i - 1, 1).Value Then
                ws.Rows(i).Delete
                i = i - 1
                lastRow = lastRow - 1
            End If
        End If
        
        cleanCount = cleanCount + 1
    Next i
    
    MsgBox "Cleaned " & cleanCount & " rows!", vbInformation
    Exit Sub
    
ErrorHandler:
    MsgBox "Error: " & Err.Description, vbCritical
End Sub`
            },
            {
                name: 'Find & Replace in Range',
                category: 'Intermediate',
                desc: 'Search and replace values in specified range',
                code: `Option Explicit

Sub FindAndReplace()
    Dim ws As Worksheet
    Dim searchRange As Range
    Dim findWhat As String
    Dim replaceWith As String
    Dim replaceCount As Long
    
    On Error GoTo ErrorHandler
    
    Set ws = ThisWorkbook.Worksheets("Sheet1")
    Set searchRange = ws.Range("A1:Z100")
    
    ' Get search criteria
    findWhat = InputBox("What do you want to find?", "Find")
    replaceWith = InputBox("Replace with:", "Replace")
    
    ' Perform replacement
    replaceCount = searchRange.Replace( _
        What:=findWhat, _
        Replacement:=replaceWith, _
        LookAt:=xlPart, _
        SearchOrder:=xlByRows, _
        MatchCase:=False)
    
    MsgBox "Replaced " & replaceCount & " occurrences!", vbInformation
    Exit Sub
    
ErrorHandler:
    MsgBox "Error: " & Err.Description, vbCritical
End Sub`
            },

            // Advanced Level
            {
                name: 'Advanced Error Handling',
                category: 'Advanced',
                desc: 'Comprehensive error handling with detailed logging',
                code: `Option Explicit

Sub AdvancedErrorHandling()
    Dim ws As Worksheet
    Dim errorLog As String
    Dim errorSheet As Worksheet
    
    On Error GoTo ErrorHandler
    
    Set ws = ThisWorkbook.Worksheets("Data")
    ws.Range("A1").Value = "Test Data"
    
    ' Your main processing code here
    
    Exit Sub
    
ErrorHandler:
    ' Create detailed error log
    errorLog = "=== ERROR REPORT ===" & vbCrLf
    errorLog = errorLog & "Error Number: " & Err.Number & vbCrLf
    errorLog = errorLog & "Description: " & Err.Description & vbCrLf
    errorLog = errorLog & "Procedure: AdvancedErrorHandling" & vbCrLf
    errorLog = errorLog & "Line: " & Erl & vbCrLf
    errorLog = errorLog & "Source: " & Err.Source & vbCrLf
    errorLog = errorLog & "Timestamp: " & Now & vbCrLf
    errorLog = errorLog & "User: " & Environ("USERNAME") & vbCrLf
    errorLog = errorLog & "==================" & vbCrLf
    
    ' Log to Debug window
    Debug.Print errorLog
    
    ' Log to worksheet (create if doesn't exist)
    On Error Resume Next
    Set errorSheet = ThisWorkbook.Worksheets("ErrorLog")
    If errorSheet Is Nothing Then
        Set errorSheet = ThisWorkbook.Worksheets.Add
        errorSheet.Name = "ErrorLog"
        errorSheet.Range("A1").Value = "Error Logs"
    End If
    
    errorSheet.Range("A" & errorSheet.Rows.Count).End(xlUp).Offset(1, 0).Value = errorLog
    On Error GoTo 0
    
    ' Show user-friendly message
    MsgBox "An error occurred. Details logged to ErrorLog sheet.", vbCritical, "Error"
End Sub`
            },
            {
                name: 'WorksheetFunction with Guards',
                category: 'Advanced',
                desc: 'Safe usage of Excel WorksheetFunction methods with validation',
                code: `Option Explicit

Sub SafeWorksheetFunctions()
    Dim ws As Worksheet
    Dim dataRange As Range
    Dim result As Variant
    
    On Error GoTo ErrorHandler
    
    Set ws = ThisWorkbook.Worksheets("Sheet1")
    Set dataRange = ws.Range("A1:A10")
    
    ' Validate range has numeric data
    If Application.WorksheetFunction.Count(dataRange) > 0 Then
        ' Sum
        result = Application.WorksheetFunction.Sum(dataRange)
        MsgBox "Sum: " & Format(result, "#,##0.00"), vbInformation
        
        ' Average
        result = Application.WorksheetFunction.Average(dataRange)
        MsgBox "Average: " & Format(result, "#,##0.00"), vbInformation
        
        ' Max & Min
        MsgBox "Max: " & Application.WorksheetFunction.Max(dataRange) & vbCrLf & _
               "Min: " & Application.WorksheetFunction.Min(dataRange), vbInformation
        
        ' Count of values
        MsgBox "Count: " & Application.WorksheetFunction.Count(dataRange) & vbCrLf & _
               "Count Non-Empty: " & Application.WorksheetFunction.CountA(dataRange), vbInformation
    Else
        MsgBox "No numeric values found in range!", vbExclamation
    End If
    
    Exit Sub
    
ErrorHandler:
    If Err.Number = 1004 Then
        MsgBox "Range error: " & Err.Description, vbCritical
    Else
        MsgBox "Error: " & Err.Description, vbCritical
    End If
End Sub`
            },
            {
                name: 'Dynamic Arrays (Excel 365)',
                category: 'Advanced',
                desc: 'Work with dynamic arrays and spill ranges in Excel 365',
                code: `Option Explicit

Sub DynamicArrays()
    Dim ws As Worksheet
    Dim sourceRange As Range
    Dim resultRange As Range
    
    On Error GoTo ErrorHandler
    
    Set ws = ThisWorkbook.Worksheets("Sheet1")
    Set sourceRange = ws.Range("A1:A10")
    
    ' Clear previous results
    ws.Range("C:F").ClearContents
    
    ' Dynamic array formulas (Excel 365)
    ws.Range("C1").Formula2 = "=UNIQUE(A1:A10)"
    ws.Range("D1").Formula2 = "=SORT(A1:A10)"
    ws.Range("E1").Formula2 = "=FILTER(A1:A10,A1:A10>50,""No values > 50"")"
    ws.Range("F1").Formula2 = "=SEQUENCE(10,1,1,1)"
    
    ' Reference spill range
    On Error Resume Next
    Set resultRange = ws.Range("C1").SpillRange
    On Error GoTo ErrorHandler
    
    If Not resultRange Is Nothing Then
        MsgBox "UNIQUE values found: " & resultRange.Rows.Count, vbInformation
    Else
        MsgBox "Spill range not detected. Requires Excel 365.", vbExclamation
    End If
    
    Exit Sub
    
ErrorHandler:
    If Err.Number = 1004 Then
        MsgBox "This feature requires Excel 365 with dynamic arrays!", vbExclamation
    Else
        MsgBox "Error: " & Err.Description, vbCritical
    End If
End Sub`
            },
            {
                name: 'Dictionary for Fast Lookups',
                category: 'Advanced',
                desc: 'Use Dictionary object for high-performance data lookups',
                code: `Option Explicit

Sub UseDictionary()
    Dim dict As Object ' Scripting.Dictionary
    Dim key As Variant
    Dim ws As Worksheet
    Dim lastRow As Long
    Dim i As Long
    Dim startTime As Double
    
    On Error GoTo ErrorHandler
    
    startTime = Timer
    
    ' Create dictionary (late binding)
    Set dict = CreateObject("Scripting.Dictionary")
    
    Set ws = ThisWorkbook.Worksheets("Sheet1")
    lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
    
    ' Add items to dictionary
    For i = 2 To lastRow
        If Not dict.Exists(ws.Cells(i, 1).Value) Then
            dict.Add ws.Cells(i, 1).Value, ws.Cells(i, 2).Value
        End If
    Next i
    
    ' Fast lookup examples
    If dict.Exists("Apple") Then
        MsgBox "Apple price: $" & dict("Apple"), vbInformation
    End If
    
    ' Loop through all items
    For Each key In dict.Keys
        Debug.Print key & ": " & dict(key)
    Next key
    
    MsgBox "Dictionary contains " & dict.Count & " unique items" & vbCrLf & _
           "Processed in " & Format(Timer - startTime, "0.000") & " seconds", vbInformation
    
    Exit Sub
    
ErrorHandler:
    MsgBox "Error: " & Err.Description, vbCritical
End Sub`
            },
            {
                name: 'File System Operations',
                category: 'Advanced',
                desc: 'Read and write text files with proper error handling',
                code: `Option Explicit

Sub FileOperations()
    Dim filePath As String
    Dim fileNum As Integer
    Dim fileContent As String
    Dim line As String
    Dim lineCount As Integer
    
    On Error GoTo ErrorHandler
    
    filePath = ThisWorkbook.Path & "\\output.txt"
    
    ' Write to file
    fileNum = FreeFile
    Open filePath For Output As #fileNum
    Print #fileNum, "=== VBA File Output ==="
    Print #fileNum, "Generated: " & Now
    Print #fileNum, String(50, "=")
    Print #fileNum, ""
    Print #fileNum, "This is sample data written by VBA"
    Print #fileNum, "You can write multiple lines"
    Close #fileNum
    
    MsgBox "File written successfully!", vbInformation
    
    ' Read from file
    fileNum = FreeFile
    lineCount = 0
    Open filePath For Input As #fileNum
    Do Until EOF(fileNum)
        Line Input #fileNum, line
        Debug.Print line
        fileContent = fileContent & line & vbCrLf
        lineCount = lineCount + 1
    Loop
    Close #fileNum
    
    MsgBox "File read successfully!" & vbCrLf & _
           "Lines read: " & lineCount, vbInformation
    
    Exit Sub
    
ErrorHandler:
    On Error Resume Next
    Close #fileNum
    On Error GoTo 0
    MsgBox "File error: " & Err.Description, vbCritical
End Sub`
            },

            // Expert Level
            {
                name: 'Email Automation (Outlook)',
                category: 'Expert',
                desc: 'Send automated emails via Outlook with attachments',
                code: `Option Explicit

Sub SendEmailViaOutlook()
    Dim outlookApp As Object
    Dim mailItem As Object
    Dim ws As Worksheet
    Dim emailBody As String
    
    On Error GoTo ErrorHandler
    
    ' Create Outlook application
    Set outlookApp = CreateObject("Outlook.Application")
    Set mailItem = outlookApp.CreateItem(0) ' olMailItem
    
    Set ws = ThisWorkbook.Worksheets("Sheet1")
    
    ' Create email body
    emailBody = "Dear Recipient," & vbCrLf & vbCrLf
    emailBody = emailBody & "Please find the automated report attached." & vbCrLf & vbCrLf
    emailBody = emailBody & "Report Details:" & vbCrLf
    emailBody = emailBody & "- Generated: " & Now & vbCrLf
    emailBody = emailBody & "- Source: " & ThisWorkbook.Name & vbCrLf & vbCrLf
    emailBody = emailBody & "Best regards," & vbCrLf
    emailBody = emailBody & "Automated VBA System"
    
    With mailItem
        .To = "recipient@example.com"
        .CC = "cc@example.com"
        .Subject = "Automated Report - " & Format(Now, "yyyy-mm-dd hh:nn")
        .Body = emailBody
        
        ' Add attachment (optional)
        ' .Attachments.Add ThisWorkbook.FullName
        
        .Display ' Use .Send to send automatically without displaying
    End With
    
    MsgBox "Email prepared successfully!", vbInformation
    
    Exit Sub
    
ErrorHandler:
    MsgBox "Error sending email: " & Err.Description, vbCritical
End Sub`
            },
            {
                name: 'SQL Database Connection',
                category: 'Expert',
                desc: 'Connect to SQL Server database and execute queries',
                code: `Option Explicit

Sub ConnectToSQLDatabase()
    Dim conn As Object
    Dim rs As Object
    Dim sql As String
    Dim ws As Worksheet
    Dim i As Long
    Dim recordCount As Long
    
    On Error GoTo ErrorHandler
    
    ' Create ADODB connection
    Set conn = CreateObject("ADODB.Connection")
    Set rs = CreateObject("ADODB.Recordset")
    
    ' Connection string (modify with your details)
    conn.ConnectionString = "Provider=SQLOLEDB;" & _
                           "Data Source=YourServerName;" & _
                           "Initial Catalog=YourDatabaseName;" & _
                           "Integrated Security=SSPI;"
    conn.Open
    
    ' SQL query
    sql = "SELECT TOP 100 * FROM YourTableName WHERE Status = 'Active' ORDER BY ID DESC"
    
    ' Execute query
    rs.Open sql, conn
    
    ' Prepare worksheet
    Set ws = ThisWorkbook.Worksheets("Data")
    ws.Cells.Clear
    
    ' Write headers
    For i = 0 To rs.Fields.Count - 1
        ws.Cells(1, i + 1).Value = rs.Fields(i).Name
        ws.Cells(1, i + 1).Font.Bold = True
    Next i
    
    ' Write data
    ws.Range("A2").CopyFromRecordset rs
    recordCount = rs.RecordCount
    
    ' Format as table
    ws.ListObjects.Add(xlSrcRange, ws.UsedRange, , xlYes).Name = "SQLData"
    ws.Columns.AutoFit
    
    ' Clean up
    rs.Close
    conn.Close
    Set rs = Nothing
    Set conn = Nothing
    
    MsgBox "Imported " & recordCount & " records successfully!", vbInformation
    Exit Sub
    
ErrorHandler:
    MsgBox "Database error: " & Err.Description, vbCritical
    On Error Resume Next
    rs.Close
    conn.Close
End Sub`
            },
            {
                name: 'Class Module - Employee',
                category: 'Expert',
                desc: 'Object-oriented programming with custom class',
                code: `Option Explicit

' Class Module: Employee
' Save this in a Class Module named "Employee"

Private pName As String
Private pDepartment As String
Private pSalary As Double
Private pHireDate As Date

' Initialize
Private Sub Class_Initialize()
    pName = ""
    pDepartment = ""
    pSalary = 0
    pHireDate = Date
End Sub

' Property: Name
Public Property Get Name() As String
    Name = pName
End Property

Public Property Let Name(value As String)
    If Len(Trim(value)) > 0 Then
        pName = Trim(value)
    Else
        Err.Raise vbObjectError + 1, "Employee.Name", "Name cannot be empty"
    End If
End Property

' Property: Department
Public Property Get Department() As String
    Department = pDepartment
End Property

Public Property Let Department(value As String)
    pDepartment = value
End Property

' Property: Salary
Public Property Get Salary() As Double
    Salary = pSalary
End Property

Public Property Let Salary(value As Double)
    If value >= 0 Then
        pSalary = value
    Else
        Err.Raise vbObjectError + 2, "Employee.Salary", "Salary cannot be negative"
    End If
End Property

' Property: HireDate
Public Property Get HireDate() As Date
    HireDate = pHireDate
End Property

Public Property Let HireDate(value As Date)
    pHireDate = value
End Property

' Method: GetAnnualSalary
Public Function GetAnnualSalary() As Double
    GetAnnualSalary = pSalary * 12
End Function

' Method: GetYearsOfService
Public Function GetYearsOfService() As Integer
    GetYearsOfService = DateDiff("yyyy", pHireDate, Date)
End Function

' Method: GetFormattedInfo
Public Function GetFormattedInfo() As String
    Dim info As String
    info = "=== Employee Information ===" & vbCrLf
    info = info & "Name: " & pName & vbCrLf
    info = info & "Department: " & pDepartment & vbCrLf
    info = info & "Monthly Salary: $" & Format(pSalary, "#,##0.00") & vbCrLf
    info = info & "Annual Salary: $" & Format(GetAnnualSalary(), "#,##0.00") & vbCrLf
    info = info & "Hire Date: " & Format(pHireDate, "mm/dd/yyyy") & vbCrLf
    info = info & "Years of Service: " & GetYearsOfService() & vbCrLf
    info = info & "=========================="
    GetFormattedInfo = info
End Function

' Usage Example (in standard module):
' Sub TestEmployee()
'     Dim emp As New Employee
'     emp.Name = "John Doe"
'     emp.Department = "IT"
'     emp.Salary = 5000
'     emp.HireDate = #1/15/2020#
'     MsgBox emp.GetFormattedInfo()
' End Sub`
            },
            {
                name: 'Progress Bar Indicator',
                category: 'Expert',
                desc: 'Display progress bar during long operations',
                code: `Option Explicit

Sub ShowProgressBar()
    Dim i As Long
    Dim totalSteps As Long
    Dim percentComplete As Double
    
    totalSteps = 100
    
    ' Create progress form (simplified version)
    Application.StatusBar = "Processing: 0%"
    
    For i = 1 To totalSteps
        ' Your actual processing here
        Application.Wait Now + TimeValue("00:00:01") / 100
        
        ' Update progress
        percentComplete = i / totalSteps
        Application.StatusBar = "Processing: " & Format(percentComplete, "0%") & _
                               " (" & i & " of " & totalSteps & ")"
    Next i
    
    ' Reset status bar
    Application.StatusBar = False
    MsgBox "Process complete!", vbInformation
End Sub`
            },
            {
                name: 'Array Processing (High Speed)',
                category: 'Expert',
                desc: 'Process large datasets using arrays instead of cells',
                code: `Option Explicit

Sub ArrayProcessing()
    Dim ws As Worksheet
    Dim dataArray As Variant
    Dim outputArray() As Variant
    Dim lastRow As Long
    Dim i As Long
    Dim startTime As Double
    
    On Error GoTo ErrorHandler
    
    startTime = Timer
    Set ws = ThisWorkbook.Worksheets("Sheet1")
    
    ' Turn off screen updating
    Application.ScreenUpdating = False
    
    ' Read entire range into array (FAST)
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    dataArray = ws.Range("A1:B" & lastRow).Value
    
    ' Prepare output array
    ReDim outputArray(1 To UBound(dataArray, 1), 1 To 1)
    
    ' Process array (VERY FAST)
    For i = 1 To UBound(dataArray, 1)
        If IsNumeric(dataArray(i, 1)) And IsNumeric(dataArray(i, 2)) Then
            outputArray(i, 1) = dataArray(i, 1) * dataArray(i, 2)
        Else
            outputArray(i, 1) = 0
        End If
    Next i
    
    ' Write entire array back to sheet (FAST)
    ws.Range("C1").Resize(UBound(outputArray, 1), 1).Value = outputArray
    
    Application.ScreenUpdating = True
    
    MsgBox "Processed " & lastRow & " rows in " & _
           Format(Timer - startTime, "0.000") & " seconds!", vbInformation
    Exit Sub
    
ErrorHandler:
    Application.ScreenUpdating = True
    MsgBox "Error: " & Err.Description, vbCritical
End Sub`
            },
            {
                name: 'Custom Function (UDF)',
                category: 'Expert',
                desc: 'Create custom Excel function usable in worksheets',
                code: `Option Explicit

' Custom function to calculate compound interest
' Usage in Excel: =CompoundInterest(1000, 5, 10)
Public Function CompoundInterest(principal As Double, rate As Double, years As Integer) As Double
    ' Formula: A = P(1 + r/n)^(nt)
    ' Assuming annual compounding (n=1)
    CompoundInterest = principal * ((1 + rate / 100) ^ years)
End Function

' Custom function to get letter grade
' Usage in Excel: =GetLetterGrade(85)
Public Function GetLetterGrade(score As Integer) As String
    Select Case score
        Case Is >= 90
            GetLetterGrade = "A"
        Case Is >= 80
            GetLetterGrade = "B"
        Case Is >= 70
            GetLetterGrade = "C"
        Case Is >= 60
            GetLetterGrade = "D"
        Case Else
            GetLetterGrade = "F"
    End Select
End Function

' Custom function to count words
' Usage in Excel: =WordCount(A1)
Public Function WordCount(text As String) As Integer
    Dim words() As String
    If Len(Trim(text)) = 0 Then
        WordCount = 0
    Else
        words = Split(Trim(text), " ")
        WordCount = UBound(words) + 1
    End If
End Function

' Custom function to remove numbers from text
' Usage in Excel: =RemoveNumbers("Test123")
Public Function RemoveNumbers(text As String) As String
    Dim i As Integer
    Dim result As String
    
    For i = 1 To Len(text)
        If Not IsNumeric(Mid(text, i, 1)) Then
            result = result & Mid(text, i, 1)
        End If
    Next i
    
    RemoveNumbers = result
End Function`
            },
            {
                name: 'Pivot Table Creator',
                category: 'Expert',
                desc: 'Automatically create and configure pivot tables',
                code: `Option Explicit

Sub CreatePivotTable()
    Dim ws As Worksheet
    Dim pvtWs As Worksheet
    Dim pvtCache As PivotCache
    Dim pvtTable As PivotTable
    Dim dataRange As Range
    Dim lastRow As Long
    
    On Error GoTo ErrorHandler
    
    ' Source data
    Set ws = ThisWorkbook.Worksheets("Data")
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    Set dataRange = ws.Range("A1:D" & lastRow)
    
    ' Create or clear pivot worksheet
    On Error Resume Next
    Set pvtWs = ThisWorkbook.Worksheets("PivotReport")
    If pvtWs Is Nothing Then
        Set pvtWs = ThisWorkbook.Worksheets.Add
        pvtWs.Name = "PivotReport"
    Else
        pvtWs.Cells.Clear
    End If
    On Error GoTo ErrorHandler
    
    ' Create pivot cache
    Set pvtCache = ThisWorkbook.PivotCaches.Create( _
        SourceType:=xlDatabase, _
        SourceData:=dataRange)
    
    ' Create pivot table
    Set pvtTable = pvtCache.CreatePivotTable( _
        TableDestination:=pvtWs.Range("A1"), _
        TableName:="SalesPivot")
    
    ' Configure pivot table
    With pvtTable
        ' Add fields (adjust based on your data)
        .PivotFields("Category").Orientation = xlRowField
        .PivotFields("Product").Orientation = xlRowField
        .PivotFields("Month").Orientation = xlColumnField
        
        ' Add data field
        With .PivotFields("Sales")
            .Orientation = xlDataField
            .Function = xlSum
            .NumberFormat = "$#,##0.00"
        End With
        
        ' Apply style
        .TableStyle2 = "PivotStyleMedium2"
    End With
    
    ' Auto-fit columns
    pvtWs.Columns.AutoFit
    
    MsgBox "Pivot table created successfully!", vbInformation
    Exit Sub
    
ErrorHandler:
    MsgBox "Error creating pivot table: " & Err.Description, vbCritical
End Sub`
            },
            {
                name: 'Web Scraping Basics',
                category: 'Expert',
                desc: 'Extract data from websites using VBA',
                code: `Option Explicit

Sub WebScraping()
    Dim IE As Object
    Dim doc As Object
    Dim ws As Worksheet
    Dim url As String
    
    On Error GoTo ErrorHandler
    
    ' Set URL
    url = "https://example.com"
    
    ' Create Internet Explorer object
    Set IE = CreateObject("InternetExplorer.Application")
    IE.Visible = False
    IE.Navigate url
    
    ' Wait for page to load
    Do While IE.Busy Or IE.ReadyState <> 4
        DoEvents
    Loop
    
    Set doc = IE.Document
    Set ws = ThisWorkbook.Worksheets("WebData")
    
    ' Extract data (example - modify based on website structure)
    ' ws.Range("A1").Value = doc.getElementById("title").innerText
    ' ws.Range("A2").Value = doc.getElementsByTagName("p")(0).innerText
    
    ' Clean up
    IE.Quit
    Set IE = Nothing
    
    MsgBox "Web scraping completed!", vbInformation
    Exit Sub
    
ErrorHandler:
    If Not IE Is Nothing Then IE.Quit
    MsgBox "Error: " & Err.Description, vbCritical
End Sub`
            },
            {
                name: 'Advanced Error Handling with Logging',
                category: 'Expert',
                desc: 'Comprehensive error handling with error logging to file',
                code: `Option Explicit

Sub AdvancedErrorHandling()
    On Error GoTo ErrorHandler
    
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Worksheets(1)
    
    ' Your code here
    ws.Range("A1").Value = 100 / 0  ' This will trigger error
    
    Exit Sub
    
ErrorHandler:
    Dim errorLog As String
    Dim errorFile As String
    Dim fileNum As Integer
    
    ' Create error log entry
    errorLog = "Error " & Err.Number & " at " & Now & vbCrLf
    errorLog = errorLog & "Description: " & Err.Description & vbCrLf
    errorLog = errorLog & "Procedure: AdvancedErrorHandling" & vbCrLf
    errorLog = errorLog & "---" & vbCrLf
    
    ' Write to log file
    errorFile = ThisWorkbook.Path & "\\ErrorLog.txt"
    fileNum = FreeFile
    Open errorFile For Append As #fileNum
    Print #fileNum, errorLog
    Close #fileNum
    
    ' Notify user
    MsgBox "An error occurred and has been logged." & vbCrLf & _
           "Error: " & Err.Description, vbExclamation
End Sub`
            },
            {
                name: 'Simple Class Module',
                category: 'Expert',
                desc: 'Basic class module structure for object-oriented programming',
                code: `' Class Module: Employee
' Save as clsEmployee

Option Explicit

' Private variables
Private m_Name As String
Private m_ID As Long
Private m_Salary As Currency

' Property Let (Setter)
Public Property Let Name(value As String)
    m_Name = value
End Property

' Property Get (Getter)
Public Property Get Name() As String
    Name = m_Name
End Property

Public Property Let ID(value As Long)
    m_ID = value
End Property

Public Property Get ID() As Long
    ID = m_ID
End Property

Public Property Let Salary(value As Currency)
    m_Salary = value
End Property

Public Property Get Salary() As Currency
    Salary = m_Salary
End Property

' Method
Public Function GetAnnualSalary() As Currency
    GetAnnualSalary = m_Salary * 12
End Function

' Usage in Standard Module:
' Dim emp As New clsEmployee
' emp.Name = "John Doe"
' emp.ID = 12345
' emp.Salary = 5000
' MsgBox emp.GetAnnualSalary()`
            },
            {
                name: 'Chart Creation & Formatting',
                category: 'Expert',
                desc: 'Create and format professional charts programmatically',
                code: `Option Explicit

Sub CreateChart()
    Dim ws As Worksheet
    Dim dataRange As Range
    Dim chartObj As ChartObject
    Dim chart As Chart
    
    Set ws = ThisWorkbook.Worksheets("Sheet1")
    
    ' Define data range
    Set dataRange = ws.Range("A1:B10")
    
    ' Create chart
    Set chartObj = ws.ChartObjects.Add(300, 50, 400, 300)
    Set chart = chartObj.Chart
    
    With chart
        ' Set chart type
        .ChartType = xlColumnClustered
        
        ' Set data source
        .SetSourceData dataRange
        
        ' Add title
        .HasTitle = True
        .ChartTitle.Text = "Sales by Month"
        .ChartTitle.Font.Size = 16
        .ChartTitle.Font.Bold = True
        
        ' Format axes
        With .Axes(xlCategory)
            .HasTitle = True
            .AxisTitle.Text = "Month"
        End With
        
        With .Axes(xlValue)
            .HasTitle = True
            .AxisTitle.Text = "Sales ($)"
            .MinimumScale = 0
        End With
        
        ' Format plot area
        .PlotArea.Format.Fill.ForeColor.RGB = RGB(240, 248, 255)
        
        ' Add data labels
        .SeriesCollection(1).HasDataLabels = True
        
        ' Format legend
        .HasLegend = True
        .Legend.Position = xlLegendPositionBottom
    End With
    
    MsgBox "Chart created successfully!", vbInformation
End Sub`
            },
            {
                name: 'Email via Outlook Automation',
                category: 'Expert',
                desc: 'Send emails with attachments using Outlook automation',
                code: `Option Explicit

Sub SendEmailViaOutlook()
    Dim outlookApp As Object
    Dim outlookMail As Object
    Dim attachment As String
    
    On Error GoTo ErrorHandler
    
    ' Create Outlook application object
    Set outlookApp = CreateObject("Outlook.Application")
    Set outlookMail = outlookApp.CreateItem(0)
    
    ' Set attachment path (optional)
    attachment = ThisWorkbook.Path & "\\Report.xlsx"
    
    With outlookMail
        .To = "recipient@example.com"
        .CC = "cc@example.com"
        .BCC = ""
        .Subject = "Monthly Report - " & Format(Now, "MMMM YYYY")
        .Body = "Dear Team," & vbCrLf & vbCrLf & _
                "Please find attached the monthly report." & vbCrLf & vbCrLf & _
                "Best regards"
        
        ' Add attachment if file exists
        If Dir(attachment) <> "" Then
            .Attachments.Add attachment
        End If
        
        .Display  ' Use .Send to send automatically
    End With
    
    Set outlookMail = Nothing
    Set outlookApp = Nothing
    
    MsgBox "Email created successfully!", vbInformation
    Exit Sub
    
ErrorHandler:
    MsgBox "Error sending email: " & Err.Description, vbCritical
End Sub`
            },
            {
                name: 'SQL Database Connection',
                category: 'Expert',
                desc: 'Connect to SQL Server database and retrieve data',
                code: `Option Explicit

Sub ConnectToSQLDatabase()
    Dim conn As Object
    Dim rs As Object
    Dim ws As Worksheet
    Dim query As String
    Dim i As Long
    
    On Error GoTo ErrorHandler
    
    ' Create connection object
    Set conn = CreateObject("ADODB.Connection")
    Set rs = CreateObject("ADODB.Recordset")
    Set ws = ThisWorkbook.Worksheets("Data")
    
    ' Connection string (modify for your database)
    conn.ConnectionString = "Provider=SQLOLEDB;" & _
                           "Data Source=ServerName;" & _
                           "Initial Catalog=DatabaseName;" & _
                           "Integrated Security=SSPI;"
    
    ' Open connection
    conn.Open
    
    ' SQL query
    query = "SELECT * FROM Customers WHERE Country = 'USA'"
    
    ' Execute query
    rs.Open query, conn
    
    ' Clear existing data
    ws.Cells.Clear
    
    ' Write headers
    For i = 0 To rs.Fields.Count - 1
        ws.Cells(1, i + 1).Value = rs.Fields(i).Name
    Next i
    
    ' Write data
    ws.Range("A2").CopyFromRecordset rs
    
    ' Clean up
    rs.Close
    conn.Close
    Set rs = Nothing
    Set conn = Nothing
    
    MsgBox "Data retrieved successfully!", vbInformation
    Exit Sub
    
ErrorHandler:
    If Not rs Is Nothing Then If rs.State = 1 Then rs.Close
    If Not conn Is Nothing Then If conn.State = 1 Then conn.Close
    MsgBox "Database error: " & Err.Description, vbCritical
End Sub`
            },
            {
                name: 'XML File Import/Export',
                category: 'Expert',
                desc: 'Import and export data using XML format',
                code: `Option Explicit

Sub ExportToXML()
    Dim ws As Worksheet
    Dim xmlFile As String
    Dim fileNum As Integer
    Dim row As Long
    Dim xmlContent As String
    
    Set ws = ThisWorkbook.Worksheets("Data")
    xmlFile = ThisWorkbook.Path & "\\export.xml"
    fileNum = FreeFile
    
    ' Build XML content
    xmlContent = "<?xml version=""1.0"" encoding=""UTF-8""?>" & vbCrLf
    xmlContent = xmlContent & "<Records>" & vbCrLf
    
    For row = 2 To ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
        xmlContent = xmlContent & "  <Record>" & vbCrLf
        xmlContent = xmlContent & "    <ID>" & ws.Cells(row, 1).Value & "</ID>" & vbCrLf
        xmlContent = xmlContent & "    <Name>" & ws.Cells(row, 2).Value & "</Name>" & vbCrLf
        xmlContent = xmlContent & "    <Value>" & ws.Cells(row, 3).Value & "</Value>" & vbCrLf
        xmlContent = xmlContent & "  </Record>" & vbCrLf
    Next row
    
    xmlContent = xmlContent & "</Records>"
    
    ' Write to file
    Open xmlFile For Output As #fileNum
    Print #fileNum, xmlContent
    Close #fileNum
    
    MsgBox "Data exported to XML successfully!" & vbCrLf & xmlFile, vbInformation
End Sub`
            },
            {
                name: 'Multi-Criteria Dynamic Filter',
                category: 'Intermediate',
                desc: 'Apply dynamic filters based on multiple criteria',
                code: `Option Explicit

Sub DynamicFilter()
    Dim ws As Worksheet
    Dim dataRange As Range
    Dim lastRow As Long
    Dim criteria1 As String
    Dim criteria2 As String
    
    Set ws = ThisWorkbook.Worksheets("Data")
    lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
    Set dataRange = ws.Range("A1:D" & lastRow)
    
    ' Get filter criteria from user
    criteria1 = InputBox("Enter first filter criteria (e.g., Sales):")
    criteria2 = InputBox("Enter second filter criteria (e.g., >1000):")
    
    If criteria1 = "" Or criteria2 = "" Then
        MsgBox "Filter cancelled", vbInformation
        Exit Sub
    End If
    
    ' Clear existing filters
    If ws.AutoFilterMode Then ws.AutoFilterMode = False
    
    ' Apply AutoFilter
    dataRange.AutoFilter
    
    ' Apply multiple criteria
    dataRange.AutoFilter Field:=2, Criteria1:=criteria1
    dataRange.AutoFilter Field:=3, Criteria1:=criteria2
    
    MsgBox "Filter applied: " & criteria1 & " and " & criteria2, vbInformation
End Sub`
            },
            {
                name: 'Progress Bar with UserForm',
                category: 'Expert',
                desc: 'Create a progress bar to show macro progress',
                code: `' UserForm code (frmProgress)
' Add a Label called lblProgress and Frame called frameProgress

Option Explicit

Public Sub ShowProgress(percent As Double)
    Me.lblProgress.Width = Me.frameProgress.Width * (percent / 100)
    Me.lblProgress.Caption = Format(percent, "0") & "%"
    DoEvents
End Sub

' Standard Module code:
Sub LongRunningTask()
    Dim i As Long
    Dim totalItems As Long
    Dim progress As Double
    
    totalItems = 1000
    
    ' Show progress form
    Load frmProgress
    frmProgress.Show vbModeless
    
    For i = 1 To totalItems
        ' Your actual work here
        DoEvents
        
        ' Update progress
        progress = (i / totalItems) * 100
        frmProgress.ShowProgress progress
    Next i
    
    ' Clean up
    Unload frmProgress
    MsgBox "Task completed!", vbInformation
End Sub`
            },
            {
                name: 'Data Validation Automation',
                category: 'Intermediate',
                desc: 'Programmatically create data validation rules',
                code: `Option Explicit

Sub CreateDataValidation()
    Dim ws As Worksheet
    Dim validationRange As Range
    
    Set ws = ThisWorkbook.Worksheets("Sheet1")
    Set validationRange = ws.Range("A2:A100")
    
    ' Clear existing validation
    validationRange.Validation.Delete
    
    ' Create dropdown list validation
    With validationRange.Validation
        .Delete
        .Add Type:=xlValidateList, _
             AlertStyle:=xlValidAlertStop, _
             Formula1:="Yes,No,Maybe"
        .IgnoreBlank = True
        .InCellDropdown = True
        .InputTitle = "Select Option"
        .ErrorTitle = "Invalid Entry"
        .InputMessage = "Please select from the dropdown list"
        .ErrorMessage = "You must select Yes, No, or Maybe"
        .ShowInput = True
        .ShowError = True
    End With
    
    ' Create numeric range validation
    Set validationRange = ws.Range("B2:B100")
    validationRange.Validation.Delete
    
    With validationRange.Validation
        .Add Type:=xlValidateWholeNumber, _
             AlertStyle:=xlValidAlertStop, _
             Operator:=xlBetween, _
             Formula1:="1", _
             Formula2:="100"
        .InputTitle = "Enter Number"
        .ErrorTitle = "Invalid Number"
        .InputMessage = "Enter a number between 1 and 100"
        .ErrorMessage = "Number must be between 1 and 100"
        .ShowInput = True
        .ShowError = True
    End With
    
    MsgBox "Data validation rules created!", vbInformation
End Sub`
            },
            {
                name: 'Workbook Protection & Unprotection',
                category: 'Intermediate',
                desc: 'Protect and unprotect worksheets with password',
                code: `Option Explicit

Sub ProtectWorkbook()
    Dim ws As Worksheet
    Dim password As String
    
    password = "SecurePassword123"  ' Change this
    
    ' Protect each worksheet
    For Each ws In ThisWorkbook.Worksheets
        ws.Protect password:=password, _
                   DrawingObjects:=True, _
                   Contents:=True, _
                   Scenarios:=True, _
                   AllowFiltering:=True, _
                   AllowSorting:=True, _
                   AllowFormattingCells:=False
    Next ws
    
    ' Protect workbook structure
    ThisWorkbook.Protect password:=password, Structure:=True, Windows:=False
    
    MsgBox "Workbook protected successfully!", vbInformation
End Sub

Sub UnprotectWorkbook()
    Dim ws As Worksheet
    Dim password As String
    
    password = "SecurePassword123"  ' Must match protection password
    
    On Error GoTo ErrorHandler
    
    ' Unprotect workbook
    ThisWorkbook.Unprotect password
    
    ' Unprotect each worksheet
    For Each ws In ThisWorkbook.Worksheets
        ws.Unprotect password
    Next ws
    
    MsgBox "Workbook unprotected successfully!", vbInformation
    Exit Sub
    
ErrorHandler:
    MsgBox "Incorrect password!", vbExclamation
End Sub`
            },
            {
                name: 'Conditional Formatting Automation',
                category: 'Intermediate',
                desc: 'Apply complex conditional formatting rules programmatically',
                code: `Option Explicit

Sub ApplyConditionalFormatting()
    Dim ws As Worksheet
    Dim dataRange As Range
    
    Set ws = ThisWorkbook.Worksheets("Sheet1")
    Set dataRange = ws.Range("A1:A100")
    
    ' Clear existing formatting
    dataRange.FormatConditions.Delete
    
    ' Rule 1: Highlight values > 100 in green
    With dataRange.FormatConditions.Add(xlCellValue, xlGreater, "=100")
        .Interior.Color = RGB(144, 238, 144)  ' Light green
        .Font.Color = RGB(0, 100, 0)  ' Dark green
        .Font.Bold = True
    End With
    
    ' Rule 2: Highlight values < 50 in red
    With dataRange.FormatConditions.Add(xlCellValue, xlLess, "=50")
        .Interior.Color = RGB(255, 182, 193)  ' Light red
        .Font.Color = RGB(139, 0, 0)  ' Dark red
        .Font.Bold = True
    End With
    
    ' Rule 3: Data bars for range
    Set dataRange = ws.Range("B1:B100")
    dataRange.FormatConditions.Delete
    
    With dataRange.FormatConditions.AddDatabar
        .BarColor.Color = RGB(0, 176, 240)  ' Blue
        .BarFillType = xlDataBarFillGradient
        .Direction = xlContext
        .ShowValue = True
    End With
    
    ' Rule 4: Color scale
    Set dataRange = ws.Range("C1:C100")
    dataRange.FormatConditions.Delete
    
    With dataRange.FormatConditions.AddColorScale(ColorScaleType:=3)
        ' Minimum = Red
        .ColorScaleCriteria(1).Type = xlConditionValueLowestValue
        .ColorScaleCriteria(1).FormatColor.Color = RGB(255, 0, 0)
        
        ' Midpoint = Yellow
        .ColorScaleCriteria(2).Type = xlConditionValuePercentile
        .ColorScaleCriteria(2).Value = 50
        .ColorScaleCriteria(2).FormatColor.Color = RGB(255, 255, 0)
        
        ' Maximum = Green
        .ColorScaleCriteria(3).Type = xlConditionValueHighestValue
        .ColorScaleCriteria(3).FormatColor.Color = RGB(0, 255, 0)
    End With
    
    MsgBox "Conditional formatting applied!", vbInformation
End Sub`
            },
            {
                name: 'Array Formula Automation',
                category: 'Expert',
                desc: 'Create and manage array formulas programmatically',
                code: `Option Explicit

Sub CreateArrayFormulas()
    Dim ws As Worksheet
    Dim formulaRange As Range
    
    Set ws = ThisWorkbook.Worksheets("Sheet1")
    
    ' Example 1: SUMPRODUCT array formula
    ws.Range("E2").Formula = "=SUMPRODUCT((A2:A100>50)*(B2:B100<100)*C2:C100)"
    
    ' Example 2: Multi-cell array formula
    Set formulaRange = ws.Range("F2:F10")
    formulaRange.FormulaArray = "=IF(A2:A10>AVERAGE(A:A),""Above"",""Below"")"
    
    ' Example 3: Dynamic array formula (Excel 365)
    ws.Range("G2").Formula = "=UNIQUE(A2:A100)"
    
    ' Example 4: Transpose array
    ws.Range("H1:H10").FormulaArray = "=TRANSPOSE(A1:J1)"
    
    ' Example 5: Array calculation
    ws.Range("I2").FormulaArray = "=SUM(A2:A10*B2:B10)"
    
    MsgBox "Array formulas created!", vbInformation
End Sub`
            },
            {
                name: 'Backup & Version Control',
                category: 'Intermediate',
                desc: 'Create automatic backups with timestamps',
                code: `Option Explicit

Sub CreateBackup()
    Dim backupPath As String
    Dim backupName As String
    Dim timestamp As String
    Dim originalName As String
    
    ' Create timestamp
    timestamp = Format(Now, "YYYY-MM-DD_HH-NN-SS")
    originalName = ThisWorkbook.Name
    
    ' Remove extension
    originalName = Left(originalName, InStrRev(originalName, ".") - 1)
    
    ' Create backup folder if it doesn't exist
    backupPath = ThisWorkbook.Path & "\\Backups\\"
    If Dir(backupPath, vbDirectory) = "" Then
        MkDir backupPath
    End If
    
    ' Create backup filename
    backupName = backupPath & originalName & "_" & timestamp & ".xlsx"
    
    ' Save backup
    ThisWorkbook.SaveCopyAs backupName
    
    MsgBox "Backup created successfully!" & vbCrLf & backupName, vbInformation
End Sub

Sub AutoBackupOnSave()
    ' Add this to ThisWorkbook module:
    ' Private Sub Workbook_BeforeSave(ByVal SaveAsUI As Boolean, Cancel As Boolean)
    '     CreateBackup
    ' End Sub
End Sub`
            }
        ];

        // Comprehensive Formula Library (combinations)
        const formulaCombinations = [
            {
                name: 'INDEX-MATCH (Better than VLOOKUP)',
                category: 'Lookup Combo',
                desc: 'Flexible lookup that can search left or right',
                syntax: '=INDEX(return_range, MATCH(lookup_value, lookup_range, 0))',
                example: '=INDEX(B2:B100, MATCH(E2, A2:A100, 0))'
            },
            {
                name: 'INDEX-MATCH-MATCH (2D Lookup)',
                category: 'Lookup Combo',
                desc: 'Lookup based on row AND column criteria',
                syntax: '=INDEX(data_range, MATCH(row_value, row_range, 0), MATCH(col_value, col_range, 0))',
                example: '=INDEX(B2:E10, MATCH("Product A", A2:A10, 0), MATCH("Q1", B1:E1, 0))'
            },
            {
                name: 'SUMIFS with Multiple Criteria',
                category: 'Math Combo',
                desc: 'Sum values meeting multiple conditions',
                syntax: '=SUMIFS(sum_range, criteria_range1, criteria1, criteria_range2, criteria2)',
                example: '=SUMIFS(D:D, A:A, "North", B:B, "Electronics", C:C, ">100")'
            },
            {
                name: 'SUMPRODUCT for Weighted Average',
                category: 'Math Combo',
                desc: 'Calculate weighted average using SUMPRODUCT',
                syntax: '=SUMPRODUCT(values, weights) / SUM(weights)',
                example: '=SUMPRODUCT(B2:B10, C2:C10) / SUM(C2:C10)'
            },
            {
                name: 'COUNTIFS with Date Range',
                category: 'Math Combo',
                desc: 'Count entries within date range',
                syntax: '=COUNTIFS(date_range, ">="&start_date, date_range, "<="&end_date)',
                example: '=COUNTIFS(A2:A100, ">="&DATE(2024,1,1), A2:A100, "<="&DATE(2024,12,31))'
            },
            {
                name: 'Nested IF for Multiple Conditions',
                category: 'Logical Combo',
                desc: 'Multiple condition checking with nested IF statements',
                syntax: '=IF(condition1, result1, IF(condition2, result2, IF(condition3, result3, default)))',
                example: '=IF(A1>=90, "A", IF(A1>=80, "B", IF(A1>=70, "C", "F")))'
            },
            {
                name: 'IF with AND for Multiple Criteria',
                category: 'Logical Combo',
                desc: 'Check if ALL conditions are true',
                syntax: '=IF(AND(condition1, condition2, condition3), value_if_true, value_if_false)',
                example: '=IF(AND(A1>100, B1="Active", C1<50), "Yes", "No")'
            },
            {
                name: 'IF with OR for Any Criteria',
                category: 'Logical Combo',
                desc: 'Check if ANY condition is true',
                syntax: '=IF(OR(condition1, condition2, condition3), value_if_true, value_if_false)',
                example: '=IF(OR(A1="Red", A1="Blue", A1="Green"), "Primary Color", "Other")'
            },
            {
                name: 'IFERROR with VLOOKUP',
                category: 'Lookup Combo',
                desc: 'Handle VLOOKUP errors gracefully',
                syntax: '=IFERROR(VLOOKUP(...), "Not Found")',
                example: '=IFERROR(VLOOKUP(A1, $D$1:$E$100, 2, FALSE), "Not Found")'
            },
            {
                name: 'Dynamic Drop-Down with OFFSET',
                category: 'Data Validation Combo',
                desc: 'Create dropdown list that automatically expands',
                syntax: '=OFFSET($A$1, 0, 0, COUNTA($A:$A), 1)',
                example: 'Use in Data Validation > List > Source'
            },
            {
                name: 'Remove Duplicates with UNIQUE',
                category: 'Array Combo',
                desc: 'Extract only unique values from list (Excel 365)',
                syntax: '=UNIQUE(range)',
                example: '=UNIQUE(A2:A100)'
            },
            {
                name: 'Sort and Filter Combined',
                category: 'Array Combo',
                desc: 'Filter data then sort results (Excel 365)',
                syntax: '=SORT(FILTER(data, criteria))',
                example: '=SORT(FILTER(A2:C100, B2:B100>100), 3, -1)'
            },
            {
                name: 'Text Extraction - First Word',
                category: 'Text Combo',
                desc: 'Extract first word from text',
                syntax: '=LEFT(text, FIND(" ", text)-1)',
                example: '=LEFT(A1, FIND(" ", A1)-1)'
            },
            {
                name: 'Text Extraction - Last Word',
                category: 'Text Combo',
                desc: 'Extract last word from text',
                syntax: '=TRIM(RIGHT(SUBSTITUTE(text," ",REPT(" ",100)),100))',
                example: '=TRIM(RIGHT(SUBSTITUTE(A1," ",REPT(" ",100)),100))'
            },
            {
                name: 'Conditional Formatting - Highlight Duplicates',
                category: 'Formatting Combo',
                desc: 'Formula for conditional formatting to highlight duplicates',
                syntax: '=COUNTIF($A:$A, A1)>1',
                example: 'Apply to range A:A in conditional formatting'
            },
            {
                name: 'Running Total',
                category: 'Math Combo',
                desc: 'Calculate cumulative sum',
                syntax: '=SUM($A$1:A1)',
                example: 'Drag formula down for running total'
            },
            {
                name: 'Percentage of Total',
                category: 'Math Combo',
                desc: 'Calculate percentage contribution',
                syntax: '=value / $total$ * 100',
                example: '=A1/$A$100*100'
            },
            {
                name: 'Age Calculator from Birthdate',
                category: 'Date Combo',
                desc: 'Calculate exact age in years',
                syntax: '=DATEDIF(birthdate, TODAY(), "Y")',
                example: '=DATEDIF(A1, TODAY(), "Y")'
            },
            {
                name: 'Days Until/Since Event',
                category: 'Date Combo',
                desc: 'Calculate days between today and event date',
                syntax: '=event_date - TODAY()',
                example: '=A1-TODAY()'
            },
            {
                name: 'Working Days Between Dates',
                category: 'Date Combo',
                desc: 'Count business days excluding weekends',
                syntax: '=NETWORKDAYS(start_date, end_date, [holidays])',
                example: '=NETWORKDAYS(A1, B1, $H$1:$H$10)'
            },
            {
                name: 'Extract Numbers from Text',
                category: 'Text Combo',
                desc: 'Get only numeric characters from mixed text',
                syntax: '=SUMPRODUCT(MID(0&text,LARGE(INDEX(ISNUMBER(--MID(text,ROW($1:$25),1))*ROW($1:$25),0),ROW($1:$25))+1,1)*10^ROW($1:$25)/10)',
                example: 'Complex array formula - extracts "123" from "ABC123XYZ"'
            },
            {
                name: 'Rank with Ties',
                category: 'Math Combo',
                desc: 'Rank values allowing for ties',
                syntax: '=RANK(value, range, [order])',
                example: '=RANK(A1, $A$1:$A$100, 0)'
            },
            {
                name: 'Find nth Occurrence',
                category: 'Lookup Combo',
                desc: 'Find the nth match in a list',
                syntax: '=INDEX(return_range, SMALL(IF(criteria_range=criteria, ROW(criteria_range)-MIN(ROW(criteria_range))+1), n))',
                example: 'Array formula: {=INDEX($B$2:$B$100, SMALL(IF($A$2:$A$100="Active", ROW($A$2:$A$100)-1), 2))}'
            },
            {
                name: 'Concatenate Range with Delimiter',
                category: 'Text Combo',
                desc: 'Join multiple cells with separator',
                syntax: '=TEXTJOIN(delimiter, ignore_empty, range)',
                example: '=TEXTJOIN(", ", TRUE, A1:A10)'
            },
            {
                name: 'Conditional Sum with Multiple OR Criteria',
                category: 'Math Combo',
                desc: 'Sum if value matches any of several criteria',
                syntax: '=SUMIF(range, criteria1) + SUMIF(range, criteria2) + SUMIF(range, criteria3)',
                example: '=SUMIF(A:A, "Red") + SUMIF(A:A, "Blue") + SUMIF(A:A, "Green")'
            }
        ];

        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        // RESPONSIVE UTILITIES (Mobile/Desktop Detection & Adaptation)
        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        
        // Debounce function for resize events
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Handle responsive layout changes
        function handleResponsiveResize() {
            try {
                const sidebar = document.getElementById('mainSidebar');
                if (!sidebar) return;
                
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    // Mobile: remove desktop collapsed class, sidebar hidden by default
                    sidebar.classList.remove('collapsed');
                    sidebar.classList.remove('mobile-open');
                    document.body.classList.remove('nav-collapsed');
                } else {
                    // Desktop: remove mobile-open class if it exists
                    sidebar.classList.remove('mobile-open');
                    // Keep collapsed state if it was set
                }
            } catch (e) {
                console.warn('Responsive resize handler error (non-critical):', e);
            }
        }
        
        // Add resize listener with debouncing
        if (typeof window !== 'undefined') {
            window.addEventListener('resize', debounce(handleResponsiveResize, 250));
        }
        
        // Prevent horizontal scroll on mobile
        function preventHorizontalScroll() {
            try {
                if (window.innerWidth <= 768) {
                    document.body.style.overflowX = 'hidden';
                    document.documentElement.style.overflowX = 'hidden';
                } else {
                    document.body.style.overflowX = '';
                    document.documentElement.style.overflowX = '';
                }
            } catch (e) {
                console.warn('Prevent horizontal scroll error (non-critical):', e);
            }
        }
        
        // Call on load and resize
        if (typeof window !== 'undefined') {
            window.addEventListener('load', preventHorizontalScroll);
            window.addEventListener('resize', debounce(preventHorizontalScroll, 250));
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', initApp);

        function initApp() {
            try {
                console.log('Initializing VBA Code Editor...');
                
                setupCodeEditor();
                console.log('✓ Code editor setup complete');
                
                setupFormulaInput();
                console.log('✓ Formula input setup complete');
                
                setupExecInput();
                console.log('✓ Execution tool setup complete');
                
                loadTemplates();
                console.log('✓ Templates loaded');
                
                loadFunctionLibrary();
                console.log('✓ Function library loaded');
                
                loadOperatorLibrary();
                console.log('✓ Operator library loaded');
                
                loadConstantLibrary();
                console.log('✓ Constant library loaded');
                
                loadCriteriaLibrary();
                console.log('✓ Criteria expressions loaded');
                
                updateTime();
                setInterval(updateTime, 1000);
                console.log('✓ Time update initialized');
                
                console.log('🎉 VBA Code Editor initialized successfully!');
            } catch (error) {
                console.error('❌ Error during initialization:', error);
                alert('Error initializing editor. Please check console for details.\n\nError: ' + error.message);
            }
        }

        // Code Editor Setup
        function setupCodeEditor() {
            const codeInput = document.getElementById('codeInput');
            const codeHighlight = document.getElementById('codeHighlight');
            const lineNumbers = document.getElementById('lineNumbers');

            if (!codeInput || !codeHighlight || !lineNumbers) return;

            // Sync scroll positions
            function syncScroll() {
                if (codeHighlight) {
                    codeHighlight.scrollTop = codeInput.scrollTop;
                    codeHighlight.scrollLeft = codeInput.scrollLeft;
                }
                if (lineNumbers) {
                    lineNumbers.scrollTop = codeInput.scrollTop;
                }
            }

            codeInput.addEventListener('input', function() {
                updateSyntaxHighlighting();
                updateLineNumbers();
                performLiveAnalysis();
                // Sync scroll after input (important for paste)
                setTimeout(syncScroll, 0);
            });

            codeInput.addEventListener('scroll', syncScroll);

            // Handle paste specifically
            codeInput.addEventListener('paste', function(e) {
                setTimeout(() => {
                    updateSyntaxHighlighting();
                    updateLineNumbers();
                    syncScroll();
                    performLiveAnalysis();
                }, 10);
            });

            codeInput.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 4;
                    updateSyntaxHighlighting();
                    updateLineNumbers();
                    syncScroll();
                }
                // Ensure Enter creates new line and updates line numbers
                if (e.key === 'Enter') {
                    // Let default behavior happen (create new line)
                    // Then update line numbers
                    setTimeout(() => {
                        updateLineNumbers();
                        updateSyntaxHighlighting();
                        syncScroll();
                    }, 0);
                }
            });

            updateLineNumbers();
        }

        function updateSyntaxHighlighting() {
            const codeInput = document.getElementById('codeInput');
            const codeHighlight = document.getElementById('codeHighlight');
            if (!codeInput || !codeHighlight) return;
            
            let code = codeInput.value;
            if (!code) {
                codeHighlight.innerHTML = '';
                return;
            }
            
            // Start with the raw code
            let result = '';
            let i = 0;
            
            while (i < code.length) {
                let matched = false;
                
                // Check for comments (highest priority)
                if (code[i] === "'" || (code[i] === 'R' && code.substr(i, 3) === 'REM')) {
                    const start = i;
                    while (i < code.length && code[i] !== '\n') {
                        i++;
                    }
                    result += '<span class="comment">' + escapeHtml(code.substring(start, i)) + '</span>';
                    matched = true;
                }
                
                // Check for strings
                else if (code[i] === '"') {
                    const start = i;
                    i++; // Skip opening quote
                    while (i < code.length && code[i] !== '"') {
                        i++;
                    }
                    if (i < code.length) i++; // Skip closing quote
                    result += '<span class="string">' + escapeHtml(code.substring(start, i)) + '</span>';
                    matched = true;
                }
                
                // Check for numbers
                else if (/\d/.test(code[i])) {
                    const start = i;
                    while (i < code.length && /[\d.]/.test(code[i])) {
                        i++;
                    }
                    result += '<span class="number">' + escapeHtml(code.substring(start, i)) + '</span>';
                    matched = true;
                }
                
                // Check for words (keywords, functions, etc.)
                else if (/[a-zA-Z_]/.test(code[i])) {
                    const start = i;
                    while (i < code.length && /[a-zA-Z0-9_]/.test(code[i])) {
                        i++;
                    }
                    const word = code.substring(start, i);
                    const lowerWord = word.toLowerCase();
                    
                    // Categorize and color the word
                    if (vbaSubFunction.some(k => k.toLowerCase() === lowerWord)) {
                        result += '<span class="keyword-sub">' + escapeHtml(word) + '</span>';
                    } else if (vbaControlFlow.some(k => k.toLowerCase() === lowerWord)) {
                        result += '<span class="keyword-control">' + escapeHtml(word) + '</span>';
                    } else if (vbaDeclarations.some(k => k.toLowerCase() === lowerWord)) {
                        result += '<span class="declaration">' + escapeHtml(word) + '</span>';
                    } else if (vbaConditions.some(k => k.toLowerCase() === lowerWord)) {
                        result += '<span class="keyword-condition">' + escapeHtml(word) + '</span>';
                    } else if (vbaLoops.some(k => k.toLowerCase() === lowerWord)) {
                        result += '<span class="keyword-loop">' + escapeHtml(word) + '</span>';
                    } else if (vbaConstantsList.some(k => k === word)) {
                        result += '<span class="constant">' + escapeHtml(word) + '</span>';
                    } else if (vbaObjects.some(k => k === word)) {
                        result += '<span class="object">' + escapeHtml(word) + '</span>';
                    } else if (vbaFunctions.some(k => k === word)) {
                        result += '<span class="function">' + escapeHtml(word) + '</span>';
                    } else if (vbaTypes.some(k => k === word)) {
                        result += '<span class="type">' + escapeHtml(word) + '</span>';
                    } else if (vbaBooleans.some(k => k === word)) {
                        result += '<span class="boolean">' + escapeHtml(word) + '</span>';
                    } else if (vbaBuiltins.some(k => k === word)) {
                        result += '<span class="builtin">' + escapeHtml(word) + '</span>';
                    } else if ([...vbaModifiers, ...vbaOperators, ...vbaOther].some(k => k.toLowerCase() === lowerWord)) {
                        result += '<span class="keyword">' + escapeHtml(word) + '</span>';
                    } else {
                        result += escapeHtml(word);
                    }
                    matched = true;
                }
                
                // Not a special character, just add it
                if (!matched) {
                    result += escapeHtml(code[i]);
                    i++;
                }
            }
            
            // Set the final HTML
            codeHighlight.innerHTML = result;
        }

        function escapeHtml(text) {
            // CRITICAL NULL-SAFETY: Ensure text is always a string
            const safeText = (text === null || text === undefined) ? '' : String(text);
            return safeText.replace(/&/g, '&amp;')
                          .replace(/</g, '&lt;')
                          .replace(/>/g, '&gt;')
                          .replace(/"/g, '&quot;')
                          .replace(/'/g, '&#039;');
        }

        function updateLineNumbers() {
            const codeInput = document.getElementById('codeInput');
            const lineNumbers = document.getElementById('lineNumbers');
            const lines = codeInput.value.split('\n').length;
            
            // Create line numbers as separate div elements for guaranteed vertical display
            let nums = '';
            for (let i = 1; i <= Math.max(lines, 1); i++) {
                nums += i + '\n';
            }
            lineNumbers.textContent = nums;
        }

        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        // 🔧 ADVANCED VBA LINT ENGINE (Tokenizer-Based Analysis)
        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        
        // 1️⃣ VBA TOKENIZER (String & Comment Safe - Enhanced)
        const VBATokenizer = (() => {
            function tokenize(code) {
                const tokens = [];
                let i = 0, line = 1, col = 1;

                while (i < code.length) {
                    const ch = code[i];

                    // Newline
                    if (ch === '\n') {
                        tokens.push({ type: 'NEWLINE', value: ch, line, col, start: i, end: i + 1 });
                        line++; col = 1; i++;
                        continue;
                    }

                    // String literal (VBA uses " and "" for escaped quotes)
                    if (ch === '"') {
                        let value = '"';
                        let startPos = i;
                        let startCol = col;
                        i++; col++;

                        while (i < code.length) {
                            value += code[i];
                            if (code[i] === '"' && (i + 1 >= code.length || code[i + 1] !== '"')) {
                                // End of string
                                i++; col++;
                                break;
                            }
                            if (code[i] === '"' && code[i + 1] === '"') {
                                // Escaped quote ""
                                value += '"';
                                i++; col++;
                            }
                            i++; col++;
                        }

                        tokens.push({ type: 'STRING', value, line, col: startCol, start: startPos, end: i });
                        continue;
                    }

                    // Comment (VBA uses ' or REM)
                    if (ch === "'") {
                        let value = "'";
                        let startPos = i;
                        let startCol = col;
                        i++; col++;

                        while (i < code.length && code[i] !== '\n') {
                            value += code[i];
                            i++; col++;
                        }

                        tokens.push({ type: 'COMMENT', value, line, col: startCol, start: startPos, end: i });
                        continue;
                    }

                    // Whitespace
                    if (/\s/.test(ch)) {
                        tokens.push({ type: 'WS', value: ch, line, col, start: i, end: i + 1 });
                        i++; col++;
                        continue;
                    }

                    // Identifier/Keyword
                    if (/[a-zA-Z_]/.test(ch)) {
                        let value = '';
                        let startPos = i;
                        let startCol = col;
                        
                        while (i < code.length && /[a-zA-Z0-9_]/.test(code[i])) {
                            value += code[i];
                            i++; col++;
                        }
                        
                        // Mark as CODE for non-string/comment tokens
                        tokens.push({ type: 'IDENT', value, line, col: startCol, start: startPos, end: i, isCode: true });
                        continue;
                    }

                    // Number
                    if (/\d/.test(ch)) {
                        let value = '';
                        let startPos = i;
                        let startCol = col;
                        
                        while (i < code.length && /[\d.]/.test(code[i])) {
                            value += code[i];
                            i++; col++;
                        }
                        
                        tokens.push({ type: 'NUMBER', value, line, col: startCol, start: startPos, end: i, isCode: true });
                        continue;
                    }

                    // Operators and other characters (CODE)
                    tokens.push({ type: 'OP', value: ch, line, col, start: i, end: i + 1, isCode: true });
                    i++; col++;
                }

                return tokens;
            }
            
            // Helper: Check if position is inside string or comment
            function isInStringOrComment(tokens, position) {
                for (let token of tokens) {
                    if (token.type === 'STRING' || token.type === 'COMMENT') {
                        if (position >= token.start && position < token.end) {
                            return true;
                        }
                    }
                }
                return false;
            }
            
            // Helper: Get CODE-only text (excludes strings and comments)
            function getCodeOnlyText(tokens) {
                return tokens
                    .filter(t => t.isCode)
                    .map(t => t.value)
                    .join('');
            }

            return { tokenize, isInStringOrComment, getCodeOnlyText };
        })();

        // 2️⃣ VBA CONTEXT DETECTION ENGINE
        const VBAContext = (() => {
            function detect(tokens, code) {
                const ctx = {
                    worksheetIO: false,
                    recordset: false,
                    errorHandling: false,
                    loops: false,
                    curlyQuotes: false,
                    hasOptionExplicit: false,
                    uiForms: false,
                    fileSystem: false,
                    securityRisk: false
                };

                // Check for REAL Unicode curly quotes (not ASCII)
                ctx.curlyQuotes = /[\u201C\u201D\u2018\u2019]/.test(code);

                // Check Option Explicit
                ctx.hasOptionExplicit = /^\s*Option\s+Explicit/im.test(code);

                // Analyze tokens (only CODE tokens, not strings/comments)
                tokens.forEach(t => {
                    if (t.type === 'STRING' || t.type === 'COMMENT') return;

                    const val = t.value;

                    // Worksheet I/O context
                    if (/Range|Cells|Rows|Columns|\.Value|\.Formula|WorksheetFunction/i.test(val)) {
                        ctx.worksheetIO = true;
                    }

                    // Recordset/Database context
                    if (/Recordset|\.Fields|\.EOF|\.MoveNext|\.Open|Provider=|SSPI|ADODB|DAO|SELECT|INSERT|UPDATE/i.test(val)) {
                        ctx.recordset = true;
                    }

                    // Error handling context
                    if (/On Error|Err\.|Resume|GoTo 0/i.test(val)) {
                        ctx.errorHandling = true;
                    }

                    // Loop context
                    if (/^(For|Do|While)$/i.test(val)) {
                        ctx.loops = true;
                    }

                    // UI/Forms context
                    if (/UserForm|Me\.Controls|\.Caption|\.Text/i.test(val)) {
                        ctx.uiForms = true;
                    }

                    // File system operations
                    if (/Kill|Shell|Dir\(|FileSystemObject|Open.*For (Input|Output|Append)/i.test(val)) {
                        ctx.fileSystem = true;
                    }

                    // Security risks
                    if (/CreateObject\("WScript\.Shell"\)|SendKeys|registry/i.test(val)) {
                        ctx.securityRisk = true;
                    }
                });

                return ctx;
            }

            return { detect };
        })();

        // 3️⃣ VBA GRAMMAR RECOVERY (Structural Validation)
        const VBAGrammar = (() => {
            const BLOCK_PAIRS = {
                'If': 'End If',
                'For': 'Next',
                'Do': 'Loop',
                'Select Case': 'End Select',
                'With': 'End With',
                'Sub': 'End Sub',
                'Function': 'End Function'
            };

            function analyze(lines) {
                const stack = [];
                const issues = [];

                lines.forEach((line, index) => {
                    // CRITICAL NULL SAFETY
                    if (line === null || line === undefined) return;
                    
                    const trimmed = line.trim();
                    const lineNum = index + 1;

                    // Opening blocks
                    if (/^If .+ Then$/i.test(trimmed) && !trimmed.includes(':')) {
                        stack.push({ type: 'If', line: lineNum, text: trimmed });
                    }
                    if (/^For\s+/i.test(trimmed)) {
                        stack.push({ type: 'For', line: lineNum, text: trimmed });
                    }
                    if (/^Do\b/i.test(trimmed)) {
                        stack.push({ type: 'Do', line: lineNum, text: trimmed });
                    }
                    if (/^Select Case/i.test(trimmed)) {
                        stack.push({ type: 'Select Case', line: lineNum, text: trimmed });
                    }
                    if (/^With\s+/i.test(trimmed)) {
                        stack.push({ type: 'With', line: lineNum, text: trimmed });
                    }
                    if (/^(Sub|Function)\s+/i.test(trimmed)) {
                        const type = trimmed.match(/^(Sub|Function)/i)[1];
                        stack.push({ type, line: lineNum, text: trimmed });
                    }

                    // Closing blocks
                    if (/^End If/i.test(trimmed)) {
                        const opener = stack.pop();
                        if (!opener || opener.type !== 'If') {
                            issues.push({
                                severity: 'Critical',
                                line: lineNum,
                                message: 'End If without matching If',
                                type: 'Grammar'
                            });
                        }
                    }
                    if (/^Next\b/i.test(trimmed)) {
                        const opener = stack.pop();
                        if (!opener || opener.type !== 'For') {
                            issues.push({
                                severity: 'Critical',
                                line: lineNum,
                                message: 'Next without matching For',
                                type: 'Grammar'
                            });
                        }
                    }
                    if (/^Loop\b/i.test(trimmed)) {
                        const opener = stack.pop();
                        if (!opener || opener.type !== 'Do') {
                            issues.push({
                                severity: 'Critical',
                                line: lineNum,
                                message: 'Loop without matching Do',
                                type: 'Grammar'
                            });
                        }
                    }
                    if (/^End Select/i.test(trimmed)) {
                        const opener = stack.pop();
                        if (!opener || opener.type !== 'Select Case') {
                            issues.push({
                                severity: 'Critical',
                                line: lineNum,
                                message: 'End Select without matching Select Case',
                                type: 'Grammar'
                            });
                        }
                    }
                    if (/^End With/i.test(trimmed)) {
                        const opener = stack.pop();
                        if (!opener || opener.type !== 'With') {
                            issues.push({
                                severity: 'Critical',
                                line: lineNum,
                                message: 'End With without matching With',
                                type: 'Grammar'
                            });
                        }
                    }
                    if (/^End (Sub|Function)/i.test(trimmed)) {
                        const type = trimmed.match(/^End (Sub|Function)/i)[1];
                        const opener = stack.pop();
                        if (!opener || opener.type !== type) {
                            issues.push({
                                severity: 'Critical',
                                line: lineNum,
                                message: `End ${type} without matching ${type}`,
                                type: 'Grammar'
                            });
                        }
                    }
                });

                // Check for unclosed blocks
                stack.forEach(item => {
                    issues.push({
                        severity: 'Critical',
                        line: item.line,
                        message: `Missing "${BLOCK_PAIRS[item.type]}" for "${item.type}" starting at line ${item.line}`,
                        type: 'Grammar',
                        code: item.text
                    });
                });

                return issues;
            }

            return { analyze };
        })();

        // 4️⃣ INLINE SQUIGGLY UNDERLINE ENGINE (CSS-based)
        const SquiggleRenderer = (() => {
            function apply(findings) {
                // This function prepares CSS classes for squiggly underlines
                // Returns a map of line numbers to CSS classes
                const decorations = new Map();
                
                findings.forEach(f => {
                    const cssClass = 'vba-squiggle-' + (f.severity || 'info').toLowerCase();
                    decorations.set(f.line, cssClass);
                });
                
                return decorations;
            }
            
            // Helper: Generate inline style for a finding
            function getInlineStyle(severity) {
                const styles = {
                    'Critical': 'text-decoration: underline wavy #ff4444; text-decoration-thickness: 2px;',
                    'Major': 'text-decoration: underline wavy #ffaa00; text-decoration-thickness: 2px;',
                    'Minor': 'text-decoration: underline wavy #ffff00; text-decoration-thickness: 1px;',
                    'Info': 'text-decoration: underline wavy #00aaff; text-decoration-thickness: 1px;',
                    'Performance': 'text-decoration: underline wavy #ffaa00; text-decoration-thickness: 1px;',
                    'Safety': 'text-decoration: underline wavy #ff4444; text-decoration-thickness: 2px;'
                };
                return styles[severity] || styles['Info'];
            }

            return { apply, getInlineStyle };
        })();

        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        // 🔒 CANONICAL VBA WHITELIST (CRITICAL - DO NOT FLAG AS TYPOS)
        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        const VBA_WHITELIST = (() => {
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // A) COMPOUND VBA STATEMENTS (ATOMIC — NEVER SPLIT)
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            const COMPOUND_STATEMENTS = [
                'On Error Resume Next',
                'On Error GoTo 0',
                'Resume Next',
                'Exit Sub',
                'Exit Function',
                'Exit Do',
                'Exit For',
                'Exit Property',
                'Select Case',
                'End Select',
                'End If',
                'End Sub',
                'End Function',
                'End With',
                'End Property',
                'Next i',
                'Next j',
                'Next k',
                'Case Else',
                'ElseIf',
                'Debug.Print'
            ];
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // B) CORE VBA KEYWORDS
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            const CORE_KEYWORDS = [
                'Sub', 'Function', 'Property', 'Get', 'Let', 'Set',
                'If', 'Then', 'Else', 'ElseIf',
                'For', 'Next', 'To', 'Step', 'Each', 'In',
                'Do', 'Loop', 'While', 'Wend', 'Until',
                'With', 'Select', 'Case',
                'Exit', 'Resume', 'GoTo',
                'Dim', 'ReDim', 'Preserve',
                'As', 'Const', 'Static',
                'Option', 'Explicit', 'Compare', 'Base',
                'Public', 'Private', 'Friend',
                'ByVal', 'ByRef', 'Optional', 'ParamArray',
                'Call', 'Return', 'Stop', 'End',
                'Declare', 'Lib', 'Alias',
                'Type', 'Enum',
                'On', 'Error',
                'Erase', 'Preserve',
                'Nothing', 'Empty', 'Null',
                'True', 'False',
                'And', 'Or', 'Not', 'Xor', 'Eqv', 'Imp',
                'Is', 'Like', 'Mod',
                'Integer', 'Long', 'Single', 'Double', 'Currency',
                'String', 'Boolean', 'Byte', 'Date', 'Object', 'Variant',
                'New'
            ];
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // C) BUILT-IN VBA FUNCTIONS (COMMON)
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            const VBA_FUNCTIONS = [
                'MsgBox', 'InputBox',
                'Debug',
                'UCase', 'LCase', 'Trim', 'LTrim', 'RTrim',
                'Left', 'Right', 'Mid',
                'Len', 'Replace', 'Split', 'Join', 'InStr', 'InStrRev',
                'CStr', 'CLng', 'CInt', 'CDbl', 'CDate', 'CBool', 'CByte', 'CCur',
                'IsNumeric', 'IsDate', 'IsEmpty', 'IsNull', 'IsArray', 'IsObject',
                'Val', 'Str', 'Format',
                'Now', 'Date', 'Time', 'Timer',
                'Year', 'Month', 'Day', 'Hour', 'Minute', 'Second',
                'DateAdd', 'DateDiff', 'DatePart', 'DateSerial', 'TimeSerial',
                'Chr', 'Asc', 'Space', 'String',
                'Array', 'LBound', 'UBound',
                'Abs', 'Sgn', 'Int', 'Fix', 'Round',
                'Sqr', 'Exp', 'Log',
                'Sin', 'Cos', 'Tan', 'Atn',
                'Rnd', 'Randomize',
                'RGB', 'QBColor',
                'Environ', 'Shell', 'Dir', 'Kill', 'FileCopy', 'Name',
                'Open', 'Close', 'Print', 'Write', 'Input', 'Get', 'Put',
                'Seek', 'Loc', 'LOF', 'EOF',
                'FreeFile', 'FileLen', 'FileDateTime', 'FileAttr',
                'GetAttr', 'SetAttr',
                'CreateObject', 'GetObject',
                'TypeName', 'VarType', 'CVErr', 'Error'
            ];
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // D) VBA BUILT-IN CONSTANTS
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            const VBA_CONSTANTS = [
                'vbInformation', 'vbCritical', 'vbExclamation', 'vbQuestion',
                'vbOKOnly', 'vbOKCancel', 'vbYesNo', 'vbYesNoCancel',
                'vbRetryCancel', 'vbAbortRetryIgnore',
                'vbYes', 'vbNo', 'vbOK', 'vbCancel', 'vbAbort', 'vbRetry', 'vbIgnore',
                'vbCr', 'vbLf', 'vbCrLf', 'vbTab', 'vbNullString', 'vbNewLine',
                'vbBlack', 'vbRed', 'vbGreen', 'vbYellow', 'vbBlue', 'vbMagenta', 'vbCyan', 'vbWhite',
                'vbNormal', 'vbMinimizedFocus', 'vbMaximizedFocus', 'vbNormalNoFocus',
                'vbHide', 'vbMinimizedNoFocus',
                'vbTextCompare', 'vbBinaryCompare', 'vbDatabaseCompare',
                'vbUseSystem', 'vbUseSystemDayOfWeek',
                'vbSunday', 'vbMonday', 'vbTuesday', 'vbWednesday', 'vbThursday', 'vbFriday', 'vbSaturday',
                'vbFirstJan1', 'vbFirstFourDays', 'vbFirstFullWeek',
                'vbGeneralDate', 'vbLongDate', 'vbShortDate', 'vbLongTime', 'vbShortTime'
            ];
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // E) EXCEL OBJECTS & CONSTANTS
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            const EXCEL_OBJECTS = [
                'Application', 'Workbook', 'Workbooks', 'Worksheet', 'Worksheets',
                'Range', 'Cells', 'Rows', 'Columns',
                'ActiveWorkbook', 'ActiveSheet', 'ActiveCell',
                'ThisWorkbook', 'Selection',
                'Chart', 'Charts', 'PivotTable', 'PivotTables',
                'Shape', 'Shapes', 'Comment', 'Comments',
                'Name', 'Names'
            ];
            
            const EXCEL_CONSTANTS = [
                'xlUp', 'xlDown', 'xlToLeft', 'xlToRight',
                'xlCalculationManual', 'xlCalculationAutomatic', 'xlCalculationSemiautomatic',
                'xlYes', 'xlNo', 'xlGuess',
                'xlPasteAll', 'xlPasteValues', 'xlPasteFormats', 'xlPasteFormulas',
                'xlPasteComments', 'xlPasteValidation',
                'xlCellTypeLastCell', 'xlCellTypeConstants', 'xlCellTypeFormulas',
                'xlCellTypeBlanks', 'xlCellTypeVisible',
                'xlByRows', 'xlByColumns',
                'xlAscending', 'xlDescending',
                'xlPart', 'xlWhole',
                'xlNext', 'xlPrevious',
                'xlA1', 'xlR1C1',
                'xlErrors', 'xlErrorBars', 'xlExpression',
                'xlFillDefault', 'xlFillCopy', 'xlFillSeries',
                'xlGeneral', 'xlAutomatic'
            ];
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // VBA OBJECT MEMBERS & PROPERTIES (NEVER FLAG AS TYPOS)
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            const VBA_OBJECT_MEMBERS = [
                // Common object properties
                'Value', 'Count', 'Index', 'Name', 'Text', 'Caption',
                'Row', 'Rows', 'Column', 'Columns', 'Address',
                'Formula', 'FormulaR1C1',
                'NumberFormat', 'Font', 'Interior', 'Borders',
                'Hidden', 'Visible', 'Enabled',
                'Width', 'Height', 'Left', 'Top',
                'Parent', 'Offset', 'Resize',
                'Item', 'Items', 'Add', 'Delete', 'Clear',
                'Copy', 'Cut', 'Paste', 'PasteSpecial',
                'Select', 'Activate', 'Open', 'Close', 'Save', 'SaveAs',
                'Show', 'Hide', 'Print', 'PrintPreview',
                // VBA Error object
                'Err', 'Error', 'Number', 'Description', 'Source',
                'HelpContext', 'HelpFile', 'Raise', 'Clear',
                // Special keywords that appear in member chains
                'Me', 'Nothing', 'Empty', 'Null', 'True', 'False',
                // Common methods
                'Find', 'FindNext', 'FindPrevious', 'Replace',
                'Sort', 'Filter', 'AutoFilter',
                'Calculate', 'Recalculate',
                'UsedRange', 'CurrentRegion', 'End',
                'SpecialCells', 'EntireRow', 'EntireColumn'
            ];
            
            // Create case-insensitive lookup sets
            const compoundSet = new Set(COMPOUND_STATEMENTS.map(s => s.toLowerCase()));
            const keywordSet = new Set(CORE_KEYWORDS.map(s => s.toLowerCase()));
            const functionSet = new Set(VBA_FUNCTIONS.map(s => s.toLowerCase()));
            const constantSet = new Set([...VBA_CONSTANTS, ...EXCEL_CONSTANTS].map(s => s.toLowerCase()));
            const objectSet = new Set(EXCEL_OBJECTS.map(s => s.toLowerCase()));
            const memberSet = new Set(VBA_OBJECT_MEMBERS.map(s => s.toLowerCase()));
            const allWhitelistSet = new Set([
                ...COMPOUND_STATEMENTS.map(s => s.toLowerCase()),
                ...CORE_KEYWORDS.map(s => s.toLowerCase()),
                ...VBA_FUNCTIONS.map(s => s.toLowerCase()),
                ...VBA_CONSTANTS.map(s => s.toLowerCase()),
                ...EXCEL_OBJECTS.map(s => s.toLowerCase()),
                ...EXCEL_CONSTANTS.map(s => s.toLowerCase()),
                ...VBA_OBJECT_MEMBERS.map(s => s.toLowerCase())
            ]);
            
            // Check if a token/phrase is whitelisted
            function isWhitelisted(text) {
                if (!text) return false;
                const lower = text.toLowerCase().trim();
                return allWhitelistSet.has(lower);
            }
            
            // Check if token is part of a compound statement (e.g., "Next" in "Next i")
            function isPartOfCompound(text, lineContext) {
                if (!text || !lineContext) return false;
                const lower = text.toLowerCase().trim();
                const lineLower = lineContext.toLowerCase().trim();
                
                // Check each compound statement
                for (const compound of COMPOUND_STATEMENTS) {
                    const compoundLower = compound.toLowerCase();
                    if (lineLower.includes(compoundLower)) {
                        // Check if our token is a substring of this compound
                        const words = compoundLower.split(/\s+/);
                        if (words.some(word => word === lower || word.startsWith(lower))) {
                            return true;
                        }
                    }
                }
                return false;
            }
            
            // Check if token is a VBA keyword
            function isKeyword(text) {
                if (!text) return false;
                return keywordSet.has(text.toLowerCase().trim());
            }
            
            // Check if token is a VBA function
            function isFunction(text) {
                if (!text) return false;
                return functionSet.has(text.toLowerCase().trim());
            }
            
            // Check if token is a VBA/Excel constant
            function isConstant(text) {
                if (!text) return false;
                return constantSet.has(text.toLowerCase().trim());
            }
            
            // Check if token is an Excel object
            function isExcelObject(text) {
                if (!text) return false;
                return objectSet.has(text.toLowerCase().trim());
            }
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // Check if token is an object member/property
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            function isObjectMember(text) {
                if (!text) return false;
                return memberSet.has(text.toLowerCase().trim());
            }
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // Check if token is part of object member chain (e.g., ws.Value, Err.Description)
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            function isPartOfMemberChain(text, lineContext) {
                if (!text || !lineContext) return false;
                
                const lower = text.toLowerCase().trim();
                const line = lineContext.trim();
                
                // Check if preceded or followed by dot (object member access)
                const dotBefore = new RegExp('\\.' + text + '\\b', 'i');
                const dotAfter = new RegExp('\\b' + text + '\\.', 'i');
                
                if (dotBefore.test(line) || dotAfter.test(line)) {
                    return true;
                }
                
                // Check if it's a known object member
                if (isObjectMember(text)) {
                    return true;
                }
                
                return false;
            }
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // Check if line contains string or comment segments
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            function getCodeSegments(line) {
                if (!line) return [];
                
                const segments = [];
                let inString = false;
                let inComment = false;
                let currentSegment = '';
                let segmentType = 'CODE';
                let segmentStart = 0;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const prevChar = i > 0 ? line[i - 1] : '';
                    
                    // Check for comment start
                    if (!inString && char === "'" && prevChar !== '"') {
                        // Save current segment
                        if (currentSegment) {
                            segments.push({ type: segmentType, text: currentSegment, start: segmentStart });
                        }
                        // Rest of line is comment
                        segments.push({ type: 'COMMENT', text: line.substring(i), start: i });
                        break;
                    }
                    
                    // Check for string toggle
                    if (char === '"' && prevChar !== '"') {
                        if (!inString) {
                            // Entering string
                            if (currentSegment) {
                                segments.push({ type: segmentType, text: currentSegment, start: segmentStart });
                            }
                            inString = true;
                            currentSegment = char;
                            segmentType = 'STRING';
                            segmentStart = i;
                        } else {
                            // Exiting string
                            currentSegment += char;
                            segments.push({ type: segmentType, text: currentSegment, start: segmentStart });
                            inString = false;
                            currentSegment = '';
                            segmentType = 'CODE';
                            segmentStart = i + 1;
                        }
                    } else {
                        currentSegment += char;
                    }
                }
                
                // Add final segment
                if (currentSegment) {
                    segments.push({ type: segmentType, text: currentSegment, start: segmentStart });
                }
                
                return segments;
            }
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // Check if a position in line is inside a string or comment
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            function isInStringOrComment(line, position) {
                if (!line) return false;
                
                const segments = getCodeSegments(line);
                for (const segment of segments) {
                    const end = segment.start + segment.text.length;
                    if (position >= segment.start && position < end) {
                        return segment.type === 'STRING' || segment.type === 'COMMENT';
                    }
                }
                return false;
            }
            
            return {
                // Methods
                isWhitelisted,
                isPartOfCompound,
                isKeyword,
                isFunction,
                isConstant,
                isExcelObject,
                isObjectMember,
                isPartOfMemberChain,
                getCodeSegments,
                isInStringOrComment,
                // Arrays (for format validation)
                COMPOUND_STATEMENTS,
                CORE_KEYWORDS,
                VBA_FUNCTIONS,
                VBA_CONSTANTS,
                EXCEL_OBJECTS,
                EXCEL_CONSTANTS,
                VBA_OBJECT_MEMBERS
            };
        })();

        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        // 📏 FORMAT & SPACING VALIDATOR (ADDITIVE)
        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        const VBAFormatValidator = (() => {
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // A) SPACING RULES
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            const SPACING_RULES = {
                // Incorrect spacing → Correct spacing
                'Else If': 'ElseIf',
                'EndIf': 'End If',
                'EndSub': 'End Sub',
                'EndFunction': 'End Function',
                'EndWith': 'End With',
                'EndSelect': 'End Select',
                'EndProperty': 'End Property',
                'Go To': 'GoTo',
                'SelectCase': 'Select Case',
                'ExitSub': 'Exit Sub',
                'ExitFunction': 'Exit Function',
                'ExitFor': 'Exit For',
                'ExitDo': 'Exit Do'
            };
            
            // Check for spacing issues
            function checkSpacing(line, lineNum) {
                const issues = [];
                const trimmed = line.trim();
                
                // Skip if entire line is comment
                if (trimmed.startsWith("'")) return issues;
                
                // Get code segments to avoid checking strings/comments
                const segments = VBA_WHITELIST.getCodeSegments(line);
                const codeSegments = segments.filter(seg => seg.type === 'CODE');
                
                // If no code segments, skip
                if (codeSegments.length === 0) return issues;
                
                // Check each spacing rule only in CODE segments
                for (const [incorrect, correct] of Object.entries(SPACING_RULES)) {
                    const regex = new RegExp('\\b' + incorrect.replace(/\s+/g, '\\s*') + '\\b', 'i');
                    
                    // Check if pattern exists in any CODE segment
                    let foundInCode = false;
                    for (const segment of codeSegments) {
                        if (regex.test(segment.text)) {
                            foundInCode = true;
                            break;
                        }
                    }
                    
                    if (foundInCode) {
                        issues.push({
                            line: lineNum,
                            type: 'warning',
                            category: '📏 Format Error',
                            title: `Incorrect spacing: "${incorrect}"`,
                            problem: `VBA requires "${correct}"`,
                            code: trimmed,
                            highlight: trimmed.replace(new RegExp(incorrect, 'gi'), `➜${incorrect}←`),
                            fix: trimmed.replace(new RegExp(incorrect, 'gi'), correct),
                            fixLabel: `Change to "${correct}"`,
                            tip: `VBA keywords have specific spacing requirements. Use "${correct}" not "${incorrect}".`
                        });
                    }
                }
                
                return issues;
            }
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // B) QUOTE RULES
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            function checkQuotes(line, lineNum) {
                const issues = [];
                const trimmed = line.trim();
                
                // Skip comments
                if (trimmed.startsWith("'")) return issues;
                
                // Check for curly quotes (already handled by VBALintEngine, but double-check)
                if (trimmed.match(/[""'']/)) {
                    issues.push({
                        line: lineNum,
                        type: 'error',
                        category: '🔤 Quote Error',
                        title: 'Smart/curly quotes detected',
                        problem: 'VBA requires straight quotes',
                        code: trimmed,
                        highlight: trimmed.replace(/[""]/g, '➜"←').replace(/['']/g, "➜'←"),
                        fix: trimmed.replace(/[""]/g, '"').replace(/['']/g, "'"),
                        fixLabel: 'Replace with straight quotes',
                        tip: 'Use straight quotes (") not curly quotes (""). Change your editor settings.'
                    });
                }
                
                return issues;
            }
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // C) COLON RULES
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            function checkColons(lines) {
                const issues = [];
                let inBlock = false;
                let blockType = null;
                let blockStartLine = 0;
                
                lines.forEach((line, idx) => {
                    if (!line) return;
                    
                    const trimmed = line.trim();
                    const lineNum = idx + 1;
                    
                    // Skip comments
                    if (trimmed.startsWith("'")) return;
                    
                    // Track block state
                    if (trimmed.match(/^If\s+.*Then\s*$/i) && !trimmed.includes(':')) {
                        inBlock = true;
                        blockType = 'If';
                        blockStartLine = lineNum;
                    } else if (trimmed.match(/^For\s+/i)) {
                        inBlock = true;
                        blockType = 'For';
                        blockStartLine = lineNum;
                    } else if (trimmed.match(/^Do\s+/i) || trimmed.match(/^While\s+/i)) {
                        inBlock = true;
                        blockType = 'Loop';
                        blockStartLine = lineNum;
                    } else if (trimmed.match(/^End\s+(If|For|Do|While)/i)) {
                        inBlock = false;
                        blockType = null;
                    }
                    
                    // Check for colons inside blocks (generally not allowed)
                    // CRITICAL: Only check colons in CODE segments, not strings/comments
                    if (inBlock && !trimmed.match(/^Dim\s+/i)) {
                        // Get code segments
                        const segments = VBA_WHITELIST.getCodeSegments(line);
                        const codeSegments = segments.filter(seg => seg.type === 'CODE');
                        
                        // Check if colon exists in CODE segments only
                        let colonInCode = false;
                        for (const segment of codeSegments) {
                            if (segment.text.includes(':')) {
                                // Exception: Label definitions (xxx:)
                                if (!trimmed.match(/^\w+:$/)) {
                                    colonInCode = true;
                                    break;
                                }
                            }
                        }
                        
                        if (colonInCode) {
                            issues.push({
                                line: lineNum,
                                type: 'warning',
                                category: '📏 Format Error',
                                title: `Colon inside ${blockType} block`,
                                problem: 'Multi-statement lines should generally be avoided inside blocks',
                                code: trimmed,
                                highlight: trimmed.replace(/:/, '➜:←'),
                                fix: null, // Manual fix
                                fixLabel: 'Split into separate lines',
                                tip: `Colons (statement separators) inside ${blockType}...End ${blockType} blocks can make code hard to read. Consider splitting into separate lines.`
                            });
                        }
                    }
                    
                    // Check for multiple statements without colon
                    // Pattern: Two or more statements on same line without colon separator
                    // This is complex and may have false positives, so we keep it simple
                });
                
                return issues;
            }
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // Main validation function
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            function validate(code) {
                const lines = code.split('\n');
                const issues = [];
                
                // A) Check spacing issues (line by line)
                lines.forEach((line, idx) => {
                    if (!line) return;
                    issues.push(...checkSpacing(line, idx + 1));
                });
                
                // B) Check quote issues (line by line)
                lines.forEach((line, idx) => {
                    if (!line) return;
                    issues.push(...checkQuotes(line, idx + 1));
                });
                
                // C) Check colon usage (multi-line analysis)
                issues.push(...checkColons(lines));
                
                return issues;
            }
            
            return { validate };
        })();

        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        // ⚠️ WRONG STATEMENT FORMAT DETECTOR (ADDITIVE)
        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        const VBAStatementValidator = (() => {
            
            function validate(code) {
                const lines = code.split('\n');
                const issues = [];
                
                lines.forEach((line, idx) => {
                    if (!line) return;
                    
                    const trimmed = line.trim();
                    const lineNum = idx + 1;
                    
                    // Skip comments
                    if (trimmed.startsWith("'")) return;
                    
                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    // 1) MsgBox missing prompt
                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    if (trimmed.match(/^MsgBox\s+(vb\w+)/i)) {
                        // MsgBox vbInformation, vbError is wrong
                        // Should be: MsgBox "message", vbInformation
                        issues.push({
                            line: lineNum,
                            type: 'error',
                            category: '⚠️ Structure Error',
                            title: 'MsgBox missing message prompt',
                            problem: 'MsgBox requires a message string as first argument',
                            code: trimmed,
                            highlight: trimmed,
                            fix: null,
                            fixLabel: 'Add message prompt',
                            tip: 'Correct format: MsgBox "Your message", vbInformation'
                        });
                    }
                    
                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    // 2) Dim with = instead of As (common mistake)
                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    if (trimmed.match(/^Dim\s+\w+\s*=\s*/i) && !trimmed.includes(' As ')) {
                        // Dim x = 5 is wrong in VBA
                        // Should be: Dim x As Long: x = 5
                        issues.push({
                            line: lineNum,
                            type: 'error',
                            category: '⚠️ Structure Error',
                            title: 'Dim statement with = instead of As',
                            problem: 'VBA does not support initialization in Dim statement',
                            code: trimmed,
                            highlight: trimmed.replace(/=/g, '➜=← (wrong)'),
                            fix: null,
                            fixLabel: 'Use: Dim x As Type, then assign separately',
                            tip: 'VBA requires: Dim x As Long (on one line), then x = 5 (on another line or after colon)'
                        });
                    }
                    
                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    // 3) For without To (incomplete loop)
                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    if (trimmed.match(/^For\s+\w+\s*=\s*\d+\s*$/i)) {
                        // For i = 1 (missing To)
                        issues.push({
                            line: lineNum,
                            type: 'error',
                            category: '⚠️ Structure Error',
                            title: 'For loop missing "To"',
                            problem: 'For loop requires "To" keyword',
                            code: trimmed,
                            highlight: trimmed + ' ➜ MISSING: To <end>',
                            fix: null,
                            fixLabel: 'Add "To" keyword and end value',
                            tip: 'Correct format: For i = 1 To 10'
                        });
                    }
                    
                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    // 4) If without Then (already checked elsewhere, but verify)
                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    // This is already handled in analyzeCode, so we skip to avoid duplicates
                    
                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    // 5) Select without Case
                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    if (trimmed.match(/^Select\s+\w+/i) && !trimmed.match(/^Select\s+Case\s+/i)) {
                        // Select x (should be Select Case x)
                        issues.push({
                            line: lineNum,
                            type: 'error',
                            category: '⚠️ Structure Error',
                            title: 'Select statement missing "Case"',
                            problem: 'VBA requires "Select Case" not just "Select"',
                            code: trimmed,
                            highlight: trimmed.replace(/^Select\s+/i, '➜Select← '),
                            fix: trimmed.replace(/^Select\s+/i, 'Select Case '),
                            fixLabel: 'Change to "Select Case"',
                            tip: 'Correct format: Select Case variableName'
                        });
                    }
                    
                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    // 6) Set without = for object assignment
                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    if (trimmed.match(/^Set\s+\w+\s+(?!= )/i) && !trimmed.includes('=')) {
                        // Set obj Range("A1") is wrong
                        // Should be: Set obj = Range("A1")
                        issues.push({
                            line: lineNum,
                            type: 'error',
                            category: '⚠️ Structure Error',
                            title: 'Set statement missing "="',
                            problem: 'Set requires = between variable and object',
                            code: trimmed,
                            highlight: trimmed + ' ➜ MISSING: =',
                            fix: null,
                            fixLabel: 'Add "=" after variable name',
                            tip: 'Correct format: Set obj = Range("A1")'
                        });
                    }
                });
                
                return issues;
            }
            
            return { validate };
        })();

        // 5️⃣ MASTER VBA LINT ENGINE (Enhanced with False-Positive Prevention)
        const VBALintEngine = (() => {
            function run(code) {
                const findings = [];
                
                // Tokenize the code
                const tokens = VBATokenizer.tokenize(code);
                
                // Detect context
                const context = VBAContext.detect(tokens, code);
                
                // Split into lines for line-based analysis
                const lines = code.split('\n');
                
                // 🔴 CRITICAL: Unicode Curly Quotes (REAL detection)
                if (context.curlyQuotes) {
                    findings.push({
                        ruleId: 'UNICODE_QUOTES',
                        scope: 'Module',
                        severity: 'Critical',
                        category: '🔤 Quote Error',
                        line: 1,
                        title: 'Unicode smart quotes detected (curly quotes)',
                        problem: 'VBA requires straight quotes " and \', not curly quotes " " \' \'',
                        message: 'Smart (curly) quotes found. VBA requires ASCII straight quotes.',
                        confidence: 100,
                        code: '(found in code)',
                        highlight: 'Unicode curly quotes: " " \' \'',
                        fix: 'Replace all curly quotes with straight quotes',
                        fixLabel: 'Replace curly quotes with straight quotes',
                        tip: 'These are Unicode characters \\u201C \\u201D \\u2018 \\u2019. Use ASCII " and \' instead.'
                    });
                }
                
                // 🔴 CRITICAL: Grammar/Structure Issues
                const grammarIssues = VBAGrammar.analyze(lines);
                grammarIssues.forEach(issue => {
                    findings.push({
                        ruleId: issue.message.includes('End If') ? 'MISSING_END_IF' :
                               issue.message.includes('Next') ? 'MISSING_NEXT' :
                               issue.message.includes('Loop') ? 'MISSING_LOOP' :
                               issue.message.includes('End Select') ? 'MISSING_END_SELECT' :
                               issue.message.includes('End With') ? 'MISSING_END_WITH' :
                               issue.message.includes('End Sub') ? 'MISSING_END_SUB' :
                               issue.message.includes('End Function') ? 'MISSING_END_FUNCTION' : 'GRAMMAR_ERROR',
                        scope: issue.message.includes('If') ? 'IfBlock' :
                              issue.message.includes('For') || issue.message.includes('Do') ? 'Loop' :
                              issue.message.includes('Sub') || issue.message.includes('Function') ? 'Procedure' : 'Line',
                        severity: issue.severity,
                        category: '⚠️ Structure Error',
                        line: issue.line,
                        title: issue.message,
                        problem: 'Block structure is incomplete or mismatched',
                        message: issue.message,
                        confidence: 95,
                        code: issue.code || '(see line)',
                        highlight: issue.message,
                        fix: 'Add the missing closing statement',
                        fixLabel: 'Add missing block terminator',
                        tip: 'Every opening block (If, For, Do, etc.) needs its matching closing statement.'
                    });
                });
                
                // ⚠️ PERFORMANCE: Array optimization (ONLY when appropriate)
                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                // ENHANCED: Precise detection + deduplication
                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                if (context.loops && context.worksheetIO && !context.recordset) {
                    // Track flagged loops to prevent duplicates
                    const flaggedLoops = new Set();
                    
                    lines.forEach((line, idx) => {
                        // CRITICAL NULL SAFETY
                        if (line === null || line === undefined) return;
                        
                        const trimmed = line.trim();
                        
                        // Detect loop start
                        if (/^For\s+/i.test(trimmed) || /^Do\s+/i.test(trimmed) || /^While\s+/i.test(trimmed)) {
                            const loopStartLine = idx + 1;
                            
                            // Check if we've already flagged this loop
                            if (flaggedLoops.has(loopStartLine)) {
                                return;
                            }
                            
                            // Scan loop body (next 20 lines) for ACTUAL cell access
                            const loopBodyLines = lines.slice(idx + 1, idx + 21);
                            let actualCellAccessLine = null;
                            let cellAccessCode = null;
                            
                            loopBodyLines.forEach((bodyLine, bodyIdx) => {
                                if (!bodyLine) return;
                                
                                // Check for cell access inside loop (not on loop line itself)
                                if (/\.Cells\(|\.Range\(/i.test(bodyLine)) {
                                    if (!actualCellAccessLine) {
                                        actualCellAccessLine = idx + 2 + bodyIdx; // Line number of cell access
                                        cellAccessCode = bodyLine.trim();
                                    }
                                }
                            });
                            
                            // Only report if we found ACTUAL cell access INSIDE loop
                            if (actualCellAccessLine && cellAccessCode) {
                                flaggedLoops.add(loopStartLine); // Mark this loop as flagged
                                
                                findings.push({
                                    ruleId: 'ARRAY_OPTIMIZATION',
                                    scope: 'Loop',
                                    severity: 'Minor',
                                    category: '⚡ Performance',
                                    line: actualCellAccessLine, // Highlight cell access line, NOT loop header
                                    title: 'Cell-by-cell processing inside loop (100x slower)',
                                    problem: 'Worksheet I/O inside loop - reading/writing cells one-by-one is extremely slow',
                                    message: 'Consider using array-based processing for better performance.',
                                    confidence: 90,
                                    code: cellAccessCode, // Show the actual cell access line
                                    highlight: cellAccessCode + ' ➜ (inside loop - use array instead)',
                                    fix: 'arr = Range("A1:A1000").Value → process → Range("A1:A1000").Value = arr',
                                    fixLabel: 'Use array instead of cell-by-cell',
                                    tip: 'Load range to array, process in memory, write back. 100x faster!'
                                });
                            }
                        }
                    });
                }
                
                // ⚠️ ERROR HANDLING: On Error Resume Next without reset
                if (context.errorHandling) {
                    const hasResumeNext = /On Error Resume Next/i.test(code);
                    const hasReset = /On Error GoTo 0|On Error GoTo \w+/i.test(code);
                    
                    if (hasResumeNext && !hasReset) {
                        findings.push({
                            ruleId: 'ERROR_HANDLING_RESET',
                            scope: 'Procedure',
                            severity: 'Major',
                            category: '🚨 Error Handling',
                            line: 1,
                            title: 'On Error Resume Next without reset',
                            problem: 'Will silently hide all errors in remaining code',
                            message: '"On Error Resume Next" used without "On Error GoTo 0" reset.',
                            confidence: 85,
                            code: 'On Error Resume Next',
                            highlight: 'Missing: On Error GoTo 0',
                            fix: 'On Error Resume Next\n\' risky code\nOn Error GoTo 0',
                            fixLabel: 'Add "On Error GoTo 0" after risky section',
                            tip: 'Always reset error handling to prevent hiding subsequent errors.'
                        });
                    }
                }
                
                // 🔒 SECURITY: Dangerous operations
                if (context.fileSystem || context.securityRisk) {
                    const dangerousOps = ['Kill', 'Shell', 'SendKeys', 'CreateObject("WScript.Shell")'];
                    
                    lines.forEach((line, idx) => {
                        // CRITICAL NULL SAFETY
                        if (line === null || line === undefined) return;
                        
                        // Only check non-string, non-comment tokens
                        const lineTokens = tokens.filter(t => 
                            t.line === idx + 1 && t.type !== 'STRING' && t.type !== 'COMMENT'
                        );
                        
                        const lineCode = lineTokens.map(t => t.value).join('');
                        
                        dangerousOps.forEach(op => {
                            if (lineCode.includes(op)) {
                                findings.push({
                                    ruleId: 'SECURITY_RISK',
                                    scope: 'Line',
                                    symbol: op,
                                    severity: 'Major',
                                    category: '🚨 Security Risk',
                                    line: idx + 1,
                                    title: `Dangerous operation: ${op}`,
                                    problem: 'File system or shell access detected',
                                    message: `${op} can be dangerous. Add user confirmation.`,
                                    confidence: 90,
                                    code: line.trim(),
                                    highlight: `${op} (security risk)`,
                                    fix: 'If MsgBox("Allow?", vbYesNo) = vbYes Then\n    ' + line.trim(),
                                    fixLabel: 'Add safety confirmation',
                                    tip: 'Always confirm dangerous operations with the user.'
                                });
                            }
                        });
                    });
                }
                
                // ✏️ TYPO DETECTION (Evidence-based, token-aware)
                // Only flags typos in CODE tokens, not strings/comments
                // FIX GROUP A: Strict gating to prevent false positives
                const vbaKeywords = new Set([
                    'Sub', 'End', 'Function', 'If', 'Then', 'Else', 'ElseIf', 'For', 'To', 'Next',
                    'Do', 'Loop', 'While', 'Until', 'Select', 'Case', 'With', 'Dim', 'As', 'Set',
                    'Let', 'Const', 'ReDim', 'Public', 'Private', 'Option', 'Explicit', 'Integer',
                    'Long', 'String', 'Double', 'Boolean', 'Variant', 'Object', 'Range', 'Worksheet',
                    'Workbook', 'MsgBox', 'InputBox', 'Exit', 'GoTo', 'Resume', 'On', 'Error',
                    'True', 'False', 'Nothing', 'Empty', 'Null', 'And', 'Or', 'Not', 'Xor',
                    'Mod', 'Is', 'Like', 'New', 'ByVal', 'ByRef', 'Optional', 'ParamArray'
                ]);
                
                // FIX GROUP A: Known valid VBA phrases that should NEVER be flagged as typos
                const validVBAPhrases = [
                    'On Error Resume Next',
                    'On Error GoTo 0',
                    'On Error GoTo',
                    'End If',
                    'End Sub',
                    'End Function',
                    'End With',
                    'End Select',
                    'Exit Sub',
                    'Exit Function',
                    'Exit Do',
                    'Exit For',
                    'Select Case',
                    'Case Else',
                    'Do While',
                    'Do Until',
                    'Loop While',
                    'Loop Until'
                ];
                
                // Common typos with their corrections (must be VBA keywords)
                // FIX GROUP A: Removed invalid entries like "Nextt"
                const knownTypos = {
                    // Structure keywords
                    'Endif': 'End If',
                    'Endfunction': 'End Function',
                    'Endsub': 'End Sub',
                    'Endwith': 'End With',
                    'Endselect': 'End Select',
                    // Loop keywords
                    'Nex': 'Next',
                    // Note: "Nextt" removed - not a valid typo pattern
                    // Declaration keywords
                    'Funtion': 'Function',
                    'Functoin': 'Function',
                    'Functon': 'Function',
                    'Publc': 'Public',
                    'Pubilc': 'Public',
                    'Privte': 'Private',
                    'Privat': 'Private',
                    // Data types
                    'Integr': 'Integer',
                    'Intger': 'Integer',
                    'Strig': 'String',
                    'Strng': 'String',
                    'Boolea': 'Boolean',
                    // Other keywords
                    'Msgox': 'MsgBox',
                    'Msgbo': 'MsgBox',
                    'Inputox': 'InputBox',
                    'Inputbo': 'InputBox',
                    'Workshet': 'Worksheet',
                    'Workbok': 'Workbook',
                    'Dimm': 'Dim',
                    'Optio': 'Option',
                    'Explict': 'Explicit'
                };
                
                // FIX GROUP A: Helper function to check if word is part of valid VBA phrase
                function isPartOfValidPhrase(line, word) {
                    const upperLine = line.trim().toUpperCase();
                    for (const phrase of validVBAPhrases) {
                        if (upperLine.includes(phrase.toUpperCase())) {
                            // Check if word is part of this phrase
                            const phraseWords = phrase.toUpperCase().split(/\s+/);
                            if (phraseWords.includes(word.toUpperCase())) {
                                return true;
                            }
                        }
                    }
                    return false;
                }
                
                // FIX GROUP A: Helper function to calculate edit distance
                function editDistance(s1, s2) {
                    const len1 = s1.length;
                    const len2 = s2.length;
                    const dp = Array(len1 + 1).fill(null).map(() => Array(len2 + 1).fill(0));
                    
                    for (let i = 0; i <= len1; i++) dp[i][0] = i;
                    for (let j = 0; j <= len2; j++) dp[0][j] = j;
                    
                    for (let i = 1; i <= len1; i++) {
                        for (let j = 1; j <= len2; j++) {
                            if (s1[i - 1].toLowerCase() === s2[j - 1].toLowerCase()) {
                                dp[i][j] = dp[i - 1][j - 1];
                            } else {
                                dp[i][j] = 1 + Math.min(dp[i - 1][j], dp[i][j - 1], dp[i - 1][j - 1]);
                            }
                        }
                    }
                    return dp[len1][len2];
                }
                
                // Check for typos (only in CODE tokens)
                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                // ENHANCED WITH VBA_WHITELIST GATING (COMPREHENSIVE)
                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                lines.forEach((line, idx) => {
                    const lineNum = idx + 1;
                    const lineTokens = tokens.filter(t => t.line === lineNum);
                    
                    // Only check IDENT tokens (not strings, comments, operators)
                    const identTokens = lineTokens.filter(t => t.type === 'IDENT');
                    
                    identTokens.forEach(token => {
                        const word = token.value;
                        
                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                        // MANDATORY GATING CONDITIONS (ALL must be true)
                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                        
                        // GATE 1: Token is standalone identifier (already filtered by type === 'IDENT')
                        // GATE 2: NOT inside string literal (already filtered - only IDENT tokens)
                        // GATE 3: NOT inside comment (already filtered - only IDENT tokens)
                        
                        // GATE 4: NOT a whitelisted VBA keyword/constant
                        if (VBA_WHITELIST.isWhitelisted(word)) {
                            return; // Skip - valid VBA keyword or constant
                        }
                        
                        // GATE 5: NOT part of compound statement (e.g., "Next" in "Next i")
                        if (VBA_WHITELIST.isPartOfCompound(word, line)) {
                            return; // Skip - part of valid compound like "Next i", "End If"
                        }
                        
                        // GATE 6: NOT part of known valid VBA phrase
                        if (isPartOfValidPhrase(line, word)) {
                            return; // Skip - part of valid phrase like "On Error Resume Next"
                        }
                        
                        // GATE 7: NOT part of object member chain (e.g., ws.Value, Err.Description)
                        if (VBA_WHITELIST.isPartOfMemberChain(word, line)) {
                            return; // Skip - part of object member chain
                        }
                        
                        // GATE 8: NOT an object member/property (Value, Count, Row, etc.)
                        if (VBA_WHITELIST.isObjectMember(word)) {
                            return; // Skip - valid object member
                        }
                        
                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                        // TYPO DETECTION: Two-tier system
                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                        
                        let typoDetected = false;
                        let correction = null;
                        let confidence = 0;
                        
                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                        // TIER 1: Check if it's a known typo (exact match)
                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                        if (knownTypos[word]) {
                            correction = knownTypos[word];
                            const distance = editDistance(word, correction.replace(/\s+/g, ''));
                            
                            if (distance <= 2) {
                                typoDetected = true;
                                confidence = 95;
                            }
                        }
                        
                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                        // TIER 2: Fuzzy match against ALL VBA keywords (if not in dictionary)
                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                        if (!typoDetected && word.length >= 3) {
                            // Build comprehensive keyword list from whitelist
                            const allKeywords = [
                                ...VBA_WHITELIST.CORE_KEYWORDS,
                                ...VBA_WHITELIST.VBA_FUNCTIONS,
                                ...VBA_WHITELIST.EXCEL_OBJECTS
                            ];
                            
                            // Find closest match
                            let minDistance = Infinity;
                            let closestMatch = null;
                            
                            for (const keyword of allKeywords) {
                                const distance = editDistance(word, keyword);
                                
                                // Only consider if edit distance is 1 or 2
                                if (distance > 0 && distance <= 2 && distance < minDistance) {
                                    minDistance = distance;
                                    closestMatch = keyword;
                                }
                            }
                            
                            // Also check compound statements
                            for (const compound of VBA_WHITELIST.COMPOUND_STATEMENTS) {
                                const firstWord = compound.split(/\s+/)[0];
                                const distance = editDistance(word, firstWord);
                                
                                if (distance > 0 && distance <= 2 && distance < minDistance) {
                                    minDistance = distance;
                                    closestMatch = compound;
                                }
                            }
                            
                            // If we found a close match
                            if (closestMatch && minDistance <= 2) {
                                typoDetected = true;
                                correction = closestMatch;
                                confidence = minDistance === 1 ? 90 : 75; // Higher confidence for 1-char difference
                            }
                        }
                        
                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                        // REPORT TYPO (if detected by either tier)
                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                        if (typoDetected && correction) {
                            findings.push({
                                ruleId: 'TYPO',
                                scope: 'Line',
                                symbol: word,
                                severity: 'Critical',
                                category: '✏️ Typo',
                                line: lineNum,
                                title: `Possible typo: "${word}"`,
                                problem: `This looks like a misspelling of "${correction}"`,
                                message: `Typo detected: "${word}" → "${correction}"`,
                                confidence: confidence,
                                code: line.trim(),
                                highlight: line.trim().replace(new RegExp(word, 'g'), `➜${word}← (typo?)`),
                                fix: null, // ADVISORY ONLY - NO AUTO-FIX
                                fixLabel: `Manual fix suggested: Replace with "${correction}"`,
                                tip: `⚠️ Advisory only - verify this is actually a typo before changing. Did you mean "${correction}"?`
                            });
                        }
                        
                        // Check for case-insensitive keyword match (VBA is case-insensitive but we check for common mistakes)
                        const wordLower = word.toLowerCase();
                        const possibleKeyword = Array.from(vbaKeywords).find(kw => kw.toLowerCase() === wordLower);
                        
                        // If we find a keyword match with different casing, it's technically valid but flag for consistency
                        if (possibleKeyword && word !== possibleKeyword && word.length > 3) {
                            // Only flag if it's ALL CAPS or all lowercase (not mixed case)
                            const isAllCaps = word === word.toUpperCase();
                            const isAllLower = word === word.toLowerCase();
                            
                            if (isAllCaps || isAllLower) {
                                findings.push({
                                    ruleId: 'KEYWORD_CASING',
                                    scope: 'Line',
                                    symbol: word,
                                    severity: 'Info',
                                    category: '💡 Style',
                                    line: lineNum,
                                    title: `Keyword casing: "${word}"`,
                                    problem: 'VBA keywords are typically PascalCase',
                                    message: `Consider using standard casing: "${possibleKeyword}"`,
                                    confidence: 70,
                                    code: line.trim(),
                                    highlight: line.trim().replace(word, `➜${word}←`),
                                    fix: line.trim().replace(word, possibleKeyword),
                                    fixLabel: `Use "${possibleKeyword}"`,
                                    tip: 'While VBA is case-insensitive, consistent casing improves readability.'
                                });
                            }
                        }
                    });
                });
                
                // 🔍 STRING LITERAL VALIDATION
                // Check if strings contain suspicious content (but don't flag keywords inside strings)
                tokens.filter(t => t.type === 'STRING').forEach(token => {
                    const stringContent = token.value;
                    
                    // Check for unclosed strings (missing closing quote)
                    if (!stringContent.endsWith('"')) {
                        // ========================================
                        // SAFE STRING AUTO-FIX DECISION LOGIC
                        // ========================================
                        
                        // Flag 1: This is an unclosed string
                        const isUnclosedString = true;
                        
                        // Flag 2: Check if string contains VBA structural keywords
                        const VBA_KEYWORDS = /\b(End\s+Sub|End\s+If|End\s+With|Sub|Function|If|Then|Else|For|Next|Do|Loop|Select|Case|With)\b/i;
                        const containsVBAKeyword = VBA_KEYWORDS.test(stringContent);
                        
                        // Flag 3: Check if this conflicts with block structure
                        const conflictsWithBlockStructure = /\b(End\s+(Sub|If|With|Function|Select)|Next|Loop)\b/i.test(stringContent);
                        
                        // AUTHORITATIVE DECISION: Allow auto-fix ONLY when safe
                        const allowStringAutoFix = 
                            isUnclosedString && 
                            !containsVBAKeyword && 
                            !conflictsWithBlockStructure;
                        
                        if (allowStringAutoFix) {
                            // ✅ SAFE TO AUTO-FIX
                            findings.push({
                                ruleId: 'UNCLOSED_STRING',
                                scope: 'Line',
                                severity: 'Critical',
                                category: '🔤 String Error',
                                line: token.line,
                                title: 'Unclosed string literal',
                                problem: 'String is missing closing quote',
                                message: 'String literal is not properly terminated',
                                confidence: 100,
                                code: stringContent,
                                highlight: stringContent + ' ➜ MISSING "',
                                fix: stringContent + '"',
                                fixLabel: 'Add closing quote',
                                tip: 'Every string must start and end with a double quote character.'
                            });
                        } else {
                            // ❌ UNSAFE TO AUTO-FIX: Contains VBA keywords
                            findings.push({
                                ruleId: 'UNCLOSED_STRING_UNSAFE',
                                scope: 'Line',
                                severity: 'Critical',
                                category: '🔤 String Error',
                                line: token.line,
                                title: 'Unclosed string literal (manual fix required)',
                                problem: 'Unclosed string contains VBA keywords - auto-fix blocked for safety',
                                message: 'String contains structural keywords - adding quote could break code structure',
                                confidence: 100,
                                code: stringContent,
                                highlight: stringContent + ' ➜ MISSING " (contains VBA keywords)',
                                fix: null,  // NO AUTO-FIX
                                fixLabel: null,
                                tip: '⚠️ Manual fix required — This string contains VBA structural keywords (End Sub, End If, etc.). Adding a quote automatically could break code structure. Please fix manually and verify block matching.'
                            });
                        }
                    }
                });
                
                return findings;
            }
            
            // Helper: Check if a token is inside a string or comment
            function isInStringOrComment(tokens, position) {
                for (let token of tokens) {
                    if (token.type === 'STRING' || token.type === 'COMMENT') {
                        if (position >= token.start && position < token.end) {
                            return true;
                        }
                    }
                }
                return false;
            }

            return { run, isInStringOrComment };
        })();

        // 6️⃣ PRODUCTION-GRADE LINT REPORTING LAYER
        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        // Eliminates duplicates, cascades, and invalid fixes
        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        
        const LintReportingLayer = (() => {
            
            // 1️⃣ DEDUPLICATION ENGINE
            // Eliminates duplicate findings (same issue reported multiple times)
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // ENHANCED: Special handling for performance warnings per loop
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            function dedupeFindings(findings) {
                const map = new Map();
                const performanceByLoop = new Map(); // Track performance warnings by loop
                
                for (const f of findings) {
                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    // SPECIAL HANDLING: Performance warnings (merge per loop)
                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    if ((f.ruleId === 'ARRAY_OPTIMIZATION' || 
                         f.category === '⚡ Performance' ||
                         f.title?.includes('Cell-by-cell') ||
                         f.title?.includes('cell-by-cell')) &&
                        f.line) {
                        
                        // Group by approximate loop location (within 20 lines)
                        const loopGroup = Math.floor(f.line / 20);
                        const perfKey = `PERF_LOOP_${loopGroup}`;
                        
                        if (!performanceByLoop.has(perfKey)) {
                            performanceByLoop.set(perfKey, f);
                        } else {
                            // Keep the one with MORE specific message
                            const existing = performanceByLoop.get(perfKey);
                            if ((f.message?.length || 0) > (existing.message?.length || 0)) {
                                performanceByLoop.set(perfKey, f);
                            }
                        }
                        continue; // Skip normal deduplication for performance warnings
                    }
                    
                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    // NORMAL DEDUPLICATION: Other findings
                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    
                    // Create unique key from ruleId + scope + symbol + message
                    const key = [
                        f.ruleId || 'UNKNOWN',
                        f.scope || 'Line',
                        f.symbol || '',
                        f.message || f.title || ''
                    ].join('|');
                    
                    // Keep highest severity only
                    if (!map.has(key)) {
                        map.set(key, f);
                    } else {
                        const existing = map.get(key);
                        if (severityRank(f.severity) > severityRank(existing.severity)) {
                            map.set(key, f);
                        }
                    }
                }
                
                // Merge performance warnings back
                const dedupedFindings = Array.from(map.values());
                const dedupedPerformance = Array.from(performanceByLoop.values());
                
                return [...dedupedFindings, ...dedupedPerformance];
            }
            
            // 2️⃣ CASCADE SUPPRESSION
            // Stops errors caused by another error (like unclosed strings)
            function suppressCascades(findings) {
                const suppressed = [];
                let blockAfterCritical = false;
                
                // Sort by line number first
                const sorted = findings.sort((a, b) => a.line - b.line);
                
                for (const f of sorted) {
                    // Skip syntax errors that come after a critical syntax error
                    if (blockAfterCritical && 
                        (f.category === 'Syntax' || f.category === '⚠️ Syntax Error' || f.category === '⚠️ Structure Error')) {
                        continue;
                    }
                    
                    suppressed.push(f);
                    
                    // If we hit a critical syntax error (like unclosed string), block subsequent syntax errors
                    if ((f.category === 'Syntax' || f.category === '🔤 String Error' || f.category === '🔤 Quote Error') &&
                        (f.severity === 'Critical' || f.type === 'error') &&
                        (f.ruleId === 'UNCLOSED_STRING' || f.title?.includes('Unclosed') || f.title?.includes('quote'))) {
                        blockAfterCritical = true;
                    }
                }
                
                return suppressed;
            }
            
            // 3️⃣ SEVERITY NORMALIZATION
            // Prevents over-aggressive warnings
            function normalizeSeverity(findings) {
                return findings.map(f => {
                    // Magic numbers are NEVER Critical
                    if (f.ruleId === 'MAGIC_NUMBER' || f.title?.includes('Magic number')) {
                        f.severity = 'Info';
                        f.type = 'info';
                        f.confidence = Math.min(f.confidence || 100, 75);
                        f.category = '💡 Best Practice';
                    }
                    
                    // Best practices should not block execution
                    if ((f.category === 'BestPractice' || f.category === '💡 Best Practice') && 
                        (f.severity === 'Major' || f.severity === 'Critical')) {
                        f.severity = 'Minor';
                        f.type = 'info';
                    }
                    
                    // Single-letter variables are suggestions, not errors
                    if (f.ruleId === 'SINGLE_LETTER_VAR' || f.title?.includes('Single-letter')) {
                        f.severity = 'Info';
                        f.type = 'info';
                    }
                    
                    // Public variable warnings should be minor
                    if (f.ruleId === 'PUBLIC_VAR_OVERUSE' || f.title?.includes('Public variable')) {
                        f.severity = 'Minor';
                        f.type = 'warning';
                    }
                    
                    // Commented code detection should be info
                    if (f.ruleId === 'COMMENTED_CODE' || f.title?.includes('commented-out code')) {
                        f.severity = 'Info';
                        f.type = 'info';
                    }
                    
                    // Many ElseIf is a suggestion, not error
                    if (f.ruleId === 'MANY_ELSEIF' || f.title?.includes('ElseIf')) {
                        f.severity = 'Info';
                        f.type = 'info';
                        f.scope = 'IfBlock';
                    }
                    
                    // Naming conventions are style suggestions
                    if (f.ruleId === 'NAMING_CONVENTION' || f.category === '📝 Naming Convention') {
                        f.severity = 'Info';
                        f.type = 'info';
                    }
                    
                    return f;
                });
            }
            
            // 4️⃣ FIX ELIGIBILITY POLICY
            // FIX GROUP B: Only UNCLOSED_STRING and INTEGER_TO_LONG can show "FIXED VERSION"
            function filterUnsafeFixes(findings) {
                // FIX GROUP B: ONLY these rules may show "FIXED VERSION"
                const SAFE_FIX_RULES = new Set([
                    'UNCLOSED_STRING',     // Closing a missing quote - safe
                    'INTEGER_TO_LONG'      // Type widening only - safe
                ]);
                
                return findings.map(f => {
                    if (!f.fix) return f;
                    
                    // FIX GROUP B: Check if this rule is in the safe list
                    const isSafeRule = SAFE_FIX_RULES.has(f.ruleId);
                    
                    // FIX GROUP B: Additional safety checks for title patterns
                    const isUnclosedString = f.title?.includes('Unclosed string') || 
                                            f.title?.includes('Missing closing quote');
                    const isIntegerToLong = f.title?.includes('Integer instead of Long') ||
                                           f.title?.includes('Use Long instead of Integer');
                    
                    const isSafe = isSafeRule || isUnclosedString || isIntegerToLong;
                    
                    // FIX GROUP B: If not safe, remove "FIXED VERSION" and use "Manual" wording
                    if (!isSafe) {
                        // Change fixLabel to indicate manual fix
                        if (f.fixLabel) {
                            // Change wording from "Replace with" to "Manual refactor idea" or "Suggested example"
                            if (f.fixLabel.includes('Replace')) {
                                f.fixLabel = 'Manual refactor idea: ' + f.fixLabel.replace('Replace with', 'Use');
                            } else {
                                f.fixLabel = 'Suggested example: ' + f.fixLabel;
                            }
                        }
                        // FIX GROUP B: Remove the actual fix code (no FIXED VERSION shown)
                        f.fix = null;
                    }
                    
                    return f;
                });
            }
            
            // 5️⃣ SEVERITY RANKING (Helper)
            function severityRank(level) {
                const ranks = {
                    'Critical': 4,
                    'Major': 3,
                    'Minor': 2,
                    'Info': 1,
                    'error': 4,
                    'warning': 3,
                    'info': 1
                };
                return ranks[level] || 0;
            }
            
            // 6️⃣ FINAL REPORTING PIPELINE
            // This is the main function to use
            function prepareLintReport(rawFindings) {
                if (!rawFindings || rawFindings.length === 0) {
                    return [];
                }
                
                // Apply all filters in order
                let report = dedupeFindings(rawFindings);
                report = suppressCascades(report);
                report = normalizeSeverity(report);
                report = filterUnsafeFixes(report);
                
                // Sort by severity (highest first), then by line number
                report.sort((a, b) => {
                    const severityDiff = severityRank(b.severity) - severityRank(a.severity);
                    if (severityDiff !== 0) return severityDiff;
                    return a.line - b.line;
                });
                
                return report;
            }
            
            // 7️⃣ FINDING GROUPING (for better presentation)
            function groupFindings(findings) {
                const groups = {
                    Critical: [],
                    Major: [],
                    Minor: [],
                    Info: []
                };
                
                findings.forEach(f => {
                    const severity = f.severity || 'Info';
                    if (groups[severity]) {
                        groups[severity].push(f);
                    } else {
                        groups.Info.push(f);
                    }
                });
                
                return groups;
            }
            
            // 8️⃣ NORMALIZE FINDING FORMAT
            // Ensures all findings have standard fields
            function normalizeFindingFormat(finding) {
                return {
                    ruleId: finding.ruleId || generateRuleId(finding),
                    category: finding.category || 'BestPractice',
                    severity: finding.severity || 'Info',
                    type: finding.type || severityToType(finding.severity),
                    scope: finding.scope || 'Line',
                    symbol: finding.symbol || null,
                    line: finding.line || 1,
                    title: finding.title || finding.message || 'Issue detected',
                    message: finding.message || finding.title || 'Issue detected',
                    problem: finding.problem || finding.message,
                    confidence: finding.confidence || 80,
                    code: finding.code || '',
                    highlight: finding.highlight || finding.code,
                    fix: finding.fix || null,
                    fixLabel: finding.fixLabel || null,
                    tip: finding.tip || ''
                };
            }
            
            // Helper: Generate ruleId from finding
            function generateRuleId(finding) {
                if (finding.title?.includes('Magic number')) return 'MAGIC_NUMBER';
                if (finding.title?.includes('ElseIf')) return 'MANY_ELSEIF';
                if (finding.title?.includes('Integer')) return 'INTEGER_TO_LONG';
                if (finding.title?.includes('typo')) return 'TYPO';
                if (finding.title?.includes('quote')) return 'UNICODE_QUOTES';
                if (finding.title?.includes('Unclosed')) return 'UNCLOSED_STRING';
                if (finding.title?.includes('Missing "Then"')) return 'MISSING_THEN';
                if (finding.title?.includes('Missing "Set"')) return 'MISSING_SET';
                if (finding.title?.includes('End If')) return 'MISSING_END_IF';
                if (finding.title?.includes('Next')) return 'MISSING_NEXT';
                if (finding.title?.includes('Loop')) return 'MISSING_LOOP';
                if (finding.title?.includes('Option Explicit')) return 'MISSING_OPTION_EXPLICIT';
                if (finding.title?.includes('Single-letter')) return 'SINGLE_LETTER_VAR';
                if (finding.title?.includes('Public variable')) return 'PUBLIC_VAR_OVERUSE';
                if (finding.title?.includes('commented')) return 'COMMENTED_CODE';
                return 'UNKNOWN';
            }
            
            // Helper: Convert severity to type
            function severityToType(severity) {
                if (severity === 'Critical' || severity === 'Major') return 'error';
                if (severity === 'Minor') return 'warning';
                return 'info';
            }
            
            return { 
                prepareLintReport,
                groupFindings,
                normalizeFindingFormat,
                dedupeFindings,
                suppressCascades,
                normalizeSeverity,
                filterUnsafeFixes,
                severityRank
            };
        })();

        // 7️⃣ AI LOCKDOWN RULES (Non-Negotiable for Claude/Gemini Integration)
        const AILockdown = (() => {
            // Prepare context for AI with strict rules
            function prepareContext(code, verifiedFindings) {
                return {
                    context: "Excel VBA",
                    codeLength: code.length,
                    lineCount: code.split('\n').length,
                    verifiedFindings: verifiedFindings.map(f => ({
                        line: f.line,
                        severity: f.severity,
                        category: f.category,
                        title: f.title,
                        confidence: f.confidence || 0
                    })),
                    rules: {
                        // CRITICAL: AI cannot override these
                        noHallucination: true,
                        noTyposInsideStrings: true,
                        noCurlyQuoteWarningsUnlessUnicode: true,
                        noArraySuggestionsForRecordsets: true,
                        noResumNextTypos: true,
                        requireEvidence: true,
                        minConfidence: 85
                    },
                    instructions: {
                        STRICT: "Do not claim errors inside string literals or comments.",
                        CURLY_QUOTES: "Only report curly quotes if Unicode smart quotes (U+201C/U+201D/U+2018/U+2019) are present.",
                        TYPOS: "Typo reports must include exact token, position, and valid VBA keyword correction.",
                        ARRAYS: "Do not suggest array optimization for recordset field loops (rs.Fields.Count).",
                        ERROR_HANDLING: "For 'On Error Resume Next', warn about missing reset ONLY if no 'On Error GoTo 0' appears later.",
                        OUTPUT: "Return findings with confidence 0-100 and exact evidence snippets."
                    }
                };
            }
            
            // Validate AI response against deterministic findings
            function validateAIResponse(aiFindings, verifiedFindings) {
                const validated = [];
                const rejected = [];
                
                aiFindings.forEach(aiFinding => {
                    // Check if AI finding matches a verified finding
                    const matchesVerified = verifiedFindings.some(vf => 
                        vf.line === aiFinding.line && 
                        vf.severity === aiFinding.severity
                    );
                    
                    // AI can only:
                    // 1. Explain verified findings
                    // 2. Suggest improvements (not errors) with low severity
                    if (matchesVerified) {
                        validated.push({ ...aiFinding, source: 'verified' });
                    } else if (aiFinding.severity === 'Info' || aiFinding.severity === 'Minor') {
                        validated.push({ ...aiFinding, source: 'ai-suggestion' });
                    } else {
                        rejected.push({ 
                            ...aiFinding, 
                            reason: 'AI cannot create Critical/Major findings - only verified linter can'
                        });
                    }
                });
                
                return { validated, rejected };
            }
            
            // Log rejected findings for debugging
            function logRejections(rejected) {
                if (rejected.length > 0) {
                    console.warn('AI Lockdown: Rejected ' + rejected.length + ' AI-generated findings:');
                    rejected.forEach(r => {
                        console.warn(`  ❌ Line ${r.line}: ${r.title} (Reason: ${r.reason})`);
                    });
                }
            }

            return { prepareContext, validateAIResponse, logRejections };
        })();

        // ========================================
        // NULL-SAFE HELPER FUNCTIONS (CRITICAL)
        // ========================================
        
        /**
         * Safely gets string value with fallback
         * Prevents "Cannot read properties of null" errors
         */
        function safeString(value, fallback = '') {
            if (value === null || value === undefined) return fallback;
            if (typeof value === 'string') return value;
            return String(value);
        }
        
        /**
         * Safely performs string operations
         */
        function safeReplace(text, search, replacement) {
            const safe = safeString(text);
            try {
                return safe.replace(search, replacement);
            } catch (error) {
                console.warn('safeReplace error:', error);
                return safe;
            }
        }
        
        /**
         * Safely trims string
         */
        function safeTrim(text) {
            const safe = safeString(text);
            return safe.trim();
        }
        
        /**
         * Safely converts to lowercase
         */
        function safeLower(text) {
            const safe = safeString(text);
            return safe.toLowerCase();
        }
        
        /**
         * Safely accesses token value
         */
        function getTokenValue(token, fallback = '') {
            if (!token) return fallback;
            return safeString(token.value, fallback);
        }
        
        // ========================================
        // GRAMMAR ERROR DETECTION (MANDATORY)
        // ========================================
        
        /**
         * Detects critical grammar errors that invalidate code
         * Returns array of grammar error objects
         */
        function detectGrammarErrors(lines) {
            const errors = [];
            const blockStack = [];
            
            try {
                lines.forEach((line, idx) => {
                    const lineNum = idx + 1;
                    const trimmed = safeTrim(line);
                    const lowerLine = safeLower(trimmed);
                    
                    // Skip empty lines and comments
                    if (!trimmed || trimmed.startsWith("'")) return;
                    
                    // 1. Invalid Sub declaration
                    if (/^Sub\s*$/i.test(trimmed)) {
                        errors.push({
                            line: lineNum,
                            type: 'INVALID_SUB',
                            severity: 'Critical',
                            category: '⚠️ Grammar Error',
                            title: 'Invalid Sub declaration',
                            message: 'Sub statement requires a procedure name.',
                            code: trimmed,
                            isCritical: true
                        });
                    }
                    
                    // 2. Invalid Function declaration
                    if (/^Function\s*$/i.test(trimmed)) {
                        errors.push({
                            line: lineNum,
                            type: 'INVALID_FUNCTION',
                            severity: 'Critical',
                            category: '⚠️ Grammar Error',
                            title: 'Invalid Function declaration',
                            message: 'Function statement requires a procedure name.',
                            code: trimmed,
                            isCritical: true
                        });
                    }
                    
                    // Track block openings
                    if (/^If\s+.*\s+Then\s*$/i.test(trimmed) && !/^If\s+.*\s+Then\s+.+$/i.test(trimmed)) {
                        blockStack.push({ type: 'If', line: lineNum });
                    }
                    if (/^For\s+/i.test(trimmed)) {
                        blockStack.push({ type: 'For', line: lineNum });
                    }
                    if (/^Do\s+/i.test(trimmed) || /^Do$/i.test(trimmed)) {
                        blockStack.push({ type: 'Do', line: lineNum });
                    }
                    if (/^With\s+/i.test(trimmed)) {
                        blockStack.push({ type: 'With', line: lineNum });
                    }
                    if (/^Select\s+Case/i.test(trimmed)) {
                        blockStack.push({ type: 'Select', line: lineNum });
                    }
                    if (/^Sub\s+\w+/i.test(trimmed)) {
                        blockStack.push({ type: 'Sub', line: lineNum });
                    }
                    if (/^Function\s+\w+/i.test(trimmed)) {
                        blockStack.push({ type: 'Function', line: lineNum });
                    }
                    
                    // Track block closings and detect orphans
                    // 3. Orphan End If
                    if (/^End\s+If/i.test(trimmed)) {
                        const last = blockStack[blockStack.length - 1];
                        if (!last || last.type !== 'If') {
                            errors.push({
                                line: lineNum,
                                type: 'ORPHAN_END_IF',
                                severity: 'Critical',
                                category: '⚠️ Grammar Error',
                                title: 'End If without matching If',
                                message: 'Block structure mismatch.',
                                code: trimmed,
                                isCritical: true
                            });
                        } else {
                            blockStack.pop();
                        }
                    }
                    
                    // 4. Orphan End With
                    if (/^End\s+With/i.test(trimmed)) {
                        const last = blockStack[blockStack.length - 1];
                        if (!last || last.type !== 'With') {
                            errors.push({
                                line: lineNum,
                                type: 'ORPHAN_END_WITH',
                                severity: 'Critical',
                                category: '⚠️ Grammar Error',
                                title: 'End With without matching With',
                                message: 'Block structure mismatch.',
                                code: trimmed,
                                isCritical: true
                            });
                        } else {
                            blockStack.pop();
                        }
                    }
                    
                    // Orphan Next
                    if (/^Next\b/i.test(trimmed)) {
                        const last = blockStack[blockStack.length - 1];
                        if (!last || last.type !== 'For') {
                            errors.push({
                                line: lineNum,
                                type: 'ORPHAN_NEXT',
                                severity: 'Critical',
                                category: '⚠️ Grammar Error',
                                title: 'Next without matching For',
                                message: 'Block structure mismatch.',
                                code: trimmed,
                                isCritical: true
                            });
                        } else {
                            blockStack.pop();
                        }
                    }
                    
                    // Orphan Loop
                    if (/^Loop\b/i.test(trimmed)) {
                        const last = blockStack[blockStack.length - 1];
                        if (!last || last.type !== 'Do') {
                            errors.push({
                                line: lineNum,
                                type: 'ORPHAN_LOOP',
                                severity: 'Critical',
                                category: '⚠️ Grammar Error',
                                title: 'Loop without matching Do',
                                message: 'Block structure mismatch.',
                                code: trimmed,
                                isCritical: true
                            });
                        } else {
                            blockStack.pop();
                        }
                    }
                    
                    // Orphan End Sub
                    if (/^End\s+Sub/i.test(trimmed)) {
                        const last = blockStack[blockStack.length - 1];
                        if (!last || last.type !== 'Sub') {
                            errors.push({
                                line: lineNum,
                                type: 'ORPHAN_END_SUB',
                                severity: 'Critical',
                                category: '⚠️ Grammar Error',
                                title: 'End Sub without matching Sub',
                                message: 'Block structure mismatch.',
                                code: trimmed,
                                isCritical: true
                            });
                        } else {
                            blockStack.pop();
                        }
                    }
                    
                    // Orphan End Function
                    if (/^End\s+Function/i.test(trimmed)) {
                        const last = blockStack[blockStack.length - 1];
                        if (!last || last.type !== 'Function') {
                            errors.push({
                                line: lineNum,
                                type: 'ORPHAN_END_FUNCTION',
                                severity: 'Critical',
                                category: '⚠️ Grammar Error',
                                title: 'End Function without matching Function',
                                message: 'Block structure mismatch.',
                                code: trimmed,
                                isCritical: true
                            });
                        } else {
                            blockStack.pop();
                        }
                    }
                    
                    // 5. Invalid MsgBox arguments
                    if (/^MsgBox\s*$/i.test(trimmed) || /^MsgBox\s*\(/i.test(trimmed)) {
                        // Check if there's a prompt string
                        const msgBoxMatch = trimmed.match(/MsgBox\s*(.*)$/i);
                        if (msgBoxMatch) {
                            const args = safeTrim(msgBoxMatch[1]);
                            // If empty or just opening paren, invalid
                            if (!args || args === '(' || args === '()') {
                                errors.push({
                                    line: lineNum,
                                    type: 'INVALID_MSGBOX',
                                    severity: 'Critical',
                                    category: '⚠️ Grammar Error',
                                    title: 'Invalid MsgBox arguments',
                                    message: 'MsgBox requires a prompt string as the first argument.',
                                    code: trimmed,
                                    isCritical: true
                                });
                            }
                        }
                    }
                });
                
                // Check for unclosed blocks
                blockStack.forEach(block => {
                    errors.push({
                        line: block.line,
                        type: 'UNCLOSED_BLOCK',
                        severity: 'Critical',
                        category: '⚠️ Grammar Error',
                        title: `Unclosed ${block.type} block`,
                        message: `${block.type} block opened at line ${block.line} but never closed.`,
                        code: `(opened at line ${block.line})`,
                        isCritical: true
                    });
                });
                
            } catch (error) {
                console.error('Grammar detection error:', error);
                // Never crash - return what we found
            }
            
            return errors;
        }
        
        /**
         * Checks if critical grammar errors exist
         */
        function hasCriticalGrammarErrors(errors) {
            return errors.some(err => err.isCritical === true);
        }

        // Live Code Analysis
        function performLiveAnalysis() {
            const codeInput = document.getElementById('codeInput');
            if (!codeInput) {
                console.warn('performLiveAnalysis: codeInput element not found');
                return;
            }
            
            const code = codeInput.value;
            
            if (!code.trim()) {
                // Don't show notification if code is empty (let auto-clear handle it)
                checkAndAutoClearCodeNotifications();
                return;
            }
            
            try {
                const issues = analyzeCode(code);
                
                // Clear previous notifications before adding new ones
                const content = document.getElementById('codeNotifContent');
                if (content) {
                    content.innerHTML = '';
                }
                
                // CRITICAL NULL-SAFETY: Validate issues array
                if (!Array.isArray(issues)) {
                    console.error('analyzeCode returned non-array:', issues);
                    addCodeNotification('error', '⚠️ Analysis produced unexpected results');
                    return;
                }
                
                if (issues.length === 0) {
                    addCodeNotification('success', '✓ No issues detected - your code looks clean!');
                } else {
                    // CRITICAL: Wrap each issue in try-catch so one bad issue doesn't stop others
                    issues.forEach((issue, index) => {
                        try {
                            addCodeNotificationEnhanced(issue);
                        } catch (issueError) {
                            console.error(`Error rendering issue #${index}:`, issueError, 'Issue:', issue);
                            // Continue with next issue - don't let one bad issue break all notifications
                        }
                    });
                }
            } catch (error) {
                console.error('Error in performLiveAnalysis:', error);
                addCodeNotification('error', '❌ Analysis error: ' + error.message);
            }
        }

        function analyzeCode(code) {
            const issues = [];
            const lines = code.split('\n');
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // 🚀 LAYER 0: GRAMMAR ERROR DETECTION (CRITICAL - FIRST)
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            
            let grammarErrors = [];
            let hasCriticalErrors = false;
            
            try {
                grammarErrors = detectGrammarErrors(lines);
                hasCriticalErrors = hasCriticalGrammarErrors(grammarErrors);
                
                // Add grammar errors to issues
                grammarErrors.forEach(err => {
                    issues.push({
                        line: err.line,
                        type: 'error',
                        category: err.category,
                        title: err.title,
                        problem: err.message,
                        code: err.code,
                        highlight: err.title,
                        fix: null, // Grammar errors have NO auto-fix
                        fixLabel: null,
                        tip: 'Manual correction required for grammar errors.',
                        isGrammarError: true,
                        isCritical: err.isCritical
                    });
                });
                
                // CASCADE SUPPRESSION: If critical grammar errors exist, suppress other checks
                if (hasCriticalErrors) {
                    console.log('⚠️ Critical grammar errors found - suppressing secondary checks');
                    issues.push({
                        line: 0,
                        type: 'info',
                        category: 'ℹ️ Analysis Note',
                        title: 'Additional errors suppressed',
                        problem: 'Additional errors suppressed due to critical grammar errors.',
                        code: '',
                        highlight: 'Fix grammar errors first, then re-run analysis.',
                        fix: null,
                        fixLabel: null,
                        tip: 'Grammar errors must be fixed before other issues can be accurately detected.'
                    });
                    
                    // Return only grammar errors - don't continue analysis
                    return issues;
                }
            } catch (error) {
                console.error('Grammar detection error:', error);
                // Never crash - continue with analysis
            }
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // 🚀 LAYER 1: TOKENIZER-BASED ANALYSIS (False-Positive Prevention)
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            
            try {
                const lintFindings = VBALintEngine.run(code);
                
                // Add tokenizer findings to issues array
                lintFindings.forEach(finding => {
                    issues.push({
                        line: finding.line,
                        type: finding.severity === 'Critical' ? 'error' : 
                              finding.severity === 'Major' ? 'warning' : 'info',
                        category: finding.category,
                        title: finding.title,
                        problem: finding.problem,
                        code: finding.code,
                        highlight: finding.highlight,
                        fix: finding.fix,
                        fixLabel: finding.fixLabel,
                        tip: finding.tip
                    });
                });
            } catch (e) {
                console.error('VBA Lint Engine error:', e);
                // Continue with legacy analysis
            }
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // 🚀 LAYER 1.5: FORMAT & STATEMENT VALIDATION (ADDITIVE)
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            
            try {
                // Run format validator (spacing, quotes, colons)
                const formatIssues = VBAFormatValidator.validate(code);
                formatIssues.forEach(issue => {
                    issues.push(issue);
                });
            } catch (e) {
                console.error('Format validator error:', e);
                // Continue with analysis
            }
            
            try {
                // Run statement structure validator
                const statementIssues = VBAStatementValidator.validate(code);
                statementIssues.forEach(issue => {
                    issues.push(issue);
                });
            } catch (e) {
                console.error('Statement validator error:', e);
                // Continue with analysis
            }
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // 🔍 LAYER 2: ENHANCED LEGACY ANALYSIS (Token-Aware)
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            
            // Tokenize for string/comment detection
            let tokens = [];
            try {
                tokens = VBATokenizer.tokenize(code);
            } catch (e) {
                console.warn('Tokenizer fallback:', e);
            }
            
            const hasOptionExplicit = /^\s*Option\s+Explicit/i.test(code);

            // 1️⃣ CHECK: Option Explicit at top (CRITICAL)
            if (!hasOptionExplicit) {
                issues.push({
                    line: 1,
                    type: 'error',
                    category: '🔴 Critical - Missing Option Explicit',
                    title: 'Option Explicit not found',
                    problem: 'Every module MUST start with "Option Explicit" to prevent typo bugs',
                    code: '(missing at top of file)',
                    highlight: '➜ ADD at line 1: Option Explicit',
                    fix: 'Option Explicit\n\n' + code,
                    fixLabel: 'Add "Option Explicit" as first line',
                    tip: 'This forces you to declare all variables, preventing silent bugs from typos.'
                });
            }

            lines.forEach((line, idx) => {
                // CRITICAL NULL SAFETY: Skip if line is null/undefined
                if (line === null || line === undefined) {
                    console.warn('Skipping null/undefined line at index', idx);
                    return;
                }
                
                const lineNum = idx + 1;
                const trimmed = safeTrim(line);  // Use safe helper
                const trimmedLower = safeLower(trimmed);  // Use safe helper

                // Skip empty lines and pure comments
                if (!trimmed || trimmed.startsWith("'")) return;

                // 2️⃣ SMART QUOTES CHECK (Unicode only - token aware)
                // NOTE: VBALintEngine handles this, but we keep this for comprehensive detection
                // ONLY flag if we find UNICODE curly quotes (\u201C \u201D \u2018 \u2019)
                // Do NOT flag ASCII quotes (") which are valid
                const hasUnicodeCurlyQuotes = /[\u201C\u201D\u2018\u2019]/.test(line);
                
                if (hasUnicodeCurlyQuotes) {
                    // Check if this line's position is NOT inside a string literal or comment token
                    const lineTokens = tokens.filter(t => t && t.line === lineNum);
                    const isInsideStringOrComment = lineTokens.some(t => 
                        t && (t.type === 'STRING' || t.type === 'COMMENT') && 
                        t.value && /[\u201C\u201D\u2018\u2019]/.test(t.value)
                    );
                    
                    // Even if inside string, curly quotes are still errors
                    const problematic = safeReplace(line, /[\u201C\u201D]/g, '➜"←');
                    const problematic2 = safeReplace(problematic, /[\u2018\u2019]/g, "➜'←");
                    issues.push({ 
                        line: lineNum,
                        type: 'error',
                        category: '🔤 Quote Error',
                        title: 'Unicode smart quotes detected (curly quotes)',
                        problem: 'VBA requires ASCII straight quotes " and \', not Unicode curly quotes',
                        code: trimmed,
                        highlight: problematic2,
                        fix: safeReplace(safeReplace(line, /[\u201C\u201D]/g, '"'), /[\u2018\u2019]/g, "'"),
                        fixLabel: 'Replace Unicode curly quotes with ASCII straight quotes',
                        tip: 'Unicode curly quotes (U+201C, U+201D, U+2018, U+2019) won\'t compile. Use ASCII " and \'.'
                    });
                }

                // 3️⃣ UNCLOSED STRING CHECK (Token-aware with SAFE AUTO-FIX)
                const quotes = (line.match(/"/g) || []).length;
                if (quotes % 2 !== 0 && !trimmed.startsWith("'")) {
                    // ========================================
                    // SAFE STRING AUTO-FIX DECISION LOGIC
                    // ========================================
                    
                    // Flag 1: This is an unclosed string
                    const isUnclosedString = true;
                    
                    // Flag 2: Check if string contains VBA structural keywords
                    const VBA_KEYWORDS = /\b(End\s+Sub|End\s+If|End\s+With|Sub|Function|If|Then|Else|For|Next|Do|Loop|Select|Case|With)\b/i;
                    const containsVBAKeyword = VBA_KEYWORDS.test(trimmed);
                    
                    // Flag 3: Check if this conflicts with block structure
                    // A string conflicts with structure if:
                    // - It contains "End" + keyword (would close a block)
                    // - It contains structural keywords in positions where VBA expects code
                    const conflictsWithBlockStructure = /\b(End\s+(Sub|If|With|Function|Select)|Next|Loop)\b/i.test(trimmed);
                    
                    // AUTHORITATIVE DECISION: Allow auto-fix ONLY when safe
                    const allowStringAutoFix = 
                        isUnclosedString && 
                        !containsVBAKeyword && 
                        !conflictsWithBlockStructure;
                    
                    if (allowStringAutoFix) {
                        // ✅ SAFE TO AUTO-FIX: Pure string literal
                        // Examples: msg = "Hello, MsgBox "Error, Debug.Print "Value
                        issues.push({ 
                            line: lineNum,
                            type: 'error',
                            category: '🔤 String Error',
                            title: 'Missing closing quote',
                            problem: 'String has opening " but no closing "',
                            code: trimmed,
                            highlight: trimmed + ' ➜ MISSING "',
                            fix: trimmed + '"',
                            fixLabel: 'Add closing quote at end',
                            tip: 'Every opening " must have a closing ". This is a safe fix for string literals.'
                        });
                    } else {
                        // ❌ UNSAFE TO AUTO-FIX: Contains VBA keywords or conflicts with structure
                        // Examples: " End Sub, " End If, " Next i
                        issues.push({ 
                            line: lineNum,
                            type: 'error',
                            category: '🔤 String Error',
                            title: 'Missing closing quote (manual fix required)',
                            problem: 'Unclosed string contains VBA keywords - auto-fix blocked for safety',
                            code: trimmed,
                            highlight: trimmed + ' ➜ MISSING " (contains VBA keywords)',
                            fix: null,  // NO AUTO-FIX
                            fixLabel: null,
                            tip: '⚠️ This string contains VBA structural keywords. Adding a quote automatically could break code structure. Please fix manually and verify block matching.'
                        });
                    }
                }

                // 4️⃣ MISSING THEN CHECK
                if (trimmedLower.match(/^if\s+/) && !trimmedLower.includes('then') && !trimmed.includes('_')) {
                    issues.push({ 
                        line: lineNum,
                        type: 'error',
                        category: '⚠️ Syntax Error',
                        title: 'If statement missing "Then"',
                        problem: 'All If statements must end with "Then"',
                        code: trimmed,
                        highlight: trimmed + ' ➜ ADD: Then',
                        fix: trimmed + ' Then',
                        fixLabel: 'Add "Then" keyword',
                        tip: 'Correct format: If [condition] Then'
                    });
                }

                // 5️⃣ MISSING SET FOR OBJECT ASSIGNMENT
                const objectAssign = trimmed.match(/^(\w+)\s*=\s*(Range|Worksheet|Workbook|Cells|ThisWorkbook|ActiveWorkbook|Sheets)\(/i);
                if (objectAssign && !trimmedLower.startsWith('set')) {
                    issues.push({ 
                        line: lineNum,
                        type: 'error',
                        category: '🎯 Object Error',
                        title: 'Missing "Set" for object assignment',
                        problem: 'Object variables require "Set" keyword',
                        code: trimmed,
                        highlight: '➜ ADD: Set ' + trimmed,
                        fix: 'Set ' + trimmed,
                        fixLabel: 'Add "Set" before assignment',
                        tip: 'Use Set for objects (Range, Worksheet). Use = for values (numbers, strings).'
                    });
                }

                // 6️⃣ IMPLICIT VARIANT DETECTION
                const dimMatch = trimmed.match(/^Dim\s+(\w+)\s*$/i);
                if (dimMatch) {
                    issues.push({
                        line: lineNum,
                        type: 'warning',
                        category: '⚠️ Type Warning',
                        title: 'Variable declared without type (implicit Variant)',
                        problem: 'Variable will be Variant (slow and error-prone)',
                        code: trimmed,
                        highlight: trimmed + ' ➜ ADD: As [Type]',
                        fix: trimmed + ' As Variant  \' Specify: String, Long, etc.',
                        fixLabel: 'Add explicit type declaration',
                        tip: 'Always specify type: Dim x As Long, Dim name As String, etc.'
                    });
                }

                // 7️⃣ INTEGER VS LONG CHECK
                if (trimmed.match(/As\s+Integer\b/i)) {
                    issues.push({
                        line: lineNum,
                        type: 'warning',
                        category: '💡 Best Practice',
                        title: 'Using Integer instead of Long',
                        problem: 'Integer is 16-bit (limit: -32,768 to 32,767). Long is better.',
                        code: trimmed,
                        highlight: safeReplace(trimmed, /Integer/i, '➜Integer← (use Long)'),
                        fix: safeReplace(trimmed, /Integer/i, 'Long'),
                        fixLabel: 'Replace Integer with Long',
                        tip: 'Long is 32-bit, handles bigger numbers, and is actually faster on modern CPUs.'
                    });
                }

                // 8️⃣ MISSING END IF CHECK
                if (trimmedLower === 'if' || (trimmedLower.startsWith('if ') && trimmedLower.includes('then'))) {
                    // Check if there's a matching End If (simplified check)
                    const endIfExists = code.toLowerCase().includes('end if');
                    if (!endIfExists && !trimmed.includes(':')) {
                        issues.push({
                            line: lineNum,
                            type: 'error',
                            category: '⚠️ Structure Error',
                            title: 'If without End If',
                            problem: 'Multi-line If blocks need "End If"',
                            code: trimmed,
                            highlight: line.trim() + '\n... (code) ...\n➜ MISSING: End If',
                            fix: line.trim() + '\n    \' your code\nEnd If',
                            fixLabel: 'Add "End If" to close the block',
                            tip: 'Single-line: If x Then y = 1\nMulti-line needs End If'
                        });
                    }
                }

                // 9️⃣ ON ERROR RESUME NEXT WITHOUT RESET
                if (trimmedLower.includes('on error resume next')) {
                    const hasReset = code.toLowerCase().includes('on error goto 0');
                    if (!hasReset) {
                        issues.push({
                            line: lineNum,
                            type: 'error',
                            category: '🚨 Error Handling',
                            title: 'On Error Resume Next without reset',
                            problem: 'Will silently hide ALL errors in rest of code',
                            code: line.trim(),
                            highlight: line.trim() + '\n... (risky code) ...\n➜ MISSING: On Error GoTo 0',
                            fix: line.trim() + '\n\' risky code here\nOn Error GoTo 0  \' Reset error handling',
                            fixLabel: 'Add "On Error GoTo 0" after risky section',
                            tip: 'Always reset error handling with "On Error GoTo 0" or errors will be hidden!'
                        });
                    }
                }

                // 🔟 SCREENUPDATING WITHOUT RESTORE
                if (trimmedLower.includes('screenupdating') && trimmedLower.includes('false')) {
                    const hasRestore = code.toLowerCase().includes('screenupdating') && 
                                      code.toLowerCase().includes('true');
                    if (!hasRestore) {
                        issues.push({
                            line: lineNum,
                            type: 'warning',
                            category: '⚡ Performance',
                            title: 'ScreenUpdating = False without restore',
                            problem: 'Screen will stay frozen if error occurs',
                            code: line.trim(),
                            highlight: line.trim() + '\n... (code) ...\n➜ MISSING: Application.ScreenUpdating = True',
                            fix: line.trim() + '\n\n\' Your code here\n\nApplication.ScreenUpdating = True',
                            fixLabel: 'Add restore line',
                            tip: 'Always restore ScreenUpdating = True, even in error handler!'
                        });
                    }
                }

                // 1️⃣1️⃣ SELECT/ACTIVATE USAGE (BAD PRACTICE)
                if (trimmed.match(/\.(Select|Activate)\s*$/i)) {
                    issues.push({
                        line: lineNum,
                        type: 'warning',
                        category: '💡 Best Practice',
                        title: 'Using .Select or .Activate (slow)',
                        problem: 'Selecting objects is slow and unnecessary',
                        code: line.trim(),
                        highlight: line.trim().replace(/\.(Select|Activate)/i, '.➜$1← (avoid)'),
                        fix: '\' Access object directly without Select:\n\' ws.Range("A1").Value = 10',
                        fixLabel: 'Remove Select/Activate, use direct access',
                        tip: 'Bad: Range("A1").Select → Selection.Value = 10\nGood: Range("A1").Value = 10'
                    });
                }

                // 1️⃣2️⃣ HARDCODED SHEET NAMES
                if (trimmed.match(/Sheets?\s*\(\s*"[^"]+"\s*\)/i)) {
                    issues.push({
                        line: lineNum,
                        type: 'warning',
                        category: '📋 Hardcoded Reference',
                        title: 'Hardcoded sheet name',
                        problem: 'Will break if sheet is renamed or doesn\'t exist',
                        code: line.trim(),
                        highlight: line.trim().replace(/"([^"]+)"/g, '➜"$1"← (hardcoded)'),
                        fix: '\' Use variable or add error handling:\nOn Error Resume Next\n' + line.trim(),
                        fixLabel: 'Use variable or add error handling',
                        tip: 'Better: Store sheet name in a constant or check if sheet exists first.'
                    });
                }

                // 1️⃣3️⃣ BOOLEAN = TRUE COMPARISON
                if (trimmed.match(/=\s*(True|False)\s+(Then|And|Or)/i)) {
                    issues.push({
                        line: lineNum,
                        type: 'warning',
                        category: '💡 Best Practice',
                        title: 'Redundant boolean comparison',
                        problem: 'No need to compare boolean to True/False',
                        code: line.trim(),
                        highlight: line.trim().replace(/=\s*(True|False)/i, '➜= $1← (redundant)'),
                        fix: line.trim().replace(/\s*=\s*True/gi, '').replace(/\s*=\s*False/gi, ' Not'),
                        fixLabel: 'Remove = True or use Not for False',
                        tip: 'If isValid = True Then → If isValid Then\nIf x = False Then → If Not x Then'
                    });
                }

                // 1️⃣4️⃣ MAGIC NUMBERS (SHOULD BE CONSTANTS)
                const magicNumbers = trimmed.match(/=\s*(\d{2,})/);
                if (magicNumbers && !trimmedLower.includes('const') && !trimmedLower.includes('for') && !trimmedLower.includes('to')) {
                    issues.push({
                        line: lineNum,
                        type: 'info',
                        category: '💡 Best Practice',
                        title: 'Magic number detected',
                        problem: 'Unexplained number in code (should be named constant)',
                        code: line.trim(),
                        highlight: line.trim().replace(/(\d{2,})/, '➜$1← (what does this mean?)'),
                        fix: 'Const MAX_ROWS As Long = ' + magicNumbers[1] + '\n' + line.trim().replace(magicNumbers[1], 'MAX_ROWS'),
                        fixLabel: 'Create named constant',
                        tip: 'Give numbers meaningful names: Const TAX_RATE = 0.15, Const MAX_ITEMS = 100'
                    });
                }

                // 1️⃣5️⃣ UNQUALIFIED RANGE REFERENCES
                if (trimmed.match(/\b(Range|Cells)\s*\(/i) && !trimmed.match(/\b\w+\.(Range|Cells)\s*\(/i)) {
                    issues.push({
                        line: lineNum,
                        type: 'warning',
                        category: '🎯 Object Reference',
                        title: 'Unqualified Range/Cells reference',
                        problem: 'Will operate on ActiveSheet, may not be the sheet you want',
                        code: line.trim(),
                        highlight: '➜' + line.trim() + '← (which sheet?)',
                        fix: 'Set ws = ThisWorkbook.Sheets("SheetName")\nws.' + line.trim(),
                        fixLabel: 'Qualify with worksheet variable',
                        tip: 'Bad: Range("A1")\nGood: ws.Range("A1") or ThisWorkbook.Sheets("Data").Range("A1")'
                    });
                }

                // 1️⃣6️⃣ COMMON TYPOS (Token-Aware with Fuzzy Matching)
                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                // NOTE: Primary typo detection is in VBALintEngine (token-aware)
                // This is a lightweight backup for line-based analysis
                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                
                // Extract identifiers from line (simple word extraction)
                const words = trimmed.split(/[\s\(\)\[\]\{\},\.:;\=\+\-\*\/\\<>]+/).filter(w => w.length >= 3);
                
                words.forEach(word => {
                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    // STRICT GATING: Prevent false positives
                    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    
                    // GATE 1: Skip if whitelisted
                    if (VBA_WHITELIST.isWhitelisted(word)) {
                        return;
                    }
                    
                    // GATE 2: Skip if object member (Value, Count, Row, Err, etc.)
                    if (VBA_WHITELIST.isObjectMember(word)) {
                        return;
                    }
                    
                    // GATE 3: Skip if part of member chain (ws.Value, Err.Description)
                    if (VBA_WHITELIST.isPartOfMemberChain(word, line)) {
                        return;
                    }
                    
                    // GATE 4: Skip if in string or comment (use better detection)
                    const segments = VBA_WHITELIST.getCodeSegments(line);
                    let wordInCode = false;
                    for (const segment of segments) {
                        if (segment.type === 'CODE' && segment.text.includes(word)) {
                            wordInCode = true;
                            break;
                        }
                    }
                    if (!wordInCode) return;
                    
                    
                    // Check known typos first
                    const knownTypos = {
                        'Endif': 'End If', 'Endfunction': 'End Function', 'Endsub': 'End Sub',
                        'Nex': 'Next', 'Funtion': 'Function', 'Publc': 'Public',
                        'Privte': 'Private', 'Integr': 'Integer', 'Strig': 'String',
                        'Msgox': 'MsgBox', 'Inputox': 'InputBox', 'Dimm': 'Dim',
                        'Rannge': 'Range', 'Celss': 'Cells', 'Workshet': 'Worksheet',
                        'Workbok': 'Workbook', 'Applicaton': 'Application'
                    };
                    
                    let correction = null;
                    let isTypo = false;
                    
                    // Tier 1: Known typos
                    if (knownTypos[word]) {
                        correction = knownTypos[word];
                        isTypo = true;
                    }
                    // Tier 2: Fuzzy match (only if not already found)
                    else if (word.length >= 3) {
                        // Build keyword list
                        const allKeywords = [
                            ...VBA_WHITELIST.CORE_KEYWORDS,
                            ...VBA_WHITELIST.VBA_FUNCTIONS,
                            ...VBA_WHITELIST.EXCEL_OBJECTS
                        ];
                        
                        // Find closest match with edit distance
                        let minDist = Infinity;
                        for (const keyword of allKeywords) {
                            // Simple edit distance calculation
                            const dist = levenshteinDistance(word, keyword);
                            if (dist > 0 && dist <= 2 && dist < minDist) {
                                minDist = dist;
                                correction = keyword;
                            }
                        }
                        
                        if (correction && minDist <= 2) {
                            isTypo = true;
                        }
                    }
                    
                    // Report if typo found
                    if (isTypo && correction) {
                        issues.push({
                            line: lineNum,
                            type: 'warning',
                            category: '✏️ Typo',
                            title: `Possible typo: "${word}"`,
                            problem: `This looks like a misspelling of "${correction}"`,
                            code: line.trim(),
                            highlight: line.trim().replace(new RegExp(word, 'g'), `➜${word}← (typo?)`),
                            fix: null, // NO AUTO-FIX for typos
                            fixLabel: `Manual fix: Replace with "${correction}"`,
                            tip: `⚠️ Verify this is actually a typo. Did you mean "${correction}"?`
                        });
                    }
                });
                
                // Helper: Levenshtein distance
                function levenshteinDistance(s1, s2) {
                    const len1 = s1.length, len2 = s2.length;
                    const dp = Array(len1 + 1).fill(null).map(() => Array(len2 + 1).fill(0));
                    
                    for (let i = 0; i <= len1; i++) dp[i][0] = i;
                    for (let j = 0; j <= len2; j++) dp[0][j] = j;
                    
                    for (let i = 1; i <= len1; i++) {
                        for (let j = 1; j <= len2; j++) {
                            if (s1[i-1].toLowerCase() === s2[j-1].toLowerCase()) {
                                dp[i][j] = dp[i-1][j-1];
                            } else {
                                dp[i][j] = 1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
                            }
                        }
                    }
                    return dp[len1][len2];
                }

                // 1️⃣7️⃣ DANGEROUS OPERATIONS (SECURITY)
                const dangerous = ['Kill', 'Shell', 'CreateObject("WScript.Shell")', 'SendKeys'];
                dangerous.forEach(danger => {
                    if (trimmed.includes(danger)) {
                        issues.push({
                            line: lineNum,
                            type: 'warning',
                            category: '🚨 Security Risk',
                            title: `Dangerous operation: ${danger}`,
                            problem: 'File system/shell access detected - potential security risk',
                            code: line.trim(),
                            highlight: line.trim().replace(danger, `➜${danger}← (dangerous)`),
                            fix: '\' Review this code carefully\n\' Add user confirmation:\nIf MsgBox("Allow?", vbYesNo) = vbYes Then\n    ' + line.trim(),
                            fixLabel: 'Add safety checks and user confirmation',
                            tip: 'Operations like Kill, Shell can be dangerous. Add user confirmation.'
                        });
                    }
                });

                // 1️⃣8️⃣ EMPTY FUNCTION/SUB DETECTION
                if ((trimmedLower.startsWith('sub ') || trimmedLower.startsWith('function ')) && 
                    trimmedLower.includes('()')) {
                    const nextNonEmpty = lines.slice(idx + 1).find(l => l.trim() && !l.trim().startsWith("'"));
                    if (nextNonEmpty && (nextNonEmpty.trim().toLowerCase().startsWith('end sub') || 
                                         nextNonEmpty.trim().toLowerCase().startsWith('end function'))) {
                        issues.push({
                            line: lineNum,
                            type: 'warning',
                            category: '📝 Code Quality',
                            title: 'Empty procedure detected',
                            problem: 'Sub/Function has no code inside',
                            code: line.trim() + '\nEnd ' + (trimmedLower.startsWith('sub') ? 'Sub' : 'Function'),
                            highlight: line.trim() + '\n➜(empty - no code)←\nEnd...',
                            fix: line.trim() + '\n    \' TODO: Add implementation\n    MsgBox "Not implemented yet"',
                            fixLabel: 'Add implementation or remove',
                            tip: 'Empty procedures should either be implemented or removed.'
                        });
                    }
                }

                // 1️⃣9️⃣ DEFAULT PROPERTY USAGE (e.g., txtName = "John" instead of txtName.Value = "John")
                if (trimmed.match(/^\w+\s*=\s*"[^"]*"/) && !trimmed.includes('.')) {
                    const varName = trimmed.match(/^(\w+)\s*=/)[1];
                    if (varName.match(/^(txt|cmb|lst)/i)) {
                        issues.push({
                            line: lineNum,
                            type: 'info',
                            category: '💡 Best Practice',
                            title: 'Relying on default property',
                            problem: 'Should explicitly use .Value, .Text, or .Caption',
                            code: line.trim(),
                            highlight: trimmed.replace(/^(\w+)/, '$1➜(needs .Value?)←'),
                            fix: trimmed.replace(/^(\w+)/, '$1.Value'),
                            fixLabel: 'Add explicit property (.Value, .Text, etc.)',
                            tip: 'Better: txtName.Value = "John" (explicit) than txtName = "John" (implicit)'
                        });
                    }
                }
            });

            // 🔹 ADDITIONAL COMPREHENSIVE CHECKS (Whole-code analysis)
            
            // 2️⃣0️⃣ LINE CONTINUATION RULES
            lines.forEach((line, idx) => {
                if (line.includes('_') && !line.trim().startsWith("'")) {
                    // Check for space before underscore
                    if (line.match(/\w_\s*$/)) {
                        issues.push({
                            line: idx + 1,
                            type: 'error',
                            category: '⚠️ Syntax Error',
                            title: 'Line continuation _ must be preceded by space',
                            problem: 'Missing space before underscore continuation character',
                            code: line.trim(),
                            highlight: line.trim().replace(/(\w)_/, '$1➜_← (missing space)'),
                            fix: line.replace(/(\w)_/, '$1 _'),
                            fixLabel: 'Add space before underscore',
                            tip: 'VBA syntax: value = 1 + _ (space required before _)'
                        });
                    }
                    // Check for comment after _ (not allowed)
                    if (line.match(/_\s*'/)) {
                        issues.push({
                            line: idx + 1,
                            type: 'error',
                            category: '⚠️ Syntax Error',
                            title: 'Comment after line continuation character',
                            problem: 'Cannot have comments after _ on same line',
                            code: line.trim(),
                            highlight: line.trim().replace(/(_\s*')/, '➜$1← (not allowed)'),
                            fix: line.replace(/_\s*'.*$/, '_'),
                            fixLabel: 'Remove comment from continuation line',
                            tip: 'Put comment on next line, not after underscore'
                        });
                    }
                }
            });

            // 2️⃣1️⃣ DETECT COMMENTED-OUT CODE (Dead code)
            let consecutiveComments = 0;
            lines.forEach((line, idx) => {
                // CRITICAL NULL SAFETY
                if (line === null || line === undefined) return;
                
                const trimmed = safeTrim(line);
                if (trimmed.startsWith("'") && !trimmed.match(/^'\s*(=|TODO|FIXME|NOTE)/i)) {
                    // Check if comment looks like code
                    if (trimmed.match(/^'\s*(Dim|If|For|Sub|Function|Set|End|Range|Cells)/i)) {
                        consecutiveComments++;
                        if (consecutiveComments === 5) { // Flag after 5 consecutive commented code lines
                            issues.push({
                                line: idx + 1 - 4,
                                type: 'warning',
                                category: '📝 Code Quality',
                                title: 'Large block of commented-out code detected',
                                problem: 'Old/unused code should be deleted, not commented',
                                code: '(multiple commented lines starting here)',
                                highlight: '➜5+ lines of commented code← (delete instead)',
                                fix: '\' Consider using version control instead of commenting',
                                fixLabel: 'Delete commented code, use Git for history',
                                tip: 'Use version control (Git) to track changes. Delete unused code.'
                            });
                        }
                    } else {
                        consecutiveComments = 0;
                    }
                } else {
                    consecutiveComments = 0;
                }
            });

            // 2️⃣2️⃣ SELECT CASE SUGGESTION (for many ElseIf)
            let elseIfCount = 0;
            let ifLineStart = 0;
            lines.forEach((line, idx) => {
                const trimmed = line.trim().toLowerCase();
                if (trimmed.startsWith('if ') && trimmed.includes('then')) {
                    ifLineStart = idx + 1;
                    elseIfCount = 0;
                } else if (trimmed.startsWith('elseif ')) {
                    elseIfCount++;
                    if (elseIfCount === 3) {
                        issues.push({
                            line: ifLineStart,
                            type: 'info',
                            category: '💡 Best Practice',
                            title: 'Many ElseIf statements (3+)',
                            problem: 'Select Case is clearer and faster for multiple conditions',
                            code: 'If...ElseIf...ElseIf...ElseIf...',
                            highlight: '➜Multiple ElseIf← (use Select Case instead)',
                            fix: 'Select Case variableName\n    Case value1\n    Case value2\n    Case Else\nEnd Select',
                            fixLabel: 'Refactor to Select Case',
                            tip: 'Select Case is more readable and performs better than many ElseIf'
                        });
                    }
                }
            });

            // 2️⃣3️⃣ LOOP STRUCTURE VALIDATION
            let forCount = 0, nextCount = 0;
            let doCount = 0, loopCount = 0;
            lines.forEach((line, idx) => {
                const trimmed = line.trim().toLowerCase();
                if (trimmed.startsWith('for ')) forCount++;
                if (trimmed.startsWith('next')) nextCount++;
                if (trimmed.startsWith('do ')) doCount++;
                if (trimmed === 'loop' || trimmed.startsWith('loop ')) loopCount++;
            });
            
            if (forCount > nextCount) {
                issues.push({
                    line: 1,
                    type: 'error',
                    category: '⚠️ Structure Error',
                    title: `Unmatched For loops (${forCount} For, ${nextCount} Next)`,
                    problem: 'Every For must have a matching Next',
                    code: '(scan entire file)',
                    highlight: `➜Found ${forCount} For but only ${nextCount} Next←`,
                    fix: '\' Add missing Next statements',
                    fixLabel: 'Add matching Next for each For loop',
                    tip: 'For i = 1 To 10\n    ...\nNext i'
                });
            }
            
            if (doCount > loopCount) {
                issues.push({
                    line: 1,
                    type: 'error',
                    category: '⚠️ Structure Error',
                    title: `Unmatched Do loops (${doCount} Do, ${loopCount} Loop)`,
                    problem: 'Every Do must have a matching Loop',
                    code: '(scan entire file)',
                    highlight: `➜Found ${doCount} Do but only ${loopCount} Loop←`,
                    fix: '\' Add missing Loop statements',
                    fixLabel: 'Add matching Loop for each Do',
                    tip: 'Do While condition\n    ...\nLoop'
                });
            }

            // 2️⃣4️⃣ INFINITE LOOP DETECTION
            lines.forEach((line, idx) => {
                const trimmed = line.trim().toLowerCase();
                if (trimmed === 'do' || trimmed === 'do while true' || trimmed === 'do until false') {
                    issues.push({
                        line: idx + 1,
                        type: 'warning',
                        category: '⚠️ Logic Warning',
                        title: 'Potential infinite loop',
                        problem: 'Loop has no exit condition or always-true condition',
                        code: line.trim(),
                        highlight: '➜' + line.trim() + '← (will never exit)',
                        fix: 'Do While [condition]\n    ...\n    If exitCondition Then Exit Do\nLoop',
                        fixLabel: 'Add proper exit condition or Exit Do',
                        tip: 'Ensure loop has a way to terminate'
                    });
                }
            });

            // 2️⃣5️⃣ WITH...END WITH SUGGESTIONS
            // FIX GROUP D: Only suggest if same object accessed 2+ times with MULTIPLE properties
            let objectPropertyAccess = new Map(); // Track object.property pairs
            lines.forEach((line, idx) => {
                // Match patterns like: obj.property, ws.Range, etc.
                const matches = line.matchAll(/(\w+)\.(\w+)/g);
                for (const match of matches) {
                    const objName = match[1];
                    const propName = match[2];
                    
                    if (!objectPropertyAccess.has(objName)) {
                        objectPropertyAccess.set(objName, { 
                            count: 0, 
                            properties: new Set(),
                            firstLine: idx + 1 
                        });
                    }
                    
                    const objData = objectPropertyAccess.get(objName);
                    objData.count++;
                    objData.properties.add(propName);
                }
            });
            
            // FIX GROUP D: Only suggest With...End With if:
            // 1) Same object accessed 2+ times
            // 2) Multiple different properties used (not just repeated access to same property)
            objectPropertyAccess.forEach((data, objName) => {
                const accessCount = data.count;
                const uniqueProperties = data.properties.size;
                
                // FIX GROUP D: Require 3+ accesses AND 2+ different properties
                if (accessCount >= 3 && uniqueProperties >= 2) {
                    issues.push({
                        line: data.firstLine,
                        type: 'info',
                        category: '⚡ Performance',
                        title: 'Repeated object access with multiple properties',
                        problem: `Object "${objName}" accessed ${accessCount} times with ${uniqueProperties} different properties`,
                        code: `(${objName} used ${accessCount}x)`,
                        highlight: `➜${objName}← accessed ${accessCount} times`,
                        fix: null, // FIX GROUP B: No auto-fix for refactoring suggestions
                        fixLabel: `Suggested example: Use With ${objName}...End With block`,
                        tip: 'With blocks improve performance when accessing multiple properties of the same object'
                    });
                }
            });

            // 2️⃣6️⃣ ARRAY VS CELL-BY-CELL PROCESSING
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // ENHANCED: Precise detection + deduplication
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            const flaggedLoops = new Set(); // Track flagged loops to prevent duplicates
            
            lines.forEach((line, idx) => {
                const trimmed = line.trim();
                
                // Detect loop start
                if (trimmed.match(/^(For\s+\w+\s*=.*To|Do\s+|While\s+)/i)) {
                    const loopStartLine = idx + 1;
                    
                    // Check if we've already flagged this loop
                    if (flaggedLoops.has(loopStartLine)) {
                        return;
                    }
                    
                    // Scan loop body (next 20 lines) for ACTUAL cell access
                    const loopBodyLines = lines.slice(idx + 1, idx + 21);
                    let actualCellAccessLine = null;
                    let cellAccessCode = null;
                    let hasCellAccess = false;
                    let hasValueAssignment = false;
                    
                    loopBodyLines.forEach((bodyLine, bodyIdx) => {
                        if (!bodyLine) return;
                        
                        // Check for cell access INSIDE loop (not on loop line itself)
                        if (bodyLine.match(/\.Cells\(|\.Range\(/i)) {
                            hasCellAccess = true;
                            if (!actualCellAccessLine) {
                                actualCellAccessLine = idx + 2 + bodyIdx;
                                cellAccessCode = bodyLine.trim();
                            }
                        }
                        
                        // Check for value assignment
                        if (bodyLine.match(/\.Value\s*=/i)) {
                            hasValueAssignment = true;
                        }
                    });
                    
                    // Only report if BOTH conditions met: cell access AND value assignment INSIDE loop
                    if (hasCellAccess && hasValueAssignment && actualCellAccessLine && cellAccessCode) {
                        flaggedLoops.add(loopStartLine); // Mark this loop as flagged
                        
                        issues.push({
                            line: actualCellAccessLine, // Highlight cell access line, NOT loop header
                            type: 'warning',
                            category: '⚡ Performance',
                            title: 'Cell-by-cell processing in loop (100x slower)',
                            problem: 'Writing to cells one at a time inside loop is extremely slow',
                            code: cellAccessCode, // Show the actual cell access line
                            highlight: '➜' + cellAccessCode + '← (inside loop - use array instead)',
                            fix: '\' Read to array:\narr = Range("A1:A1000").Value\n\' Process array\n\' Write back:\nRange("A1:A1000").Value = arr',
                            fixLabel: 'Use array-based processing',
                            tip: 'Read range to array → process → write array to range (100x faster!)'
                        });
                    }
                }
            });

            // 2️⃣7️⃣ FUNCTION PURITY CHECK (Functions shouldn't modify state)
            let inFunction = false;
            let functionStartLine = 0;
            lines.forEach((line, idx) => {
                const trimmed = line.trim().toLowerCase();
                if (trimmed.startsWith('function ')) {
                    inFunction = true;
                    functionStartLine = idx + 1;
                } else if (trimmed.startsWith('end function')) {
                    inFunction = false;
                }
                
                if (inFunction) {
                    // Detect side effects in functions
                    if (trimmed.match(/\.value\s*=|application\.|screenupdating|enableevents/i)) {
                        issues.push({
                            line: idx + 1,
                            type: 'warning',
                            category: '💡 Best Practice',
                            title: 'Function has side effects',
                            problem: 'Functions should only compute and return values, not modify state',
                            code: line.trim(),
                            highlight: '➜' + line.trim() + '← (side effect in Function)',
                            fix: '\' Move this logic to a Sub, keep Function pure',
                            fixLabel: 'Use Sub for actions, Function for calculations',
                            tip: 'Functions = read-only calculations. Subs = actions with side effects.'
                        });
                    }
                }
            });

            // 2️⃣8️⃣ MEANINGFUL VARIABLE NAMES
            lines.forEach((line, idx) => {
                const match = line.match(/Dim\s+([a-z])\s+As/i);
                if (match && !match[1].match(/^[ijkxyz]$/i)) { // Allow common loop vars
                    issues.push({
                        line: idx + 1,
                        type: 'info',
                        category: '📝 Code Quality',
                        title: 'Single-letter variable name',
                        problem: `Variable "${match[1]}" is not descriptive`,
                        code: line.trim(),
                        highlight: line.trim().replace(match[1], `➜${match[1]}← (unclear)`),
                        fix: line.trim().replace(match[1], 'meaningfulName'),
                        fixLabel: 'Use descriptive name (e.g., rowCount, totalSales)',
                        tip: 'Use descriptive names except for loop counters (i, j, k)'
                    });
                }
            });

            // 2️⃣9️⃣ PUBLIC VARIABLE OVERUSE
            lines.forEach((line, idx) => {
                if (line.trim().toLowerCase().startsWith('public ') && 
                    !line.trim().toLowerCase().includes('sub ') && 
                    !line.trim().toLowerCase().includes('function ')) {
                    issues.push({
                        line: idx + 1,
                        type: 'warning',
                        category: '🔒 Scope Warning',
                        title: 'Public variable declared',
                        problem: 'Public variables are global and can cause bugs. Use Private when possible.',
                        code: line.trim(),
                        highlight: line.trim().replace(/Public/i, '➜Public← (use Private?)'),
                        fix: line.trim().replace(/Public/i, 'Private'),
                        fixLabel: 'Change to Private unless truly needed globally',
                        tip: 'Limit scope: Private by default, Public only when necessary'
                    });
                }
            });

            // 3️⃣0️⃣ NAMING CONVENTION CHECKS (Prefixes)
            lines.forEach((line, idx) => {
                const dimMatch = line.match(/Dim\s+(\w+)\s+As\s+(Worksheet|Workbook|Range)/i);
                if (dimMatch) {
                    const varName = dimMatch[1];
                    const varType = dimMatch[2].toLowerCase();
                    const expectedPrefix = varType === 'worksheet' ? 'ws' : 
                                         varType === 'workbook' ? 'wb' : 'rng';
                    
                    if (!varName.toLowerCase().startsWith(expectedPrefix)) {
                        issues.push({
                            line: idx + 1,
                            type: 'info',
                            category: '📝 Naming Convention',
                            title: `${dimMatch[2]} variable should start with "${expectedPrefix}"`,
                            problem: 'Standard prefixes improve code readability',
                            code: line.trim(),
                            highlight: line.trim().replace(varName, `➜${varName}← (use ${expectedPrefix}...)`),
                            fix: line.trim().replace(varName, expectedPrefix + varName),
                            fixLabel: `Rename to ${expectedPrefix}${varName}`,
                            tip: `Convention: ws=Worksheet, wb=Workbook, rng=Range, arr=Array`
                        });
                    }
                }
            });

            // 3️⃣1️⃣ MSGBOX IN PRODUCTION LOGIC
            let msgBoxCount = lines.filter(l => l.toLowerCase().includes('msgbox')).length;
            if (msgBoxCount > 3) {
                issues.push({
                    line: 1,
                    type: 'info',
                    category: '📝 Code Quality',
                    title: `Multiple MsgBox calls (${msgBoxCount})`,
                    problem: 'Consider using Debug.Print or custom logging for debugging',
                    code: '(multiple locations)',
                    highlight: `➜${msgBoxCount} MsgBox calls← (use logging instead?)`,
                    fix: '\' Replace with:\nDebug.Print "Message"\n\' Or custom logger',
                    fixLabel: 'Consider logging instead of MsgBox',
                    tip: 'MsgBox stops execution. Use Debug.Print for development logging.'
                });
            }

            // 3️⃣2️⃣ EXCEL 365-SPECIFIC FUNCTIONS (Version compatibility)
            const excel365Functions = ['XLOOKUP', 'FILTER', 'SORT', 'UNIQUE', 'SEQUENCE'];
            lines.forEach((line, idx) => {
                excel365Functions.forEach(func => {
                    if (line.match(new RegExp(`\\b${func}\\b`, 'i'))) {
                        issues.push({
                            line: idx + 1,
                            type: 'warning',
                            category: '🔄 Version Compatibility',
                            title: `${func} is Excel 365-only`,
                            problem: 'Will fail on Excel 2019 and earlier',
                            code: line.trim(),
                            highlight: line.trim().replace(new RegExp(func, 'i'), `➜${func}← (365 only)`),
                            fix: '\' Use backward-compatible alternative or check Excel version first',
                            fixLabel: 'Add version check or use older functions',
                            tip: `${func} requires Excel 365. Check version or use alternatives.`
                        });
                    }
                });
            });

            // 3️⃣3️⃣ DEPRECATED METHOD DETECTION
            const deprecated = {
                'Application.Goto': 'Use Range.Select or direct access',
                'Selection.Font': 'Use Range.Font directly',
                '.Evaluate': 'Use WorksheetFunction or direct calculation'
            };
            
            lines.forEach((line, idx) => {
                Object.keys(deprecated).forEach(oldMethod => {
                    if (line.includes(oldMethod)) {
                        issues.push({
                            line: idx + 1,
                            type: 'info',
                            category: '💡 Best Practice',
                            title: `Deprecated method: ${oldMethod}`,
                            problem: deprecated[oldMethod],
                            code: line.trim(),
                            highlight: line.trim().replace(oldMethod, `➜${oldMethod}← (deprecated)`),
                            fix: '\' ' + deprecated[oldMethod],
                            fixLabel: 'Use modern alternative',
                            tip: 'Use modern VBA methods for better performance and compatibility'
                        });
                    }
                });
            });

            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // 🎯 PRODUCTION-GRADE REPORTING LAYER (ADVISORY ONLY)
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // Apply: deduplication, cascade suppression, severity normalization
            // This does NOT change execution flow - only presentation
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            
            try {
                // Process findings through 5-layer reporting pipeline
                const processedIssues = LintReportingLayer.prepareLintReport(issues);
                return processedIssues;
            } catch (e) {
                console.warn('Reporting layer error (falling back to raw findings):', e);
                // SAFETY: Fallback to raw issues if reporting layer fails
                return issues;
            }
        }

        // ========================================
        // NULL-SAFE NOTIFICATION FIELD ACCESS (CRITICAL)
        // Ensures Live Monitoring NEVER crashes on malformed data
        // ========================================
        
        /**
         * Safely extracts field from issue object with fallback
         * GUARANTEES: Never returns null/undefined, always returns string
         */
        function safeIssueField(issue, fieldName, fallback = '') {
            if (!issue) return fallback;
            const value = issue[fieldName];
            if (value === null || value === undefined) return fallback;
            if (typeof value === 'string') return value;
            if (typeof value === 'number') return String(value);
            return fallback;
        }
        
        /**
         * Safely escapes HTML with null-safety guarantee
         * GUARANTEES: Never crashes, even if input is null/undefined
         */
        function safeEscapeHtml(text) {
            const safeText = typeof text === 'string' ? text : '';
            return safeText
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        /**
         * Validates if issue object has minimum required fields
         * GUARANTEES: Returns true only if issue can be rendered safely
         */
        function isValidIssue(issue) {
            if (!issue || typeof issue !== 'object') return false;
            // Minimum required: type and at least one message field
            if (!issue.type) return false;
            if (!issue.title && !issue.problem && !issue.category) return false;
            return true;
        }
        
        /**
         * Creates fallback notification for malformed issues
         * GUARANTEES: Always produces valid HTML, never crashes
         */
        function createFallbackNotification() {
            return `
                <div style="padding: 15px; background: rgba(255, 184, 0, 0.1); border-left: 4px solid var(--warning); border-radius: 4px;">
                    <div style="font-size: 13px; font-weight: 600; color: var(--warning); margin-bottom: 6px;">
                        ⚠️ Analysis Warning
                    </div>
                    <div style="font-size: 12px; color: var(--text-main);">
                        Some details could not be rendered for this issue.
                        The analyzer detected a problem but the notification data was incomplete.
                    </div>
                </div>
            `;
        }

        // Enhanced notification with code preview
        function addCodeNotificationEnhanced(issue) {
            const content = document.getElementById('codeNotifContent');
            const counter = document.getElementById('codeNotifCount');
            
            if (!content || !counter) return;
            
            // CRITICAL: Wrap entire rendering in try-catch
            try {
                // CRITICAL: Validate issue object first
                if (!isValidIssue(issue)) {
                    console.warn('Invalid issue object received:', issue);
                    // Render fallback notification
                    const fallbackNotif = document.createElement('div');
                    fallbackNotif.className = 'notif-item notif-warning';
                    fallbackNotif.innerHTML = createFallbackNotification();
                    content.insertBefore(fallbackNotif, content.firstChild);
                    codeNotifCounter++;
                    counter.textContent = codeNotifCounter - 1;
                    return;
                }
                
                const notif = document.createElement('div');
                notif.className = `notif-item notif-${safeIssueField(issue, 'type', 'warning')}`;
                notif.style.cssText = 'padding: 15px; margin-bottom: 10px; border-left: 4px solid;';
                
                // CRITICAL: Use safe field access for ALL issue properties
                const category = safeIssueField(issue, 'category', 'Analysis');
                const line = safeIssueField(issue, 'line', '?');
                const title = safeIssueField(issue, 'title', 'Issue detected');
                const problem = safeIssueField(issue, 'problem', 'Details unavailable');
                const code = safeIssueField(issue, 'code', '(no code snippet available)');
                const highlight = safeIssueField(issue, 'highlight', code);
                const fix = safeIssueField(issue, 'fix', '');
                const fixLabel = safeIssueField(issue, 'fixLabel', 'Manual correction required');
                const tip = safeIssueField(issue, 'tip', '');
                
                // Build enhanced notification HTML with safe values
                let html = `
                    <div style="margin-bottom: 8px;">
                        <span class="notif-number">#${codeNotifCounter}</span>
                        <strong style="color: var(--text-bright); font-size: 13px;">${safeEscapeHtml(category)}</strong>
                    </div>
                    
                    <div style="margin-bottom: 8px;">
                        <div style="font-size: 14px; font-weight: 700; color: var(--error); margin-bottom: 4px;">
                            📍 Line ${safeEscapeHtml(line)}: ${safeEscapeHtml(title)}
                        </div>
                        <div style="font-size: 12px; color: var(--text-main); margin-bottom: 8px;">
                            ${safeEscapeHtml(problem)}
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-dark); padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                        <div style="font-size: 11px; color: var(--accent-orange); margin-bottom: 4px;">YOUR CODE:</div>
                        <code style="font-family: 'Fira Code', monospace; font-size: 12px; color: var(--error);">
                            ${safeEscapeHtml(code)}
                        </code>
                        
                        <div style="font-size: 11px; color: var(--accent-cyan); margin: 8px 0 4px 0;">PROBLEM LOCATION:</div>
                        <code style="font-family: 'Fira Code', monospace; font-size: 12px; color: var(--warning);">
                            ${safeEscapeHtml(highlight)}
                        </code>
                `;
                
                // CRITICAL: Only show FIXED VERSION if fix exists and is not null/empty
                if (fix && fix.trim()) {
                    html += `
                        <div style="font-size: 11px; color: var(--success); margin: 8px 0 4px 0;">✓ FIXED VERSION:</div>
                        <code style="font-family: 'Fira Code', monospace; font-size: 12px; color: var(--success);">
                            ${safeEscapeHtml(fix)}
                        </code>
                    `;
                }
                
                html += `</div>`;
                
                // CRITICAL: Only show tip section if fixLabel or tip exists
                if (fixLabel || tip) {
                    html += `
                        <div style="background: rgba(80, 250, 123, 0.1); padding: 8px; border-radius: 4px; border-left: 3px solid var(--success);">
                            <div style="font-size: 11px; color: var(--success); font-weight: 600; margin-bottom: 4px;">
                                💡 ${safeEscapeHtml(fixLabel)}
                            </div>
                    `;
                    
                    if (tip) {
                        html += `
                            <div style="font-size: 11px; color: var(--text-main);">
                                ${safeEscapeHtml(tip)}
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                }
                
                notif.innerHTML = html;
                content.insertBefore(notif, content.firstChild);
                
                codeNotifCounter++;
                counter.textContent = codeNotifCounter - 1;
                
                // Limit to 30 notifications
                while (content.children.length > 30) {
                    content.removeChild(content.lastChild);
                }
                
            } catch (error) {
                // CRITICAL: NEVER let notification rendering crash Live Monitoring
                console.error('Notification rendering error:', error, 'Issue:', issue);
                
                // Render safe fallback notification
                try {
                    const fallbackNotif = document.createElement('div');
                    fallbackNotif.className = 'notif-item notif-error';
                    fallbackNotif.innerHTML = createFallbackNotification();
                    content.insertBefore(fallbackNotif, content.firstChild);
                    codeNotifCounter++;
                    counter.textContent = codeNotifCounter - 1;
                } catch (fallbackError) {
                    console.error('Even fallback notification failed:', fallbackError);
                    // Absolute last resort - just log
                }
            }
        }

        // Notification Management
        function addCodeNotification(type, message) {
            const content = document.getElementById('codeNotifContent');
            const counter = document.getElementById('codeNotifCount');
            
            if (!content || !counter) return;
            
            const notif = document.createElement('div');
            notif.className = `notif-item notif-${type}`;
            notif.innerHTML = `
                <span class="notif-number">#${codeNotifCounter}</span>
                ${type === 'success' ? '✓' : type === 'error' ? '✗' : type === 'warning' ? '⚠' : '►'} ${message}
            `;
            
            content.insertBefore(notif, content.firstChild);
            codeNotifCounter++;
            counter.textContent = codeNotifCounter - 1;
            
            while (content.children.length > 50) {
                content.removeChild(content.lastChild);
            }
        }

        function addFormulaNotification(type, message) {
            const content = document.getElementById('formulaNotifContent');
            const counter = document.getElementById('formulaNotifCount');
            
            if (!content || !counter) return;
            
            const notif = document.createElement('div');
            notif.className = `notif-item notif-${type}`;
            notif.innerHTML = `
                <span class="notif-number">#${formulaNotifCounter}</span>
                ${type === 'success' ? '✓' : type === 'error' ? '✗' : type === 'warning' ? '⚠' : '►'} ${message}
            `;
            
            content.insertBefore(notif, content.firstChild);
            formulaNotifCounter++;
            counter.textContent = formulaNotifCounter - 1;
            
            while (content.children.length > 50) {
                content.removeChild(content.lastChild);
            }
        }

        function toggleCodeNotifications() {
            // CRITICAL FIX: Only allow toggle in code-editor view
            if (currentView !== 'code-editor') {
                console.warn('⚠️ Code notifications can only be toggled in Code Editor view');
                return;
            }
            
            const sidebar = document.getElementById('codeNotifSidebar');
            const toggle = document.getElementById('codeNotifToggle');
            
            if (!sidebar || !toggle) return;
            
            // ADDITIONAL GUARD: Close other sidebars first
            const formulaSidebar = document.getElementById('formulaNotifSidebar');
            const execSidebar = document.getElementById('execNotifSidebar');
            if (formulaSidebar) formulaSidebar.classList.add('closed');
            if (execSidebar) execSidebar.classList.add('closed');
            
            codeNotifOpen = !codeNotifOpen;
            
            if (codeNotifOpen) {
                sidebar.classList.remove('closed');
                toggle.classList.add('hidden');
            } else {
                sidebar.classList.add('closed');
                toggle.classList.remove('hidden');
            }
        }

        function toggleFormulaNotifications() {
            // CRITICAL FIX: Only allow toggle in formula-checker view
            if (currentView !== 'formula-checker') {
                console.warn('⚠️ Formula notifications can only be toggled in Formula Checker view');
                return;
            }
            
            const sidebar = document.getElementById('formulaNotifSidebar');
            const toggle = document.getElementById('formulaNotifToggle');
            
            if (!sidebar || !toggle) return;
            
            // ADDITIONAL GUARD: Close other sidebars first
            const codeSidebar = document.getElementById('codeNotifSidebar');
            const execSidebar = document.getElementById('execNotifSidebar');
            if (codeSidebar) codeSidebar.classList.add('closed');
            if (execSidebar) execSidebar.classList.add('closed');
            
            formulaNotifOpen = !formulaNotifOpen;
            
            if (formulaNotifOpen) {
                sidebar.classList.remove('closed');
                toggle.classList.add('hidden');
            } else {
                sidebar.classList.add('closed');
                toggle.classList.remove('hidden');
            }
        }

        // NEW: Clear Code Notifications function
        function clearCodeNotifications() {
            const content = document.getElementById('codeNotifContent');
            const countEl = document.getElementById('codeNotifCount');
            if (content) {
                content.innerHTML = '<div class="notif-item notif-success"><span class="notif-number">#1</span>✓ Notifications cleared</div>';
            }
            if (countEl) {
                countEl.textContent = '0';
            }
            codeNotifCounter = 1;
        }

        // NEW: Clear Formula Notifications function
        function clearFormulaNotifications() {
            const content = document.getElementById('formulaNotifContent');
            const countEl = document.getElementById('formulaNotifCount');
            if (content) {
                content.innerHTML = '<div class="notif-item notif-success"><span class="notif-number">#1</span>✓ Notifications cleared</div>';
            }
            if (countEl) {
                countEl.textContent = '0';
            }
            formulaNotifCounter = 1;
        }

        // NEW: Auto-clear when code input is empty
        function checkAndAutoClearCodeNotifications() {
            const codeInput = document.getElementById('codeInput');
            if (codeInput && codeInput.value.trim() === '') {
                clearCodeNotifications();
            }
        }

        // NEW: Auto-clear when formula input is empty
        function checkAndAutoClearFormulaNotifications() {
            const formulaInput = document.getElementById('formulaInput');
            if (formulaInput && formulaInput.value.trim() === '') {
                clearFormulaNotifications();
            }
        }

        // NEW: Toggle Navigation Panel
        function toggleNavigation() {
            const sidebar = document.getElementById('mainSidebar');
            const arrow = document.getElementById('navArrow');
            
            if (!sidebar || !arrow) return;
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // RESPONSIVE ENHANCEMENT: Handle mobile vs desktop differently
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            try {
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    // Mobile: toggle mobile-open class (slide in/out from left)
                    sidebar.classList.toggle('mobile-open');
                    
                    // Close sidebar when clicking overlay (the ::before pseudo-element)
                    if (sidebar.classList.contains('mobile-open')) {
                        // Add click listener to sidebar to detect overlay clicks
                        const closeOnOverlay = (e) => {
                            // If click is on sidebar itself (not children), close it
                            if (e.target === sidebar) {
                                sidebar.classList.remove('mobile-open');
                                sidebar.removeEventListener('click', closeOnOverlay);
                            }
                        };
                        sidebar.addEventListener('click', closeOnOverlay);
                    }
                } else {
                    // Desktop: toggle collapsed class (slide in/out from left edge)
                    sidebar.classList.toggle('collapsed');
                    
                    // Also toggle class on body for the toggle button CSS
                    document.body.classList.toggle('nav-collapsed', sidebar.classList.contains('collapsed'));
                }
            } catch (e) {
                // FAIL-SAFE: If responsive logic fails, fall back to desktop behavior
                console.warn('Mobile navigation toggle failed, using desktop mode:', e);
                sidebar.classList.toggle('collapsed');
                document.body.classList.toggle('nav-collapsed', sidebar.classList.contains('collapsed'));
            }
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            
            // Arrow automatically rotates via CSS, but we can add haptic feedback
            if (sidebar.classList.contains('collapsed') || !sidebar.classList.contains('mobile-open')) {
                // Panel is now closed
                arrow.setAttribute('title', 'Open Navigation Panel');
            } else {
                // Panel is now open
                arrow.setAttribute('title', 'Close Navigation Panel');
            }
        }

        // Formula Input Setup
        function setupFormulaInput() {
            const formulaInput = document.getElementById('formulaInput');
            const suggestions = document.getElementById('formulaSuggestions');

            formulaInput.addEventListener('input', function(e) {
                const value = this.value;
                const cursorPos = this.selectionStart;
                
                // Check if we're inside a formula (starts with =) or typing a function name
                if (value.startsWith('=')) {
                    // Get the text up to cursor position
                    const textBeforeCursor = value.substring(0, cursorPos);
                    
                    // Find the last function name being typed
                    // Match: word characters after ( or , or = (function boundaries)
                    const match = textBeforeCursor.match(/[=,(]\s*([A-Z]*)$/i);
                    
                    if (match) {
                        const partialFunction = match[1].toUpperCase();
                        
                        // Show ALL functions when just "=" or show matches
                        const matches = excelFunctions.filter(f => 
                            f.name.startsWith(partialFunction) || partialFunction === ''
                        );

                        if (matches.length > 0) {
                            showSuggestions(matches);
                        } else {
                            hideSuggestions();
                        }
                        
                        // Show syntax for exact match
                        const exact = excelFunctions.find(f => f.name === partialFunction);
                        if (exact) {
                            document.getElementById('syntaxHelp').textContent = exact.syntax;
                            document.getElementById('formulaSyntax').style.display = 'block';
                        }
                    } else {
                        hideSuggestions();
                    }
                } else {
                    hideSuggestions();
                    document.getElementById('formulaSyntax').style.display = 'none';
                }
            });

            formulaInput.addEventListener('keydown', function(e) {
                const suggestions = document.getElementById('formulaSuggestions');
                
                if (suggestions.classList.contains('show')) {
                    if (e.key === 'Tab' || e.key === 'Enter') {
                        e.preventDefault();
                        const selected = suggestions.querySelector('.suggestion-item.selected');
                        if (selected) {
                            selectSuggestion(selected.dataset.name);
                        }
                    } else if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        navigateSuggestions(1);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        navigateSuggestions(-1);
                    } else if (e.key === 'Escape') {
                        hideSuggestions();
                    }
                }
                
                // Excel-like bracket matching - show which bracket is being closed
                if (e.key === ')' || e.key === ']') {
                    setTimeout(() => {
                        highlightMatchingBracket(this, e.key);
                    }, 0);
                }
            });
        }

        function showSuggestions(matches) {
            const suggestions = document.getElementById('formulaSuggestions');
            suggestions.innerHTML = '';
            
            matches.slice(0, 15).forEach((match, index) => {
                const item = document.createElement('div');
                item.className = 'suggestion-item' + (index === 0 ? ' selected' : '');
                item.dataset.name = match.name;
                item.innerHTML = `
                    <div class="suggestion-name">${match.name}</div>
                    <div class="suggestion-desc">${match.desc}</div>
                `;
                item.onclick = () => selectSuggestion(match.name);
                suggestions.appendChild(item);
            });
            
            suggestions.classList.add('show');
            selectedSuggestionIndex = 0;
        }

        function hideSuggestions() {
            document.getElementById('formulaSuggestions').classList.remove('show');
        }

        function navigateSuggestions(direction) {
            const items = document.querySelectorAll('.suggestion-item');
            if (items.length === 0) return;
            
            items[selectedSuggestionIndex].classList.remove('selected');
            selectedSuggestionIndex = (selectedSuggestionIndex + direction + items.length) % items.length;
            items[selectedSuggestionIndex].classList.add('selected');
            
            // Scroll into view
            items[selectedSuggestionIndex].scrollIntoView({ block: 'nearest' });
        }

        function selectSuggestion(name) {
            const formulaInput = document.getElementById('formulaInput');
            const cursorPos = formulaInput.selectionStart;
            const value = formulaInput.value;
            
            // Find where the current function name starts
            const textBeforeCursor = value.substring(0, cursorPos);
            const match = textBeforeCursor.match(/[=,(]\s*([A-Z]*)$/i);
            
            if (match) {
                const startPos = cursorPos - match[1].length;
                const newValue = value.substring(0, startPos) + name + '(' + value.substring(cursorPos);
                formulaInput.value = newValue;
                formulaInput.selectionStart = formulaInput.selectionEnd = startPos + name.length + 1;
            } else {
                formulaInput.value = '=' + name + '(';
                formulaInput.selectionStart = formulaInput.selectionEnd = name.length + 2;
            }
            
            formulaInput.focus();
            hideSuggestions();
            
            const func = excelFunctions.find(f => f.name === name);
            if (func) {
                document.getElementById('syntaxHelp').textContent = func.syntax;
                document.getElementById('formulaSyntax').style.display = 'block';
                addFormulaNotification('info', `Selected ${func.name}: ${func.desc}`);
            }
        }

        // Excel-like bracket matching - highlights the matching opening bracket
        function highlightMatchingBracket(input, closingBracket) {
            const value = input.value;
            const cursorPos = input.selectionStart;
            
            // Find the matching opening bracket
            const openBracket = closingBracket === ')' ? '(' : '[';
            let depth = 1;
            let matchPos = -1;
            
            // Search backward from cursor position
            for (let i = cursorPos - 2; i >= 0; i--) {
                if (value[i] === closingBracket) {
                    depth++;
                } else if (value[i] === openBracket) {
                    depth--;
                    if (depth === 0) {
                        matchPos = i;
                        break;
                    }
                }
            }
            
            // If matching bracket found, briefly highlight it
            if (matchPos !== -1) {
                // Extract function name before the opening bracket
                let funcStart = matchPos - 1;
                while (funcStart >= 0 && /[A-Z_]/i.test(value[funcStart])) {
                    funcStart--;
                }
                funcStart++;
                
                const funcName = value.substring(funcStart, matchPos);
                
                // Show visual feedback in syntax help
                const syntaxDiv = document.getElementById('formulaSyntax');
                const syntaxHelp = document.getElementById('syntaxHelp');
                
                if (funcName && syntaxDiv && syntaxHelp) {
                    const func = excelFunctions.find(f => f.name === funcName.toUpperCase());
                    if (func) {
                        syntaxHelp.innerHTML = `<span style="color: var(--accent-cyan); font-weight: bold;">Closing: ${funcName.toUpperCase()}()</span> - ${func.syntax}`;
                        syntaxDiv.style.display = 'block';
                        
                        // Flash effect - back to normal after 1 second
                        setTimeout(() => {
                            syntaxHelp.textContent = func.syntax;
                        }, 1500);
                    }
                }
                
                // Visual feedback: temporarily select the matching bracket region
                input.setSelectionRange(matchPos, matchPos + 1);
                setTimeout(() => {
                    input.setSelectionRange(cursorPos, cursorPos);
                }, 200);
            }
        }

        // Templates
        function loadTemplates() {
            const grid = document.getElementById('templateGrid');
            grid.innerHTML = '';
            
            vbaTemplates.forEach((template, index) => {
                const card = document.createElement('div');
                card.className = 'template-card';
                card.innerHTML = `
                    <div class="template-name">${template.name}</div>
                    <div class="template-desc">${template.desc}</div>
                    <div class="template-category">${template.category}</div>
                `;
                card.onclick = () => showTemplateModal(index);
                grid.appendChild(card);
            });
        }

        function showTemplateModal(index) {
            currentTemplate = vbaTemplates[index];
            document.getElementById('modalTitle').textContent = currentTemplate.name;
            document.getElementById('modalCode').textContent = currentTemplate.code;
            document.getElementById('templateModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('templateModal').classList.remove('active');
            currentTemplate = null;
        }

        function loadSelectedTemplate() {
            if (currentTemplate) {
                document.getElementById('codeInput').value = currentTemplate.code;
                updateSyntaxHighlighting();
                updateLineNumbers();
                closeModal();
                const codeNavItem = document.querySelector('[onclick*="code-editor"]');
                switchView('code-editor', codeNavItem);
                addCodeNotification('success', `Template "${currentTemplate.name}" loaded successfully!`);
            }
        }

        function loadTemplateDialog() {
            const templateNavItem = document.querySelector('[onclick*="templates"]');
            switchView('templates', templateNavItem);
        }

        // Function Library
        function loadFunctionLibrary() {
            const list = document.getElementById('functionList');
            if (!list) {
                console.warn('functionList element not found');
                return;
            }
            
            list.innerHTML = '';
            
            try {
                // Combine all formulas
                const allFormulas = [
                    ...excelFunctions.map(f => ({ ...f, isBasic: true })),
                    ...formulaCombinations.map(f => ({ ...f, isCombo: true }))
                ];

                allFormulas.forEach(func => {
                    const item = document.createElement('div');
                    item.className = 'function-item clickable-formula';
                    item.style.cursor = 'pointer';
                    item.title = 'Click to load into Formula Checker';
                    
                    item.innerHTML = `
                        <div class="function-header">
                            <span class="function-name">${func.name}</span>
                            <span class="function-category-badge">${func.category}</span>
                            <span class="click-hint" style="color: var(--accent-cyan); font-size: 11px; margin-left: auto;">👆 Click to load</span>
                        </div>
                        <div class="function-desc">${func.desc}</div>
                        <div class="function-syntax">Syntax: ${func.syntax}</div>
                        ${func.example ? `<div class="function-example">Example: ${func.example}</div>` : ''}
                    `;
                    
                    // Make formula clickable - loads into Formula Checker
                    item.onclick = function() {
                        loadFormulaToChecker(func.name, func.syntax, func.example);
                    };
                    
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading function library:', error);
            }
        }

        // NEW: Load formula into Formula Checker textbox
        function loadFormulaToChecker(name, syntax, example) {
            // Switch to Formula Checker view
            switchView('formula-checker');
            
            // Get formula input
            const formulaInput = document.getElementById('formulaInput');
            if (!formulaInput) return;
            
            // Load example if available, otherwise load syntax template
            let formulaText = '';
            if (example) {
                formulaText = example;
            } else {
                // Convert syntax to template (e.g., "SUM(number1, [number2])" -> "=SUM()")
                formulaText = '=' + name + '()';
            }
            
            formulaInput.value = formulaText;
            formulaInput.focus();
            
            // Show syntax help
            const syntaxDiv = document.getElementById('formulaSyntax');
            const syntaxHelp = document.getElementById('syntaxHelp');
            if (syntaxDiv && syntaxHelp) {
                syntaxHelp.textContent = syntax;
                syntaxDiv.style.display = 'block';
            }
            
            // Add notification
            addFormulaNotification('info', `📋 Loaded formula: ${name}`);
            
            console.log(`✅ Loaded ${name} into Formula Checker`);
        }

        // Load Arithmetic Operators Library
        function loadOperatorLibrary() {
            const list = document.getElementById('operatorList');
            if (!list) {
                console.warn('operatorList element not found - view may not be active yet');
                return;
            }
            
            list.innerHTML = '';
            
            try {
                // Group by category
                const categories = {};
                arithmeticOperators.forEach(op => {
                    if (!categories[op.category]) {
                        categories[op.category] = [];
                    }
                    categories[op.category].push(op);
                });
                
                // Render each category
                Object.keys(categories).forEach(category => {
                    const header = document.createElement('div');
                    header.className = 'resource-section-header';
                    header.innerHTML = `<h3>${category} Operators</h3>`;
                    list.appendChild(header);
                    
                    categories[category].forEach(op => {
                        const item = document.createElement('div');
                        item.className = 'function-item';
                        item.innerHTML = `
                            <div class="function-header">
                                <span class="function-name">${op.symbol}</span>
                                <span class="function-category-badge">${op.category}</span>
                            </div>
                            <div class="function-desc"><strong>${op.name}</strong> - ${op.desc}</div>
                            <div class="function-example">Example: <code>${op.example}</code></div>
                        `;
                        list.appendChild(item);
                    });
                });
            } catch (error) {
                console.error('Error loading operator library:', error);
            }
        }

        // Load VBA Constants & Declarations Library
        function loadConstantLibrary() {
            const list = document.getElementById('constantList');
            if (!list) {
                console.warn('constantList element not found - view may not be active yet');
                return;
            }
            
            list.innerHTML = '';
            
            try {
                // Group by category
                const categories = {};
                vbaConstants.forEach(vba => {
                    if (!categories[vba.category]) {
                        categories[vba.category] = [];
                    }
                    categories[vba.category].push(vba);
                });
                
                // Render each category
                Object.keys(categories).forEach(category => {
                    const header = document.createElement('div');
                    header.className = 'resource-section-header';
                    header.innerHTML = `<h3>${category}</h3>`;
                    list.appendChild(header);
                    
                    categories[category].forEach(vba => {
                        const item = document.createElement('div');
                        item.className = 'function-item';
                        item.innerHTML = `
                            <div class="function-header">
                                <span class="function-name">${vba.keyword}</span>
                                <span class="function-category-badge">${vba.category}</span>
                            </div>
                            <div class="function-desc">${vba.desc}</div>
                            <div class="function-example">Example: <code>${vba.example}</code></div>
                        `;
                        list.appendChild(item);
                    });
                });
            } catch (error) {
                console.error('Error loading constant library:', error);
            }
        }

        // Load Excel Criteria Expressions Library
        function loadCriteriaLibrary() {
            const list = document.getElementById('criteriaList');
            if (!list) {
                console.warn('criteriaList element not found - view may not be active yet');
                return;
            }
            
            list.innerHTML = '';
            
            try {
                // Group by category
                const categories = {};
                criteriaExpressions.forEach(criteria => {
                    if (!categories[criteria.category]) {
                        categories[criteria.category] = [];
                    }
                    categories[criteria.category].push(criteria);
                });
                
                // Render each category
                Object.keys(categories).forEach(category => {
                    const header = document.createElement('div');
                    header.className = 'resource-section-header';
                    header.innerHTML = `<h3>🧩 ${category}</h3>`;
                    list.appendChild(header);
                    
                    categories[category].forEach(criteria => {
                        const item = document.createElement('div');
                        item.className = 'function-item';
                        
                        const noteHtml = criteria.note ? 
                            `<div class="function-desc" style="color: var(--accent-orange); font-size: 13px;">📌 Note: ${criteria.note}</div>` : '';
                        
                        item.innerHTML = `
                            <div class="function-header">
                                <span class="function-name">${criteria.operator}</span>
                                <span class="function-category-badge">${criteria.category}</span>
                            </div>
                            <div class="function-desc"><strong>${criteria.meaning}</strong></div>
                            <div class="function-syntax">Syntax: <code>${criteria.example}</code></div>
                            <div class="function-example">Example: <code>${criteria.usage}</code></div>
                            ${noteHtml}
                        `;
                        list.appendChild(item);
                    });
                });
            } catch (error) {
                console.error('Error loading criteria library:', error);
            }
        }

        // View Switching
        function switchView(viewName, element) {
            currentView = viewName;
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // RESPONSIVE ENHANCEMENT: Close mobile nav when switching views
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            try {
                const sidebar = document.getElementById('mainSidebar');
                if (sidebar && window.innerWidth <= 768) {
                    sidebar.classList.remove('mobile-open');
                }
            } catch (e) {
                console.warn('Mobile nav close failed (non-critical):', e);
            }
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            const viewElement = document.getElementById('view-' + viewName);
            if (viewElement) {
                viewElement.classList.add('active');
            }
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if (element) {
                const navItem = element.closest ? element.closest('.nav-item') : element;
                if (navItem) {
                    navItem.classList.add('active');
                }
            }

            // Show/hide appropriate notification toggle
            const codeToggle = document.getElementById('codeNotifToggle');
            const formulaToggle = document.getElementById('formulaNotifToggle');
            const execToggle = document.getElementById('execNotifToggle');
            
            // Get all sidebars for strict isolation
            const codeSidebar = document.getElementById('codeNotifSidebar');
            const formulaSidebar = document.getElementById('formulaNotifSidebar');
            const execSidebar = document.getElementById('execNotifSidebar');
            
            // CRITICAL FIX: Close ALL sidebars first WITHOUT toggling flags
            // Just force them all closed, then open only the relevant one
            if (codeSidebar) codeSidebar.classList.add('closed');
            if (formulaSidebar) formulaSidebar.classList.add('closed');
            if (execSidebar) execSidebar.classList.add('closed');
            
            if (viewName === 'code-editor') {
                // Show only code notifications
                if (codeToggle) {
                    codeToggle.classList.remove('hidden');
                    codeToggle.removeAttribute('disabled');
                    codeToggle.removeAttribute('tabindex');
                }
                if (formulaToggle) {
                    formulaToggle.classList.add('hidden');
                    formulaToggle.setAttribute('disabled', 'true');
                    formulaToggle.setAttribute('tabindex', '-1');
                }
                if (execToggle) {
                    execToggle.classList.add('hidden');
                    execToggle.setAttribute('disabled', 'true');
                    execToggle.setAttribute('tabindex', '-1');
                }
                
                // Open ONLY code sidebar if it was previously open
                if (codeSidebar && codeNotifOpen) {
                    codeSidebar.classList.remove('closed');
                }
            } else if (viewName === 'formula-checker') {
                // Show only formula notifications
                if (formulaToggle) {
                    formulaToggle.classList.remove('hidden');
                    formulaToggle.removeAttribute('disabled');
                    formulaToggle.removeAttribute('tabindex');
                }
                if (codeToggle) {
                    codeToggle.classList.add('hidden');
                    codeToggle.setAttribute('disabled', 'true');
                    codeToggle.setAttribute('tabindex', '-1');
                }
                if (execToggle) {
                    execToggle.classList.add('hidden');
                    execToggle.setAttribute('disabled', 'true');
                    execToggle.setAttribute('tabindex', '-1');
                }
                
                // Open ONLY formula sidebar if it was previously open
                if (formulaSidebar && formulaNotifOpen) {
                    formulaSidebar.classList.remove('closed');
                }
            } else if (viewName === 'execution-tool') {
                // Show only execution notifications
                if (execToggle) {
                    execToggle.classList.remove('hidden');
                    execToggle.removeAttribute('disabled');
                    execToggle.removeAttribute('tabindex');
                }
                if (codeToggle) {
                    codeToggle.classList.add('hidden');
                    codeToggle.setAttribute('disabled', 'true');
                    codeToggle.setAttribute('tabindex', '-1');
                }
                if (formulaToggle) {
                    formulaToggle.classList.add('hidden');
                    formulaToggle.setAttribute('disabled', 'true');
                    formulaToggle.setAttribute('tabindex', '-1');
                }
                
                // Open ONLY execution sidebar if it was previously open
                if (execSidebar && execNotifOpen) {
                    execSidebar.classList.remove('closed');
                }
            } else {
                // Hide all notification toggles (for other views like templates, resources, etc.)
                if (codeToggle) {
                    codeToggle.classList.add('hidden');
                    codeToggle.setAttribute('disabled', 'true');
                    codeToggle.setAttribute('tabindex', '-1');
                }
                if (formulaToggle) {
                    formulaToggle.classList.add('hidden');
                    formulaToggle.setAttribute('disabled', 'true');
                    formulaToggle.setAttribute('tabindex', '-1');
                }
                if (execToggle) {
                    execToggle.classList.add('hidden');
                    execToggle.setAttribute('disabled', 'true');
                    execToggle.setAttribute('tabindex', '-1');
                }
                
                // All sidebars already closed above
            }
        }

        // Actions
        function formatCode() {
            const codeInput = document.getElementById('codeInput');
            const formatted = codeInput.value.split('\n').map(line => line.trimRight()).join('\n');
            codeInput.value = formatted;
            updateSyntaxHighlighting();
            addCodeNotification('success', 'Code formatted successfully - trailing spaces removed!');
        }

        function clearEditor() {
            document.getElementById('codeInput').value = '';
            document.getElementById('codeHighlight').innerHTML = '';
            updateLineNumbers();
            addCodeNotification('info', 'Editor cleared - ready for new code');
        }

        function copyCode() {
            const code = document.getElementById('codeInput').value;
            navigator.clipboard.writeText(code).then(() => {
                addCodeNotification('success', `${code.split('\n').length} lines copied to clipboard!`);
            });
        }

        function checkFormula() {
            const formula = document.getElementById('formulaInput').value;
            
            if (!formula.trim()) {
                addFormulaNotification('warning', 'Please enter a formula to check');
                return;
            }
            
            const issues = analyzeFormula(formula);
            
            if (issues.length === 0) {
                addFormulaNotification('success', 'Formula is syntactically correct! No errors detected.');
            } else {
                issues.forEach(issue => {
                    addFormulaNotification('error', issue);
                });
            }
        }

        function analyzeFormula(formula) {
            const issues = [];
            let working = formula.startsWith('=') ? formula.substring(1) : formula;
            
            // ========================================
            // 1️⃣ SMART QUOTES DETECTION
            // ========================================
            if (working.match(/[""'']/)) {
                issues.push('⚠️ Smart quotes detected - replace with straight quotes (")');
            }
            
            // ========================================
            // 2️⃣ BRACKET MATCHING (COMPREHENSIVE)
            // ========================================
            let parenDepth = 0;
            let bracketDepth = 0;
            let braceDepth = 0;
            
            for (let i = 0; i < working.length; i++) {
                const char = working[i];
                if (char === '(') parenDepth++;
                if (char === ')') parenDepth--;
                if (char === '[') bracketDepth++;
                if (char === ']') bracketDepth--;
                if (char === '{') braceDepth++;
                if (char === '}') braceDepth--;
                
                // Check for negative depth (closing before opening)
                if (parenDepth < 0) {
                    issues.push(`❌ Extra closing parenthesis ")" at position ${i + 1}`);
                    parenDepth = 0; // Reset to continue checking
                }
                if (bracketDepth < 0) {
                    issues.push(`❌ Extra closing bracket "]" at position ${i + 1}`);
                    bracketDepth = 0;
                }
            }
            
            // Check final depth (only positive, negatives already caught in loop)
            if (parenDepth > 0) {
                issues.push(`❌ Missing ${parenDepth} closing parenthesis ")" - unbalanced ()`);
            }
            if (bracketDepth > 0) {
                issues.push(`❌ Missing ${bracketDepth} closing bracket "]" - unbalanced []`);
            }
            if (braceDepth !== 0) {
                issues.push(`❌ Unbalanced curly braces {} - check array constants`);
            }
            
            // ========================================
            // 3️⃣ MISSPELLED FUNCTION NAMES (COMPREHENSIVE)
            // ========================================
            const commonTypos = {
                'SUMM': 'SUM',
                'VLOOOKUP': 'VLOOKUP',
                'HLOOOKUP': 'HLOOKUP',
                'IFF': 'IF',
                'AVERAGGE': 'AVERAGE',
                'COUNTA': null, // Valid function, not a typo
                'COUTN': 'COUNT',
                'COUNTIF': null, // Valid
                'COUNTIFS': null, // Valid
                'SUMIF': null, // Valid
                'SUMIFS': null, // Valid
                'IFERROR': null, // Valid
                'IFERR': 'IFERROR',
                'VLOKUP': 'VLOOKUP',
                'HLOKUP': 'HLOOKUP',
                'MATCTH': 'MATCH',
                'INDX': 'INDEX',
                'CONCATINATE': 'CONCATENATE',
                'CONCATE': 'CONCAT',
                'TEXTJION': 'TEXTJOIN',
                'ROUNND': 'ROUND',
                'ROUNDD': 'ROUND',
                'INTT': 'INT',
                'MODD': 'MOD',
                'ABSSS': 'ABS',
                'MAXX': 'MAX',
                'MINN': 'MIN',
                'ANDD': 'AND',
                'ORR': 'OR',
                'NOTT': 'NOT'
            };
            
            Object.keys(commonTypos).forEach(typo => {
                const correction = commonTypos[typo];
                if (correction && working.toUpperCase().includes(typo + '(')) {
                    issues.push(`❌ Misspelled function: "${typo}" → Should be "${correction}"`);
                }
            });
            
            // ========================================
            // 4️⃣ WRONG SYNTAX PATTERNS
            // ========================================
            
            // Missing opening parenthesis for known functions
            const knownFunctions = ['SUM', 'AVERAGE', 'COUNT', 'IF', 'VLOOKUP', 'INDEX', 'MATCH', 'SUMIF', 'COUNTIF'];
            knownFunctions.forEach(func => {
                const regex = new RegExp(`\\b${func}\\s*[^(]`, 'i');
                if (regex.test(working)) {
                    issues.push(`⚠️ Function "${func}" should be followed by "(" - missing opening parenthesis`);
                }
            });
            
            // Multiple equals signs (common mistake)
            const equalsCount = (working.match(/=/g) || []).length;
            if (equalsCount > 1) {
                issues.push(`⚠️ Multiple "=" signs detected (${equalsCount}) - formulas should have only one "=" at the start`);
            }
            
            // Consecutive operators (e.g., ++, --, **)
            if (working.match(/[\+\-\*\/]{2,}/)) {
                issues.push(`❌ Consecutive operators detected (e.g., ++, --, **) - invalid syntax`);
            }
            
            // Missing comma between arguments
            if (working.match(/\)\s*[A-Z0-9]/i)) {
                issues.push(`⚠️ Possible missing comma "," between function arguments`);
            }
            
            // Division by literal zero
            if (working.match(/\/\s*0\b/)) {
                issues.push(`❌ Division by zero detected - will cause #DIV/0! error`);
            }
            
            // Empty parentheses (function with no arguments when it requires them)
            if (working.match(/\b(SUM|AVERAGE|COUNT|MAX|MIN|VLOOKUP|INDEX|MATCH)\s*\(\s*\)/i)) {
                issues.push(`❌ Function called with empty parentheses () - requires arguments`);
            }
            
            // ========================================
            // 5️⃣ REDUNDANT FUNCTION USE
            // ========================================
            
            // Redundant SUM of a single cell
            if (working.match(/SUM\s*\(\s*[A-Z]+\d+\s*\)/i)) {
                issues.push(`💡 Redundant: SUM of a single cell - just reference the cell directly`);
            }
            
            // Redundant AVERAGE of a single cell
            if (working.match(/AVERAGE\s*\(\s*[A-Z]+\d+\s*\)/i)) {
                issues.push(`💡 Redundant: AVERAGE of a single cell - just reference the cell directly`);
            }
            
            // Nested IF with same condition
            const nestedIfPattern = /IF\s*\(([^,]+),.*IF\s*\(\1,/i;
            if (nestedIfPattern.test(working)) {
                issues.push(`💡 Redundant: Nested IF with same condition - simplify logic`);
            }
            
            // Double negative (NOT(NOT(...)))
            if (working.match(/NOT\s*\(\s*NOT\s*\(/i)) {
                issues.push(`💡 Redundant: NOT(NOT(...)) - double negatives cancel out`);
            }
            
            // IFERROR wrapping IFERROR
            if (working.match(/IFERROR\s*\([^)]*IFERROR\s*\(/i)) {
                issues.push(`💡 Redundant: IFERROR wrapping IFERROR - outer one is sufficient`);
            }
            
            // ========================================
            // 6️⃣ COMMON EXCEL ERRORS
            // ========================================
            
            // Missing $ for absolute references in formulas that look like they should be absolute
            if (working.match(/VLOOKUP\s*\([^,]+,[A-Z]+\d+:[A-Z]+\d+/i)) {
                issues.push(`💡 Tip: VLOOKUP table reference should probably be absolute (use $A$1:$B$10)`);
            }
            
            // VLOOKUP with range lookup TRUE when it should probably be FALSE
            if (working.match(/VLOOKUP\s*\([^,]+,[^,]+,\d+,\s*TRUE\s*\)/i)) {
                issues.push(`⚠️ VLOOKUP using approximate match (TRUE) - use FALSE for exact match in most cases`);
            }
            
            // Using & outside of text context
            if (working.match(/\d+\s*&\s*\d+/) && !working.match(/"/)) {
                issues.push(`⚠️ Using "&" to concatenate numbers - this converts them to text. Use "+" for math.`);
            }
            
            // Empty string comparison without quotes
            if (working.match(/=\s*\b\s*[,\)]/)) {
                issues.push(`⚠️ Possible missing quotes "" for empty string comparison`);
            }
            
            // ========================================
            // 7️⃣ ADVANCED SYNTAX CHECKS
            // ========================================
            
            // Comma before closing parenthesis (trailing comma)
            if (working.match(/,\s*\)/)) {
                issues.push(`⚠️ Trailing comma before ")" - remove extra comma`);
            }
            
            // Missing operator between cell references
            if (working.match(/[A-Z]+\d+\s+[A-Z]+\d+/i)) {
                issues.push(`❌ Missing operator between cell references - add +, -, *, /, or &`);
            }
            
            // Using semicolon instead of comma (common in non-US Excel)
            if (working.match(/;/) && !working.match(/"/)) {
                issues.push(`⚠️ Semicolon ";" detected - Excel formulas in English use commas ","  (semicolons are for other locales)`);
            }
            
            return issues;
        }

        function clearFormula() {
            document.getElementById('formulaInput').value = '';
            document.getElementById('formulaSyntax').style.display = 'none';
            addFormulaNotification('info', 'Formula input cleared');
        }

        function updateTime() {
            document.getElementById('currentTime').textContent = 
                new Date().toLocaleTimeString('en-US', { hour12: false });
        }

        // ===== EXECUTION TOOL FUNCTIONS =====
        
        // Progress Management
        async function setProgress(pct, stageText) {
            const container = document.getElementById('execProgressContainer');
            const fill = document.getElementById('execProgressFill');
            const label = document.getElementById('execProgressLabel');
            const percent = document.getElementById('execProgressPercent');
            const bar = document.getElementById('execProgressBar');
            
            if (!container || !fill || !label || !percent || !bar) return;
            
            container.style.display = 'block';
            fill.style.width = pct + '%';
            label.textContent = stageText;
            percent.textContent = pct + '%';
            bar.setAttribute('aria-valuenow', pct);
            
            // Small delay to show progress
            await sleep(100);
        }

        async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function resetProgress() {
            const container = document.getElementById('execProgressContainer');
            const fill = document.getElementById('execProgressFill');
            
            if (container) {
                setTimeout(() => {
                    if (fill) fill.style.width = '0%';
                    container.style.display = 'none';
                }, 1000);
            }
        }

        // Execution Tool Main Functions
        window.ExecTool.runAnalysis = async function() {
            if (window.ExecTool.isRunning) {
                addExecNotification('warning', 'Analysis already in progress...');
                return;
            }

            const input = document.getElementById('execInput');
            const output = document.getElementById('execOutput');
            
            if (!input || !output) return;
            
            const code = input.value.trim();
            
            if (!code) {
                addExecNotification('warning', 'Please paste VBA code or Excel formula to analyze');
                return;
            }

            window.ExecTool.isRunning = true;
            output.style.display = 'none';
            output.innerHTML = '';

            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // UI ENHANCEMENT: Initialize professional panels (ADDITIVE ONLY)
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            try {
                window.ExecUI.resetForExecution();
                window.ExecUI.updateCodeView(code);
                window.ExecUI.appendLog('Execution started', 'info');
            } catch (e) {
                console.warn('UI enhancement failed (non-critical):', e);
            }
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

            try {
                addExecNotification('info', 'Starting analysis...');
                
                // Stage 1: Starting (5%)
                await setProgress(5, 'Starting analysis...');
                try { window.ExecUI.updateProgress(5, '🚀 Starting analysis...'); } catch (e) {}
                
                // Stage 2: Parse input (15%)
                await setProgress(15, 'Parsing input...');
                try { window.ExecUI.updateProgress(15, '🔍 Parsing input...'); } catch (e) {}
                const inputType = detectInputType(code);
                addExecNotification('info', `Detected: ${inputType}`);
                try { window.ExecUI.appendLog(`Detected: ${inputType}`, 'info'); } catch (e) {}
                
                // Stage 3: Syntax/structure (30%)
                await setProgress(30, 'Checking syntax and structure...');
                try { window.ExecUI.updateProgress(30, '📝 Checking syntax and structure...'); } catch (e) {}
                const syntaxIssues = performSyntaxCheck(code, inputType);
                try { window.ExecUI.appendLog(`Syntax check: ${syntaxIssues.length} issues found`, 'info'); } catch (e) {}
                
                // Stage 4: Compile/runtime checks (50%)
                await setProgress(50, 'Analyzing compile and runtime risks...');
                try { window.ExecUI.updateProgress(50, '⚠️ Analyzing compile and runtime risks...'); } catch (e) {}
                const runtimeIssues = performRuntimeCheck(code, inputType);
                try { window.ExecUI.appendLog(`Runtime check: ${runtimeIssues.length} issues found`, 'info'); } catch (e) {}
                
                // Stage 5: Logic correctness (75%)
                await setProgress(75, 'Validating logic and edge cases...');
                try { window.ExecUI.updateProgress(75, '🧮 Validating logic and edge cases...'); } catch (e) {}
                const logicIssues = performLogicCheck(code, inputType);
                try { window.ExecUI.appendLog(`Logic check: ${logicIssues.length} issues found`, 'info'); } catch (e) {}
                
                // Stage 6: Draft fixes (95%)
                await setProgress(95, 'Generating fixes and report...');
                try { window.ExecUI.updateProgress(95, '📊 Generating fixes and report...'); } catch (e) {}
                const allIssues = [...syntaxIssues, ...runtimeIssues, ...logicIssues];
                const analysis = packageAnalysis(code, inputType, allIssues);
                
                // Stage 7: Done (100%)
                await setProgress(100, 'Analysis complete!');
                try { 
                    window.ExecUI.updateProgress(100, '✅ Analysis complete!'); 
                    window.ExecUI.appendLog(`Analysis complete - ${allIssues.length} total issues found`, 'success');
                } catch (e) {}
                
                // Display results
                displayAnalysis(analysis);
                output.style.display = 'block';
                
                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                // UI ENHANCEMENT: Move test results to popup panel (ADDITIVE)
                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                try {
                    window.TestResultsPanel.onAnalysisComplete();
                } catch (e) {
                    console.warn('TestResultsPanel failed (non-critical):', e);
                }
                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                
                addExecNotification('success', `Analysis complete - ${allIssues.length} issues found`);
                
                resetProgress();
                try { window.ExecUI.hideProgress(); } catch (e) {}
                
            } catch (error) {
                await setProgress(0, 'Error occurred');
                try { 
                    window.ExecUI.appendLog(`Error: ${error.message}`, 'error'); 
                    window.ExecUI.hideProgress();
                } catch (e) {}
                addExecNotification('error', `Analysis failed: ${error.message}`);
                output.innerHTML = `
                    <div class="verdict-section verdict-fail">
                        <div class="verdict-title">❌ Analysis Error</div>
                        <div class="verdict-summary">
                            An error occurred during analysis: ${escapeHtml(error.message)}<br><br>
                            <strong>How to fix:</strong> Ensure your input contains valid VBA code or Excel formulas.
                        </div>
                    </div>
                `;
                output.style.display = 'block';
                resetProgress();
            } finally {
                window.ExecTool.isRunning = false;
            }
        };

        // Input Detection
        function detectInputType(code) {
            const hasVbaKeywords = /\b(Sub|Function|Dim|Set|If|For|While|Do|End)\b/i.test(code);
            const hasFormula = /^=/.test(code.trim()) || /^[A-Z]+\(/.test(code.trim());
            
            if (hasVbaKeywords && hasFormula) return 'VBA + Formula';
            if (hasVbaKeywords) return 'VBA Code';
            if (hasFormula) return 'Excel Formula';
            return 'Unknown (will attempt VBA analysis)';
        }

        // Syntax Check (Zero-False-Pass)
        function performSyntaxCheck(code, inputType) {
            const issues = [];
            
            if (inputType.includes('VBA')) {
                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                // 🚀 LAYER 1: TOKENIZER-BASED ANALYSIS (Enhanced Detection)
                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                
                try {
                    const lintFindings = VBALintEngine.run(code);
                    
                    // Convert tokenizer findings to Execution Tool format
                    lintFindings.forEach(finding => {
                        issues.push({
                            severity: finding.severity || 'Major',
                            location: `Line ${finding.line}`,
                            type: finding.severity === 'Critical' ? 'Compile' : 
                                  finding.category.includes('Performance') ? 'Performance' :
                                  finding.category.includes('Security') ? 'Runtime' : 'Logic',
                            description: finding.title,
                            why: finding.problem,
                            fix: finding.fix,
                            line: finding.line
                        });
                    });
                } catch (e) {
                    console.warn('VBA Lint Engine error in Execution Tool:', e);
                }
                
                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                // 🚀 LAYER 1.5: FORMAT & STATEMENT VALIDATION (ADDITIVE)
                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                
                try {
                    const formatIssues = VBAFormatValidator.validate(code);
                    formatIssues.forEach(issue => {
                        issues.push({
                            severity: issue.type === 'error' ? 'Critical' : 
                                     issue.type === 'warning' ? 'Major' : 'Minor',
                            location: `Line ${issue.line}`,
                            type: issue.category.includes('Format') ? 'Compile' : 'Logic',
                            description: issue.title,
                            why: issue.problem,
                            fix: issue.fix,
                            line: issue.line
                        });
                    });
                } catch (e) {
                    console.error('Format validator error in Execution Tool:', e);
                }
                
                try {
                    const statementIssues = VBAStatementValidator.validate(code);
                    statementIssues.forEach(issue => {
                        issues.push({
                            severity: 'Critical',
                            location: `Line ${issue.line}`,
                            type: 'Compile',
                            description: issue.title,
                            why: issue.problem,
                            fix: issue.fix,
                            line: issue.line
                        });
                    });
                } catch (e) {
                    console.error('Statement validator error in Execution Tool:', e);
                }
                
                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                // 🔍 LAYER 2: LEGACY CHECKS (Token-Aware)
                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                
                const lines = code.split('\n');
                
                // Tokenize for string/comment detection
                let tokens = [];
                try {
                    tokens = VBATokenizer.tokenize(code);
                } catch (e) {
                    console.warn('Tokenizer error:', e);
                }
                
                lines.forEach((line, idx) => {
                    const lineNum = idx + 1;
                    const trimmed = line.trim();
                    
                    // Smart quotes (Unicode only - token aware)
                    const hasUnicodeCurlyQuotes = /[\u201C\u201D\u2018\u2019]/.test(line);
                    if (hasUnicodeCurlyQuotes) {
                        issues.push({
                            severity: 'Critical',
                            location: `Line ${lineNum}`,
                            type: 'Compile',
                            description: `Unicode smart quotes detected (U+201C, U+201D, U+2018, U+2019)`,
                            why: 'Will cause compile error: "Expected: end of statement". VBA requires ASCII quotes.',
                            fix: line.replace(/[\u201C\u201D]/g, '"').replace(/[\u2018\u2019]/g, "'"),
                            line: lineNum
                        });
                    }
                    
                    // Unclosed strings (token-aware with SAFE AUTO-FIX)
                    const quotes = (line.match(/"/g) || []).length;
                    if (quotes % 2 !== 0 && !trimmed.startsWith("'")) {
                        // ========================================
                        // SAFE STRING AUTO-FIX DECISION LOGIC
                        // ========================================
                        
                        const isUnclosedString = true;
                        const VBA_KEYWORDS = /\b(End\s+Sub|End\s+If|End\s+With|Sub|Function|If|Then|Else|For|Next|Do|Loop|Select|Case|With)\b/i;
                        const containsVBAKeyword = VBA_KEYWORDS.test(trimmed);
                        const conflictsWithBlockStructure = /\b(End\s+(Sub|If|With|Function|Select)|Next|Loop)\b/i.test(trimmed);
                        
                        const allowStringAutoFix = 
                            isUnclosedString && 
                            !containsVBAKeyword && 
                            !conflictsWithBlockStructure;
                        
                        if (allowStringAutoFix) {
                            // ✅ SAFE TO AUTO-FIX
                            issues.push({
                                severity: 'Critical',
                                location: `Line ${lineNum}`,
                                type: 'Compile',
                                description: 'Unclosed string literal - missing closing quote',
                                why: 'Will cause compile error: "Expected: end of statement"',
                                fix: line + '"',
                                line: lineNum
                            });
                        } else {
                            // ❌ UNSAFE TO AUTO-FIX
                            issues.push({
                                severity: 'Critical',
                                location: `Line ${lineNum}`,
                                type: 'Compile',
                                description: 'Unclosed string literal (manual fix required) - contains VBA keywords',
                                why: 'String contains structural keywords (End Sub, End If, etc.). Auto-fix blocked to prevent breaking code structure.',
                                fix: null,  // NO AUTO-FIX
                                line: lineNum
                            });
                        }
                    }
                    
                    // Missing Then
                    if (trimmed.match(/^If\s+/i) && !trimmed.includes('Then') && !trimmed.includes('_')) {
                        issues.push({
                            severity: 'Critical',
                            location: `Line ${lineNum}`,
                            type: 'Compile',
                            description: 'If statement missing "Then" keyword',
                            why: 'Will cause compile error: "Expected: Then or GoTo"',
                            fix: trimmed.replace(/^(If\s+.+?)$/i, '$1 Then'),
                            line: lineNum
                        });
                    }
                    
                    // Missing Set for objects
                    const objAssign = trimmed.match(/^(\w+)\s*=\s*(Range|Worksheet|Workbook|Cells)\(/i);
                    if (objAssign && !trimmed.startsWith('Set')) {
                        issues.push({
                            severity: 'Critical',
                            location: `Line ${lineNum}`,
                            type: 'Runtime',
                            description: 'Object assignment without "Set" keyword',
                            why: 'Will cause runtime error 91: "Object variable or With block variable not set"',
                            fix: 'Set ' + trimmed,
                            line: lineNum
                        });
                    }
                    
                    // Undeclared variables (if Option Explicit assumed)
                    const varUsage = trimmed.match(/^(\w+)\s*=/);
                    if (varUsage && !code.toLowerCase().includes('dim ' + varUsage[1].toLowerCase())) {
                        issues.push({
                            severity: 'Major',
                            location: `Line ${lineNum}`,
                            type: 'Runtime',
                            description: `Variable "${varUsage[1]}" used but not declared`,
                            why: 'If Option Explicit is enabled, will cause compile error: "Variable not defined"',
                            fix: `Dim ${varUsage[1]} As Variant\n${trimmed}`,
                            line: lineNum
                        });
                    }
                });
                
                // Block matching
                const ifCount = (code.match(/\bIf\b/gi) || []).length;
                const endIfCount = (code.match(/\bEnd\s+If\b/gi) || []).length;
                
                if (ifCount !== endIfCount) {
                    issues.push({
                        severity: 'Critical',
                        location: 'Overall structure',
                        type: 'Compile',
                        description: `Mismatched If/End If blocks (${ifCount} If, ${endIfCount} End If)`,
                        why: 'Will cause compile error: "Block If without End If" or vice versa',
                        fix: 'Add missing End If or remove extra ones',
                        line: 0
                    });
                }
            }
            
            if (inputType.includes('Formula')) {
                const formulas = code.match(/=.+/g) || [code];
                
                formulas.forEach((formula, idx) => {
                    // Parentheses balance
                    let depth = 0;
                    for (let char of formula) {
                        if (char === '(') depth++;
                        if (char === ')') depth--;
                    }
                    
                    if (depth !== 0) {
                        issues.push({
                            severity: 'Critical',
                            location: `Formula ${idx + 1}`,
                            type: 'Excel-Calc',
                            description: `Unbalanced parentheses (${depth > 0 ? 'missing closing' : 'extra closing'})`,
                            why: 'Will show #NAME? or formula error in Excel',
                            fix: depth > 0 ? formula + ')'.repeat(depth) : 'Remove extra closing parentheses',
                            line: idx + 1
                        });
                    }
                    
                    // Division by zero
                    if (formula.match(/\/\s*0\b/)) {
                        issues.push({
                            severity: 'Major',
                            location: `Formula ${idx + 1}`,
                            type: 'Excel-Calc',
                            description: 'Division by zero detected',
                            why: 'Will cause #DIV/0! error in Excel',
                            fix: formula.replace(/\/\s*0/, '/ 1 (or wrap in IFERROR)'),
                            line: idx + 1
                        });
                    }
                });
            }
            
            // 🔹 ADDITIONAL COMPREHENSIVE CHECKS FOR EXECUTION TOOL
            if (inputType.includes('VBA')) {
                const lines = code.split('\n');
                
                // Option Explicit check
                if (!/^\s*Option\s+Explicit/im.test(code)) {
                    issues.push({
                        severity: 'Critical',
                        location: 'Line 1 (missing)',
                        type: 'Compile',
                        description: 'Option Explicit not found - ALL modules must start with this',
                        why: 'Without it, typos in variable names create NEW variables instead of errors',
                        fix: 'Option Explicit\n\n' + code,
                        line: 1
                    });
                }
                
                // Line continuation validation
                lines.forEach((line, idx) => {
                    if (line.includes('_') && !line.trim().startsWith("'")) {
                        if (line.match(/\w_\s*$/)) {
                            issues.push({
                                severity: 'Critical',
                                location: `Line ${idx + 1}`,
                                type: 'Compile',
                                description: 'Line continuation underscore must have space before it',
                                why: 'Will cause compile error: "Invalid character"',
                                fix: line.replace(/(\w)_/, '$1 _'),
                                line: idx + 1
                            });
                        }
                    }
                });
                
                // Detect INTEGER usage (should use LONG)
                lines.forEach((line, idx) => {
                    if (line.match(/As\s+Integer\b/i)) {
                        issues.push({
                            severity: 'Minor',
                            location: `Line ${idx + 1}`,
                            type: 'Performance',
                            description: 'Using Integer instead of Long',
                            why: 'Integer is 16-bit (max 32,767). Long is 32-bit, faster, and handles bigger numbers',
                            fix: line.replace(/Integer/i, 'Long'),
                            line: idx + 1
                        });
                    }
                });
                
                // Unqualified Range/Cells references
                lines.forEach((line, idx) => {
                    if (line.match(/\b(Range|Cells)\s*\(/i) && !line.match(/\b\w+\.(Range|Cells)\s*\(/i)) {
                        issues.push({
                            severity: 'Major',
                            location: `Line ${idx + 1}`,
                            type: 'Runtime',
                            description: 'Unqualified Range/Cells - will operate on ActiveSheet',
                            why: 'May operate on wrong sheet if user switches sheets during execution',
                            fix: 'Set ws = ThisWorkbook.Sheets("SheetName")\nws.' + line.trim(),
                            line: idx + 1
                        });
                    }
                });
                
                // .Select / .Activate usage (performance killer)
                lines.forEach((line, idx) => {
                    if (line.match(/\.(Select|Activate)\s*$/i)) {
                        issues.push({
                            severity: 'Minor',
                            location: `Line ${idx + 1}`,
                            type: 'Performance',
                            description: 'Using .Select or .Activate (100x slower than direct access)',
                            why: 'Selecting objects is unnecessary and dramatically slows execution',
                            fix: 'Access object directly: ws.Range("A1").Value = 10',
                            line: idx + 1
                        });
                    }
                });
                
                // Hardcoded sheet references
                lines.forEach((line, idx) => {
                    if (line.match(/Sheets?\s*\(\s*"[^"]+"\s*\)/i)) {
                        issues.push({
                            severity: 'Minor',
                            location: `Line ${idx + 1}`,
                            type: 'Logic',
                            description: 'Hardcoded sheet name - will break if sheet renamed',
                            why: 'Runtime error 9 "Subscript out of range" if sheet doesn\'t exist',
                            fix: 'Use variable or add: On Error Resume Next',
                            line: idx + 1
                        });
                    }
                });
                
                // Boolean = True comparison (redundant)
                lines.forEach((line, idx) => {
                    if (line.match(/=\s*(True|False)\s+(Then|And|Or)/i)) {
                        issues.push({
                            severity: 'Minor',
                            location: `Line ${idx + 1}`,
                            type: 'Logic',
                            description: 'Redundant boolean comparison (= True or = False)',
                            why: 'Unnecessary code clutter',
                            fix: 'If x Then (not If x = True Then)',
                            line: idx + 1
                        });
                    }
                });
                
                // Dangerous operations
                const dangerous = ['Kill', 'Shell', 'SendKeys', 'CreateObject("WScript.Shell")'];
                lines.forEach((line, idx) => {
                    dangerous.forEach(danger => {
                        if (line.includes(danger)) {
                            issues.push({
                                severity: 'Major',
                                location: `Line ${idx + 1}`,
                                type: 'Runtime',
                                description: `SECURITY RISK: ${danger} - file system/shell access`,
                                why: 'Can delete files, execute programs, or perform malicious actions',
                                fix: 'Add user confirmation: If MsgBox("Allow?", vbYesNo) = vbYes Then...',
                                line: idx + 1
                            });
                        }
                    });
                });
                
                // Excel 365-only functions
                const excel365Funcs = ['XLOOKUP', 'FILTER', 'SORT', 'UNIQUE', 'SEQUENCE'];
                lines.forEach((line, idx) => {
                    excel365Funcs.forEach(func => {
                        if (line.match(new RegExp(`\\b${func}\\b`, 'i'))) {
                            issues.push({
                                severity: 'Minor',
                                location: `Line ${idx + 1}`,
                                type: 'Runtime',
                                description: `${func} is Excel 365-only (will fail on 2019 and earlier)`,
                                why: 'Function not available in older Excel versions',
                                fix: 'Add version check or use backward-compatible alternative',
                                line: idx + 1
                            });
                        }
                    });
                });
            }
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // 🎯 REPORTING LAYER (ADVISORY MODE - NEVER BLOCKS EXECUTION)
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // Process findings for better presentation
            // CRITICAL: This is ADVISORY ONLY - does not block execution
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            
            try {
                // Apply reporting layer (dedupe, normalize, etc.)
                const processedIssues = LintReportingLayer.prepareLintReport(issues);
                // ADVISORY: Return processed findings for display only
                return processedIssues;
            } catch (e) {
                console.warn('Reporting layer error in Execution Tool (falling back):', e);
                // SAFETY: Fallback to raw issues - never block execution
                return issues;
            }
        }

        // Runtime Check
        function performRuntimeCheck(code, inputType) {
            const issues = [];
            
            if (inputType.includes('VBA')) {
                const lines = code.split('\n');
                
                // Unqualified references
                if (code.match(/\b(Range|Cells|Rows|Columns)\(/i) && !code.includes('Set ws =')) {
                    issues.push({
                        severity: 'Major',
                        location: 'Multiple lines',
                        type: 'Runtime',
                        description: 'Unqualified Range/Cells references detected',
                        why: 'May operate on wrong worksheet if another sheet is active',
                        fix: 'Use: Set ws = ThisWorkbook.Worksheets("SheetName")\\nThen: ws.Range(...)',
                        line: 0
                    });
                }
                
                // ScreenUpdating without restore
                if (code.includes('ScreenUpdating = False') && !code.includes('ScreenUpdating = True')) {
                    issues.push({
                        severity: 'Major',
                        location: 'Overall',
                        type: 'Performance',
                        description: 'Application.ScreenUpdating = False without restore to True',
                        why: 'Will leave Excel screen frozen if error occurs before restore',
                        fix: 'Add error handler that restores: Application.ScreenUpdating = True',
                        line: 0
                    });
                }
                
                // EnableEvents without restore
                if (code.includes('EnableEvents = False') && !code.includes('EnableEvents = True')) {
                    issues.push({
                        severity: 'Major',
                        location: 'Overall',
                        type: 'Runtime',
                        description: 'Application.EnableEvents = False without restore to True',
                        why: 'Will disable all event handlers permanently if error occurs',
                        fix: 'Add error handler that restores: Application.EnableEvents = True',
                        line: 0
                    });
                }
                
                // Calculation mode without restore
                if (code.includes('Calculation = xlCalculationManual') && !code.includes('xlCalculationAutomatic')) {
                    issues.push({
                        severity: 'Major',
                        location: 'Overall',
                        type: 'Performance',
                        description: 'Calculation set to Manual without restoring to Automatic',
                        why: 'Formulas won\'t recalculate automatically after macro runs',
                        fix: 'Add: Application.Calculation = xlCalculationAutomatic',
                        line: 0
                    });
                }
                
                // On Error Resume Next without reset
                if (code.includes('On Error Resume Next') && !code.includes('On Error GoTo 0')) {
                    issues.push({
                        severity: 'Critical',
                        location: 'Overall',
                        type: 'Runtime',
                        description: '"On Error Resume Next" without "On Error GoTo 0" to reset',
                        why: 'Will silently hide all errors in subsequent code, masking bugs',
                        fix: 'Add "On Error GoTo 0" after the risky section',
                        line: 0
                    });
                }
                
                // Cell-by-cell processing (performance)
                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                // ENHANCED: Precise detection + deduplication
                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                const flaggedLoopsExec = new Set(); // Track flagged loops
                
                lines.forEach((line, idx) => {
                    const trimmed = line.trim();
                    
                    // Detect loop start
                    if (trimmed.match(/^(For\s+\w+\s*=.*To|Do\s+|While\s+)/i)) {
                        const loopStartLine = idx + 1;
                        
                        // Check if already flagged
                        if (flaggedLoopsExec.has(loopStartLine)) {
                            return;
                        }
                        
                        // Scan loop body for ACTUAL cell access
                        const loopBodyLines = lines.slice(idx + 1, idx + 21);
                        let actualCellAccessLine = null;
                        let hasCellAccess = false;
                        let hasValueAssignment = false;
                        
                        loopBodyLines.forEach((bodyLine, bodyIdx) => {
                            if (!bodyLine) return;
                            
                            // Check for cell access INSIDE loop
                            if (bodyLine.match(/\.Cells\(|\.Range\(/i)) {
                                hasCellAccess = true;
                                if (!actualCellAccessLine) {
                                    actualCellAccessLine = idx + 2 + bodyIdx;
                                }
                            }
                            
                            // Check for value assignment
                            if (bodyLine.match(/\.Value\s*=/i)) {
                                hasValueAssignment = true;
                            }
                        });
                        
                        // Only report if BOTH conditions met INSIDE loop
                        if (hasCellAccess && hasValueAssignment && actualCellAccessLine) {
                            flaggedLoopsExec.add(loopStartLine); // Mark as flagged
                            
                            issues.push({
                                severity: 'Minor',
                                location: `Line ${actualCellAccessLine}`, // Highlight cell access line, NOT loop header
                                type: 'Performance',
                                description: 'Cell-by-cell processing inside loop (100x slower than arrays)',
                                why: 'Reading/writing cells one-by-one inside loop is extremely slow',
                                fix: 'Use array: arr = Range("A1:A1000").Value, process arr, then write back',
                                line: actualCellAccessLine
                            });
                        }
                    }
                });
                
                // Loop counter not used (potential infinite loop)
                lines.forEach((line, idx) => {
                    const forMatch = line.match(/For\s+(\w+)\s*=/i);
                    if (forMatch) {
                        const counter = forMatch[1];
                        const loopBody = lines.slice(idx, idx + 20).join('\n');
                        if (!loopBody.includes(counter) || loopBody.split(counter).length <= 2) {
                            issues.push({
                                severity: 'Major',
                                location: `Line ${idx + 1}`,
                                type: 'Logic',
                                description: `Loop counter "${counter}" never used in loop body`,
                                why: 'May indicate logic error or unnecessary loop',
                                fix: 'Verify loop logic or remove unused counter',
                                line: idx + 1
                            });
                        }
                    }
                });
                
                // Missing input validation
                if (code.match(/InputBox|Application\.InputBox/i) && !code.match(/IsNumeric|IsDate|Len\(/i)) {
                    issues.push({
                        severity: 'Major',
                        location: 'Overall',
                        type: 'Runtime',
                        description: 'InputBox without validation - will crash on bad input',
                        why: 'User can enter invalid data causing Type Mismatch or other errors',
                        fix: 'Add: If Not IsNumeric(userInput) Then Exit Sub',
                        line: 0
                    });
                }
                
                // Function with side effects
                let inFunction = false;
                lines.forEach((line, idx) => {
                    const trimmed = line.trim().toLowerCase();
                    if (trimmed.startsWith('function ')) {
                        inFunction = true;
                    } else if (trimmed.startsWith('end function')) {
                        inFunction = false;
                    }
                    
                    if (inFunction && trimmed.match(/\.value\s*=|screenupdating|enableevents/i)) {
                        issues.push({
                            severity: 'Minor',
                            location: `Line ${idx + 1}`,
                            type: 'Logic',
                            description: 'Function has side effects (modifying state)',
                            why: 'Functions should only calculate and return, not change things',
                            fix: 'Move state changes to a Sub, keep Function pure',
                            line: idx + 1
                        });
                    }
                });
            }
            
            return issues;
        }

        // Logic Check
        function performLogicCheck(code, inputType) {
            const issues = [];
            
            // This is where we'd check business logic, but without context we mark UNVERIFIED
            if (inputType.includes('VBA')) {
                const lines = code.split('\n');
                
                // Hard-coded worksheet names
                if (code.match(/Worksheets\("[\w\s]+"\)/)) {
                    issues.push({
                        severity: 'Minor',
                        location: 'UNVERIFIED',
                        type: 'Logic',
                        description: 'Hard-coded worksheet names detected',
                        why: 'Cannot verify: Sheet names unknown. Will fail if sheet doesn\'t exist.',
                        fix: 'Verify sheet names exist, or use error handling: On Error Resume Next',
                        line: 0
                    });
                }
                
                // Empty Sub/Function detection
                lines.forEach((line, idx) => {
                    const trimmed = line.trim().toLowerCase();
                    if ((trimmed.startsWith('sub ') || trimmed.startsWith('function ')) && 
                        trimmed.includes('()')) {
                        const nextNonEmpty = lines.slice(idx + 1).find(l => l.trim() && !l.trim().startsWith("'"));
                        if (nextNonEmpty && (nextNonEmpty.trim().toLowerCase().startsWith('end sub') || 
                                             nextNonEmpty.trim().toLowerCase().startsWith('end function'))) {
                            issues.push({
                                severity: 'Minor',
                                location: `Line ${idx + 1}`,
                                type: 'Logic',
                                description: 'Empty procedure detected (no code inside)',
                                why: 'Procedure serves no purpose',
                                fix: 'Implement the procedure or remove it',
                                line: idx + 1
                            });
                        }
                    }
                });
                
                // Magic numbers (should be constants)
                lines.forEach((line, idx) => {
                    const match = line.match(/=\s*(\d{2,})/);
                    if (match && !line.toLowerCase().includes('const') && 
                        !line.toLowerCase().includes('for') && 
                        !line.toLowerCase().includes('to')) {
                        issues.push({
                            severity: 'Minor',
                            location: `Line ${idx + 1}`,
                            type: 'Logic',
                            description: `Magic number detected: ${match[1]}`,
                            why: 'Unexplained numbers make code hard to understand',
                            fix: `Const MEANINGFUL_NAME = ${match[1]}`,
                            line: idx + 1
                        });
                    }
                });
                
                // Many ElseIf (suggest Select Case)
                let elseIfCount = 0;
                let ifLineStart = 0;
                lines.forEach((line, idx) => {
                    const trimmed = line.trim().toLowerCase();
                    if (trimmed.startsWith('if ') && trimmed.includes('then')) {
                        ifLineStart = idx + 1;
                        elseIfCount = 0;
                    } else if (trimmed.startsWith('elseif ')) {
                        elseIfCount++;
                        if (elseIfCount === 4) {
                            issues.push({
                                severity: 'Minor',
                                location: `Line ${ifLineStart}`,
                                type: 'Logic',
                                description: 'Many ElseIf statements (4+) detected',
                                why: 'Select Case is clearer and faster for multiple conditions',
                                fix: 'Refactor to: Select Case variable\\n    Case value1\\n    Case value2\\nEnd Select',
                                line: ifLineStart
                            });
                        }
                    }
                });
                
                // Loop structure validation
                const forCount = (code.match(/\bFor\s+/gi) || []).length;
                const nextCount = (code.match(/\bNext\b/gi) || []).length;
                if (forCount > nextCount) {
                    issues.push({
                        severity: 'Minor',
                        location: 'UNVERIFIED',
                        type: 'Logic',
                        description: `Mismatched For/Next (${forCount} For, ${nextCount} Next)`,
                        why: 'Loop structure may be incomplete',
                        fix: 'Add missing Next statements',
                        line: 0
                    });
                }
                
                // Naming convention check
                lines.forEach((line, idx) => {
                    const dimMatch = line.match(/Dim\s+(\w+)\s+As\s+(Worksheet|Workbook|Range)/i);
                    if (dimMatch) {
                        const varName = dimMatch[1];
                        const varType = dimMatch[2].toLowerCase();
                        const expectedPrefix = varType === 'worksheet' ? 'ws' : 
                                             varType === 'workbook' ? 'wb' : 'rng';
                        
                        if (!varName.toLowerCase().startsWith(expectedPrefix)) {
                            issues.push({
                                severity: 'Minor',
                                location: `Line ${idx + 1}`,
                                type: 'Logic',
                                description: `Variable naming: ${varType} should start with "${expectedPrefix}"`,
                                why: 'Standard prefixes improve code readability',
                                fix: `Rename to: Dim ${expectedPrefix}${varName} As ${dimMatch[2]}`,
                                line: idx + 1
                            });
                        }
                    }
                });
                
                // Commented-out code blocks
                let consecutiveComments = 0;
                lines.forEach((line, idx) => {
                    const trimmed = line.trim();
                    if (trimmed.startsWith("'") && trimmed.match(/^'\s*(Dim|If|For|Sub|Function)/i)) {
                        consecutiveComments++;
                        if (consecutiveComments === 5) {
                            issues.push({
                                severity: 'Minor',
                                location: `Line ${idx - 4}`,
                                type: 'Logic',
                                description: 'Large block of commented-out code (5+ lines)',
                                why: 'Dead code should be deleted, not commented',
                                fix: 'Delete commented code, use version control (Git) for history',
                                line: idx - 4
                            });
                        }
                    } else {
                        consecutiveComments = 0;
                    }
                });
            }
            
            return issues;
        }

        // Package Analysis
        // ========================================
        // EXECUTION TOOL VALIDATION (CRITICAL)
        // ========================================
        
        /**
         * Validates code for execution readiness
         * Returns classification: EXECUTION_READY, PARTIALLY_CORRECTED, or INVALID_CODE
         */
        function validateExecutionReadiness(code, issues) {
            const classification = {
                status: 'INVALID_CODE',
                canLabelAsReady: false,
                reason: [],
                confidence: 0
            };
            
            try {
                const lines = code.split('\n');
                
                // Check for critical grammar errors first
                const grammarErrors = detectGrammarErrors(lines);
                const hasCritical = hasCriticalGrammarErrors(grammarErrors);
                
                if (hasCritical) {
                    classification.status = 'INVALID_CODE';
                    classification.canLabelAsReady = false;
                    classification.reason.push('Critical grammar errors detected');
                    grammarErrors.forEach(err => {
                        if (err.isCritical) {
                            classification.reason.push(`Line ${err.line}: ${err.title}`);
                        }
                    });
                    classification.confidence = 0;
                    return classification;
                }
                
                // Check for critical issues in analysis
                const criticalIssues = issues.filter(i => 
                    i.severity === 'Critical' || 
                    i.type === 'Compile' ||
                    (i.description && (
                        i.description.includes('Invalid Sub') ||
                        i.description.includes('Invalid Function') ||
                        i.description.includes('Orphan') ||
                        i.description.includes('End If without') ||
                        i.description.includes('End With without') ||
                        i.description.includes('End Sub without') ||
                        i.description.includes('unclosed string') ||
                        i.description.includes('smart quotes')
                    ))
                );
                
                if (criticalIssues.length > 0) {
                    // Check if all critical issues are fixable
                    const allFixable = criticalIssues.every(i => i.fix && i.fix !== null);
                    
                    if (allFixable) {
                        classification.status = 'PARTIALLY_CORRECTED';
                        classification.canLabelAsReady = false;
                        classification.reason.push('Some issues were auto-corrected, but manual review required');
                        classification.confidence = 50;
                    } else {
                        classification.status = 'INVALID_CODE';
                        classification.canLabelAsReady = false;
                        classification.reason.push('Critical errors that cannot be auto-fixed');
                        criticalIssues.forEach(i => {
                            if (!i.fix) {
                                classification.reason.push(`${i.location}: ${i.description}`);
                            }
                        });
                        classification.confidence = 0;
                    }
                    return classification;
                }
                
                // Check for major issues
                const majorIssues = issues.filter(i => 
                    i.severity === 'Major' ||
                    i.type === 'Runtime'
                );
                
                if (majorIssues.length > 0) {
                    classification.status = 'PARTIALLY_CORRECTED';
                    classification.canLabelAsReady = false;
                    classification.reason.push('Major runtime risks detected');
                    classification.confidence = 60;
                    return classification;
                }
                
                // No critical or major issues - check for minor issues
                const minorIssues = issues.filter(i => 
                    i.severity === 'Minor' ||
                    i.type === 'Performance' ||
                    i.type === 'Style'
                );
                
                if (minorIssues.length > 0) {
                    classification.status = 'EXECUTION_READY';
                    classification.canLabelAsReady = true;
                    classification.reason.push('Code is valid with minor optimization opportunities');
                    classification.confidence = 90;
                    return classification;
                }
                
                // Zero issues detected
                classification.status = 'EXECUTION_READY';
                classification.canLabelAsReady = true;
                classification.reason.push('No issues detected');
                classification.confidence = 100;
                
            } catch (error) {
                console.error('Validation error:', error);
                classification.status = 'INVALID_CODE';
                classification.canLabelAsReady = false;
                classification.reason.push('Validation error occurred');
                classification.confidence = 0;
            }
            
            return classification;
        }

        function packageAnalysis(code, inputType, issues) {
            const criticalCount = issues.filter(i => i.severity === 'Critical').length;
            const majorCount = issues.filter(i => i.severity === 'Major').length;
            
            // CRITICAL: Validate execution readiness
            const validation = validateExecutionReadiness(code, issues);
            
            let verdict = 'pass';
            if (validation.status === 'INVALID_CODE') {
                verdict = 'fail';
            } else if (validation.status === 'PARTIALLY_CORRECTED') {
                verdict = 'warn';
            } else if (criticalCount > 0) {
                verdict = 'fail';
            } else if (majorCount > 0) {
                verdict = 'warn';
            }
            
            return {
                verdict,
                inputType,
                totalIssues: issues.length,
                criticalCount,
                majorCount,
                issues: issues.sort((a, b) => {
                    const severityOrder = { 'Critical': 0, 'Major': 1, 'Minor': 2 };
                    return severityOrder[a.severity] - severityOrder[b.severity];
                }),
                originalCode: code,
                fixedCode: validation.canLabelAsReady ? generateFixedCode(code, issues) : null,
                testCases: generateTestCases(inputType),
                validation: validation // Include validation result
            };
        }

        // Generate Fixed Code
        function generateFixedCode(code, issues) {
            let fixed = code;
            
            // Apply line-specific fixes
            issues.forEach(issue => {
                if (issue.line > 0 && issue.fix && !issue.fix.includes('...')) {
                    const lines = fixed.split('\n');
                    if (lines[issue.line - 1]) {
                        lines[issue.line - 1] = issue.fix;
                        fixed = lines.join('\n');
                    }
                }
            });
            
            return fixed;
        }

        // Generate Test Cases
        function generateTestCases(inputType) {
            if (inputType.includes('VBA')) {
                return [
                    { case: 'Normal: Valid input data', expected: 'Success', result: 'PASS' },
                    { case: 'Edge: Empty cells', expected: 'Handle gracefully', result: 'VERIFY' },
                    { case: 'Edge: Last row of data', expected: 'No overflow', result: 'VERIFY' },
                    { case: 'Stress: 10,000 rows', expected: 'Complete without timeout', result: 'VERIFY' },
                    { case: 'Trap: Sheet doesn\'t exist', expected: 'Error handler catches', result: 'VERIFY' },
                    { case: 'Trap: Division by zero', expected: 'No crash', result: 'VERIFY' },
                    { case: 'Trap: Invalid data type', expected: 'Type mismatch handled', result: 'VERIFY' },
                    { case: 'Trap: Excel minimized', expected: 'ScreenUpdating restores', result: 'VERIFY' }
                ];
            } else {
                return [
                    { case: 'Normal: Valid cell reference', expected: 'Correct result', result: 'PASS' },
                    { case: 'Edge: #N/A in lookup', expected: 'IFERROR handles', result: 'VERIFY' },
                    { case: 'Edge: Empty range', expected: 'No #VALUE!', result: 'VERIFY' },
                    { case: 'Stress: Large range (A1:Z10000)', expected: 'Calculates', result: 'VERIFY' },
                    { case: 'Trap: Circular reference', expected: 'Excel warnings', result: 'VERIFY' },
                    { case: 'Trap: Divide by zero', expected: '#DIV/0! or handled', result: 'VERIFY' },
                    { case: 'Trap: Text in number field', expected: '#VALUE! or handled', result: 'VERIFY' },
                    { case: 'Trap: Different Excel version', expected: 'Function available', result: 'VERIFY' }
                ];
            }
        }

        // Display Analysis
        function displayAnalysis(analysis) {
            const output = document.getElementById('execOutput');
            if (!output) return;
            
            const verdictClass = `verdict-${analysis.verdict}`;
            const verdictIcon = analysis.verdict === 'pass' ? '✅' : analysis.verdict === 'warn' ? '⚠️' : '❌';
            const verdictText = analysis.verdict === 'pass' ? 'PASS (Verified)' : 
                               analysis.verdict === 'warn' ? 'PASS with Risks' : 'FAIL (Bugs Found)';
            
            let html = `
                <div class="verdict-section ${verdictClass}">
                    <div class="verdict-title">${verdictIcon} ${verdictText}</div>
                    <div class="verdict-summary">
                        <strong>Input Type:</strong> ${analysis.inputType}<br>
                        <strong>Total Issues:</strong> ${analysis.totalIssues} 
                        (${analysis.criticalCount} Critical, ${analysis.majorCount} Major)<br><br>
                        ${analysis.verdict === 'pass' ? '✓ No critical issues found. Code passes basic validation.' : ''}
                        ${analysis.verdict === 'warn' ? '⚠ Code has non-critical issues that should be addressed.' : ''}
                        ${analysis.verdict === 'fail' ? '✗ Critical bugs found. Code will not compile or will crash at runtime.' : ''}
                    </div>
                </div>
            `;
            
            // Issues
            if (analysis.issues.length > 0) {
                html += '<h3 style="color: var(--accent-cyan); margin: 20px 0 10px 0;">📋 Issues Found (Ranked by Severity)</h3>';
                
                analysis.issues.forEach((issue, idx) => {
                    html += `
                        <div class="issue-item">
                            <div class="issue-header">
                                <span class="issue-severity severity-${issue.severity.toLowerCase()}">${issue.severity}</span>
                                <span class="issue-location">${issue.location}</span>
                            </div>
                            <div class="issue-description">
                                <strong>${issue.type}:</strong> ${issue.description}<br>
                                <strong>Why it breaks:</strong> ${issue.why}
                            </div>
                            ${issue.fix ? `<div class="issue-fix">Fix: ${escapeHtml(issue.fix)}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            // CRITICAL VALIDATION GATE: Only show "Corrected Version" if code passes validation
            if (analysis.validation && analysis.validation.canLabelAsReady && analysis.fixedCode) {
                html += '<h3 style="color: var(--accent-cyan); margin: 20px 0 10px 0;">✅ Corrected Version (Ready to Paste)</h3>';
                html += `<pre class="code-preview">${escapeHtml(analysis.fixedCode)}</pre>`;
                html += `<div style="margin: 10px 0; padding: 10px; background: var(--bg-accent); border-left: 4px solid var(--accent-green); border-radius: 4px;">`;
                html += `<strong>Status:</strong> ${analysis.validation.status}<br>`;
                html += `<strong>Confidence:</strong> ${analysis.validation.confidence}%<br>`;
                html += `<strong>Reason:</strong> ${analysis.validation.reason[0] || 'Code validated'}`;
                html += `</div>`;
            } else if (analysis.validation && analysis.validation.status === 'PARTIALLY_CORRECTED') {
                html += '<h3 style="color: var(--accent-orange); margin: 20px 0 10px 0;">⚠️ Partially Corrected (Manual Review Required)</h3>';
                html += `<div style="margin: 10px 0; padding: 15px; background: var(--bg-accent); border-left: 4px solid var(--accent-orange); border-radius: 4px;">`;
                html += `<strong>Status:</strong> Some issues were auto-corrected, but critical errors remain.<br><br>`;
                html += `<strong>Reasons:</strong><ul>`;
                analysis.validation.reason.forEach(r => {
                    html += `<li>${r}</li>`;
                });
                html += `</ul>`;
                html += `<strong>Action Required:</strong> Fix the issues listed above manually, then re-run analysis.`;
                html += `</div>`;
            } else {
                html += '<h3 style="color: var(--accent-red); margin: 20px 0 10px 0;">❌ Code Still Invalid (Requires Manual Fixes)</h3>';
                html += `<div style="margin: 10px 0; padding: 15px; background: var(--bg-accent); border-left: 4px solid var(--accent-red); border-radius: 4px;">`;
                html += `<strong>Status:</strong> Critical grammar or structural errors prevent execution.<br><br>`;
                html += `<strong>Reasons:</strong><ul>`;
                if (analysis.validation && analysis.validation.reason) {
                    analysis.validation.reason.forEach(r => {
                        html += `<li>${r}</li>`;
                    });
                } else {
                    html += `<li>Critical errors detected that cannot be auto-fixed</li>`;
                }
                html += `</ul>`;
                html += `<strong>Action Required:</strong> Fix grammar errors manually. Grammar errors have no auto-fix.<br>`;
                html += `<strong>Note:</strong> Code cannot be labeled as "Ready to Paste" until all critical errors are resolved.`;
                html += `</div>`;
            }
            
            // Test Cases
            html += '<h3 style="color: var(--accent-cyan); margin: 20px 0 10px 0;">🧪 Test Cases</h3>';
            html += '<table class="test-cases-table">';
            html += '<tr><th>Test Case</th><th>Expected</th><th>Result</th></tr>';
            analysis.testCases.forEach(test => {
                const resultClass = test.result === 'PASS' ? 'test-result-pass' : test.result === 'FAIL' ? 'test-result-fail' : '';
                html += `<tr><td>${test.case}</td><td>${test.expected}</td><td class="${resultClass}">${test.result}</td></tr>`;
            });
            html += '</table>';
            
            // Verification Checklist
            html += '<h3 style="color: var(--accent-cyan); margin: 20px 0 10px 0;">✓ Verification Checklist</h3>';
            html += '<ul style="line-height: 2;">';
            html += '<li>✓ Syntax validated</li>';
            html += '<li>✓ Structure checked (block matching)</li>';
            html += '<li>✓ Runtime risks analyzed</li>';
            html += '<li>✓ Object assignments verified</li>';
            html += '<li>' + (analysis.issues.some(i => i.location === 'UNVERIFIED') ? '⚠' : '✓') + ' Context dependencies noted</li>';
            html += '<li>✓ Test cases generated</li>';
            html += '</ul>';
            
            output.innerHTML = html;
        }

        // Execution Tool UI Functions
        window.ExecTool.clearExecution = function() {
            const input = document.getElementById('execInput');
            const output = document.getElementById('execOutput');
            
            if (input) input.value = '';
            if (output) {
                output.style.display = 'none';
                output.innerHTML = '';
            }
            
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            // UI ENHANCEMENT: Clear professional panels (ADDITIVE ONLY)
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            try {
                window.ExecUI.updateCodeView('');
                window.ExecUI.clearImmediateWindow();
                window.ExecUI.hidePanels();
                window.ExecUI.hideProgress();
                window.TestResultsPanel.reset();  // Close test results panel
            } catch (e) {
                console.warn('UI clear failed (non-critical):', e);
            }
            // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            
            addExecNotification('info', 'Execution tool cleared');
        };

        window.ExecTool.copyExecutionCode = function() {
            const input = document.getElementById('execInput');
            if (!input) return;
            
            navigator.clipboard.writeText(input.value).then(() => {
                addExecNotification('success', 'Code copied to clipboard');
            });
        };

        // Execution Notifications
        function addExecNotification(type, message) {
            const content = document.getElementById('execNotifContent');
            const counter = document.getElementById('execNotifCount');
            
            if (!content || !counter) return;
            
            const notif = document.createElement('div');
            notif.className = `notif-item notif-${type}`;
            notif.innerHTML = `
                <span class="notif-number">#${execNotifCounter}</span>
                ${type === 'success' ? '✓' : type === 'error' ? '✗' : type === 'warning' ? '⚠' : '►'} ${message}
            `;
            
            content.insertBefore(notif, content.firstChild);
            execNotifCounter++;
            counter.textContent = execNotifCounter - 1;
            
            while (content.children.length > 50) {
                content.removeChild(content.lastChild);
            }
        }

        function toggleExecNotifications() {
            // CRITICAL FIX: Only allow toggle in execution-tool view
            if (currentView !== 'execution-tool') {
                console.warn('⚠️ Execution notifications can only be toggled in Execution Tool view');
                return;
            }
            
            const sidebar = document.getElementById('execNotifSidebar');
            const toggle = document.getElementById('execNotifToggle');
            
            if (!sidebar || !toggle) return;
            
            // ADDITIONAL GUARD: Close other sidebars first
            const codeSidebar = document.getElementById('codeNotifSidebar');
            const formulaSidebar = document.getElementById('formulaNotifSidebar');
            if (codeSidebar) codeSidebar.classList.add('closed');
            if (formulaSidebar) formulaSidebar.classList.add('closed');
            
            execNotifOpen = !execNotifOpen;
            
            if (execNotifOpen) {
                sidebar.classList.remove('closed');
                toggle.classList.add('hidden');
            } else {
                sidebar.classList.add('closed');
                toggle.classList.remove('hidden');
            }
        }

        // Setup Execution Input Line Numbers
        function setupExecInput() {
            const execInput = document.getElementById('execInput');
            const execLineNumbers = document.getElementById('execLineNumbers');
            
            if (!execInput || !execLineNumbers) return;
            
            function updateExecLineNumbers() {
                const lines = execInput.value.split('\n').length;
                let nums = '';
                for (let i = 1; i <= Math.max(lines, 1); i++) {
                    nums += i + '\n';
                }
                execLineNumbers.textContent = nums;
            }
            
            function syncExecScroll() {
                execLineNumbers.scrollTop = execInput.scrollTop;
            }
            
            execInput.addEventListener('input', function() {
                updateExecLineNumbers();
                setTimeout(syncExecScroll, 0);
            });
            
            execInput.addEventListener('scroll', syncExecScroll);
            
            // Handle paste specifically
            execInput.addEventListener('paste', function(e) {
                setTimeout(() => {
                    updateExecLineNumbers();
                    syncExecScroll();
                }, 10);
            });
            
            execInput.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 4;
                    updateExecLineNumbers();
                }
                if (e.key === 'Enter') {
                    setTimeout(() => {
                        updateExecLineNumbers();
                        syncExecScroll();
                    }, 0);
                }
            });
            
            updateExecLineNumbers();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (currentView === 'code-editor') formatCode();
            }
            if (e.key === 'Escape') {
                closeModal();
                hideSuggestions();
            }
        });
        
        // ========================================
        // GLOBAL FUNCTION REGISTRATION (CRITICAL FOR BUTTONS)
        // ========================================
        try {
            window.switchView = switchView;
            window.formatCode = formatCode;
            window.copyCode = copyCode;
            window.clearEditor = clearEditor;
            window.loadTemplateDialog = loadTemplateDialog;
            window.loadSelectedTemplate = loadSelectedTemplate;
            window.closeModal = closeModal;
            window.checkFormula = checkFormula;
            window.clearFormula = clearFormula;
            window.toggleNavigation = toggleNavigation;
            window.toggleCodeNotifications = toggleCodeNotifications;
            window.toggleFormulaNotifications = toggleFormulaNotifications;
            window.toggleExecNotifications = toggleExecNotifications;
            window.clearCodeNotifications = clearCodeNotifications;
            window.clearFormulaNotifications = clearFormulaNotifications;
            window.loadFormulaToChecker = loadFormulaToChecker;
            
            console.log('%c✅ All functions registered successfully!', 'color: #00ff00; font-weight: bold;');
        } catch (error) {
            console.error('❌ Error registering functions:', error);
            alert('ERROR: Function registration failed. Press Ctrl+F5 to refresh.\n\nError: ' + error.message);
        }
        
        // Final verification
        const requiredFunctions = ['switchView', 'formatCode', 'toggleNavigation'];
        const missing = requiredFunctions.filter(fn => typeof window[fn] !== 'function');
        if (missing.length > 0) {
            console.error('❌ Critical functions missing:', missing);
            alert('CRITICAL ERROR: Essential functions not loaded: ' + missing.join(', ') + '\n\nPress Ctrl+F5 to force refresh.');
        } else {
            console.log('%c✅ VBA Code Editor ready!', 'color: #00ff00; font-size: 14px; font-weight: bold;');
        }
    </script>
    
    <!-- Footer -->
    <footer>
        <p>
            © 2026 Matthew Naliponguit Sugang. 
            Licensed under 
            <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" rel="noopener noreferrer">
                CC BY-NC-ND 4.0
            </a>.
        </p>
    </footer>
</body>
</html>